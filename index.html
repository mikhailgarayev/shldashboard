<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>SUMO Dashboard</title>
  <!-- Подключаем Bootstrap (опционально) -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    /* Общий сброс и фон */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      min-height: 100vh;
      background: linear-gradient(120deg, #fdfbfb 0%, #ebedee 100%);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow-x: hidden;
    }
    .dashboard-container {
      max-width: 1400px;
      margin: auto;
      padding: 40px 20px;
    }
    h1 {
      text-align: center;
      color: #343a40;
      margin-bottom: 30px;
      font-weight: 500;
      font-size: 2rem;
    }
    .status-bar {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      flex-wrap: wrap;
      margin-bottom: 30px;
    }
    .status-bar button {
      border: none;
      border-radius: 50px;
      padding: 10px 20px;
      font-size: 0.9rem;
      margin: 6px;
      transition: background-color 0.3s, box-shadow 0.3s;
      cursor: pointer;
    }
    .status-bar button:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(52, 58, 64, 0.4);
    }
    .btn-outline-primary {
      background-color: #ffffff;
      color: #007bff;
      border: 2px solid #007bff;
    }
    .btn-outline-primary:hover {
      background-color: #007bff;
      color: #ffffff;
    }
    .btn-outline-secondary {
      background-color: #ffffff;
      color: #6c757d;
      border: 2px solid #6c757d;
    }
    .btn-outline-secondary:hover {
      background-color: #6c757d;
      color: #ffffff;
    }
    .status-badge {
      background-color: #28a745;
      border-radius: 50px;
      padding: 8px 16px;
      font-size: 0.9rem;
      margin: 6px;
    }
    .status-bar span {
      margin: 6px;
      font-size: 0.9rem;
      color: #343a40;
    }
    /* Горизонтальный ряд карточек */
    .platforms-row {
      display: flex;
      flex-wrap: nowrap;
      justify-content: center;
      overflow-x: auto;
      padding-bottom: 10px;
    }
    .platform-card {
      /* Возвращаем фиксированную ширину */
      flex: 0 0 220px;
      box-sizing: border-box;
      background: #ffffff;
      border-radius: 16px;
      padding: 20px;
      margin: 0 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      transition: transform 0.2s, box-shadow 0.2s;
      /* Самое главное – разрешаем перенос слов/строк */
      white-space: normal;
      overflow-wrap: break-word; /* или word-wrap: break-word; */
    }
    .platform-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    }
    .platform-card h5 {
      color: #343a40;
      margin-bottom: 12px;
      text-align: center;
      font-weight: 600;
      font-size: 1.1rem;
    }
    .platform-card p {
      text-align: center;
      color: #6c757d;
      margin: 10px 0;
      font-size: 0.85rem;
    }
    .platform-card ul {
      list-style: none;
      padding-left: 0;
      margin: 0;
      font-size: 0.85rem;
      color: #495057;
      /* Тоже полезно разрешить перенос строк */
      white-space: normal;
      overflow-wrap: break-word;
    }
    .platform-card ul li {
      border-bottom: 1px solid #e9ecef;
      padding: 4px 0;
      /* Позволяем перенос для каждого элемента списка */
      white-space: normal;
      overflow-wrap: anywhere;
    }
    .platform-card ul li:last-child {
      border-bottom: none;
    }

    /* Upcoming Breaks */
    #breaks-section {
      margin-top: 40px;
    }
    #breaks-section h2 {
      text-align: center;
      color: #343a40;
      margin-bottom: 20px;
      font-weight: 500;
      font-size: 1.5rem;
    }
    .break-card {
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      padding: 20px;
      margin: 0 auto;
      max-width: 600px;
      text-align: center;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .break-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    }
    .break-card h5 {
      margin-bottom: 12px;
      font-weight: 600;
      color: #343a40;
      font-size: 1.1rem;
    }
    .break-card ul {
      list-style: none;
      padding-left: 0;
      margin: 0;
      font-size: 0.85rem;
      color: #495057;
    }
    .break-card ul li {
      padding: 6px 0;
      border-bottom: 1px solid #e9ecef;
    }
    .break-card ul li:last-child {
      border-bottom: none;
    }

    /* Скролл */
    ::-webkit-scrollbar {
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb {
      background: #cccccc;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #b3b3b3;
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <h1>Support Monitoring Dashboard</h1>
    
    <!-- Панель кнопок и статуса -->
    <div class="status-bar">
      <button id="toggle-autorefresh" class="btn btn-outline-primary">Disable Auto Refresh</button>
      <button id="refresh-now" class="btn btn-outline-secondary">Refresh now</button>
      <span id="update-status" class="status-badge">Updated</span>
      <span>Auto refresh in <span id="countdown">10</span> seconds...</span>
    </div>
    
    <!-- Горизонтальная лента карточек платформ -->
    <div id="app" class="platforms-row"></div>
    
    <!-- Раздел Upcoming Breaks (одна карточка) -->
    <div id="breaks-section">
      <h2>Upcoming Breaks</h2>
      <div id="breaks-app"></div>
    </div>
  </div>

  <!-- PapaParse для CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script>
    // Ссылки на CSV
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSmaCLCDgsSsk-HY4qtkZteI60f1NxMCO4IYrFjeXoCbQRjAh0IeK0tJ4fMSScZqbS1troISgXNvssJ/pub?output=csv";
    const BREAKS_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSmaCLCDgsSsk-HY4qtkZteI60f1NxMCO4IYrFjeXoCbQRjAh0IeK0tJ4fMSScZqbS1troISgXNvssJ/pub?gid=96694645&single=true&output=csv";

    // Конфигурация платформ (индексы столбцов/строк)
    const platforms = [
      { name: "CS",             colIndexNames: 3,  colIndexData: 4,  rowActiveCount: 3, rowActiveNamesStart: 4,  rowActiveNamesEnd: 15, rowAwayCount: 27, rowAwayNamesStart: 28, rowAwayNamesEnd: 35 },
      { name: "CS/Post order",  colIndexNames: 5,  colIndexData: 6,  rowActiveCount: 3, rowActiveNamesStart: 4,  rowActiveNamesEnd: 15, rowAwayCount: 27, rowAwayNamesStart: 28, rowAwayNamesEnd: 35 },
      { name: "PSR",            colIndexNames: 7,  colIndexData: 8,  rowActiveCount: 3, rowActiveNamesStart: 4,  rowActiveNamesEnd: 15, rowAwayCount: 27, rowAwayNamesStart: 28, rowAwayNamesEnd: 35 },
      { name: "SiMo",           colIndexNames: 9,  colIndexData: 10, rowActiveCount: 3, rowActiveNamesStart: 4,  rowActiveNamesEnd: 15, rowAwayCount: 27, rowAwayNamesStart: 28, rowAwayNamesEnd: 35 },
      { name: "Aircall",        colIndexNames: 11, colIndexData: 12, rowActiveCount: 3, rowActiveNamesStart: 4,  rowActiveNamesEnd: 15, rowAwayCount: 27, rowAwayNamesStart: 28, rowAwayNamesEnd: 35 },
      { name: "Venue",          colIndexNames: 13, colIndexData: 14, rowActiveCount: 3, rowActiveNamesStart: 4,  rowActiveNamesEnd: 15, rowAwayCount: 27, rowAwayNamesStart: 28, rowAwayNamesEnd: 35 },
      { name: "Trainee",        colIndexNames: 15, colIndexData: 16, rowActiveCount: 3, rowActiveNamesStart: 4,  rowActiveNamesEnd: 15, rowAwayCount: 27, rowAwayNamesStart: 28, rowAwayNamesEnd: 35 },
      { name: "ST",             colIndexNames: 17, colIndexData: 18, rowActiveCount: 3, rowActiveNamesStart: 4,  rowActiveNamesEnd: 15, rowAwayCount: 27, rowAwayNamesStart: 28, rowAwayNamesEnd: 35 }
    ];

    let autoRefreshEnabled = true;
    let refreshInterval = 10; 
    let refreshTimer = null;
    let countdownTimer = null;
    let countdownValue = refreshInterval;

    // Загрузка основного CSV
    function fetchData() {
      Papa.parse(CSV_URL, {
        download: true,
        header: false,
        complete: function(results) {
          const data = results.data;
          renderDashboard(data);
          showUpdatedStatus();
          // Обновляем также Upcoming Breaks
          fetchBreaksData();
          if (autoRefreshEnabled) resetAutoRefresh();
        },
        error: function(err) {
          console.error("Ошибка парсинга CSV:", err);
        }
      });
    }

    // Рендерим карточки платформ
    function renderDashboard(data) {
      const app = document.getElementById("app");
      let html = "";
      platforms.forEach(platform => {
        const activeCount = data[platform.rowActiveCount]?.[platform.colIndexData] || 0;
        const activeNames = [];
        for (let r = platform.rowActiveNamesStart; r <= platform.rowActiveNamesEnd; r++) {
          const name = data[r]?.[platform.colIndexNames]?.trim();
          if (name) activeNames.push(name);
        }
        const awayCount = data[platform.rowAwayCount]?.[platform.colIndexData] || 0;
        const awayData = [];
        for (let r = platform.rowAwayNamesStart; r <= platform.rowAwayNamesEnd; r++) {
          const name = data[r]?.[platform.colIndexNames]?.trim();
          if (!name) continue;
          const reason = data[r]?.[platform.colIndexData]?.trim() || "";
          awayData.push({ name, reason });
        }

        html += `
          <div class="platform-card">
            <h5>${platform.name}</h5>
            <p><small>Активные (${activeCount})</small></p>
            <ul>
              ${activeNames.map(n => `<li>${n}</li>`).join("")}
            </ul>
            <p><small>Away (${awayCount})</small></p>
            <ul>
              ${awayData.map(item => {
                const extra = item.reason ? " - " + item.reason : "";
                return `<li>${item.name}${extra}</li>`;
              }).join("")}
            </ul>
          </div>
        `;
      });
      app.innerHTML = html;
    }

    // Показ статуса обновления
    function showUpdatedStatus() {
      const updateStatusEl = document.getElementById("update-status");
      updateStatusEl.textContent = "Updated";
      updateStatusEl.style.backgroundColor = "#28a745";
    }

    // Загрузка CSV для Upcoming Breaks
    function fetchBreaksData() {
      Papa.parse(BREAKS_CSV_URL, {
        download: true,
        header: true,
        complete: function(results) {
          const data = results.data;
          renderBreaks(data);
        },
        error: function(err) {
          console.error("Ошибка загрузки брейков:", err);
        }
      });
    }

    // Преобразование "HH:MM" в минуты от полуночи
    function parseTimeToMinutes(timeStr) {
      const [hh, mm] = timeStr.trim().split(":");
      return parseInt(hh, 10) * 60 + parseInt(mm, 10);
    }

    // Рендерим Upcoming Breaks одной карточкой
    function renderBreaks(breaksData) {
      const now = new Date();
      const currentTotalMinutes = now.getHours() * 60 + now.getMinutes();
      const horizon = currentTotalMinutes + 60;

      const upcoming = breaksData.filter(item => {
        if (!item["Break Time"]) return false;
        const breakTimeStr = item["Break Time"].trim();
        const breakMinutes = parseTimeToMinutes(breakTimeStr);
        return (breakMinutes > currentTotalMinutes) && (breakMinutes <= horizon);
      });
      upcoming.sort((a, b) => {
        return parseTimeToMinutes(a["Break Time"]) - parseTimeToMinutes(b["Break Time"]);
      });

      let html = `<div class="break-card">
                    <h5>Upcoming Breaks</h5>
                    <ul>`;
      upcoming.forEach(item => {
        const name = item["Name"];
        const breakTime = item["Break Time"];
        const shiftStart = item["Shift Start Time"];
        const workspace = item["Working Space"];
        html += `<li>
                   <strong>${name}</strong><br/>
                   Break at: <strong>${breakTime}</strong><br/>
                   Shift: ${shiftStart} | ${workspace}
                 </li>`;
      });
      html += `</ul></div>`;
      document.getElementById("breaks-app").innerHTML = html;
    }

    // Автообновление
    function resetAutoRefresh() {
      clearTimeout(refreshTimer);
      clearInterval(countdownTimer);
      countdownValue = refreshInterval;
      updateCountdownDisplay();
      refreshTimer = setTimeout(fetchData, refreshInterval * 1000);
      countdownTimer = setInterval(() => {
        countdownValue--;
        if (countdownValue <= 0) clearInterval(countdownTimer);
        updateCountdownDisplay();
      }, 1000);
    }
    function updateCountdownDisplay() {
      document.getElementById("countdown").textContent = countdownValue;
    }
    function toggleAutoRefresh() {
      autoRefreshEnabled = !autoRefreshEnabled;
      const btn = document.getElementById("toggle-autorefresh");
      if (autoRefreshEnabled) {
        btn.textContent = "Disable Auto Refresh";
        resetAutoRefresh();
      } else {
        btn.textContent = "Enable Auto Refresh";
        clearTimeout(refreshTimer);
        clearInterval(countdownTimer);
        document.getElementById("countdown").textContent = "";
      }
    }
    function refreshNow() {
      fetchData();
    }
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("toggle-autorefresh").addEventListener("click", toggleAutoRefresh);
      document.getElementById("refresh-now").addEventListener("click", refreshNow);
      fetchData();
    });
  </script>
</body>
</html>
