<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>SUMO Dashboard</title>
    <link rel="icon" type="image/png" href="favicon.png" />
    <!-- Подключаем Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <!-- Подключаем Bootstrap-Select CSS для современного dropdown -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.18/css/bootstrap-select.min.css"
    />
    <style>
      /* Скрываем страницу до проверки авторизации */
      body.hidden {
        display: none;
      }

      :root {
        /* Светлая тема по умолчанию */
        --bg-color: linear-gradient(120deg, #fdfbfb 0%, #ebedee 100%);
        --text-color: #343a40;
        --card-bg-color: #ffffff;
        --card-text-color: #495057;
        --card-border-color: #dee2e6;
        --card-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        --card-hover-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
        --menu-bg-color: #ffffff;
        --menu-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
        --menu-width: 250px;
        --transition-speed: 0.3s;
      }
      /* Тёмная тема */
      body.dark-theme {
        --bg-color: linear-gradient(120deg, #2a2a2a 0%, #3c3a3c 100%);
        --text-color: #f0f0f0;
        --card-bg-color: #3a3a3a;
        --card-text-color: #e5e5e5;
        --card-border-color: #555555;
        --card-shadow: 0 4px 16px rgba(255, 255, 255, 0.08);
        --card-hover-shadow: 0 6px 20px rgba(255, 255, 255, 0.12);
        --menu-bg-color: #3a3a3a;
      }

      /* Общий сброс и фон */
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        min-height: 100vh;
        background: var(--bg-color);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        overflow-x: hidden;
        color: var(--text-color);
        transition: background var(--transition-speed) ease,
          color var(--transition-speed) ease;
      }

      /* Стиль для блока с информацией о пользователе и кнопкой выхода */
      #user-info {
        text-align: right;
        padding: 10px;
        font-size: 1rem;
        color: var(--text-color);
      }

      /* Сайдбар (меню) */
      .hamburger-menu {
        margin-right: 12px;
        cursor: pointer;
      }
      .hamburger-menu span {
        font-size: 28px;
        color: var(--text-color);
      }
      #sidebar {
        position: fixed;
        top: 0;
        left: -250px;
        width: 250px;
        height: 100%;
        background: var(--menu-bg-color);
        box-shadow: 2px 0 12px rgba(0, 0, 0, 0.2);
        transition: left 0.3s ease;
        z-index: 1099;
        padding: 30px 20px;
      }

      #sidebar.active {
        left: 0;
      }

      #sidebar a {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 10px;
        font-size: 1rem;
        color: var(--text-color);
        border-bottom: 1px solid var(--card-border-color);
        transition: background 0.2s ease, transform 0.2s ease;
        text-decoration: none;
      }

      #sidebar a:hover {
        background: rgba(0, 123, 255, 0.05);
        transform: translateX(4px);
        border-radius: 6px;
      }

      #sidebar .close-btn {
        font-size: 24px;
        text-align: right;
        cursor: pointer;
        color: var(--text-color);
        margin-bottom: 20px;
      }

      body.dark-theme #sidebar {
        background: #2b2b2b;
      }

      body.dark-theme #sidebar a {
        color: #f0f0f0;
      }

      body.dark-theme #sidebar a:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .dashboard-container {
        width: 100%;
        margin: 0;
        padding: 20px;
        box-sizing: border-box;
      }
      h1 {
        text-align: center;
        margin-bottom: 20px;
        font-weight: 500;
        font-size: 2rem;
        color: var(--text-color);
      }

      /* Панель фильтров */
      .filter-panel {
        background: var(--card-bg-color);
        border-radius: 12px;
        padding: 12px 24px;
        margin: 0 auto 24px;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
        box-shadow: var(--card-shadow);
        nax-width: 1200px;
      }
      .filter-panel .filter-dropdown {
        background: #f7f8fa;
        border: 1px solid #e0e0e5;
        border-radius: 6px;
        padding: 8px 12px;
        min-width: 140px;
        transition: border-color .2s ease;
      }
      .filter-panel .filter-dropdown:hover,
      .filter-panel .filter-dropdown:focus,
      .filter-panel .search-input:hover,
      .filter-panel .search-input:focus {
        border-color: #007bff;                  /* подчеркнём цветом при взаимодействии */
        outline: none;
      }
      #summary-grid {
        display: grid !important;
        grid-template-columns: repeat(6, minmax(0, 1fr)) !important;
        grid-auto-rows: auto;
        gap: 0.5rem 0.75rem !important;
        max-width: 1150px !important;
        margin: 0 auto 2rem;
        margin-bottom: 0.5rem !important;
        padding-bottom: 0;
      }
      .stats-card {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        margin: 8px;
        padding: 0.8rem 0.6rem !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        background: var(--card-bg-color);
        border-radius: 8px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        position: relative;
        overflow: hidden;
        border: 1px solid var(--card-border-color);
        min-width: 180px;
      }
      .stats-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
      }
      .stats-card .stats-title {
        font-size: 0.75rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.05rem;
        margin-bottom: 0.3rem;
      }
      .stats-card .stats-value {
        font-size: 1.4rem;
        font-weight: 700;
        color: #343a40;
        margin-bottom: 0.2rem;
      }
      .stats-card .small {
        font-size: 0.75rem;
        color: #868e96;
        margin-top: 0.25rem;
      }
      .stats-card .info-icon {
        width: 1rem;
        height: 1rem;
        marging-left: 0.5rem !important;
        filter: grayscale(100%);
        transition: filter 0.2s ease;
        cursor: pointer;
      }
      .stats-card .info-icon:hover {
        filter: none;
      }
      .stats-value.d-inline-flex {
        gap: 0.25rem  !important;
        align-items: center !important;
      }
      .stats-card.red-card {
        background-color: #fff5ff;
        border: 1px solid #ff6b6b;     /* красная граница */
      }
      .stats-title {
        font-size: 0.9rem;
        opacity: 0.7;
      }
      .stats-value {
        font-weight: bold;
        font-size: 1.2rem;
        margin-top: 4px;
      }
      .red-card {
        background-color: #ffe5e5;
        border-color: #dc3545;     /* красная граница */
        border: 1px solid #ff6b6b;
      }
      .filter-section {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }
      .filter-dropdown {
        padding: 8px 12px;
        border: 1px solid var(--card-border-color);
        border-radius: 6px;
        background: var(--card-bg-color);
        min-width: 120px;
        color: var(--text-color);
      }
      .search-section {
        display: flex;
        margin-left: auto;
      }
      .search-input {
        padding: 8px 12px;
        border: 1px solid var(--card-border-color);
        border-radius: 6px 0 0 6px;
        background: var(--card-bg-color);
        width: 150px;
        color: var(--text-color);
      }

      /* Секция обновления страницы */
      .refresh-section {
        margin-left: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .refresh-btn {
        padding: 6px 10px;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .refresh-btn, .refresh-section img {
        transition: transform .2s ease;
      }
      .refresh-btn:hover, .refresh-section img:hover {
        transform: scale(1.1);
      }
      .theme-switch .slider:before {
        font-size: 14px;
        line-height: 18px;
      }
      .refresh-btn:hover {
        background-color: #218838;
      }
      .spinner-border {
        width: 1rem;
        height: 1rem;
        border-width: 0.1em;
      }
      @media (max-width: 768px) {
        .filter-panel {
          justify-content: center;
        }
        .filter-panel .filter-dropdown,
        .filter-panel .search-input {
          min-width: 45%;
        }
      }
      /* Сброс стилей для текста */
      .theme-text {
        margin: 0;
        padding: 0;
        line-height: 1;
        font-size: 1rem;
      }
      /* Переключатель темы */
      .theme-toggle-container {
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .theme-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
      }
      .theme-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 24px;
      }
      .slider:before {
        position: absolute;
        content: "☀️";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
        font-size: 12px;
        line-height: 18px;
        text-align: center;
        color: #f39c12;
      }
      input:checked + .slider {
        background-color: #007bff;
      }
      input:checked + .slider:before {
        transform: translateX(26px);
        content: "🌙";
        color: #f1c40f;
      }

      /* Карточки и таблицы */
      .platforms-row {
        display: flex;
        flex-wrap: nowrap;
        align-items: flex-start;
        justify-content: space-between;
        overflow-x: auto;
        gap: 10px;
      }
      .platform-card {
        flex: 1 1 220px;
        min-width: 220px;
        background: var(--card-bg-color);
        color: var(--card-text-color);
        border-radius: 16px;
        padding: 20px;
        box-shadow: var(--card-shadow);
        transition: transform 0.2s, box-shadow 0.2s;
        overflow-wrap: break-word;
      }
      .platform-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--card-hover-shadow);
      }
      .platform-card h5 {
        text-align: center;
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 12px;
        color: var(--text-color);
      }
      .platform-card h5 .info-icon {
        display: inline-block;
        margin-left: 5px;
        cursor: pointer;
        font-size: 0.9rem;
        vertical-align: middle;
      }
      .platform-card p {
        text-align: center;
        margin: 10px 0;
        font-size: 0.85rem;
        color: #6c757d;
      }
      .platform-card ul {
        list-style: none;
        padding-left: 0;
        font-size: 0.85rem;
        color: var(--card-text-color);
      }
      .platform-card ul li {
        padding: 4px 0;
        cursor: pointer;
        border-bottom: 1px solid var(--card-border-color);
      }
      .platform-card ul li:last-child {
        border-bottom: none;
      }
      .shift-summary-card {
        background: none !important;
        color: var(--card-text-color);
        border: none !important;
        box-shadow: none !important;
        padding: 20px;
        margin: 0 auto 40px;
        text-align: center;
        overflow-wrap: break-word;
        font-size: 1.2rem;
        font-weight: 700;
      }
      .shift-summary-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--card-hover-shadow);
      }
      .shift-summary-title {
        margin-bottom: 16px;
        font-weight: 600;
        font-size: 1.3rem;
        color: var(--text-color);
      }
      .shift-summary-grid {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        table-layout: auto;
        font-size: 2rem;
      }
      .shift-summary-grid th,
      .shift-summary-grid td {
        padding: 8px 12px;
        text-align: center;
        font-size: 0.85rem;
        color: var(--card-text-color);
      }
      .shift-summary-grid th {
        background: none !important;
        font-weight: 600;
      }
      .shift-summary-grid td {
        background: none !important;
        border: 1px solid var(--card-border-color);
        border-radius: 8px;
      }
      .small-font-card {
        font-size: 0.9rem;
      }
      .shift-card-title {
        font-size: 1.4rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
        text-align: center;
      }
      .shift-card-away {
        font-size: 1.1rem;
        color: #666;
        text-align: center;
      }
      #breaks-section {
        margin-top: 40px;
      }

      #alerts-section #breaks-section {
        margin-top: 0;
      }
      
      #breaks-section h2 {
        text-align: center;
        margin-bottom: 20px;
        font-weight: 500;
        font-size: 1.5rem;
        color: var(--text-color);
      }
      /* Контейнер двух карточек */
      #alerts-section {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
        justify-content: center;
        align-items: stretch;
        margin: 2rem 0;
      }
      
      /* Карточка внутри */
      .alert-card {
        flex: 0 1 320px;      /* не растягиваем карточку больше базисной ширины */
        max-width: 400px;      /* ограничиваем максимальную ширину */
        align-self: stretch;   /* заставляем все карточки быть одной высоты */
        background: var(--card-bg-color);
        border: 1px solid var(--card-border-color);
        box-shadow: var(--card-shadow);
        border-radius: 8px;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        text-align: center;
        justify-content: center;
      }

      #breaks-app .break-card {
      margin-bottom: 0 !important;
      }

      .alert-content {
        flex: 1;             /* займёт всё оставшееся пространство */
        overflow-y: auto;    /* если много элементов — появится скролл */
      }
      
      /* Заголовок */
      .alert-card h2 {
        margin-bottom: 20px;
        font-weight: 500;
        font-size: 1.5rem;
        color: var(--text-color);
      }
      
      /* Контент-область */
      .alert-card > div {
        flex: 1;
        overflow-y: auto;
      }

      .alert-card ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .alert-card li {
        margin-bottom: 0.75rem;
        line-height: 1.3;
      }
      @media (max-width: 768px) {
        .alert-card { max-width: 100%; }
      }

      .break-conflict > strong {
        color: #dc3545;
      }

      /* контейнер списка внутри */
      #shift-overs-app ul,
      #breaks-app ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      #shift-overs-app li,
      #breaks-app li {
        margin-bottom: 0.75rem;
      }

      .break-card {
        background: var(--card-bg-color);
        color: var(--card-text-color);
        border-radius: 16px;
        box-shadow: var(--card-shadow);
        padding: 20px;
        margin: 0 auto 40px;
        max-width: 600px;
        text-align: center;
        overflow-wrap: break-word;
      }
      .break-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--card-hover-shadow);
      }
      .break-card h5 {
        margin-bottom: 12px;
        font-weight: 600;
        font-size: 1.1rem;
        color: var(--text-color);
      }
      .break-card ul {
        list-style: none;
        padding-left: 0;
        font-size: 0.85rem;
        color: var(--card-text-color);
      }
      .break-card ul li {
        padding: 6px 0;
        border-bottom: 1px solid var(--card-border-color);
      }
      .break-card ul li:last-child {
        border-bottom: none;
      }

      /* Модальное окно сотрудника */
      #modal-overlay {
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
        position:fixed;
        top : 0;
        left: 0;  
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }
      #employee-modal {
        opacity: 0;
        transform: translateX(-50%) scale(0.95);
        transition: opacity 0.3s ease, transform 0.3s ease;
        position: fixed;
        top: 20%;
        left: 50%;
        background: var(--card-bg-color);
        color: var(--card-text-color);
        border: 1px solid var(--card-border-color);
        box-shadow: var(--card-shadow);
        border-radius: 8px;
        padding: 20px;
        z-index: 1001;
        width: 330px;
        pointer-events: none;
      }

      #employee-modal.show {
        opacity: 1;
        transform: translateX(-50%) scale(1);
        pointer-events: auto;
      }

      #modal-overlay.show {
        opacity: 1;
        pointer-events: auto;
      }

      #employee-modal h3 {
        margin: 0 0 8px 0;
      }
      #employee-modal .close-btn {
        position: absolute;
        top: 8px;
        right: 12px;
        cursor: pointer;
        font-size: 20px;
      }
      #employee-modal a {
        color: #007bff;
        text-decoration: underline;
      }
      #employee-modal a:hover {
        color: #0056b3;
      }
      .dashboard-header {
        background: var(--card-bg-color);
        border-bottom: 1px solid var(--card-border-color);
        box-shadow: var(--card-shadow);
        border-radius: 0 0 12px 12px;
        position: sticky;
        top: 0;
        z-index: 100;
      }
      .filters-wrapper {
        flex: 1 1 auto;
        min-width: 0;
        max-width: 100%;
      }
      .filters-wrapper select,
      .filters-wrapper input {
        flex-shrink: 0;
      }
      @media (max-width: 768px) {
        .filters-wrapper {
          flex-direction: column;
          align-items: stretch;
        }
        .filters-wrapper > * {
          width: 100%;
        }
      }
      .header-gap > * {
        margin-right: 10px;
        margin-bottom: 6px;
      }
      .header-gap > *:last-child {
        margin-right: 0;
      }
      .info-cards {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        justify-content: center;
        margin-bottom: 20px;
      }
      
      
      /* Переопределение ширины для поля Platform, используем bootstrap‑select */
      .bootstrap-select .dropdown-toggle {
        width: 120px !important;
        padding: 4px 8px !important;
        font-size: 0.9rem !important;
        height: auto;
        line-height: 1.2  !important;
      }
      .btn-outline-primary:hover {
        color: white !important;
        background-color: #007bff !important;
        border-color: #007bff !important;
      }

      body.dark-theme #employee-modal {
        background-color: #2b2b2b;
        color: #f0f0f0;
        border: 1px solid #444;
      }

      body.dark-theme #employee-modal h5 {
        color: #fff;
      }

      body.dark-theme #employee-modal small {
        color: #aaa;
      }

      body.dark-theme #employee-modal strong {
        color: #ddd;
      }

      body.dark-theme #employee-modal a,
      body.dark-theme #employee-modal .btn-outline-primary {
        color: #66b0ff;
        border-color: #66b0ff;
      }

      body.dark-theme #employee-modal .btn-outline-primary:hover {
        background-color: #66b0ff;
        color: white;
      }

      /* Стили для карточек в dark-theme */
      body.dark-theme .stats-card {
        background: var(--card-bg-color) !important;    /* из ваших переменных тёмной темы */
        border-color: var(--card-border-color) !important;
        color: var(--card-text-color) !important;       /* общий цвет текста */
      }

      /* Заголовки внутри карточек (stats-title) */
      body.dark-theme .stats-card .stats-title {
        color: rgba(255,255,255,0.7) !important;
      }

      /* Основные большие цифры (stats-value) */
      body.dark-theme .stats-card .stats-value {
        color: #ffffff !important;
      }

      /* Мелкий дополнительный текст (класс .small или inline) */
      body.dark-theme .stats-card .small,
      body.dark-theme .stats-card .stats-value small {
        color: rgba(255,255,255,0.6) !important;
      }

      body.dark-theme .platform-card,
      body.dark-theme .stats-card,
      body.dark-theme .alert-card {
        box-shadow: none !important;
      }

      .break-overdue {
        color: #dc3545; /* Bootstrap red */
        font-weight: bold;
        animation: pulse 1s infinite;
      }
      .employee-item.king .employee-name {
        color: gold !important;
        font-weight: bold;
      }

      .employee-item.pink-name .employee-name {
      color: hotpink !important;
      }

      .pink-name {
      color: hotpink !important;
      }

      .employee-name {
        transition: transform 0.3s ease, color 0.3 ease;
      }

      .employee-name:hover {
        transition: scale(1.1);
        color: #ff4500;
        cursor: pointer;
      }


      @keyframes pulse {
        0% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.6;
          transform: scale(1.05);
        }
        100% {
          opacity: 1;
          transform: scale(1);
        }
      }
    </style>
    <!-- Подключаем Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script>
      // Инициализация Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyAHyxC12UaO6QU_nCiWFnegul1Vix5skm8",
        authDomain: "shldashboard.firebaseapp.com",
        projectId: "shldashboard",
        storageBucket: "shldashboard.firebasestorage.app",
        messagingSenderId: "362566153595",
        appId: "1:362566153595:web:ee35c2588bd0f798e6f9de"
      };
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      
      const TRANSFERS_API = 'https://script.google.com/macros/s/AKfycbz1QN5KuR4ZDGxkrApKqDzHDj1ewm5UTVP0vDjblopXqlOKlsDea7JOkldx_fBZ-GrA/exec?json=true';

      // 2) Глобальная переменная для кеша:
      let transfersData = [];

      // 3) Функция загрузки архива/сегодняшних данных:
      async function fetchTransfers() {
        try {
          const res = await fetch(TRANSFERS_API);
          transfersData = await res.json();
        } catch (e) {
          console.error('Transfers load error', e);
        }
      }

      // Список разрешённых email
      const allowedEmails = [
        "mikhail.garayev@wolt.com",
        "elshan.tahmazov@wolt.com",
        "inara.mammadzada@wolt.com",
        "mayya.mirzayeva@wolt.com",
        "mikayil.alizada@wolt.com",
        "pasha.chiragov@wolt.com",
        "rahim.mammadov@wolt.com",
        "toghrul.mirzali@wolt.com",
        "amaliya.rizvanova@wolt.com",
        "anar.mikayilov@wolt.com",
        "arif.guliyev@wolt.com",
        "farid.hajiyev@wolt.com",
        "naziya.orujova@wolt.com",
        "rafig.huseynov@wolt.com",
        "sama.akbarzadegan@wolt.com",
        "mursal.askarov@wolt.com"
      ];

      // Проверка авторизации – если пользователь не авторизован или его email не разрешён, перенаправляем на login.html
      auth.onAuthStateChanged((user) => {
        if (!user || !allowedEmails.includes(user.email)) {
          window.location.replace("login.html");
        } else {
          // Если все ок, выводим имя пользователя и убираем класс hidden
          document.getElementById("user-display-name").textContent =
            user.displayName || user.email;
          document.body.classList.remove("hidden");
        }
      });

      // Обработчик для кнопки Log Out
      document.addEventListener("DOMContentLoaded", () => {
        const logoutBtn = document.getElementById("logout-btn");
        logoutBtn.addEventListener("click", () => {
          auth.signOut();
        });
      });
    </script>
  </head>
  <body class="hidden">
    <header
      class="dashboard-header d-flex flex-wrap align-items-center justify-content-between gap-3 px-3 py-2"
    >
      <!-- Левая часть: бургер + заголовок -->
      <div class="d-flex align-items-center gap-3">
        <div class="hamburger-menu" id="hamburger-menu">
          <span style="font-size: 24px; cursor: pointer;">☰</span>
        </div>
        <h1 class="mb-0" style="font-size: 1.3rem;">
          Support Monitoring Dashboard
        </h1>
      </div>
      <!-- Центр: фильтры -->
      <div
        class="filters-wrapper d-flex flex-wrap align-items-center flex-grow-1 justify-content-center header-gap"
      >
        <select id="status-filter" class="filter-dropdown">
          <option value="both">Status</option>
          <option value="active">Active</option>
          <option value="away">Away</option>
        </select>
        <!-- Новый современный dropdown с помощью Bootstrap-Select для выбора платформ -->
        <select
          id="platform-dropdown"
          class="selectpicker filter-dropdown"
          multiple
          data-live-search="true"
          title="Platform"
          data-width="140px"
        >
          <option value="all" selected>All platforms</option>
          <option value="CS">CS</option>
          <option value="CS/Post order">CS/Post order</option>
          <option value="PSR">PSR</option>
          <option value="SiMo">SiMo</option>
          <option value="Aircall">Aircall</option>
          <option value="Venue">Venue</option>
          <option value="Trainee">Trainee</option>
          <option value="ST">ST</option>
        </select>
        <select id="realloc-filter" class="filter-dropdown">
          <option value="all">Reallocate: All</option>
          <option value="Yes">Yes</option>
          <option value="No">No</option>
        </select>
        <select id="lang-filter" class="filter-dropdown">
          <option value="all">Language: All</option>
          <option value="two">Bilingual</option>
          <option value="three">Trilingual</option>
        </select>
        <select id="break-filter" class="filter-dropdown">
          <option value="upcoming">Breaks: Upcoming</option>
          <option value="all">Breaks: All</option>
        </select>
        <input
          type="text"
          id="employee-search"
          placeholder="Search..."
          class="search-input"
        />
      </div>
      <!-- Правая часть: тема + refresh + имя + logout -->
      <div class="d-flex align-items-center flex-wrap header-gap">
        <!-- Переключатель темы -->
        <div class="d-flex align-items-center gap-2">
          <span>Theme:</span>
          <label class="theme-switch mb-0" style="margin-left: 8px;">
            <input type="checkbox" id="theme-checkbox" />
            <span class="slider"></span>
          </label>
        </div>
        <div class="refresh-section d-flex align-items-center gap-2">
          <span id="timer-label"
            >Refresh in: 
            
            <span id="countdown">15</span>s
          
          </span
          >
          <div
            style="width: 18px; height: 18px; display: flex; align-items: center; justify-content: center;"
          >
            <div
              id="refresh-spinner"
              class="spinner-border text-primary"
              role="status"
              style="display:none;"
            >
              <span class="sr-only">Loading...</span>
            </div>
          </div>
          <img
            src="https://www.svgrepo.com/show/168563/refresh.svg"
            alt="Refresh"
            title="Refresh now"
            style="width: 24px; height: 24px; cursor: pointer;"
            onclick="refreshNow()"
          />

        </div>
        <div class="d-flex align-items-center gap-2">
          <span id="user-display-name" class="small text-muted"></span>
          <img
            id="logout-btn"
            src="https://www.svgrepo.com/show/356468/logout.svg"
            alt="Log Out"
            title="Log Out"
            style="width: 22px; height: 22px; cursor: pointer; margin-left: 8px;"
          />
        </div>
      </div>
    </header>
    <div id="sidebar">
      <div class="close-btn" id="sidebar-close">&times;</div>
      <a href="https://mikhailgarayev.github.io/shldashboard/allocations.html">📈 Allocation stats</a>
      <a href="https://my.yigim.az/login" target="_blank">📊 YIGIM Dashboard</a>
      <a href="https://wolt-prod.datadoghq.eu/dashboard/zpt-745-5da/city-health-dashboard-template-24h-aze?fromUser=false&refresh_mode=sliding&tpl_var_area_name%5B0%5D=baku&view=spans&from_ts=1745505436253&to_ts=1745507236253&live=true" target="_blank">📈 Datadog Dashboard</a>
      <a href="https://wolt-prod.datadoghq.eu/dashboard/y66-xdi-4xy/payments---authorizations?fromUser=false&fullscreen_end_ts=1745567771563&fullscreen_paused=false&fullscreen_refresh_mode=sliding&fullscreen_section=overview&fullscreen_start_ts=1745566871563&fullscreen_widget=2003408243236226&refresh_mode=sliding&view=spans&from_ts=1745556684337&to_ts=1745560284337&live=true" target="_blank">📈 Datadog Payment Dashboard</a>
      <a href="https://ops.wolt.com/city-states?country=AZE" target="_blank">🏙️ City States</a>
      <a href="https://ops.wolt.com/city-tools" target="_blank">🛠️ City Tools</a>
      <a href="https://ops.wolt.com/support/converse/admin/users" target="_blank">🧭 Converse Admin Panel</a>
      <a href="https://wo.lt/tracker" target="_blank">⚙️ Away employees tracker</a>
      <a href="https://dashboard.aircall.io" target="_blank">📞 Aircall Dashboard</a>
      <a href="https://app.getguru.com/dashboard" target="_blank">📚 Guru</a>
      <a href="https://wo.lt/dashboard" target="_blank">📩 Video dashboard</a>
    </div>
    <div class="dashboard-container">
      <div class="info-cards d-flex flex-wrap gap-3 my-3 px-3">
      </div>
      <!-- Контент -->
      <div id="shift-summary" class="shift-summary-card">
  <div class="shift-summary-title">📊 Metrics per platform</div>
  <!-- flex-контейнер вместо таблицы -->
  <div id="summary-grid" class="d-flex flex-wrap gap-3 justify-content-center">
    <!-- сюда через JS будут вставлены все stats-card -->
  </div>
</div>

      <div id="platforms-container" class="platforms-row"></div>
    <!-- Секция с двумя карточками: Shift-Overs и Breaks -->
    <div
  id="alerts-section"
  class="d-flex flex-wrap gap-4 justify-content-center my-4 px-3"
  style="align-items: stretch;"
>
  <!-- Upcoming Shift-Overs -->
  <div id="shift-overs-section" class="alert-card">
    <h2 class="h5 mb-3">⏳ Upcoming Shift-Overs</h2>
    <div id="shift-overs-app" class="alert-content">
      Loading…
    </div>
  </div>

  <!-- Upcoming Breaks -->
  <div id="breaks-section" class="alert-card">
    <h2 class="h5 mb-3">⏰ Breaks</h2>
    <div id="breaks-app" class="alert-content">
      Loading…
    </div>
  </div>
</div>

    </div>
    <!-- Модальное окно сотрудника -->
    <div id="modal-overlay"></div>
    <div
      id="employee-modal">
      <div style="display: flex; align-items: center; justify-content: space-between; padding: 20px 20px 0 20px;">
        <div style="display: flex; align-items: center;">
          <img 
          id="modal-emp-avatar" 
          src="https://i.ibb.co/YrbxqCn/favicon.jpg" 
          alt="Avatar" 
          style="width: 60px; height: 60px; border-radius: 50%; margin-right: 15px;"
        />
          <div>
            <h5 id="modal-emp-name" style="margin: 0; font-weight: 600;">Employee Name</h5>
            <small id="modal-emp-email" style="color: #888;">employee.email@wolt.com</small>
          </div>
        </div>
        <span class="close-btn" id="modal-close" style="cursor: pointer; font-size: 24px; color: #999;">&times;</span>
      </div>
      <!-- Информация -->
      <div style="padding: 15px 20px 0 20px; text-align: left;">
        <div style="margin-bottom: 10px;">
          <strong>Role:</strong>
          <span id="modal-emp-role">Support Associate</span>
        </div>
        <div style="margin-bottom: 10px;">
          <strong>Prime platform:</strong>
          <span id="modal-emp-prime">CS</span>
        </div>
        <div style="margin-bottom: 10px;">
          <strong>Preferred platform:</strong>
          <span id="modal-emp-pref">PSR</span>
        </div>
        <div style="margin-bottom: 10px;">
          <strong>Can reallocate?:</strong>
          <span id="modal-emp-realloc">Yes</span>
        </div>
        <div style="margin-bottom: 10px;">
          <strong>Language:</strong>
          <span id="modal-emp-languages">AZ RUGB</span>
        </div>
        <div style="margin-bottom: 10px;">
          <strong>Capacity:</strong>
          <span id="modal-emp-capacity">—</span>
        </div>
        <div style="margin-bottom: 10px;">
          <strong>Shift:</strong>
          <span id="modal-emp-shift">—</span>
        </div>
        <div style="margin-bottom: 10px;">
          <strong>Break:</strong>
          <span id="modal-emp-break">—</span>
        </div>
        <div style="margin-bottom: 10px;">
          <strong>Platform changes today:</strong>
          <span id="modal-platform-count">–</span>
        </div>
        <ul id="modal-platform-list" style="margin-left: 20px; font-size:0.9rem;"></ul>

      </div>
      <!-- Кнопки -->
      <div style="padding: 20px; text-align: right;">
        <button id="modal-inbox-link" class="btn btn-primary" style="margin-right: 10px;">Open Inbox</button>
        <button id="modal-admin-link" class="btn btn-outline-primary">Admin Panel</button>
      </div>
      <!-- Подключаем jQuery, Bootstrap JS и Bootstrap-Select JS -->
      <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.18/js/bootstrap-select.min.js"></script>
      <script>
        // ===============================
        // WEATHER SECTION WITH CACHING & EMOJI
        const OPENWEATHER_API_KEY = "f97220cfb6bcefa391405990e7b9825d";
        const CITY_NAME = "Baku,AZ";
        async function fetchWeather() {
          const cacheKey = "bakuWeatherData";
          const cacheTimeKey = "bakuWeatherTimestamp";
          const now = Date.now();
          const cacheTTL = 15 * 60 * 1000; // 15 минут

          const cachedData = localStorage.getItem(cacheKey);
          const cachedTimestamp = localStorage.getItem(cacheTimeKey);

          if (cachedData && cachedTimestamp && now - cachedTimestamp < cacheTTL) {
            const data = JSON.parse(cachedData);
            updateWeatherUI(data);
            return;
          }

          const url = `https://api.openweathermap.org/data/2.5/weather?q=${CITY_NAME}&units=metric&appid=${OPENWEATHER_API_KEY}`;
          try {
            const res = await fetch(url);
            if (!res.ok) {
              console.error("Ошибка получения погоды: " + res.statusText);
              return;
            }
            const data = await res.json();
            localStorage.setItem(cacheKey, JSON.stringify(data));
            localStorage.setItem(cacheTimeKey, now);
            updateWeatherUI(data);
          } catch (err) {
            console.error("Ошибка при запросе погоды: " + err);
          }
        }
        function updateWeatherUI(data) {
          const temperature = data.main?.temp ?? null;
          const windSpeed = data.wind?.speed;
          // Определяем погодный смайлик
          let weatherEmoji = "";
          if (data.weather && data.weather.length > 0) {
            const condition = data.weather[0].main;
            switch (condition) {
              case "Clear":
                weatherEmoji = "☀️";
                break;
              case "Clouds":
                weatherEmoji = "☁️";
                break;
              case "Rain":
              case "Drizzle":
                weatherEmoji = "🌧️";
                break;
              case "Thunderstorm":
                weatherEmoji = "⛈️";
                break;
              case "Snow":
                weatherEmoji = "❄️";
                break;
              default:
                weatherEmoji = "";
                break;
            }
          }

          document.getElementById("baku-temp").textContent =
            temperature ? `${Math.round(temperature)} °C ${weatherEmoji}` : "-- °C";
            // показываем 0 m/s если скорость равна нулю, и только при undefined/null рисуем "--"
            const windEl = document.getElementById("baku-wind");
            // получаем из data.wind.speed, если есть, иначе undefined
            const rawSpeed = data.wind?.speed;
            // если число или 0
            const hasSpeed = typeof rawSpeed === 'number';
            // округляем до одной цифры, если число, иначе оставляем плейсхолдер
            const displaySpeed = hasSpeed
              ? Math.round(rawSpeed * 10) / 10
              : '--';

            windEl.textContent = `${displaySpeed} m/s`;
          }
        
        // ===============================

        // Информация по платформам
        const platformInfo = {
          "CS":
            "Click on the link to open the CS platform.\nClick on employee name to open their profile.",
          "CS/Post order":
            "Click on the link to open the CS PO AZE platform.\nClick on employee name to open their profile.",
          PSR: "Click on the link to open the PSR platform.\nClick on employee name to open their profile.",
          SiMo: "Click on the link to open the Support Inbox.\nClick on employee name to open their profile.",
          Aircall:
            "Click on the link to open the CS platform.\nClick on employee name to open their profile.\n You can see employee's status in the Aircall.",
          Venue:
            "Click on the link to open the Venue platform.\nClick on employee name to open their profile.",
          Trainee: "Click on employee name to open their profile.",
          ST: "Click on employee name to open their profile."
        };

        let fetchedData = null;
        let currentSearchTerm = "";
        let currentStatusFilter = "both";
        let currentPlatformFilter = ["all"];
        let currentReallocFilter = "all";
        let currentLangFilter = "all";
        let currentBreakFilter = "upcoming";

        const SPREADSHEET_ID = "1dICKOxxz9R3x8MY3FKQ9I-IwR9fBUDfMOT9PFDLloAE";
        const SHIFT_RANGE = "list1!AT5:BH47";
        const RANGE = "list1!A1:BJ100";
        const RESPONSIBLES_RANGE = "list1!B5:C27";
        const BREAKS_RANGE = "prebreaks!A1:D40";
        const SHIFT_QUINYX_RANGE = "shiftsquinyx!B3:C"; 

        let employeeData = {};

        const platforms = [
          {
            name: "CS",
            url: "https://ops.wolt.com/support/converse/conversations?conversationListId=6643245bfadf62c6edc28feb",
            colIndexNames: 3,
            colIndexData: 4,
            rowActiveNamesStart: 4,
            rowActiveNamesEnd: 27,
            rowAwayNamesStart: 28,
            rowAwayNamesEnd: 47
          },
          {
            name: "CS/Post order",
            url: "https://ops.wolt.com/support/converse/conversations?conversationListId=664324a0510ac011feaa798c",
            colIndexNames: 5,
            colIndexData: 6,
            rowActiveNamesStart: 4,
            rowActiveNamesEnd: 27,
            rowAwayNamesStart: 28,
            rowAwayNamesEnd: 47
          },
          {
            name: "PSR",
            url: "https://ops.wolt.com/support/converse/conversations?conversationListId=6567a44af7d470550b11dc68",
            colIndexNames: 7,
            colIndexData: 8,
            rowActiveNamesStart: 4,
            rowActiveNamesEnd: 27,
            rowAwayNamesStart: 28,
            rowAwayNamesEnd: 47
          },
          {
            name: "SiMo",
            url: "https://ops.wolt.com/support/converse/conversations?conversationListId=6668088fc6d870f3cfd61653",
            colIndexNames: 9,
            colIndexData: 10,
            rowActiveNamesStart: 4,
            rowActiveNamesEnd: 27,
            rowAwayNamesStart: 28,
            rowAwayNamesEnd: 47
          },
          {
            name: "Aircall",
            url: "https://ops.wolt.com/support/converse/conversations?conversationListId=671a26a2a5b9ae4a2ca603fb",
            colIndexNames: 11,
            colIndexData: 12,
            rowActiveNamesStart: 4,
            rowActiveNamesEnd: 27,
            rowAwayNamesStart: 28,
            rowAwayNamesEnd: 47
          },
          {
            name: "Venue",
            url: "https://ops.wolt.com/support/converse/conversations?conversationListId=666807fc28b3f1231948f407",
            colIndexNames: 13,
            colIndexData: 14,
            rowActiveNamesStart: 4,
            rowActiveNamesEnd: 27,
            rowAwayNamesStart: 28,
            rowAwayNamesEnd: 47
          },
          {
            name: "Trainee",
            url: "https://wolt.com/",
            colIndexNames: 15,
            colIndexData: 16,
            rowActiveNamesStart: 4,
            rowActiveNamesEnd: 27,
            rowAwayNamesStart: 28,
            rowAwayNamesEnd: 47
          },
          {
            name: "ST",
            url: "https://wolt.com/",
            colIndexNames: 17,
            colIndexData: 18,
            rowActiveNamesStart: 4,
            rowActiveNamesEnd: 27,
            rowAwayNamesStart: 28,
            rowAwayNamesEnd: 47
          }
        ];

        let aircallActive = [];
        let aircallAway = [];

        function logDebug(message) {
          console.log(message);
        }

        async function fetchSheetData(range) {
          try {
            const res = await fetch("https://sheets-proxy.mikhail-garayev.workers.dev", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                secret: "superWoltKey42",
                range: range
              })
            });
            const data = await res.json();
            return data.values;
          } catch (e) {
            console.error("Sheets proxy error:", e);
            return null;
          }
        }

        async function fetchEmployeeList() {
          const data = await fetchSheetData("emplist!A1:G");
          if (!data || data.length < 2) return;
          for (let i = 1; i < data.length; i++) {
            const row = data[i];
            if (!row[0]) continue;
            const empName = row[0].trim();
            const empId = row[1]?.trim() || "";
            const canRealloc = row[2]?.trim() || "";
            const primePlatform = row[3]?.trim() || "";
            const preferredPlatform = row[4]?.trim() || "";
            const languages = row[5]?.trim() || "";
            employeeData[empName] = {
              id: empId,
              canReallocate: canRealloc,
              prime: primePlatform,
              pref: preferredPlatform,
              languages: languages,
              capacity: row[6]?.trim() || "N/A"
            };
          }
        }

        function generateInboxLink(empId) {
          return (
            "https://ops.wolt.com/support/converse/users/conversations?assigneeIds=" +
            encodeURIComponent(empId)
          );
        }

        function generateAdminLink(empId) {
          return (
            "https://ops.wolt.com/support/converse/admin/users?userId=" +
            encodeURIComponent(empId)
          );
        }

        async function openEmployeeModal(empName) {
          const info = employeeData[empName];
          if (!info) {
            logDebug("Данные о сотруднике не найдены: " + empName);
            return;
          }

          // Получаем смену
          let shift = "—";
          if (window.allShiftData && Array.isArray(window.allShiftData)) {
            for (const row of window.allShiftData) {
              for (const cell of row) {
                if (typeof cell === "string" && cell.toLowerCase().includes(empName.toLowerCase())) {
                  const dashIndex = cell.lastIndexOf(" - ");
                  shift = dashIndex !== -1
                    ? cell.substring(0, dashIndex).trim()
                    : cell.trim();
                  break;
                }
              }
              if (shift !== "—") break;
            }
          }
          document.getElementById("modal-emp-shift").textContent = shift;

          // Break time
          let breakTime = "—";
          if (window.allBreaksData && Array.isArray(window.allBreaksData)) {
            const foundBreak = allBreaksData
              .find(b => b["Name"]?.trim().toLowerCase() === empName.trim().toLowerCase());
            if (foundBreak) {
              breakTime = foundBreak["Break Time"] || "—";
            }
          }
          document.getElementById("modal-emp-break").textContent = breakTime;

          // Основная информация
          const parts = empName.trim().split(" ");
          const email = parts.length >= 2
            ? `${parts[0].toLowerCase()}.${parts[1].toLowerCase()}@wolt.com`
            : `${parts[0].toLowerCase()}@wolt.com`;
          document.getElementById("modal-emp-name").textContent = empName;
          document.getElementById("modal-emp-email").textContent = email;
          document.getElementById("modal-emp-realloc").textContent = info.canReallocate || "N/A";
          document.getElementById("modal-emp-prime").textContent   = info.prime         || "N/A";
          document.getElementById("modal-emp-pref").textContent    = info.pref          || "N/A";
          document.getElementById("modal-emp-languages").textContent = info.languages    || "N/A";
          document.getElementById("modal-emp-capacity").textContent  = info.capacity     || "N/A";

          document.getElementById("modal-inbox-link").onclick = () => {
            window.open(generateInboxLink(info.id), "_blank");
          };
          document.getElementById("modal-admin-link").onclick = () => {
            window.open(generateAdminLink(info.id), "_blank");
          };

          // Новая часть: подсчёт и список смен платформ
          // transfersData — глобальный массив, полученный fetchTransfers()
          const myTransfers = transfersData.filter(t =>
            t.name.toLowerCase() === empName.toLowerCase()
          );

          // Количество смен
          document.getElementById("modal-platform-count").textContent = myTransfers.length;

          // Список смен (время HH:MM:SS → Новая платформа)
          const listEl = document.getElementById("modal-platform-list");
          if (myTransfers.length > 0) {
            listEl.innerHTML = myTransfers
              .map(t => {
                const timeOnly = t.time.split(" ")[1] || t.time;
                return `<li>${timeOnly} → ${t.newPlatform}</li>`;
              })
              .join("");
          } else {
            listEl.innerHTML = "<li>No changes</li>";
          }

          // Открываем модалку
          document.getElementById("modal-overlay").classList.add("show");
          document.getElementById("employee-modal").classList.add("show");
        }

        function closeEmployeeModal() {
          document.getElementById("employee-modal").classList.remove("show");
          document.getElementById("modal-overlay").classList.remove("show");
        }


        async function getAircallUserId(email) {
          try {
            const res = await fetch("https://aircall-proxy.mikhail-garayev.workers.dev", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                secret: "superWoltKey42",
                email: email
              })
            });
        
            if (!res.ok) {
              logDebug(`Ошибка при проксированном запросе Aircall: ${res.statusText}`);
              return null;
            }
        
            const data = await res.json();
        
            if (!data?.user?.id) {
              logDebug("Aircall API вернул пустой результат");
              return null;
            }
        
            logDebug(`Получен Aircall ID: ${data.user.id}`);
            return data.user.id;
        
          } catch (err) {
            logDebug("Ошибка getAircallUserId через Worker: " + err.message);
            return null;
          }
        }


        async function getAircallAvailability(userId) {
          if (!userId) {
            logDebug("getAircallAvailability: userId не передан");
            return "No ID";
          }
        
          try {
            const res = await fetch("https://aircall-proxy.mikhail-garayev.workers.dev", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                secret: "superWoltKey42",
                userId: userId,
                action: "availability"
              })
            });
        
            if (!res.ok) {
              logDebug("Ошибка при получении статуса через Worker: " + res.statusText);
              return "Error";
            }
        
            const data = await res.json();
        
            const status =
              data?.user_availability?.availability_status || data?.availability;
        
            logDebug(`Статус через Worker: ${status}`);
            return status || "Unknown";
        
          } catch (err) {
            logDebug("Исключение в getAircallAvailability через Worker: " + err.message);
            return "Error";
          }
        }

        function passReallocAndLang(empName) {
          const info = employeeData[empName];
          if (!info) return false;
          if (currentReallocFilter !== "all") {
            if (info.canReallocate !== currentReallocFilter) return false;
          }
          if (currentLangFilter !== "all") {
            let lang = info.languages.replace(/\s+/g, "");
            if (currentLangFilter === "two") {
              if (!(lang.includes("🇦🇿") && lang.includes("🇬🇧")) || lang.includes("🇷🇺")) {
                return false;
              }
            } else if (currentLangFilter === "three") {
              if (!(lang.includes("🇦🇿") && lang.includes("🇬🇧") && lang.includes("🇷🇺"))) {
                return false;
              }
            }
          }
          return true;
        }

        function applyFilters() {
          const container = document.getElementById("platforms-container");
          container.innerHTML = "";

          platforms.forEach((platform) => {
            if (
              !currentPlatformFilter.includes("all") &&
              !currentPlatformFilter.includes(platform.name)
            ) {
              return;
            }

            if (platform.name !== "Aircall") {
              let activeNames = [];
              for (
                let r = platform.rowActiveNamesStart;
                r <= platform.rowActiveNamesEnd;
                r++
              ) {
                const nm = fetchedData[r]?.[platform.colIndexNames]?.trim();
                if (nm) activeNames.push(nm);
              }
              let awayData = [];
              for (
                let r = platform.rowAwayNamesStart;
                r <= platform.rowAwayNamesEnd;
                r++
              ) {
                const nm = fetchedData[r]?.[platform.colIndexNames]?.trim();
                if (!nm) continue;
                const rsn = fetchedData[r]?.[platform.colIndexData]?.trim() || "";
                awayData.push({ name: nm, reason: rsn });
              }
              if (currentSearchTerm) {
                activeNames = activeNames.filter((n) =>
                  n.toLowerCase().includes(currentSearchTerm.toLowerCase())
                );
                awayData = awayData.filter((item) =>
                  item.name.toLowerCase().includes(currentSearchTerm.toLowerCase())
                );
              }
              activeNames = activeNames.filter((n) => passReallocAndLang(n));
              awayData = awayData.filter((item) => passReallocAndLang(item.name));

              let showActive = true,
                showAway = true;
              if (currentStatusFilter === "active") showAway = false;
              else if (currentStatusFilter === "away") showActive = false;

              let html = `
        
        <div class="platform-card">
          <h5>
            <a href="${platform.url}" target="_blank" rel="noopener" title="Click to navigate to ${platform.name}" style="vertical-align: middle;">
                            ${platform.name}
                          </a>
            <span class="info-icon" data-toggle="tooltip" title="${
                            platformInfo[platform.name] || ""
                          }" style="display: inline-block; vertical-align: middle; margin-left: 6px;">
              <img src="https://www.svgrepo.com/show/474873/info.svg" alt="Info" style="width:16px; height:16px; cursor:pointer; vertical-align:middle;" />
            </span>
          </h5>`;
              if (showActive) {
                if (activeNames.length === 0) {
                  html += `
          
          <p>
            <small style="color: red; font-weight: bold;">Active (0)</small>
            <span data-toggle="tooltip" title="Нет активных сотрудников" style="color: red; margin-left: 5px; cursor: pointer; font-size: 1.5rem;">&#9888;</span>
          </p>`;
                } else {
                  html += `
          
          <p>
            <small>Active (${activeNames.length})</small>
          </p>
          <ul>`;
            // Предположим, что у вас где-то объявлено ваше имя, например:
          const myName = "Mikhail Garayev";
          
          // Предположим, что у вас уже определена переменная myName (если используется), либо просто используйте проверку для Naziya

activeNames.forEach((n) => {
  // Приводим имя к нижнему регистру для сравнения
  const trimmedName = n.trim();
  const lowerName = trimmedName.toLowerCase();

  // Если ваше имя есть (если нужно оставить эту проверку), например:
  const myName = "Mikhail Garayev";  // Объявите эту переменную, если ещё не объявлена.
  const isYou = lowerName === myName.toLowerCase();

  // Проверяем, что это Naziya Orujova
  const isNaziya = lowerName === "naziya orujova";

  // Базовый класс
  let className = "employee-item";
  if (isYou) {
    className += " king";
  }
  if (isNaziya) {
    className += " pink-name";
  }

  // Добавляем эмодзи, если это Naziya
  const extraEmoji = isNaziya ? " 🎀" : "";
  const crown = isYou ? "👑" : "";

  // Формируем HTML для элемента:
  html += `
    <li class="${className}" data-employee="${trimmedName}">
      <span class="employee-name">${trimmedName}${extraEmoji}</span> ${crown}
    </li>`;
});

                  html += `
          
          </ul>`;
                }
              }
              if (showAway) {
                let brbCount = 0;
                html += `
          
          <p>
            <small>Away (${awayData.length})</small>
          </p>
          <ul>`;
                  awayData.forEach((item) => {
                    let reasonText = item.reason || "";
                    let reasonClass = "";
                  
                    if (/(Break|BRB)/.test(reasonText)) {
                      const match = reasonText.match(/-([0-9]+:[0-9]{2}(?::[0-9]{2})?)/);
                      if (match) {
                        reasonClass = "break-overdue"; // анимация
                      }
                    }
                  
                    if (reasonText.includes("BRB")) {
                      brbCount++;
                    }
                  
                    // Меняем тут:
                    html += `<li class="employee-item ${reasonClass}" data-employee="${item.name}">`;
                  
                    // Вместо ${item.name} -> <span class="employee-name">${item.name}</span>
                    html += `<span class="employee-name">${item.name}</span>`;
                  
                    // reasonText при желании оставляем как есть
                    if (reasonText) {
                      html += ` (${reasonText})`;
                    }
                  
                    html += `</li>`;
                  });


                html += `
          
          </ul>`;
                if (brbCount >= 2) {
                  html += `
                  <p style="text-align:center; font-size: 1.5rem; margin-top: 8px; color: red;" title="2 or more on BRB">
                    &#9888;
                  </p>`;
                }

              }
              html += `
        
        </div>`;
              container.innerHTML += html;
            } else {
              // Для Aircall используем отдельную функцию
              let filteredActive = aircallActive.slice().filter(
                (n) => n.toLowerCase() !== "away"
              );
              let filteredAway = aircallAway.slice().filter(
                (item) => item.name.toLowerCase() !== "away"
              );
              if (currentSearchTerm) {
                filteredActive = filteredActive.filter((n) =>
                  n.toLowerCase().includes(currentSearchTerm.toLowerCase())
                );
                filteredAway = filteredAway.filter((item) =>
                  item.name.toLowerCase().includes(currentSearchTerm.toLowerCase())
                );
              }
              filteredActive = filteredActive.filter((n) => passReallocAndLang(n));
              filteredAway = filteredAway.filter((item) =>
                passReallocAndLang(item.name)
              );

              let showActive = true,
                showAway = true;
              if (currentStatusFilter === "active") showAway = false;
              else if (currentStatusFilter === "away") showActive = false;
              renderAircallCardWithStatuses(filteredActive, filteredAway, showActive, showAway);
            }
          });

          const employeeItems = document.querySelectorAll(".employee-item");
          employeeItems.forEach((item) => {
            item.addEventListener("click", function () {
              const empName = this.getAttribute("data-employee");
              openEmployeeModal(empName);
            });
          });

          $('[data-toggle="tooltip"]').tooltip();
        }

        function renderAircallCardWithStatuses(
          activeList,
          awayList,
          showActive = true,
          showAway = true
        ) {
          const aircallPlatform = platforms.find((p) => p.name === "Aircall");
          let html = `
        
        <div class="platform-card">
          <h5>
            <a href="${aircallPlatform.url}" target="_blank" rel="noopener" title="Click to navigate to Snooze inbox" style="vertical-align: middle;">
                        Aircall
                      </a>
            <span class="info-icon" data-toggle="tooltip" title="${
                        platformInfo["Aircall"] || ""
                      }" style="display: inline-block; vertical-align: middle; margin-left: 6px;">
              <img src="https://www.svgrepo.com/show/474873/info.svg" alt="Info" style="width:16px; height:16px; cursor:pointer; vertical-align:middle;" />
            </span>
          </h5>`;
          if (showActive) {
            if (activeList.length === 0) {
              html += `
          
          <p>
            <small style="color: red; font-weight: bold;">Active (0)</small>
            <span data-toggle="tooltip" title="No active employees" style="color: red; margin-left: 5px; cursor: pointer; font-size: 1.5rem;">&#9888;</span>
          </p>`;
            } else {
              html += `
          
          <p>
            <small>Active (${activeList.length})</small>
          </p>
          <ul id="aircall-active-list">` +
                activeList
                  .map((n, index) => {
                    const safeId = `aircall-active-${index}`;
                    return `
            
            <li id="${safeId}" class="employee-item" data-employee="${n}">${n} - 
              
              <span style="color: green;">Checking status...</span>
            </li>`;
                  })
                  .join("") +
                `
          
          </ul>`;
            }
          }
          if (showAway) {
            html += `
          
          <p>
            <small>Away (${awayList.length})</small>
          </p>
          <ul>` +
              awayList
                .map((a) => {
                  const extra = a.reason ? " - " + a.reason : "";
                  return `
            
            <li class="employee-item" data-employee="${a.name}">${a.name}${extra}</li>`;
                })
                .join("") +
              `
          
          </ul>`;
          }
          html += `
        
        </div>`;
          document.getElementById("platforms-container").innerHTML += html;
        }

        function renderShiftSummary(data) {
  // контейнер, где рендерятся все stats-card
  const container = document.getElementById("summary-grid");
  container.innerHTML = "";

  // ваши карточки: title — заголовок, value — строка из ячейки (например "2, Alice, Bob"), away — опционально
  const summaryCards = [
    { title: "On shift now",  value: data[6][27] || "" },
    { title: "Should be",     value: data[6][29] || "" },
    { title: "CS",            value: data[6][31] || "", away: data[8][31] || "" },
    { title: "CS/Post Order", value: data[6][33] || "", away: data[8][33] || "" },
    { title: "PSR",           value: data[6][35] || "", away: data[8][35] || "" },
    { title: "Venue",         value: data[6][37] || "", away: data[8][37] || "" },
    { title: "Aircall",       value: data[6][39] || "", away: data[8][39] || "" },
    { title: "Simo",          value: data[6][41] || "", away: data[8][41] || "" },
    { title: "ST",            value: data[6][43] || "", away: data[8][43] || "" },
    // Special: Not here и WNATS тоже делают из столбца 29 и 27, плюс детали из колонки 10
    { 
      title: "Not here", 
      value: (data[8][29] || "") + (data[10][29] ? "," + data[10][29] : ""), 
      customClass: "small-font-card" 
    },
    { 
      title: "WNATS", 
      value: (data[8][27] || "") + (data[10][27] ? "," + data[10][27] : ""), 
      customClass: "small-font-card" 
    }
  ];

  summaryCards.forEach(card => {
    // если нет даже count — пропускаем
    if (!card.value) return;

    // создаём div.stats-card
    const div = document.createElement("div");
    div.className = `stats-card ${card.customClass || ""}`;

    // разбираем для специальных тултипов
    if (card.title === "Not here" || card.title === "WNATS") {
      // value = "count, detail1, detail2, …"
      const parts = card.value.split(",").map(s => s.trim()).filter(s => s !== "");
      const count = parts.shift();        // первое — число
      const details = parts;              // остаток — массив тултипов
      // если Not here и count ≠ 0, добавляем красный фон
      if (card.title === "Not here" && count !== "0") {
        div.classList.add("red-card");
      }
      // формируем HTML
      div.innerHTML = `
        <div class="stats-title">${card.title}</div>
        <div class="stats-value d-inline-flex align-items-center gap-1">
          ${count}
          <img
            src="https://www.svgrepo.com/show/474873/info.svg"
            data-toggle="tooltip"
            data-html="true"
            title="${details.join("<br/>")}"
            class="info-icon"
            style="width:16px; height:16px; cursor:pointer;"
          />
        </div>
      `;
    } else {
      // обычная карточка: title, value, away
      let html = `
        <div class="stats-title">${card.title}</div>
        <div class="stats-value">${card.value}</div>
      `;
      if (card.away) {
        html += `<div class="stats-value" style="font-size:0.9rem; color:#666;">Away: ${card.away}</div>`;
      }
      div.innerHTML = html;
    }

    container.appendChild(div);
  });

  // вставляем погоду как последнюю карточку
  // новый код — в конце renderShiftSummary
  const weatherCard = document.createElement("div");
  weatherCard.className = "stats-card";
  weatherCard.id = "weather-card";
  weatherCard.innerHTML = `
    <div class="stats-title">Baku Weather</div>
    <div class="stats-value" id="baku-temp">-- °C</div>

    <div class="stats-title" style="margin-top:.5rem;">Wind Speed</div>
    <div class="stats-value small" id="baku-wind">-- m/s</div>
  `;
  container.appendChild(weatherCard);


  // реинициализируем Bootstrap-Tooltip для всех [data-toggle="tooltip"]
  $('[data-toggle="tooltip"]').tooltip();

  // и подгружаем погоду
  fetchWeather();
}

        function renderResponsiblePeople(data) {
  if (!data || data.length === 0) return;

  // Удаляем старую, если уже существует
  const existing = document.getElementById("responsible-card");
  if (existing) existing.remove();

  let html = `
    
        
        <div class="shift-summary-card" id="responsible-card">
          <div class="shift-summary-title">👥 Responsible People</div>
          <table class="shift-summary-grid" style="max-width: 500px; margin: 0 auto;">
            <thead>
              <tr>
                <th>Name</th>
                <th>Position</th>
              </tr>
            </thead>
            <tbody>`;

  data.forEach(row => {
  const name = row[0]?.trim() || "";
  const role = row[1]?.trim() || "";

  // Приводим имя к нижнему регистру для сравнения
  const lowerName = name.toLowerCase();
  const isNaziya = (lowerName === "naziya orujova");
  const extraEmoji = isNaziya ? " 🎀" : "";
  const nameClass = isNaziya ? "pink-name" : "";

  if (name && role) {
    html += `
      <tr>
        <td>
          <span class="${nameClass}" style="font-weight: bold;">${name}${extraEmoji}</span>
        </td>
        <td>
          <span style="background:#e7f1ff; color:#0056b3; padding: 2px 6px; border-radius: 6px; font-size: 0.85rem;">${role}</span>
        </td>
      </tr>`;
  }
});

html += `
      </tbody>
    </table>
  </div>`;


  const container = document.getElementById("shift-summary");
  container.insertAdjacentHTML("afterend", html);
}

function renderShiftOvers() {
  const container = document.getElementById("shift-overs-app");
  container.innerHTML = ""; 
  if (!window.shiftsQuinyxData) {
    container.textContent = "No data";
    return;
  }

  const now = new Date();
  const oneHourLater = new Date(now.getTime() + 60*60*1000);

  // фильтрация сотрудников
  const upcoming = window.shiftsQuinyxData.filter(({name, shift}) => {
    const parts = shift.split("-");
    if (parts.length < 2) return false;
    const [ hh, mm ] = parts[1].split(":").map(Number);
    const endDate = new Date(now);
    endDate.setHours(hh, mm, 0, 0);
    return endDate > now && endDate <= oneHourLater;
  });

  if (upcoming.length === 0) {
    container.innerHTML = "<p style='text-align:center;color:#666;'>No shift-overs in the next hour</p>";
    return;
  }

  // список
  const ul = document.createElement("ul");
  upcoming.forEach(({name, shift}) => {
    const li = document.createElement("li");
    li.innerHTML = `<strong>${name}</strong> — ${shift}`;
    ul.appendChild(li);
  });
  container.appendChild(ul);
}

                // 1) Shift-Overs из листа shiftsquinyx!A:C
        async function fetchShiftOversData() {
  const raw = await fetchSheetData("shiftsquinyx!A:C"); // теперь A-C, а не B-C
  if (!raw) {
    document.getElementById("shift-overs-app").textContent = "Error";
    return;
  }

  // Преобразуем массив строк в объекты с полями Name, ShiftName и Shift
  const arr = raw.slice(1).map(row => ({
    ShiftName: row[0]?.trim(),   // A = название смены
    Name: row[1]?.trim(),        // B = имя сотрудника
    Shift: row[2]?.trim(),       // C = время смены
  }));

  const now = new Date();
  const next = new Date(now.getTime() + 60 * 60 * 1000);

  // Фильтрация: отбираем тех, у кого shift заканчивается в течение часа
  const upcoming = arr.filter(r => {
    if (!r.Shift) return false;
    const parts = r.Shift.split("-");
    if (parts.length !== 2) return false;

    const [h, m] = parts[1].split(":").map(Number);
    if (isNaN(h)) return false;

    const end = new Date(now);
    end.setHours(h, m, 0, 0);
    return end > now && end <= next;
  });

  const c = document.getElementById("shift-overs-app");

  if (!upcoming.length) {
    c.innerHTML = "<p>No shift-overs in the next hour</p>";
    return;
  }

  // Подсветка при совпадении shiftName + время
  const counts = {};
  upcoming.forEach(r => {
    const key = `${r.ShiftName}–${r.Shift}`;
    counts[key] = (counts[key] || 0) + 1;
  });

  c.innerHTML = "<ul>" + upcoming.map(r => {
    const [start, end] = r.Shift.split("-").map(s => s.trim());
    const key = `${r.ShiftName}–${r.Shift}`;
    const conflictClass = counts[key] > 1 ? "break-conflict" : "";

    return `
      <li class="${conflictClass}">
        <strong>${r.Name}</strong><br/>
        Ends at ${end}<br/>
        Shift: ${start} | ${r.ShiftName}
      </li>`;
  }).join("") + "</ul>";
}



        
async function fetchBreaksData() {
  const raw = await fetchSheetData(BREAKS_RANGE);
  if (!raw) {
    document.getElementById("breaks-app").textContent = "Error";
    return;
  }

  const arr = arrayToObjects(raw);
  const now = new Date();
  const nextHour = new Date(now.getTime() + 3600 * 1000);

  // Фильтрация по режиму
  let list;
  if (currentBreakFilter === "upcoming") {
    list = arr.filter(r => {
      const [h, m] = (r["Break Time"] || "").split(":").map(Number);
      if (isNaN(h)) return false;
      const dt = new Date(now);
      dt.setHours(h, m, 0, 0);
      return dt > now && dt <= nextHour;
    });
  } else {
    list = arr.slice().sort((a, b) => {
      const pa = parseTimeToMinutes(a["Break Time"]),
            pb = parseTimeToMinutes(b["Break Time"]);
      return pa - pb;
    });
  }

  const c = document.getElementById("breaks-app");

  // Подсчёт совпадений
  const counts = {};
  list.forEach(r => {
    const key = `${r["Working Space"]}–${r["Break Time"]}`;
    counts[key] = (counts[key] || 0) + 1;
  });

  if (!list.length) {
    c.innerHTML = "<p>No breaks</p>";
    return;
  }

  // Генерация HTML
  c.innerHTML = "<ul>" + list.map(r => {
    const key = `${r["Working Space"]}–${r["Break Time"]}`;
    const conflictClass = counts[key] > 1 ? "break-conflict" : "";
    return `
      <li class="${conflictClass}">
        <strong>${r.Name}</strong><br/>
        Break at <span class="break-time" data-name="${r.Name}" data-time="${r["Break Time"]}">${r["Break Time"]}</span>
        <button class="edit-btn" title="Edit time" style="border:none;background:none;cursor:pointer;">
        <img src="https://www.svgrepo.com/show/502640/edit-1.svg" alt="edit" width="16" height="16">
        </button><br/>
        Shift: ${r["Shift Start Time"]} | ${r["Working Space"]}
      </li>
    `;
  }).join("") + "</ul>";

  document.querySelectorAll(".edit-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const name = btn.dataset.name;
    const timeSpan = btn.previousElementSibling;
    const oldTime = timeSpan.dataset.time;

    const newTime = prompt(`Enter new break time for ${name}:`, oldTime);
    if (!newTime || newTime === oldTime) return;

    fetch("https://breaks-proxy.mikhail-garayev.workers.dev/", {
  method: "POST",
  headers: {
    "Content-Type": "application/json"
  },
  body: JSON.stringify({
    name,
    newBreakTime: newTime,
    secret: "superWoltKey42" // тот же, что в Worker и Google Script
  })
})

    .then(res => res.text())
    .then(response => {
      if (response === "Success") {
        timeSpan.textContent = newTime;
        timeSpan.dataset.time = newTime;
        alert("Break time updated successfully!");
      } else {
        alert("Server response:\n" + response);
      }
    })
    .catch(err => {
      alert("Request failed:\n" + err.message);
    });
  }); // ← закрываем addEventListener
});   // ← закрываем forEach
}

        // кладём в глобальную window.shiftsQuinyxData
        async function fetchShiftsQuinyxData() {
          const raw = await fetchSheetData(SHIFT_QUINYX_RANGE);
          if (!raw || raw.length < 2) {
            window.shiftsQuinyxData = [];
            return;
          }
          // raw[0] — заголовки, raw[1..] — строки [name, "HH:mm-HH:mm"]
          window.shiftsQuinyxData = raw.slice(1)
            .filter(r => r[0] && r[1])
            .map(r => ({
              name: r[0].trim(),
              shift: r[1].trim()
            }));
        }


        function parseTimeToMinutes(timeStr) {
          timeStr = timeStr.trim();
          let parts = timeStr.split(":");
          if (parts.length < 2) return 0;
          let hours = parseInt(parts[0], 10);
          let minutes = parseInt(parts[1], 10);
          return hours * 60 + minutes;
        }

        function arrayToObjects(arr) {
          if (!arr.length) return [];
          const header = arr[0];
          return arr.slice(1).map((row) => {
            const obj = {};
            header.forEach((key, i) => {
              obj[key] = row[i] || "";
            });
            return obj;
          });
        }

        async function fetchAircallStatuses() {
          const activeElements = document.querySelectorAll(
            "[id^='aircall-active-']"
          );
          for (let elem of activeElements) {
            const name = elem.textContent.split(" - ")[0].trim();
            const email = generateWoltEmail(name);
            const userId = await getAircallUserId(email);
            if (!userId) {
              elem.querySelector("span").textContent = "No ID";
              continue;
            }
            const status = await getAircallAvailability(userId);
            elem.querySelector("span").textContent = status;
          }
        }

        let autoRefreshEnabled = true;
        let refreshInterval = 15;
        let refreshTimer = null;
        let countdownTimer = null;
        let countdownValue = refreshInterval;

        function resetAutoRefresh() {
          clearTimeout(refreshTimer);
          clearInterval(countdownTimer);
          countdownValue = refreshInterval;
          updateCountdownDisplay();
          refreshTimer = setTimeout(fetchData, refreshInterval * 1000);
          countdownTimer = setInterval(() => {
            countdownValue--;
            updateCountdownDisplay();
            if (countdownValue <= 0) clearInterval(countdownTimer);
          }, 1000);
        }
        function updateCountdownDisplay() {
          const countdownElem = document.getElementById("countdown");
          if (countdownElem) {
            countdownElem.textContent = countdownValue;
          }
        }
        function toggleAutoRefresh() {
          autoRefreshEnabled = !autoRefreshEnabled;
          const btn = document.getElementById("toggle-autorefresh");
          if (autoRefreshEnabled) {
            btn.textContent = "Disable Auto Refresh";
            resetAutoRefresh();
          } else {
            btn.textContent = "Enable Auto Refresh";
            clearTimeout(refreshTimer);
            clearInterval(countdownTimer);
          }
        }
        // Кнопка Refresh Now и автообновление вызывают эту функцию
        function refreshNow() {
          document.getElementById("refresh-spinner").style.display =
            "inline-block";
          fetchData();
        }

        async function fetchData() {
          document.getElementById("refresh-spinner").style.display =
            "inline-block";
          const data = await fetchSheetData(RANGE);
          if (!data) {
            document.getElementById("refresh-spinner").style.display = "none";
            return;
          }
          fetchedData = data;
          const shiftData = await fetchSheetData(SHIFT_RANGE);
          window.allShiftData = shiftData;

          await fetchEmployeeList();
          await fetchShiftsQuinyxData();     
          await fetchShiftOversData();

          // Заполнение данных для Aircall
          const aircallConfig = platforms.find((p) => p.name === "Aircall");
          aircallActive = [];
          aircallAway = [];
          for (
            let r = aircallConfig.rowActiveNamesStart;
            r <= aircallConfig.rowActiveNamesEnd;
            r++
          ) {
            const name = data[r]?.[aircallConfig.colIndexNames]?.trim();
            if (name) aircallActive.push(name);
          }
          for (
            let r = aircallConfig.rowAwayNamesStart;
            r <= aircallConfig.rowAwayNamesEnd;
            r++
          ) {
            const name = data[r]?.[aircallConfig.colIndexNames]?.trim();
            const reason = data[r]?.[aircallConfig.colIndexData]?.trim() || "";
            if (name) aircallAway.push({ name, reason });
          }

          renderShiftSummary(data);
          const responsiblesData = await fetchSheetData(RESPONSIBLES_RANGE);
          renderResponsiblePeople(responsiblesData);
          await fetchBreaksData();
          applyFilters();
          fetchAircallStatuses();
          fetchTransfers();
          

          document.getElementById("refresh-spinner").style.display = "none";
          if (autoRefreshEnabled) resetAutoRefresh();
        }

        function generateWoltEmail(name) {
          if (!name) return "";
          const parts = name.split(" ");
          return parts.length < 2
            ? parts[0].toLowerCase() + "@wolt.com"
            : parts[0].toLowerCase() +
                "." +
                parts[1].toLowerCase() +
                "@wolt.com";
        }

        function getUpcomingShiftOvers() {
        if (!window.shiftsQuinyxData) return [];
        const now = new Date();
        const oneHourLater = new Date(now.getTime() + 60*60*1000);

        return window.shiftsQuinyxData
          .filter(({name, shift}) => {
            // из "06:00-15:00" берём вторую часть – время конца
            const endStr = shift.split("-")[1];
            if (!endStr) return false;
            // составляем дату-объект: сегодня + endStr
            const [hh, mm] = endStr.split(":").map(Number);
            const endDate = new Date(now);
            endDate.setHours(hh, mm, 0, 0);

            return endDate > now && endDate <= oneHourLater;
          })
          .map(o => o.name);
      }


        function loadThemePreference() {
          const saved = localStorage.getItem("darkThemeEnabled");
          if (saved === "true") {
            document.body.classList.add("dark-theme");
            const themeCheckbox = document.getElementById("theme-checkbox");
            if (themeCheckbox) themeCheckbox.checked = true;
          }
        }

        
        function toggleTheme(e) {
          const isDark = e.target.checked;
          document.body.classList.toggle("dark-theme", isDark);
          localStorage.setItem("darkThemeEnabled", isDark.toString());
        }

        // Инициализация Bootstrap-Select и обработка изменения выбора платформ
        $(document).ready(function () {
          $("#platform-dropdown").selectpicker();
          $("#platform-dropdown").on(
            "changed.bs.select",
            function (e, clickedIndex, isSelected, previousValue) {
              let selected = $(this).val();
              currentPlatformFilter = selected && selected.length ? selected : ["all"];
              applyFilters();
            }
          );
        });

document.addEventListener("DOMContentLoaded", () => {
  // Загрузка темы
  loadThemePreference();

  // Сайдбар
  const sidebar = document.getElementById("sidebar");
  const hamburger = document.getElementById("hamburger-menu");
  const closeBtn = document.getElementById("sidebar-close");

  if (hamburger) {
    hamburger.addEventListener("click", (e) => {
      e.stopPropagation();
      sidebar.classList.add("active");
    });
  }

  if (closeBtn) {
    closeBtn.addEventListener("click", () => {
      sidebar.classList.remove("active");
    });
  }

  document.addEventListener("click", (e) => {
    if (
      sidebar.classList.contains("active") &&
      !sidebar.contains(e.target) &&
      !e.target.closest("#hamburger-menu")
    ) {
      sidebar.classList.remove("active");
    }
  });

  // Фильтры таблицы платформ
  document
    .getElementById("employee-search")
    .addEventListener("input", (e) => {
      currentSearchTerm = e.target.value;
      applyFilters();
    });

  document
    .getElementById("status-filter")
    .addEventListener("change", (e) => {
      currentStatusFilter = e.target.value;
      applyFilters();
    });

  document
    .getElementById("realloc-filter")
    .addEventListener("change", (e) => {
      currentReallocFilter = e.target.value;
      applyFilters();
    });

  document
    .getElementById("lang-filter")
    .addEventListener("change", (e) => {
      currentLangFilter = e.target.value;
      applyFilters();
    });

  // Фильтр перерывов
  document
    .getElementById("break-filter")
    .addEventListener("change", (e) => {
      currentBreakFilter = e.target.value; // "upcoming" или "all"
      fetchBreaksData();
    });

  // Селектор платформ (bootstrap-select)
  $('#platform-dropdown').selectpicker();
  $('#platform-dropdown').on('changed.bs.select', function () {
    const selected = $(this).val();
    currentPlatformFilter = selected && selected.length ? selected : ['all'];
    applyFilters();
  });

  // Модалка сотрудника
  const overlay = document.getElementById("modal-overlay");
  const modalClose = document.getElementById("modal-close");
  overlay.addEventListener("click", closeEmployeeModal);
  modalClose.addEventListener("click", closeEmployeeModal);

  // Переключатель темы
  document.getElementById("theme-checkbox").addEventListener("change", toggleTheme);

  // Первичная загрузка данных
  fetchData();
  fetchWeather();
});
     
      
      </script>
    </div>
  </body>
</html>
