<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>SUMO Dashboard</title>
  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Bootstrap (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    :root {
      /* –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
      --bg-color: linear-gradient(120deg, #fdfbfb 0%, #ebedee 100%);
      --text-color: #343a40;
      --card-bg-color: #ffffff;
      --card-text-color: #495057;
      --card-border-color: #dee2e6;
      --card-shadow: 0 4px 16px rgba(0,0,0,0.08);
      --card-hover-shadow: 0 6px 20px rgba(0,0,0,0.12);
    }
    /* –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ */
    body.dark-theme {
      --bg-color: linear-gradient(120deg, #2a2a2a 0%, #3c3c3c 100%);
      --text-color: #f0f0f0;
      --card-bg-color: #3a3a3a;
      --card-text-color: #e5e5e5;
      --card-border-color: #555555;
      --card-shadow: 0 4px 16px rgba(255,255,255,0.08);
      --card-hover-shadow: 0 6px 20px rgba(255,255,255,0.12);
    }
    /* –û–±—â–∏–π —Å–±—Ä–æ—Å –∏ —Ñ–æ–Ω */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      min-height: 100vh;
      background: var(--bg-color);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow-x: hidden;
      color: var(--text-color);
      transition: background 0.3s ease, color 0.3s ease;
    }
    .dashboard-container {
      width: 100%;
      margin: 0;
      padding: 40px 20px;
      box-sizing: border-box;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      font-weight: 500;
      font-size: 2rem;
      color: var(--text-color);
    }
    /* –ë–ª–æ–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ */
    .tools-bar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .tools-bar > * {
      margin: 5px;
    }
    /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã */
    .theme-toggle-container {
      display: flex;
      align-items: center;
    }
    .theme-toggle-label {
      margin-right: 8px;
      font-size: 0.9rem;
    }
    .theme-switch {
      position: relative;
      display: inline-block;
      width: 52px;
      height: 28px;
    }
    .theme-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      border-radius: 34px;
      transition: 0.4s;
    }
    .slider:before {
      position: absolute;
      content: "‚òÄ";
      color: #f39c12;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      width: 22px;
      height: 22px;
      left: 3px;
      bottom: 3px;
      border-radius: 50%;
      background-color: #fff;
      transition: 0.4s;
    }
    input:checked + .slider {
      background-color: #007bff;
    }
    input:checked + .slider:before {
      transform: translateX(24px);
      content: "üåô";
      color: #f1c40f;
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
    .btn {
      transition: background-color 0.3s, box-shadow 0.3s;
    }
    /* –§–∏–ª—å—Ç—Ä—ã */
    .tools-bar input[type="text"],
    .tools-bar select {
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.9rem;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    .tools-bar input[type="text"]:focus,
    .tools-bar select:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 5px rgba(0,123,255,0.5);
    }
    /* –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ª–µ–Ω—Ç–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ */
    .platforms-row {
      display: flex;
      flex-wrap: nowrap;
      align-items: flex-start;
      justify-content: space-between;
      overflow-x: auto;
      width: 100%;
      gap: 10px;
    }
    .platform-card {
      flex: 1 1 220px;
      min-width: 220px;
      box-sizing: border-box;
      background: var(--card-bg-color);
      color: var(--card-text-color);
      border-radius: 16px;
      padding: 20px;
      box-shadow: var(--card-shadow);
      transition: transform 0.2s, box-shadow 0.2s, background 0.3s;
      white-space: normal;
      overflow-wrap: break-word;
      word-break: normal;
    }
    .platform-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--card-hover-shadow);
    }
    .platform-card h5 {
      color: var(--text-color);
      margin-bottom: 12px;
      text-align: center;
      font-weight: 600;
      font-size: 1.1rem;
    }
    .platform-card h5 a {
      text-decoration: underline;
      color: #007bff;
      cursor: pointer;
    }
    .platform-card h5 a:hover {
      color: #0056b3;
    }
    .platform-card p {
      text-align: center;
      color: #6c757d;
      margin: 10px 0;
      font-size: 0.85rem;
    }
    .platform-card ul {
      list-style: none;
      padding-left: 0;
      margin: 0;
      font-size: 0.85rem;
      color: var(--card-text-color);
    }
    /* –£–±–∏—Ä–∞–µ–º –¥–æ–ø. —Ç–µ–∫—Å—Ç, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∏–º—è */
    .platform-card ul li {
      border-bottom: 1px solid var(--card-border-color);
      padding: 4px 0;
      white-space: normal;
      overflow-wrap: break-word;
      word-break: normal;
      cursor: pointer;
    }
    .platform-card ul li:last-child {
      border-bottom: none;
    }
    /* Shift Summary Card */
    .shift-summary-card {
      background: var(--card-bg-color);
      color: var(--card-text-color);
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      padding: 20px;
      margin: 0 auto 40px;
      width: auto;
      text-align: center;
      transition: transform 0.2s, box-shadow 0.2s, background 0.3s;
      overflow-wrap: break-word;
      word-break: normal;
    }
    .shift-summary-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--card-hover-shadow);
    }
    .shift-summary-title {
      margin-bottom: 16px;
      font-weight: 600;
      font-size: 1.3rem;
      color: var(--text-color);
    }
    .shift-summary-grid {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      table-layout: auto;
    }
    .shift-summary-grid th,
    .shift-summary-grid td {
      padding: 8px 12px;
      text-align: center;
      font-size: 0.85rem;
      white-space: normal;
      color: var(--card-text-color);
    }
    .shift-summary-grid th {
      background-color: #f8f9fa;
      font-weight: 600;
    }
    .shift-summary-grid td {
      background: var(--card-bg-color);
      border: 1px solid var(--card-border-color);
      border-radius: 8px;
    }
    /* Upcoming Breaks */
    #breaks-section {
      margin-top: 40px;
    }
    #breaks-section h2 {
      text-align: center;
      margin-bottom: 20px;
      font-weight: 500;
      font-size: 1.5rem;
      color: var(--text-color);
    }
    .break-card {
      background: var(--card-bg-color);
      color: var(--card-text-color);
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      padding: 20px;
      margin: 0 auto 40px;
      max-width: 600px;
      text-align: center;
      transition: transform 0.2s, box-shadow 0.2s, background 0.3s;
      overflow-wrap: break-word;
      word-break: normal;
    }
    .break-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--card-hover-shadow);
    }
    .break-card h5 {
      margin-bottom: 12px;
      font-weight: 600;
      color: var(--text-color);
      font-size: 1.1rem;
    }
    .break-card ul {
      list-style: none;
      padding-left: 0;
      margin: 0;
      font-size: 0.85rem;
      color: var(--card-text-color);
    }
    .break-card ul li {
      padding: 6px 0;
      border-bottom: 1px solid var(--card-border-color);
    }
    .break-card ul li:last-child {
      border-bottom: none;
    }
    /* –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –±–ª–æ–∫ */
    #debug-section {
      margin: 20px auto;
      width: 90%;
      max-width: 900px;
      background: #fff2;
      color: #f00;
      padding: 10px;
      font-size: 0.85rem;
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
    }
    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ */
    #modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
    }
    #employee-modal {
      display: none;
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--card-bg-color);
      color: var(--card-text-color);
      border: 1px solid var(--card-border-color);
      box-shadow: var(--card-shadow);
      border-radius: 8px;
      padding: 20px;
      z-index: 1001;
      width: 330px;
    }
    #employee-modal h3 {
      margin-top: 0;
      margin-bottom: 8px;
    }
    #employee-modal .close-btn {
      position: absolute;
      top: 8px;
      right: 12px;
      cursor: pointer;
      font-size: 20px;
    }
    #employee-modal a {
      color: #007bff;
      text-decoration: underline;
    }
    #employee-modal a:hover {
      color: #0056b3;
    }
    .platform-link-hint {
      display: inline-block;
      margin-left: 5px;
      cursor: pointer;
    }
    .platform-link-hint::before {
      content: "i";
      display: inline-block;
      width: 16px;
      height: 16px;
      line-height: 16px;
      text-align: center;
      border-radius: 50%;
      background-color: #eee;
      color: #333;
      font-size: 12px;
      font-weight: bold;
      vertical-align: middle;
      transition: background-color 0.3s, color 0.3s;
    }
    .platform-link-hint:hover::before {
      background-color: #0056b3;
      color: #fff;
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <h1>Support Monitoring Dashboard</h1>
    
    <div class="tools-bar">
      <!-- –¢–µ–º–∞ -->
      <div class="theme-toggle-container">
        <span class="theme-toggle-label">–¢–µ–º–∞:</span>
        <label class="theme-switch">
          <input type="checkbox" id="theme-checkbox"/>
          <span class="slider"></span>
        </label>
      </div>
      <button id="toggle-autorefresh" class="btn btn-outline-primary">Disable Auto Refresh</button>
      <button id="refresh-now" class="btn btn-outline-secondary">Refresh now</button>
      <span>Auto refresh in <span id="countdown">15</span> sec</span>

      <!-- –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
      <input type="text" id="employee-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º" />
      <select id="platform-filter">
        <option value="all">–í—Å–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã</option>
        <option value="CS">CS</option>
        <option value="CS/Post order">CS/Post order</option>
        <option value="PSR">PSR</option>
        <option value="SiMo">SiMo</option>
        <option value="Aircall">Aircall</option>
        <option value="Venue">Venue</option>
        <option value="Trainee">Trainee</option>
        <option value="ST">ST</option>
      </select>
      <select id="status-filter">
        <option value="both">–ê–∫—Ç–∏–≤–Ω—ã–µ –∏ Away</option>
        <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
        <option value="away">Away</option>
      </select>
      <!-- –§–∏–ª—å—Ç—Ä—ã Reallocate –∏ Language -->
      <select id="realloc-filter">
        <option value="all">Reallocate: All</option>
        <option value="Yes">Yes</option>
        <option value="No">No</option>
      </select>
      <select id="lang-filter">
        <option value="All">Language: All</option>
        <option value="two">Bilingualüá¶üáø üá¨üáß</option>
        <option value="three">Trilingualüá¶üáøüá∑üá∫üá¨üáß</option>
      </select>
      <!-- –ù–æ–≤—ã–π —Ñ–∏–ª—å—Ç—Ä –¥–ª—è –±—Ä–µ–π–∫–æ–≤ -->
      <select id="break-filter">
        <option value="upcoming">–ë—Ä–µ–π–∫–∏ –≤ –±–ª–∏–∂–∞–π—à–∏–π —á–∞—Å</option>
        <option value="all">–í—Å–µ –±—Ä–µ–π–∫–∏</option>
      </select>
    </div>

    <div id="shift-summary" class="shift-summary-card">
      <div class="shift-summary-title">Statistics per platform</div>
      <table class="shift-summary-grid" id="summary-table"></table>
    </div>

    <div id="platforms-container" class="platforms-row"></div>

    <div id="breaks-section">
      <h2>Upcoming Breaks</h2>
      <div id="breaks-app"></div>
    </div>

    <div id="debug-section"></div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ -->
  <div id="modal-overlay"></div>
  <div id="employee-modal">
    <span class="close-btn" id="modal-close">&times;</span>
    <h3 id="modal-emp-name"></h3>
    <p><strong>Can Reallocate?</strong>: <span id="modal-emp-realloc"></span></p>
    <p><strong>Prime Platform:</strong> <span id="modal-emp-prime"></span></p>
    <p><strong>Preferred Platform:</strong> <span id="modal-emp-pref"></span></p>
    <p><strong>Languages:</strong> <span id="modal-emp-languages"></span></p>
    <p>
      <a id="modal-inbox-link" href="#" target="_blank">Inbox</a> |
      <a id="modal-admin-link" href="#" target="_blank">Admin Dashboard</a>
    </p>
  </div>
  
  <script>
    /********* –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ **********/
    let fetchedData = null;
    let currentSearchTerm = "";
    let currentPlatformFilter = "all";
    let currentStatusFilter = "both";
    let currentReallocFilter = "all";
    let currentLangFilter = "All";

    const SPREADSHEET_ID = "1dICKOxxz9R3x8MY3FKQ9I-IwR9fBUDfMOT9PFDLloAE";
    const RANGE = "list1!A1:BJ100";
    const EMP_LIST_RANGE = "emplist!A1:F";
    const BREAKS_RANGE = "prebreaks!A1:D40";
    const GOOGLE_API_KEY = "AIzaSyBVHrKvA61CAJBLxU-4AAiow6Y0TV4ChSY";

    let employeeData = {};

    const platforms = [
      { name: "CS",             url: "https://ops.wolt.com/support/converse/conversations?conversationListId=6643245bfadf62c6edc28feb", colIndexNames: 3,  colIndexData: 4,  rowActiveNamesStart: 4,  rowActiveNamesEnd: 27, rowAwayNamesStart: 28, rowAwayNamesEnd: 47 },
      { name: "CS/Post order",  url: "https://ops.wolt.com/support/converse/conversations?conversationListId=664324a0510ac011feaa798c", colIndexNames: 5,  colIndexData: 6,  rowActiveNamesStart: 4,  rowActiveNamesEnd: 27, rowAwayNamesStart: 28, rowAwayNamesEnd: 47 },
      { name: "PSR",            url: "https://ops.wolt.com/support/converse/conversations?conversationListId=6567a44af7d470550b11dc68", colIndexNames: 7,  colIndexData: 8,  rowActiveNamesStart: 4,  rowActiveNamesEnd: 27, rowAwayNamesStart: 28, rowAwayNamesEnd: 47 },
      { name: "SiMo",           url: "https://ops.wolt.com/support/converse/conversations?conversationListId=6668088fc6d870f3cfd61653", colIndexNames: 9,  colIndexData: 10, rowActiveNamesStart: 4,  rowActiveNamesEnd: 27, rowAwayNamesStart: 28, rowAwayNamesEnd: 47 },
      { name: "Aircall",        url: "https://ops.wolt.com/support/converse/conversations?conversationListId=671a26a2a5b9ae4a2ca603fb", colIndexNames: 11, colIndexData: 12, rowActiveNamesStart: 4,  rowActiveNamesEnd: 27, rowAwayNamesStart: 28, rowAwayNamesEnd: 47 },
      { name: "Venue",          url: "https://ops.wolt.com/support/converse/conversations?conversationListId=666807fc28b3f1231948f407", colIndexNames: 13, colIndexData: 14, rowActiveNamesStart: 4,  rowActiveNamesEnd: 27, rowAwayNamesStart: 28, rowAwayNamesEnd: 47 },
      { name: "Trainee",        url: "https://wolt.com/", colIndexNames: 15, colIndexData: 16, rowActiveNamesStart: 4,  rowActiveNamesEnd: 27, rowAwayNamesStart: 28, rowAwayNamesEnd: 47 },
      { name: "ST",             url: "https://wolt.com/", colIndexNames: 17, colIndexData: 18, rowActiveNamesStart: 4,  rowActiveNamesEnd: 27, rowAwayNamesStart: 28, rowAwayNamesEnd: 47 }
    ];

    let aircallActive = [];
    let aircallAway = [];

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ –æ—Ç–ª–∞–¥–æ—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π –±–ª–æ–∫
    function logDebug(message) {
      const debugDiv = document.getElementById("debug-section");
      debugDiv.textContent += message + "\n";
    }

    async function fetchSheetData(range) {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(range)}?key=${GOOGLE_API_KEY}`;
      try {
        const res = await fetch(url);
        if (!res.ok) {
          logDebug("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: " + res.statusText);
          return null;
        }
        const data = await res.json();
        return data.values;
      } catch (err) {
        logDebug("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: " + err);
        return null;
      }
    }

    async function fetchEmployeeList() {
      const data = await fetchSheetData(EMP_LIST_RANGE);
      if (!data || data.length < 2) return;
      for (let i = 1; i < data.length; i++) {
        const row = data[i];
        if (!row[0]) continue;
        const empName = row[0].trim();
        const empId = row[1]?.trim() || "";
        const canRealloc = row[2]?.trim() || "";
        const primePlatform = row[3]?.trim() || "";
        const preferredPlatform = row[4]?.trim() || "";
        const languages = row[5]?.trim() || "";
        employeeData[empName] = {
          id: empId,
          canReallocate: canRealloc,
          prime: primePlatform,
          pref: preferredPlatform,
          languages: languages
        };
      }
    }

    function generateInboxLink(empId) {
      return "https://ops.wolt.com/support/converse/users/conversations?assigneeIds=" + encodeURIComponent(empId);
    }
    function generateAdminLink(empId) {
      return "https://ops.wolt.com/support/converse/admin/users?userId=" + encodeURIComponent(empId);
    }

    function openEmployeeModal(empName) {
      const info = employeeData[empName];
      if (!info) {
        logDebug("–î–∞–Ω–Ω—ã–µ –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã: " + empName);
        return;
      }
      document.getElementById("modal-emp-name").textContent = empName;
      document.getElementById("modal-emp-realloc").textContent = info.canReallocate || "N/A";
      document.getElementById("modal-emp-prime").textContent = info.prime || "N/A";
      document.getElementById("modal-emp-pref").textContent = info.pref || "N/A";
      document.getElementById("modal-emp-languages").textContent = info.languages || "N/A";
      document.getElementById("modal-inbox-link").href = generateInboxLink(info.id);
      document.getElementById("modal-admin-link").href = generateAdminLink(info.id);
      document.getElementById("employee-modal").style.display = "block";
      document.getElementById("modal-overlay").style.display = "block";
    }
    function closeEmployeeModal() {
      document.getElementById("employee-modal").style.display = "none";
      document.getElementById("modal-overlay").style.display = "none";
    }

    const AIRCALL_API_KEY = "43bce092d80a09050211a837c0bbd705";
    const AIRCALL_API_SECRET = "092d2eb157c47614788386920acd7413";

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Aircall –ø–æ email —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –ª–æ–≥–æ–≤
    async function getAircallUserId(email) {
      const authString = btoa(`${AIRCALL_API_KEY}:${AIRCALL_API_SECRET}`);
      const url = `https://api.aircall.io/v1/users/${encodeURIComponent(email)}`;
      try {
        logDebug(`–ó–∞–ø—Ä–æ—Å Aircall ID –¥–ª—è email: ${email}`);
        const res = await fetch(url, { headers: { "Authorization": `Basic ${authString}` }});
        if (!res.ok) {
          logDebug(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è ID Aircall: ${res.statusText} (–°—Ç–∞—Ç—É—Å: ${res.status})`);
          return null;
        }
        const data = await res.json();
        logDebug(`–ü–æ–ª—É—á–µ–Ω ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${data.user?.id}`);
        return data.user?.id || null;
      } catch (err) {
        logDebug("–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ Aircall ID: " + err);
        return null;
      }
    }
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ Aircall —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    async function getAircallAvailability(userId) {
      if (!userId) {
         logDebug("getAircallAvailability: userId –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω");
         return "No ID";
      }
      const authString = btoa(`${AIRCALL_API_KEY}:${AIRCALL_API_SECRET}`);
      const url = `https://api.aircall.io/v1/users/${userId}/availability`;
      try {
         logDebug(`–ó–∞–ø—Ä–æ—Å —Å—Ç–∞—Ç—É—Å–∞ Aircall –¥–ª—è userId: ${userId}`);
         const res = await fetch(url, { headers: { "Authorization": `Basic ${authString}` }});
         if (!res.ok) {
             logDebug(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ Aircall: ${res.statusText} (–°—Ç–∞—Ç—É—Å: ${res.status})`);
             return "Error";
         }
         const data = await res.json();
         let status = data?.user_availability?.availability_status || data?.availability;
         logDebug(`–ü–æ–ª—É—á–µ–Ω —Å—Ç–∞—Ç—É—Å –¥–ª—è userId ${userId}: ${status}`);
         return status || "Unknown";
      } catch (err) {
         logDebug("–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –≤ getAircallAvailability: " + err);
         return "Error";
      }
    }

    function applyFilters() {
      const debugDiv = document.getElementById("debug-section");
      // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–∏–µ –ª–æ–≥–∏ –æ—Ç–ª–∞–¥–∫–∏ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Ñ–∏–ª—å—Ç—Ä–∞
      debugDiv.textContent = "–û—Ç–ª–∞–¥–∫–∞ applyFilters():\n";
      debugDiv.textContent += ` - currentPlatformFilter: ${currentPlatformFilter}\n`;
      debugDiv.textContent += ` - currentStatusFilter: ${currentStatusFilter}\n`;
      debugDiv.textContent += ` - currentReallocFilter: ${currentReallocFilter}\n`;
      debugDiv.textContent += ` - currentLangFilter: ${currentLangFilter}\n`;
      debugDiv.textContent += ` - search: '${currentSearchTerm}'\n`;

      const container = document.getElementById("platforms-container");
      container.innerHTML = "";

      platforms.forEach(platform => {
        if (currentPlatformFilter !== "all" &&
            platform.name.toLowerCase() !== currentPlatformFilter.toLowerCase()) {
          return;
        }

        if (platform.name !== "Aircall") {
          let activeNames = [];
          for (let r = platform.rowActiveNamesStart; r <= platform.rowActiveNamesEnd; r++) {
            const nm = fetchedData[r]?.[platform.colIndexNames]?.trim();
            if (nm) activeNames.push(nm);
          }
          let awayData = [];
          for (let r = platform.rowAwayNamesStart; r <= platform.rowAwayNamesEnd; r++) {
            const nm = fetchedData[r]?.[platform.colIndexNames]?.trim();
            if (!nm) continue;
            const rsn = fetchedData[r]?.[platform.colIndexData]?.trim() || "";
            awayData.push({ name: nm, reason: rsn });
          }

          if (currentSearchTerm) {
            activeNames = activeNames.filter(n => n.toLowerCase().includes(currentSearchTerm.toLowerCase()));
            awayData = awayData.filter(item => item.name.toLowerCase().includes(currentSearchTerm.toLowerCase()));
          }

          // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é
          activeNames = activeNames.filter(n => passReallocAndLang(n));
          awayData = awayData.filter(item => passReallocAndLang(item.name));

          let showActive = true, showAway = true;
          if (currentStatusFilter === "active") showAway = false;
          else if (currentStatusFilter === "away") showActive = false;

          let html = `<div class="platform-card">
              <h5>
                <a href="${platform.url}" target="_blank" rel="noopener" title="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å ${platform.name}">
                  ${platform.name}
                </a>
                <span class="platform-link-hint" title="–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É CS"></span>
              </h5>`;

          if (showActive) {
            html += `<p><small>–ê–∫—Ç–∏–≤–Ω—ã–µ (${activeNames.length})</small></p><ul>`;
            activeNames.forEach(n => {
              html += `<li class="employee-item" data-employee="${n}">${n}</li>`;
            });
            html += `</ul>`;
          }
          if (showAway) {
            html += `<p><small>Away (${awayData.length})</small></p><ul>`;
            awayData.forEach(item => {
              html += `<li class="employee-item" data-employee="${item.name}">${item.name}`;
              if (item.reason) html += ` (${item.reason})`;
              html += `</li>`;
            });
            html += `</ul>`;
          }
          html += `</div>`;
          container.innerHTML += html;
        } else {
          let filteredActive = aircallActive.slice();
          let filteredAway = aircallAway.slice();
          if (currentSearchTerm) {
            filteredActive = filteredActive.filter(n => n.toLowerCase().includes(currentSearchTerm.toLowerCase()));
            filteredAway = filteredAway.filter(item => item.name.toLowerCase().includes(currentSearchTerm.toLowerCase()));
          }
          filteredActive = filteredActive.filter(n => passReallocAndLang(n));
          filteredAway = filteredAway.filter(item => passReallocAndLang(item.name));

          let showActive = true, showAway = true;
          if (currentStatusFilter === "active") showAway = false;
          else if (currentStatusFilter === "away") showActive = false;
          renderAircallCardWithStatuses(filteredActive, filteredAway, showActive, showAway);
        }
      });

      // –í—ã–≤–æ–¥ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
      const allItems = document.querySelectorAll(".employee-item");
      const finalList = Array.from(allItems).map(item => item.getAttribute("data-employee"));
      debugDiv.textContent += "–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤:\n" + finalList.join(", ") + "\n\n";

      // –ù–∞–≤–µ—Å–∏–º –∫–ª–∏–∫
      const employeeItems = document.querySelectorAll(".employee-item");
      employeeItems.forEach(item => {
        item.addEventListener("click", function() {
          const empName = this.getAttribute("data-employee");
          openEmployeeModal(empName);
        });
      });
    }

    function renderAircallCardWithStatuses(activeList, awayList, showActive = true, showAway = true) {
      const aircallPlatform = platforms.find(p => p.name === "Aircall");
      let html = `<div class="platform-card">
            <h5>
              <a href="${aircallPlatform.url}" target="_blank" rel="noopener" title="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å Aircall">
                Aircall
              </a>
              <span class="platform-link-hint" title="–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É CS"></span>
            </h5>`;
      if (showActive) {
        html += `<p><small>–ê–∫—Ç–∏–≤–Ω—ã–µ (${activeList.length})</small></p><ul id="aircall-active-list">`;
        activeList.forEach(n => {
          html += `<li class="employee-item" data-employee="${n}">${n} - <span style="color:blue;">Loading...</span></li>`;
        });
        html += `</ul>`;
      }
      if (showAway) {
        html += `<p><small>Away (${awayList.length})</small></p><ul>`;
        awayList.forEach(a => {
          html += `<li class="employee-item" data-employee="${a.name}">${a.name}</li>`;
        });
        html += `</ul>`;
      }
      html += `</div>`;
      document.getElementById("platforms-container").innerHTML += html;
    }

    function passReallocAndLang(empName) {
      const info = employeeData[empName];
      if (!info) return false;
      let lang = info.languages.replace(/\s+/g, "");
      if (currentReallocFilter !== "all") {
        if (info.canReallocate !== currentReallocFilter) {
          return false;
        }
      }
      if (currentLangFilter !== "All") {
        if (currentLangFilter === "two") {
          if (!(lang.includes("üá¶üáø") && lang.includes("üá¨üáß")) || lang.includes("üá∑üá∫")) {
            return false;
          }
        } else if (currentLangFilter === "three") {
          if (!(lang.includes("üá¶üáø") && lang.includes("üá∑üá∫") && lang.includes("üá¨üáß"))) {
            return false;
          }
        }
      }
      return true;
    }

    function renderShiftSummary(data) {
      const tableEl = document.getElementById("summary-table");
      let html = "";
      for (let i = 5; i < data.length; i++) {
        const row = data[i];
        const subset = row.slice(27, 44)
                         .map(cell => cell.trim())
                         .filter(cell => cell !== "");
        if (subset.length === 0 || subset.includes("Dashboard"))
          continue;
        html += "<tr>";
        subset.forEach(cell => {
          html += `<td>${cell}</td>`;
        });
        html += "</tr>";
      }
      tableEl.innerHTML = html;
    }

    // –§—É–Ω–∫—Ü–∏—è, –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ª–∏–±–æ –≤—Å–µ—Ö –±—Ä–µ–π–∫–æ–≤, –ª–∏–±–æ —Ç–æ–ª—å–∫–æ –±—Ä–µ–π–∫–æ–≤ –≤ –±–ª–∏–∂–∞–π—à–∏–π —á–∞—Å
    async function fetchBreaksData() {
      const data = await fetchSheetData(BREAKS_RANGE);
      if (!data) return;
      const breaksObjects = arrayToObjects(data);
      let filteredBreaks = breaksObjects;

      // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ –±—Ä–µ–π–∫–æ–≤
      const breakFilter = document.getElementById("break-filter").value;
      const now = new Date();
      const currMinutes = now.getHours() * 60 + now.getMinutes();

      if (breakFilter === "upcoming") {
        const horizon = currMinutes + 60;
        filteredBreaks = breaksObjects.filter(item => {
          if (!item["Break Time"]) return false;
          const timeStr = item["Break Time"].trim();
          // –ü—Ä–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–∏ –ø–µ—Ä–µ–¥–∞–µ–º currMinutes, —á—Ç–æ–±—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –±—Ä–µ–π–∫–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è
          const minutes = parseTimeToMinutes(timeStr, currMinutes);
          return (minutes >= currMinutes && minutes <= horizon);
        });
        filteredBreaks.sort((a, b) => parseTimeToMinutes(a["Break Time"], currMinutes) - parseTimeToMinutes(b["Break Time"], currMinutes));
      } else if (breakFilter === "all") {
        // –ü—Ä–∏ –≤—ã–±–æ—Ä–µ "–í—Å–µ –±—Ä–µ–π–∫–∏" ‚Äî —Å–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ –±—Ä–µ–π–∫–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏, —Å —É—á–µ—Ç–æ–º –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö –¥–Ω–µ–π
        filteredBreaks.sort((a, b) => parseTimeToMinutes(a["Break Time"], currMinutes) - parseTimeToMinutes(b["Break Time"], currMinutes));
      }

      let html = `<div class="break-card">
                    <h5>`;
      html += breakFilter === "upcoming" ? `Upcoming breaks in the next hour` : `All Breaks`;
      html += `</h5><ul>`;
      filteredBreaks.forEach(item => {
        html += `
          <li>
            <strong>${item["Name"]}</strong><br/>
            Break at: <strong>${item["Break Time"]}</strong><br/>
            Shift: ${item["Shift Start Time"]} | ${item["Working Space"]}
          </li>`;
      });
      html += `</ul></div>`;
      document.getElementById("breaks-app").innerHTML = html;
    }

    function parseTimeToMinutes(timeStr, currMinutes) {
      timeStr = timeStr.trim();
      let parts = timeStr.split(":");
      if (parts.length < 2) return 0;
      let hours = parseInt(parts[0], 10);
      let minutes = parseInt(parts[1], 10);
      let total = hours * 60 + minutes;
      // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω currMinutes –∏ –≤—Ä–µ–º—è –±—Ä–µ–π–∫–∞ –º–µ–Ω—å—à–µ —Ç–µ–∫—É—â–µ–≥–æ, —Ç–æ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –±—Ä–µ–π–∫ –Ω–∞–∑–Ω–∞—á–µ–Ω –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å
      if (typeof currMinutes !== "undefined" && total < currMinutes) {
        total += 1440; // –¥–æ–±–∞–≤–ª—è–µ–º 24 —á–∞—Å–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö
      }
      return total;
    }

    function arrayToObjects(arr) {
      if (!arr.length) return [];
      const header = arr[0];
      return arr.slice(1).map(row => {
        const obj = {};
        header.forEach((key, i) => {
          obj[key] = row[i] || "";
        });
        return obj;
      });
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ Aircall —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—ã—Ö –ª–æ–≥–æ–≤
    async function fetchAircallStatuses() {
      const activeElements = document.querySelectorAll("#aircall-active-list li");
      logDebug(`–ù–∞—á–∞–ª–æ –∑–∞–ø—Ä–æ—Å–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ Aircall. –ù–∞–π–¥–µ–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤: ${activeElements.length}`);
      for (let elem of activeElements) {
        const text = elem.textContent;
        // –†–∞–∑–¥–µ–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –ø–æ " - ", –ø–µ—Ä–≤—ã–π –∫—É—Å–æ–∫ ‚Äî –∏–º—è
        const [name] = text.split(" - ");
        const span = elem.querySelector("span");
        if (!name || !span) {
          logDebug("–ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è —ç–ª–µ–º–µ–Ω—Ç ‚Äì –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–º—è –∏–ª–∏ span.");
          continue;
        }
        span.textContent = "Fetching ID...";
        logDebug(`–ó–∞–ø—Ä–æ—Å —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞: ${name}`);
        // –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ: —Ñ—É–Ω–∫—Ü–∏—è generateWoltEmail –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞!
        const email = generateWoltEmail(name);
        if (!email) {
          span.textContent = "No email";
          logDebug(`generateWoltEmail –Ω–µ –≤–µ—Ä–Ω—É–ª–∞ email –¥–ª—è ${name}`);
          continue;
        }
        logDebug(`–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π email –¥–ª—è ${name}: ${email}`);
        const userId = await getAircallUserId(email);
        if (!userId) {
          span.textContent = "No ID";
          logDebug(`–ù–µ –Ω–∞–π–¥–µ–Ω Aircall ID –¥–ª—è ${name} (email: ${email})`);
          continue;
        }
        span.textContent = "Fetching status...";
        const status = await getAircallAvailability(userId);
        span.textContent = status;
      }
    }

    let autoRefreshEnabled = true;
    let refreshInterval = 15;
    let refreshTimer = null;
    let countdownTimer = null;
    let countdownValue = refreshInterval;

    function resetAutoRefresh() {
      clearTimeout(refreshTimer);
      clearInterval(countdownTimer);
      countdownValue = refreshInterval;
      updateCountdownDisplay();
      refreshTimer = setTimeout(fetchData, refreshInterval * 1000);
      countdownTimer = setInterval(() => {
        countdownValue--;
        if (countdownValue <= 0) clearInterval(countdownTimer);
        updateCountdownDisplay();
      }, 1000);
    }
    function updateCountdownDisplay() {
      document.getElementById("countdown").textContent = countdownValue;
    }
    function toggleAutoRefresh() {
      autoRefreshEnabled = !autoRefreshEnabled;
      const btn = document.getElementById("toggle-autorefresh");
      if (autoRefreshEnabled) {
        btn.textContent = "Disable Auto Refresh";
        resetAutoRefresh();
      } else {
        btn.textContent = "Enable Auto Refresh";
        clearTimeout(refreshTimer);
        clearInterval(countdownTimer);
        document.getElementById("countdown").textContent = "";
      }
    }
    function refreshNow() {
      fetchData();
    }

    async function fetchData() {
      // –ü–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∑–∞–ø—Ä–æ—Å–æ–º –æ—á–∏—â–∞–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π –±–ª–æ–∫
      document.getElementById("debug-section").textContent = "–ù–∞—á–∞–ª–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö...\n";
      const data = await fetchSheetData(RANGE);
      if (!data) return;
      fetchedData = data;

      await fetchEmployeeList();

      const aircallConfig = platforms.find(p => p.name === "Aircall");
      aircallActive = [];
      aircallAway = [];
      for (let r = aircallConfig.rowActiveNamesStart; r <= aircallConfig.rowActiveNamesEnd; r++) {
        const name = data[r]?.[aircallConfig.colIndexNames]?.trim();
        if (name) aircallActive.push(name);
      }
      for (let r = aircallConfig.rowAwayNamesStart; r <= aircallConfig.rowAwayNamesEnd; r++) {
        const name = data[r]?.[aircallConfig.colIndexNames]?.trim();
        const reason = data[r]?.[aircallConfig.colIndexData]?.trim() || "";
        if (name) aircallAway.push({ name, reason });
      }

      renderShiftSummary(data);
      fetchBreaksData();
      applyFilters();
      fetchAircallStatuses();

      if (autoRefreshEnabled) resetAutoRefresh();
    }

    // –ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ñ—É–Ω–∫—Ü–∏–∏ generateWoltEmail: –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –∏–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –≤ email –≤ —Ñ–æ—Ä–º–∞—Ç–µ lowercase —Å —Ç–æ—á–∫–æ–π –∏ –¥–æ–º–µ–Ω–æ–º @wolt.com
    function generateWoltEmail(name) {
      // –ù–∞–ø—Ä–∏–º–µ—Ä, "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤" -> "–∏–≤–∞–Ω.–∏–≤–∞–Ω–æ–≤@wolt.com"
      if (!name) return "";
      let parts = name.split(" ");
      if (parts.length < 2) return parts[0].toLowerCase() + "@wolt.com";
      return parts[0].toLowerCase() + "." + parts[1].toLowerCase() + "@wolt.com";
    }

    function loadThemePreference() {
      const saved = localStorage.getItem("darkThemeEnabled");
      if (saved === "true") {
        document.body.classList.add("dark-theme");
        document.getElementById("theme-checkbox").checked = true;
      }
    }
    function toggleTheme(e) {
      const isDark = e.target.checked;
      document.body.classList.toggle("dark-theme", isDark);
      localStorage.setItem("darkThemeEnabled", isDark.toString());
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadThemePreference();

      document.getElementById("theme-checkbox").addEventListener("change", toggleTheme);
      document.getElementById("toggle-autorefresh").addEventListener("click", toggleAutoRefresh);
      document.getElementById("refresh-now").addEventListener("click", refreshNow);

      document.getElementById("employee-search").addEventListener("input", function(e){
        currentSearchTerm = e.target.value;
        applyFilters();
      });
      document.getElementById("platform-filter").addEventListener("change", function(e){
        currentPlatformFilter = e.target.value;
        applyFilters();
      });
      document.getElementById("status-filter").addEventListener("change", function(e){
        currentStatusFilter = e.target.value;
        applyFilters();
      });

      document.getElementById("realloc-filter").addEventListener("change", function(e){
        currentReallocFilter = e.target.value;
        applyFilters();
      });
      document.getElementById("lang-filter").addEventListener("change", function(e){
        currentLangFilter = e.target.value;
        applyFilters();
      });
      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ –±—Ä–µ–π–∫–æ–≤
      document.getElementById("break-filter").addEventListener("change", fetchBreaksData);

      document.getElementById("modal-overlay").addEventListener("click", closeEmployeeModal);
      document.getElementById("modal-close").addEventListener("click", closeEmployeeModal);

      fetchData();
    });
  </script>
</body>
</html>
