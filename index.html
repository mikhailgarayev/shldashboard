<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>SUMO Dashboard</title>
    <link rel="icon" type="image/png" href="favicon.png" />
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Bootstrap-Select CSS –¥–ª—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ dropdown -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.18/css/bootstrap-select.min.css"
    />
    <link rel="stylesheet" href="style.css">
    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

    <script>
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyAHyxC12UaO6QU_nCiWFnegul1Vix5skm8",
        authDomain: "shldashboard.firebaseapp.com",
        databaseURL: "https://shldashboard-default-rtdb.firebaseio.com",
        projectId: "shldashboard",
        storageBucket: "shldashboard.firebasestorage.app",
        messagingSenderId: "362566153595",
        appId: "1:362566153595:web:ee35c2588bd0f798e6f9de"
      };
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const database = firebase.database();
      const brbAlertSent = {};
      const BREAK_NOTIF_KEY = 'overdueBreakNotified';
      let overdueBreakNotified = JSON.parse(localStorage.getItem(BREAK_NOTIF_KEY) || '{}');
      const brbOverdueNotified = {};
      const TRANSITIONS_API = 'https://script.google.com/macros/s/AKfycbwlp0Gsq8sVkI28nFW1TZvW_immH6PLrXejAeexj-48MhFtV7_uQ8SVjNi13RUfv_uj/exec?json=1';


      window.CURRENT_UPDATE_ID = '2025-05-18-v3.3'; // –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ —Å–µ–π—á–∞—Å –Ω–∞ —Å–∞–π—Ç–µ

        // --- Default settings ---
      const NOTIF_SETTINGS_KEY = 'notifSettings';
      const defaultSettings = {
        breakOverdue: false,
        brbOverdue:   true,
        emptyPlatforms: true,
        notHere: true,
        brbTwoOrMore: true
      };
      // –º–∞–ø–ø–∏–Ω–≥ ¬´–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã–π¬ª ‚Üí ¬´—Ä–µ–∞–ª—å–Ω—ã–π¬ª e-mail
      function normalizeEmail(email) {
        const aliases = {
          'ramil.guliyev@wolt.com':  'ramil.quliyev@wolt.com',
          'javidan.mammadli@wolt.com': 'cavidan.mammadli@wolt.com',
          'adil.ibrahimov@wolt.com': 'adil.ibragimov@wolt.com'
        };
        return aliases[email] || email;
      }

      // –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ localStorage –∏–ª–∏ –≤–∑—è—Ç—å –¥–µ—Ñ–æ–ª—Ç
      function loadNotifSettings() {
        const stored = localStorage.getItem(NOTIF_SETTINGS_KEY);
        return stored ? JSON.parse(stored) : {...defaultSettings};
      }

      // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
      function saveNotifSettings(settings) {
        localStorage.setItem(NOTIF_SETTINGS_KEY, JSON.stringify(settings));
      }
      

async function fetchStatusChanges() {
  try {
    const res = await fetch(TRANSFERS_API);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    // API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ –≤–∏–¥–∞
    // { Timestamp: "...", Name: "...", FromPlatform: "...", ToPlatform: "...", Duration: "..." }
    const raw = await res.json();
    // –ø—Ä–∏–≤–æ–¥–∏–º –∫ –µ–¥–∏–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É
    window.transfersData = raw
      .map(item => ({
        name:         item.Name,
        fromPlatform: item.FromPlatform,
        toPlatform:   item.ToPlatform,
        duration:     item.Duration,
        timestamp:    item.Timestamp
      }))
      // –æ—Ç–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–µ–ø–æ–ª–Ω—ã–µ –∑–∞–ø–∏—Å–∏
      .filter(t => t.name && t.fromPlatform && t.toPlatform);
    console.log('transfersData', window.transfersData);
  } catch (err) {
    console.error('–û—à–∏–±–∫–∞ fetchStatusChanges:', err);
    window.transfersData = [];
  }
}


      // –°–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö email
      const allowedEmails = [
        "mikhail.garayev@wolt.com",
        "elshan.tahmazov@wolt.com",
        "inara.mammadzada@wolt.com",
        "mayya.mirzayeva@wolt.com",
        "mikayil.alizada@wolt.com",
        "pasha.chiragov@wolt.com",
        "rahim.mammadov@wolt.com",
        "toghrul.mirzali@wolt.com",
        "amaliya.rizvanova@wolt.com",
        "anar.mikayilov@wolt.com",
        "arif.guliyev@wolt.com",
        "ratemikhail@gmail.com",
        "farid.hajiyev@wolt.com",
        "naziya.orujova@wolt.com",
        "murad.ismayilov@wolt.com",
        "sabina.amirova@wolt.com",
        "terlan.mammedov@wolt.com",
        "rafig.huseynov@wolt.com",
        "sama.akbarzadegan@wolt.com",
        "mursal.askarov@wolt.com"
      ];

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ‚Äì –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∏–ª–∏ –µ–≥–æ email –Ω–µ —Ä–∞–∑—Ä–µ—à—ë–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ login.html
      // 3) –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–π —É—á–∞—Å—Ç–æ–∫ –≤–Ω—É—Ç—Ä–∏ –≤–∞—à–µ–≥–æ <script>
        auth.onAuthStateChanged((user) => {
  if (!user || !allowedEmails.includes(user.email)) {
    // –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π ‚Äî –Ω–∞ –ª–æ–≥–∏–Ω
    window.location.replace("login.html");
    return;
  }

  // –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —à–∞–ø–∫—É
  document.getElementById("user-display-name").textContent =
    user.displayName || user.email;
  document.body.classList.remove("hidden");

  // –ø–æ–ª—É—á–∞–µ–º –æ–≤–µ—Ä–ª–µ–π —Ç–µ—Ö—Ä–∞–±–æ—Ç
  const overlay = document.getElementById("maintenance-overlay");
  // —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–ª–∞–≥ —Ç–µ—Ö—Ä–∞–±–æ—Ç –≤ –ë–î
  const maintRef = database.ref("maintenanceMode");

  // —Å–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–ª–∞–≥–∞ –∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–ª–∞—Å—Å .show
  maintRef.on("value", (snap) => {
    const on = snap.val() === true;
    overlay.classList.toggle("show", on);
  });

  // –µ—Å–ª–∏ —ç—Ç–æ –≤—ã ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–¥–º–∏–Ω-–∫–Ω–æ–ø–∫–∏
  if (user.email === "mikhail.garayev@wolt.com") {
    // –∫–Ω–æ–ø–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏
    document
      .getElementById("send-update-notif")
      .style.display = "inline-block";

    // –∫–Ω–æ–ø–∫–∞ —Ç–µ—Ö—Ä–∞–±–æ—Ç
    const maintBtn = document.getElementById("maintenance-btn");
    maintBtn.style.display = "inline-block";
    maintBtn.addEventListener("click", async () => {
      // –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –ë–î
      const snap = await maintRef.get();
      const current = snap.exists() && snap.val() === true;
      await maintRef.set(!current);
    });
  }
});


      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ Log Out
      document.addEventListener("DOMContentLoaded", () => {
        const logoutBtn = document.getElementById("logout-btn");
        logoutBtn.addEventListener("click", () => {
          auth.signOut();
        });
      });
    </script>
  </head>
  <body class="hidden">
      <!-- Header -->
      <header class="dashboard-header">
  <!-- 1) –õ–µ–≤–∞—è —á–∞—Å—Ç—å: –±—É—Ä–≥–µ—Ä + –∑–∞–≥–æ–ª–æ–≤–æ–∫ -->
  <div class="d-flex align-items-center gap-3">
    <div class="hamburger-menu" id="hamburger-menu">
      <span style="font-size: 24px; cursor: pointer;">‚ò∞</span>
    </div>
    <h1 class="mb-0" style="font-size: 1.3rem;">
      Support Monitoring Dashboard
    </h1>
  </div>

  <!-- 2) –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å: –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ + —Ç–∞–π–º–µ—Ä -->
  <div class="d-flex align-items-center flex-wrap header-gap flex-grow-1 justify-content-end">
    <!-- –∫–Ω–æ–ø–∫–∞ –º–∞—Å—Å–æ–≤–æ–π —Ä–∞—Å—Å—ã–ª–∫–∏ ‚Äî –≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –≤–∞–º -->
    <button
    id="send-update-notif"
    class="btn btn-outline-primary btn-sm rounded-pill ml-2"
    style="display: none;"
    >
    Send update notification
    </button>
    <!-- –ö–Ω–æ–ø–∫–∞ ‚ÄúMaintenance Mode‚Äù -->
<button
id="maintenance-btn"
class="btn btn-outline-danger btn-sm rounded-pill ml-2"
style="display:none;"
>
Enable maintenance
</button>

    <!-- Bell -->
    <div id="notification-bell" style="position:relative; cursor:pointer; margin-right:1rem;">
      <img
        src="https://www.svgrepo.com/show/525245/bell-off.svg"
        alt="Notifications"
        title="Notifications"
        style="width:24px; height:24px;"
      />
      <span
        id="notification-count"
        style="position:absolute; top:-4px; right:-4px; background:#dc3545;
               color:#fff; border-radius:50%; padding:2px 6px; font-size:0.7rem;
               display:none;"
      >0</span>
      <div id="notifications-panel" class="notifications-dropdown"></div>
    </div>
    <!-- Notifications dropdown panel -->


    <!-- Refresh -->
    <div class="refresh-section d-flex align-items-center gap-2 mr-3">
      <span id="timer-label">
        Refresh in: <span id="countdown">15</span>s
      </span>
      <img
        id="refresh-icon"
        src="https://www.svgrepo.com/show/168563/refresh.svg"
        alt="Refresh"
        title="Refresh now"
        style="width:24px; height:24px; cursor:pointer;"
        onclick="refreshNow()"
      />
    </div>
  </div>

<!-- –í–º–µ—Å—Ç–æ —Ç–µ–∫—É—â–µ–≥–æ –±–ª–æ–∫–∞ —Å –∏–º–µ–Ω–µ–º –∏ –∫–Ω–æ–ø–∫–∞–º–∏ -->
<div class="user-dropdown">
  <div class="user-menu-toggle" id="user-menu-toggle">
    <span id="user-display-name" class="small"></span>
    <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="https://www.svgrepo.com/show/355704/arrow-angle-down-solid.svg">
      <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </div>
  <div class="user-dropdown-menu" id="user-dropdown-menu">
    <div class="dropdown-item toggle-container">
  <div class="item-content">
    <img src="icons/dnd.svg" alt="Do not Disturb icon">
    <span>Do not Disturb</span>
  </div>
  <label class="dnd-switch toggle-switch">
    <input type="checkbox" id="dnd-toggle" />
    <span class="slider"></span>
  </label>
</div>
    <div class="dropdown-item toggle-container">
  <div class="item-content">
    <img src="icons/theme.svg" alt="Theme icon">
    <span>Theme</span>
  </div>
  <label class="theme-switch toggle-switch mb-0">
    <input type="checkbox" id="theme-checkbox" />
    <span class="slider"></span>
  </label>
</div>
    <div class="dropdown-item" id="notif-settings-btn">
      <img src="https://www.svgrepo.com/show/355637/bell-2-slash-solid.svg" width="16" height="16" style="margin-right:8px;"/>
      <span>Notification settings</span>
    </div>
    <div class="dropdown-divider"></div>
    <div class="dropdown-item" id="logout-btn">
      <img src="./log-out.svg" width="16" height="16" style="margin-right:8px;"/>
      <span>Log Out</span>
    </div>
  </div>
</div>
</header>

    <!-- Grid container -->
    <div class="dashboard-layout">

      <!-- Sidebar -->
      <aside class="sidebar">
        <div id="sidebar">
          <!-- –Ω–æ–≤—ã–π close-btn —Å SVG-—Å—Ç—Ä–µ–ª–∫–æ–π -->
          <div class="close-btn" id="sidebar-close" title="Close sidebar">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24" height="24"
              viewBox="0 0 16 16"
              fill="currentColor"
              aria-hidden="true"
            >
              <path
                fill-rule="evenodd"
                d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 
                  5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 
                  1 0-.708l6-6a.5.5 0 0 1 .708 0z"
              />
            </svg>
          </div>
          <a href=""></a>
          <a href="https://mikhailgarayev.github.io/shldashboard/shifts.html">üóìÔ∏è Today`s Shifts by Platform</a>
          <a href="https://script.google.com/macros/s/AKfycbyMdv_AP0p3tTMUZoeKEQhw8YFI9upxx6P0oAAI5pO1s-PbcCyBkKIcbGasvi-dpVAb/exec">üìà Allocation stats</a>
          <a href="https://my.yigim.az/login" target="_blank">üìä YIGIM Dashboard</a>
          <a href="https://wolt-prod.datadoghq.eu/dashboard/zpt-745-5da/city-health-dashboard-template-24h-aze?fromUser=false&refresh_mode=sliding&tpl_var_area_name%5B0%5D=baku&view=spans&from_ts=1745505436253&to_ts=1745507236253&live=true" target="_blank">üìà Datadog Dashboard</a>
          <a href="https://wolt-prod.datadoghq.eu/dashboard/y66-xdi-4xy/payments---authorizations?fromUser=false&fullscreen_end_ts=1745567771563&fullscreen_paused=false&fullscreen_refresh_mode=sliding&fullscreen_section=overview&fullscreen_start_ts=1745566871563&fullscreen_widget=2003408243236226&refresh_mode=sliding&view=spans&from_ts=1745556684337&to_ts=1745560284337&live=true" target="_blank">üìà Datadog Payment Dashboard</a>
          <a href="https://ops.wolt.com/city-states?country=AZE" target="_blank">üèôÔ∏è City States</a>
          <a href="https://ops.wolt.com/city-tools" target="_blank">üõ†Ô∏è City Tools</a>
          <a href="https://ops.wolt.com/support/converse/admin/users" target="_blank">üß≠ Converse Admin Panel</a>
          <a href="https://wo.lt/tracker" target="_blank">‚öôÔ∏è Away employees tracker</a>
          <a href="https://mikhailgarayev.github.io/shldashboard/numberblocking.html" target="_blank">üìû Aircall Number Blocking Dashboard</a>
          <a href="https://app.getguru.com/dashboard" target="_blank">üìö Guru</a>
          <a href="https://wo.lt/dashboard" target="_blank">üì© Video dashboard</a>
          <a href="https://docs.google.com/spreadsheets/d/1clZAsYF98NKN28JhVZ-qHjdOtS17rg-DfRCSqG7PGlc/edit?gid=0#gid=0" target="_blank">üóì Pre-breaks</a>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Filters -->
     <!-- –¶–µ–Ω—Ç—Ä: —Ñ–∏–ª—å—Ç—Ä—ã -->
     <div class="filters-wrapper d-flex flex-wrap align-items-center flex-grow-1 justify-content-center header-gap">
       <!-- –∏–∫–æ–Ω–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
      <img
        src="https://www.svgrepo.com/show/508058/filter.svg"
        alt="Filter icon"
        class="filter-icon"
      />
      <!-- –°—Ç–∞—Ç—É—Å -->
      <select id="status-filter" class="filter-dropdown">
        <option value="both">Status</option>
        <option value="active">Active</option>
        <option value="away">Away</option>
      </select>
    
      <!-- –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã (bootstrap-select) -->
      <select
        id="platform-dropdown"
        class="selectpicker"
        multiple
        data-live-search="true"
        title="Platform"
        data-width="auto"
        data-style="filter-dropdown platform-filter"
      >
        <option value="all" selected>All platforms</option>
        <option value="CS">CS</option>
        <option value="CS/Post order">CS/Post order</option>
        <option value="PSR">PSR</option>
        <option value="SiMo">SiMo</option>
        <option value="Aircall">Aircall</option>
        <option value="Venue">Venue</option>
        <option value="Trainee">Trainee</option>
        <option value="ST">ST</option>
      </select>
    
      <!-- Reallocate —Ñ–∏–ª—å—Ç—Ä -->
      <select id="realloc-filter" class="filter-dropdown">
        <option value="all">Reallocate: All</option>
        <option value="Yes">Yes</option>
        <option value="No">No</option>
      </select>
    
      <!-- Language —Ñ–∏–ª—å—Ç—Ä -->
      <select id="lang-filter" class="filter-dropdown">
        <option value="all">Language: All</option>
        <option value="two">Bilingual</option>
        <option value="three">Trilingual</option>
      </select>
    
      <!-- Breaks —Ñ–∏–ª—å—Ç—Ä -->
      <select id="break-filter" class="filter-dropdown">
        <option value="upcoming">Breaks: Upcoming</option>
        <option value="all">Breaks: All</option>
      </select>
    
      <!-- –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ -->
      <div class="autocomplete flex-grow-1" style="position: relative;">
      <input
        type="text"
        id="employee-search"
        placeholder="Global search..."
        class="search-input"
        autocomplete="off"
      />
      <button id="clear-search-button" class="clear-btn">√ó</button>
      <div id="autocomplete-list" class="autocomplete-items"></div>
    </div>

      <!-- –ù–æ–≤—ã–π —Å–µ–ª–µ–∫—Ç –¥–ª—è Find Candidate -->
      <select id="target-platform" class="filter-dropdown">
        <option value="">Reallocate to..</option>
      </select>
      <button id="find-candidate" class="btn btn-outline-primary">Find candidate</button>
      <div id="candidate-result" style="margin:1rem 0;"></div>
    </div>

        <!-- Stats Cards -->
        <!-- 1) –û–±—â–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ (On shift now, Should be, Not here, WNATS, Weather) -->
        <div id="summary-general"></div>

        <!-- 2) –¢–æ–ª—å–∫–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω—ã–µ —Å—Ç–∞—Ç—ã (CS, CS/Post Order, PSR, SiMo, Aircall, Venue, ST) -->
        <div id="summary-platforms"></div>

        <!-- 3) –ü–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω—ã–µ platform-card -->
        <div id="platforms-container" class="platforms-row"></div>

        <!-- –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π iframe —Å Converse Dashboard -->
<div class="glass-card" style="margin-top: 2rem; height: 670px;">
  <h2 style="margin-bottom: 1rem; font-size: 1.25rem; color: var(--text-color);">
    Aircall dashboard
  </h2>
  <iframe
  src="https://mikhailgarayev.github.io/shldashboard/numberblocking.html"
  width="100%"
  height="600"
  frameborder="0"
  style="border-radius:16px;"
  allowfullscreen>
</iframe>
</div>


      </main>

      <!-- Right Panel: Breaks & Shift-Overs -->
      <aside class="right-panel">
        <div id="shift-overs-section" class="alert-card"><h2>‚è≥ Upcoming Shift-Overs</h2><div id="shift-overs-app" class="alert-content">Loading...</div></div>
        <div id="breaks-section" class="alert-card"><h2>‚è∞ Breaks</h2><div id="breaks-app" class="alert-content">Loading...</div></div>
        <div id="upcoming-shifts-section" class="alert-card">
        <h2>üöÄ Upcoming Shifts</h2>
        <div id="upcoming-shifts-app" class="alert-content">Loading...</div>
        </div>
      </aside>

    </div> <!-- /.dashboard-layout -->

    <!-- Modals -->
  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ -->
  <div id="modal-overlay"></div>
  <div
    id="employee-modal">
    <div style="display: flex; align-items: center; justify-content: space-between; padding: 20px 20px 0 20px;">
      <div style="display: flex; align-items: center;">
        <img 
        id="modal-emp-avatar" 
        src="https://i.ibb.co/YrbxqCn/favicon.jpg" 
        alt="Avatar" 
        style="width: 60px; height: 60px; border-radius: 50%; margin-right: 15px;"
      />
        <div>
          <h5 id="modal-emp-name" style="margin: 0; font-weight: 600;">Employee Name</h5>
          <div id="modal-emp-email-wrap" style="display:flex; align-items:center; gap:6px; position:relative;">
          <small id="modal-emp-email" style="color:#888; cursor:pointer;" title="Click to copy"></small>
          <img id="modal-copy-email-btn"
               src="https://www.svgrepo.com/show/506467/copy.svg"
               alt="Copy" width="16" height="16"
               style="cursor:pointer" title="Copy e-mail" />
        </div>
        </div>
      </div>
      <span class="close-btn" id="modal-close" style="cursor: pointer; font-size: 24px; color: #999;">&times;</span>
    </div>
    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div style="padding: 15px 20px 0 20px; text-align: left;">
      <div style="margin-bottom: 10px;">
        <strong>Role:</strong>
        <span id="modal-emp-role">Support Associate</span>
      </div>
      <div style="margin-bottom: 10px;">
        <strong>Prime platform:</strong>
        <span id="modal-emp-prime">CS</span>
      </div>
      <div style="margin-bottom: 10px;">
        <strong>Preferred platform:</strong>
        <span id="modal-emp-pref">PSR</span>
      </div>
      <div style="margin-bottom: 10px;">
        <strong>Can reallocate?:</strong>
        <span id="modal-emp-realloc">Yes</span>
      </div>
      <div style="margin-bottom: 10px;">
        <strong>Language:</strong>
        <span id="modal-emp-languages">AZ RUGB</span>
      </div>
      <div style="margin-bottom: 10px;">
        <strong>Capacity:</strong>
        <span id="modal-emp-capacity">‚Äî</span>
      </div>
      <div style="margin-bottom: 10px;">
        <strong>Shift:</strong>
        <span id="modal-emp-shift">‚Äî</span>
      </div>
      <div style="margin-bottom: 10px;">
        <strong>Break:</strong>
        <span id="modal-emp-break">‚Äî</span>
      </div>
      <div style="margin-bottom: 10px;">
        <strong>Platform changes today:</strong>
        <span id="modal-platform-count">‚Äì</span>
      </div>
      <ul id="modal-platform-list" style="margin-left: 20px; font-size:0.9rem;"></ul>

    </div>
    <!-- –ö–Ω–æ–ø–∫–∏ -->
    <div class="d-flex justify-content-end modal-footer" style="gap:8px; padding:20px;">
    <button id="modal-inbox-link" class="btn btn-primary btn-sm">Open Inbox</button>
    <button id="modal-admin-link" class="btn btn-outline-primary btn-sm">Admin Panel</button>
    <button id="brb-correct-btn"   class="btn btn-warning btn-sm">BRB Time c-on</button>
    <button id="modal-end-shift"     class="btn btn-danger btn-sm">End Shift</button>
  </div>
  </div>


  
    <!-- –°–µ–∫—Ü–∏—è —Å –¥–≤—É–º—è –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏: Shift-Overs –∏ Breaks -->
    <div
  id="alerts-section"
  class="d-flex flex-wrap gap-4 justify-content-center my-4 px-3"
  style="align-items: stretch;"
>

    <div
      class="modal fade"
      id="candidateModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="candidateModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="candidateModalLabel">Recommended candidates</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" id="candidateModalBody">
            <!-- —Å—é–¥–∞ JS –≤—Å—Ç–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <!-- ================================================== -->
      
      
      <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º jQuery, Bootstrap JS –∏ Bootstrap-Select JS -->
      <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.18/js/bootstrap-select.min.js"></script>
      <script>
        // ========== Do Not Disturb ==========
        let doNotDisturb = localStorage.getItem('doNotDisturb') === 'true';

        function setDoNotDisturb(value) {
          doNotDisturb = value;
          localStorage.setItem('doNotDisturb', value);
        }

        // —á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ
        // –æ—á–µ—Ä–µ–¥—å –¥–ª—è –ø–∞–Ω–µ–ª–∏ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
        const notificationQueue = [];


        // -------------- begin shift‚Äêbadge config --------------

        // map –ø–ª–∞—Ç—Ñ–æ—Ä–º ‚Üí bootstrap‚Äê–∫–ª–∞—Å—Å –±–µ–π–¥–∂–∞

        // –≤–º–µ—Å—Ç–æ platformBadgeClasses
        const shiftBadgeClasses = {
        "CS":      "badge-primary",
        "CS PO":   "badge-danger",
        "PSR":     "badge-success",
        "Simo":    "badge-info",
        "Aircall": "badge-warning",
        "Venue":   "badge-warning",
        "Trainee": "badge-light text-dark",
        "ST":      "badge-dark",
        "SUMO":    "badge-secondary",
      };

      const shiftDisplayNames = {
      "CS/Post order": "CS PO",
      "CS/Post Order": "CS PO",
      "CS / Post order": "CS PO",
      "CS / Post Order": "CS PO",
      "Special task": "ST",
      "SiMo/Aircall": "SUMO",
    };
        // –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –≤–∏–¥–∞ "06:00-15:00" –¥–ª—è –∏–º–µ–Ω–∏
        // –≤–º–µ—Å—Ç–æ "getEmployeeShift" ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–º–µ–Ω—ã, –∞ –Ω–µ –≤—Ä–µ–º—è
        
        function processEmployeeSelection(name) {
          if (!name) return;
          const items = Array.from(document.querySelectorAll('.employee-item'));
          const el = items.find(li =>
            li.dataset.employee.toLowerCase().includes(name.toLowerCase())
          );

          if (el) {
            el.scrollIntoView({ behavior: "smooth", block: "center" });
            el.classList.add("pulse-highlight");
            setTimeout(() => el.classList.remove("pulse-highlight"), 3000);
          } else {
            openEmployeeModal(name);
          }
        }
        
      function initAutocomplete() {
      const inp      = document.getElementById('employee-search');
      const list     = document.getElementById('autocomplete-list');
      const clearBtn = document.getElementById('clear-search-button');
      const wrap     = inp.parentElement; // .autocomplete wrapper
      let currentFocus = -1;               // –¥–ª—è —Å—Ç—Ä–µ–ª–æ—á–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏

      // –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –∫—Ä–µ—Å—Ç–∏–∫
      clearBtn.style.display = inp.value.trim() ? 'block' : 'none';

      // –æ—á–∏—Å—Ç–∫–∞ –ø–æ –∫–ª–∏–∫—É –Ω–∞ √ó
      clearBtn.addEventListener('click', () => {
        inp.value = '';
        list.innerHTML = '';
        clearBtn.style.display = 'none';
        inp.focus();
      });

      // –≤–≤–æ–¥ –≤ –ø–æ–ª–µ
      inp.addEventListener('input', () => {
        const val = inp.value.trim().toLowerCase();
        clearBtn.style.display = val ? 'block' : 'none';
        list.innerHTML = '';
        if (!val) return;

        const matches = Object.keys(employeeData)
          .filter(name => name.toLowerCase().includes(val))
          .slice(0, 10);

        matches.forEach(name => {
          const item = document.createElement('div');
          item.textContent = name;
          item.addEventListener('click', () => {
            inp.value = name;
            list.innerHTML = '';
            clearBtn.style.display = 'block';
            processEmployeeSelection(name);
          });
          list.appendChild(item);
        });
        currentFocus = -1;
      });

      // —Å—Ç—Ä–µ–ª–∫–∏ –∏ Enter
      inp.addEventListener('keydown', e => {
        const items = list.getElementsByTagName('div');
        if (e.key === 'ArrowDown') {
          currentFocus++;
          addActive(items);
          e.preventDefault();
        }
        else if (e.key === 'ArrowUp') {
          currentFocus--;
          addActive(items);
          e.preventDefault();
        }
        else if (e.key === 'Enter') {
          e.preventDefault();
          if (currentFocus > -1 && items[currentFocus]) {
            items[currentFocus].click();
          } else {
            processEmployeeSelection(inp.value.trim());
          }
        }
      });

      // –∫–ª–∏–∫ –≤–Ω–µ –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞ ‚Äî –∑–∞–∫—Ä—ã—Ç—å —Å–ø–∏—Å–æ–∫ –∏ —Å–ø—Ä—è—Ç–∞—Ç—å √ó
      document.addEventListener('click', e => {
        if (!wrap.contains(e.target)) {
          list.innerHTML = '';
          if (!inp.value.trim()) {
            clearBtn.style.display = 'none';
          }
        }
      });

      // –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ
      function addActive(items) {
        if (!items) return;
        removeActive(items);
        if (currentFocus >= items.length) currentFocus = 0;
        if (currentFocus < 0) currentFocus = items.length - 1;
        items[currentFocus].classList.add('autocomplete-active');
      }
      function removeActive(items) {
        Array.from(items).forEach(i => i.classList.remove('autocomplete-active'));
      }
    }


        function getEmployeeShiftName(empName) {
          const rec = window.shiftsQuinyxData.find(r =>
            r.name.toLowerCase() === empName.toLowerCase()
          );
          return rec?.platform || "";
        }


        // -------------- end shift‚Äêbadge config --------------

        // ===============================
        // WEATHER SECTION WITH CACHING & EMOJI
        const OPENWEATHER_API_KEY = "f97220cfb6bcefa391405990e7b9825d";
        const STORAGE_KEY = "notifiedEmptyPlatforms";

        let notifiedEmpty = new Set(
  JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]")
);

// 1) –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ ‚Äî –ø—É—à–∏–º –≤ Realtime Database
document
  .getElementById("send-update-notif")
  .addEventListener("click", () => {
    const notifRef = database.ref("notifications");
    const payload = {
      title: "Support Monitoring Dashboard updated",
      text:  "Please, refresh the page for smooth work",
      ts:    firebase.database.ServerValue.TIMESTAMP
    };
    notifRef.push(payload)
      .then(() => {
        alert("Notification sent to all users");
      })
      .catch(err => {
        console.error("Error sending notification:", err);
      });
  });
// 1) –ú–∞—Å—Å–∏–≤ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
let readNotifs = JSON.parse(localStorage.getItem('readNotifs') || '[]');

// 2) –•–µ–ª–ø–µ—Ä –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
function markAsRead(key) {
  if (!readNotifs.includes(key)) {
    readNotifs.push(key);
    localStorage.setItem('readNotifs', JSON.stringify(readNotifs));
  }
}

// 1) –ü–æ–ª—É—á–∞–µ–º —Å—Å—ã–ª–∫—É
const notificationsRef = database.ref("notifications");

// 2) –°–Ω–∞—á–∞–ª–∞ –≥—Ä—É–∑–∏–º –≤—Å–µ —Ç–µ–∫—É—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö –∫–ª—é—á–∏ –≤ readNotifs
notificationsRef.once("value").then(snapshot => {
  snapshot.forEach(childSnap => {
    const key = childSnap.key;
    if (!readNotifs.includes(key)) {
      readNotifs.push(key);
    }
  });
  // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ localStorage
  localStorage.setItem('readNotifs', JSON.stringify(readNotifs));

  // 3) –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –Ω–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  notificationsRef.on("child_added", snap => {
    const key = snap.key;
    if (readNotifs.includes(key)) return;      // —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º

    const { title, text } = snap.val();
    showGlobalNotification(title, text, key);
  });
});


// 4) –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–ø–ª—ã–≤–∞—à–∫–∏ —Å –ø–µ—Ä–µ–¥–∞—á–µ–π key
function showGlobalNotification(title, text, key) {
  const div = document.createElement("div");
  div.className = "global-notification";
  div.innerHTML = `
    <span class="close-x" style="
      position:absolute; top:6px; right:8px; cursor:pointer;
      font-size:14px; color:#fff;
    ">√ó</span>
    <strong>${title}</strong><br>
    ${text}
    <a href="#" class="refresh-link">Refresh</a>
  `;
  document.body.appendChild(div);

  // –∫—Ä–µ—Å—Ç–∏–∫ ¬´√ó¬ª
  div.querySelector(".close-x").addEventListener("click", () => {
    markAsRead(key);
    div.remove();
  });

  // ¬´Refresh¬ª
  div.querySelector(".refresh-link").addEventListener("click", e => {
    e.preventDefault();
    markAsRead(key);
    location.reload();
  });
}


/**
 * –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–æ–≥–æ–¥—É –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞ –∏ –∫–ª–∞–¥—ë—Ç
 * —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —É–∫–∞–∑–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã.
 *
 * @param {string} city       ‚Äî —Å—Ç—Ä–æ–∫–∞ –≤–∏–¥–∞ "Ganja,AZ"
 * @param {string} tempElemId ‚Äî id –±–ª–æ–∫–∞ –¥–ª—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä "temp-ganja")
 * @param {string} windElemId ‚Äî id –±–ª–æ–∫–∞ –¥–ª—è –≤–µ—Ç—Ä–∞       (–Ω–∞–ø—Ä–∏–º–µ—Ä "wind-ganja")
 */
async function fetchWeatherFor(city, tempElemId, windElemId) {
  const cacheKey     = city + "_weatherData";
  const cacheTimeKey = city + "_weatherTimestamp";
  const now          = Date.now();
  const cacheTTL     = 15 * 60 * 1000; // 15 –º–∏–Ω—É—Ç

  let data;
  const rawData      = localStorage.getItem(cacheKey);
  const rawTs        = localStorage.getItem(cacheTimeKey);

  if (rawData && rawTs && now - rawTs < cacheTTL) {
    data = JSON.parse(rawData);
  } else {
    const url = `https://api.openweathermap.org/data/2.5/weather` +
                `?q=${encodeURIComponent(city)}` +
                `&units=metric&appid=${OPENWEATHER_API_KEY}`;
    const res = await fetch(url);
    if (!res.ok) {
      console.error("Weather API error for", city, res.statusText);
      return;
    }
    data = await res.json();
    localStorage.setItem(cacheKey, JSON.stringify(data));
    localStorage.setItem(cacheTimeKey, now);
  }

  // Build display strings
  const tempRaw   = data.main?.temp;
  const windRaw   = data.wind?.speed;
  const emoji     = (() => {
    const cond = data.weather?.[0]?.main;
    switch(cond){
      case "Clear":       return "‚òÄÔ∏è";
      case "Clouds":      return "‚òÅÔ∏è";
      case "Rain":
      case "Drizzle":     return "üåßÔ∏è";
      case "Thunderstorm":return "‚õàÔ∏è";
      case "Snow":        return "‚ùÑÔ∏è";
      default:            return "";
    }
  })();

  const tempText = (tempRaw != null)
    ? `${Math.round(tempRaw)} ¬∞C ${emoji}`
    : "-- ¬∞C";
  const windText = (typeof windRaw === "number")
    ? `${Math.round(windRaw * 10) / 10} m/s`
    : "-- m/s";

  // –í—Å—Ç–∞–≤–ª—è–µ–º –≤ DOM
  const tempElem = document.getElementById(tempElemId);
  const windElem = document.getElementById(windElemId);
  tempElem.textContent = tempText;
  windElem.textContent = windText;

  // --- –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ —Å–∏–ª—å–Ω–æ–º –≤–µ—Ç—Ä–µ ---
  const STRONG_WIND_THRESHOLD = 10; // –º/—Å
  const cardEl = tempElem.closest('.stats-card');
  // —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
  const prevWarn = cardEl.querySelector('.wind-warning');
  if (prevWarn) prevWarn.remove();

  if (windRaw > STRONG_WIND_THRESHOLD) {
    const warn = document.createElement('div');
    warn.className = 'wind-warning';
    warn.innerHTML = `
      ‚ö†Ô∏è <strong>Strong wind!</strong><br>
      City state needs to be turned on.
    `;
    cardEl.appendChild(warn);
  }
}


        
        // ===============================

        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º
        const platformInfo = {
          "CS":
            "Click on the link to open the CS platform.\nClick on employee name to open their profile.",
          "CS/Post order":
            "Click on the link to open the CS PO AZE platform.\nClick on employee name to open their profile.",
          PSR: "Click on the link to open the PSR platform.\nClick on employee name to open their profile.",
          SiMo: "Click on the link to open the Support Inbox.\nClick on employee name to open their profile.",
          Aircall:
            "Click on the link to open the Snooze platform.\nClick on employee name to open their profile.\n You can see employee's status in the Aircall.",
          Venue:
            "Click on the link to open the Venue platform.\nClick on employee name to open their profile.",
          Trainee: "Click on employee name to open their profile.",
          ST: "Click on employee name to open their profile."
        };

        let fetchedData = null;
        let currentSearchTerm = "";
        let currentStatusFilter = "both";
        let currentPlatformFilter = ["all"];
        let currentReallocFilter = "all";
        let currentLangFilter = "all";
        let currentBreakFilter = "upcoming";

        const SPREADSHEET_ID = "1dICKOxxz9R3x8MY3FKQ9I-IwR9fBUDfMOT9PFDLloAE";
        const SHIFT_RANGE = "list1!AT5:BH47";
        const RANGE = "list1!A1:BJ100";
        const RESPONSIBLES_RANGE = "responsiblepeople!A:B";
        const BREAKS_RANGE = "prebreaks!A1:D80";
        const SHIFT_QUINYX_RANGE = "shiftsquinyx!B3:C"; 

        let employeeData = {};

        const platforms = [
          {
            name: "CS",
            url: "https://ops.wolt.com/support/converse/conversations?conversationListId=6643245bfadf62c6edc28feb",
            colIndexNames: 3,
            colIndexData: 4,
            rowActiveNamesStart: 4,
            rowActiveNamesEnd: 27,
            rowAwayNamesStart: 28,
            rowAwayNamesEnd: 47
          },
          {
            name: "CS/Post order",
            url: "https://ops.wolt.com/support/converse/conversations?conversationListId=664324a0510ac011feaa798c",
            colIndexNames: 5,
            colIndexData: 6,
            rowActiveNamesStart: 4,
            rowActiveNamesEnd: 27,
            rowAwayNamesStart: 28,
            rowAwayNamesEnd: 47
          },
          {
            name: "PSR",
            url: "https://ops.wolt.com/support/converse/conversations?conversationListId=6567a44af7d470550b11dc68",
            colIndexNames: 7,
            colIndexData: 8,
            rowActiveNamesStart: 4,
            rowActiveNamesEnd: 27,
            rowAwayNamesStart: 28,
            rowAwayNamesEnd: 47
          },
          {
            name: "SiMo",
            url: "https://ops.wolt.com/support/converse/conversations?conversationListId=6668088fc6d870f3cfd61653",
            colIndexNames: 9,
            colIndexData: 10,
            rowActiveNamesStart: 4,
            rowActiveNamesEnd: 27,
            rowAwayNamesStart: 28,
            rowAwayNamesEnd: 47
          },
          {
            name: "Aircall",
            url: "https://ops.wolt.com/support/converse/conversations?conversationListId=671a26a2a5b9ae4a2ca603fb",
            colIndexNames: 11,
            colIndexData: 12,
            rowActiveNamesStart: 4,
            rowActiveNamesEnd: 27,
            rowAwayNamesStart: 28,
            rowAwayNamesEnd: 47
          },
          {
            name: "Venue",
            url: "https://ops.wolt.com/support/converse/conversations?conversationListId=666807fc28b3f1231948f407",
            colIndexNames: 13,
            colIndexData: 14,
            rowActiveNamesStart: 4,
            rowActiveNamesEnd: 27,
            rowAwayNamesStart: 28,
            rowAwayNamesEnd: 47
          },
          {
            name: "Trainee",
            url: "https://wolt.com/",
            colIndexNames: 15,
            colIndexData: 16,
            rowActiveNamesStart: 4,
            rowActiveNamesEnd: 27,
            rowAwayNamesStart: 28,
            rowAwayNamesEnd: 47
          },
          {
            name: "ST",
            url: "https://wolt.com/",
            colIndexNames: 17,
            colIndexData: 18,
            rowActiveNamesStart: 4,
            rowActiveNamesEnd: 27,
            rowAwayNamesStart: 28,
            rowAwayNamesEnd: 47
          }
        ];

        let aircallActive = [];
        let aircallAway = [];

        function logDebug(message) {
          console.log(message);
        }

        async function fetchSheetData(range) {
        try {
          // –î–æ–±–∞–≤–ª—è–µ–º cache-busting –ø–∞—Ä–∞–º–µ—Ç—Ä –∏ –æ—Ç–∫–ª—é—á–∞–µ–º HTTP-–∫—ç—à
          const url = `https://sheets-proxy.mikhail-garayev.workers.dev?cacheBust=${Date.now()}`;
          const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            cache: "no-store",
            body: JSON.stringify({
              secret: "superWoltKey42",
              range: range
            })
          });
          if (!res.ok) {
            throw new Error(`HTTP ${res.status}`);
          }
          const data = await res.json();
          return data.values;
        } catch (e) {
          console.error("Sheets proxy error:", e);
          return null;
        }
      }


        async function fetchEmployeeList() {
  // —Ç–µ–ø–µ—Ä—å A‚ÄìH: A: Name, B: ID, C: CanReallocate, D: Prime, E: Pref, F: Languages, G: Capacity, H: StartDate
  const data = await fetchSheetData("emplist!A1:H");
  if (!data || data.length < 2) return;

  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    const empName           = row[0]?.trim();
    if (!empName) continue;

    const empId             = row[1]?.trim() || "";
    const canRealloc        = row[2]?.trim() || "No";
    const primePlatform     = row[3]?.trim() || "N/A";
    const preferredPlatform = row[4]?.trim() || "N/A";
    const languages         = row[5]?.trim() || "";
    const capacity          = row[6]?.trim() || "";
    const startDateRaw      = row[7]?.trim() || "";

    employeeData[empName] = {
      id:            empId,
      canReallocate: canRealloc,
      prime:         primePlatform,
      pref:          preferredPlatform,
      languages:     languages,
      capacity:      capacity,
      startDate:     startDateRaw
    };
  }
}
      

        function generateInboxLink(empId) {
          return (
            "https://ops.wolt.com/support/converse/users/conversations?assigneeIds=" +
            encodeURIComponent(empId)
          );
        }

        function generateAdminLink(empId) {
          return (
            "https://ops.wolt.com/support/converse/admin/users?userId=" +
            encodeURIComponent(empId)
          );
        }
        
        
        // –í—Å—Ç–∞–≤—å—Ç–µ –≥–¥–µ-–Ω–∏–±—É–¥—å —Ä—è–¥–æ–º —Å –¥—Ä—É–≥–∏–º–∏ —É—Ç–∏–ª–∏—Ç–∞–º–∏
function normalize(str) {
  return String(str || "")
    .toLowerCase()
    .replace(/[\s\/-]+/g, ""); // —É–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã, –∫–æ—Å—É—é —á–µ—Ä—Ç—É, –¥–µ—Ñ–∏—Å
}
// –ø–∞—Ä—Å–∏—Ç —Å—Ç—Ä–æ–∫–∏ –≤–∏–¥–∞ "DD.MM.YYYY HH:mm:ss" ‚Üí JS Date
// –ø–∞—Ä—Å–∏—Ç —Å—Ç—Ä–æ–∫–∏ –≤–∏–¥–∞ "DD.MM.YYYY HH:mm:ss" ‚Üí JS Date,
// –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∏–ª–∏ –Ω–µ–ø–æ–ª–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –±–µ–∑ –ø–∞–¥–µ–Ω–∏—è
function parseDDMMYYYY(str) {
  if (typeof str !== 'string') {
    console.warn('parseDDMMYYYY got non-string:', str);
    return new Date(str);           // –ø–æ–ø—Ä–æ–±—É–µ–º native-–ø–∞—Ä—Å–µ—Ä
  }

  // —Ä–∞–∑–¥–µ–ª—è–µ–º –ø–æ –ª—é–±–æ–º—É —á–∏—Å–ª—É –ø—Ä–æ–±–µ–ª–æ–≤
  const parts = str.trim().split(/\s+/);
  if (parts.length < 2) {
    // –Ω–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ ‚Äî –ø–æ–ø—ã—Ç–∫–∞ native-–ø–∞—Ä—Å–µ—Ä–∞
    return new Date(str);
  }
  const [datePart, timePart] = parts;

  const dp = datePart.split('.');
  if (dp.length !== 3) {
    console.warn('parseDDMMYYYY got bad datePart:', datePart);
    return new Date(str);
  }
  let [day, month, year] = dp;

  // –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –ø–æ –¥–≤–µ —Ü–∏—Ñ—Ä—ã
  day   = String(day).padStart(2,'0');
  month = String(month).padStart(2,'0');

  // —Ñ–æ—Ä–º–∏—Ä—É–µ–º ISO-—Å—Ç—Ä–æ–∫—É
  const iso = `${year}-${month}-${day}T${timePart}`;
  const d = new Date(iso);
  if (isNaN(d.getTime())) {
    console.warn('parseDDMMYYYY failed to parse:', iso);
    return new Date(str);
  }
  return d;
}



async function openEmployeeModal(empName) {
  const info = employeeData[empName];
  if (!info) {
    console.warn("–î–∞–Ω–Ω—ã–µ –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã: " + empName);
    return;
  }

  // 1) –°–º–µ–Ω–∞
  const rec = window.shiftsQuinyxData.find(
    r => r.name.toLowerCase() === empName.toLowerCase()
  ) || {};
  const shiftName = rec.platform || "‚Äî";
  const shiftTime = rec.shift    || "‚Äî";
  document.getElementById("modal-emp-shift").textContent =
    `${shiftName} (${shiftTime})`;

  // 2) –ü–µ—Ä–µ—Ä—ã–≤
  let breakTime = "‚Äî";
  if (Array.isArray(window.allBreaksData)) {
    const br = window.allBreaksData.find(b =>
      b.Name?.trim().toLowerCase() === empName.trim().toLowerCase()
    );
    if (br) breakTime = br.BreakTime || "‚Äî";
  }
  document.getElementById("modal-emp-break").textContent = breakTime;

  // 3) –û–±—â–∞—è –∏–Ω—Ñ–∞ + e-mail
  const parts = empName.trim().split(" ");
  const rawEmail = parts.length >= 2
    ? `${parts[0].toLowerCase()}.${parts[1].toLowerCase()}@wolt.com`
    : `${parts[0].toLowerCase()}@wolt.com`;
  const email = normalizeEmail(rawEmail);

  document.getElementById("modal-emp-name").textContent      = empName;
  document.getElementById("modal-emp-email").textContent     = email;
  document.getElementById("modal-emp-realloc").textContent   = info.canReallocate || "N/A";
  document.getElementById("modal-emp-prime").textContent     = info.prime         || "N/A";
  document.getElementById("modal-emp-pref").textContent      = info.pref          || "N/A";
  document.getElementById("modal-emp-languages").textContent = info.languages     || "N/A";
  document.getElementById("modal-emp-capacity").textContent  = info.capacity      || "N/A";

  document.getElementById("modal-inbox-link").onclick = () => {
    window.open(generateInboxLink(info.id), "_blank");
  };
  document.getElementById("modal-admin-link").onclick = () => {
    window.open(generateAdminLink(info.id), "_blank");
  };
  // –Ω–æ–≤—ã–π –∫–æ–¥:
  // –≤ —Å–∞–º–æ–º –≤–µ—Ä—Ö—É openEmployeeModal, —Ä—è–¥–æ–º —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏ —Å—Å—ã–ª–∫–∞–º–∏:
const endBtn = document.getElementById("modal-end-shift");           // ‚Üê –ø–æ–º–µ–Ω—è–ª id (–≤ HTML —É –≤–∞—Å button id="end-shift-btn")
endBtn.addEventListener("click", async () => {
  const employeeEmail = document.getElementById("modal-emp-email").textContent.trim();
  const adminEmail    = auth.currentUser.email;
  try {
    await fetch(
      "https://script.google.com/macros/s/AKfycbxVDXb7piIXJ8qhv8YPVLc0i08othqGVjcoIMsDxWveTBm95z1v6j4ZEQgEs-GN8EtC-w/exec",             // ‚Üê –∑–¥–µ—Å—å –≤–∞—à URL Google Apps Script
      {
        method:  "POST",
        mode:    "no-cors",
        headers: { "Content-Type": "application/json" },
        body:    JSON.stringify({ admin: adminEmail, employee: employeeEmail })
      }
    );
    alert("End shift workflow triggered ‚úÖ");
    closeEmployeeModal();
  } catch (err) {
    console.error("End shift error:", err);
    alert("Failed to trigger End shift: " + err.message);
  }
});

// ‚Üì‚Üì‚Üì –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –±–ª–æ–∫ –ø–æ–¥ –Ω–∏–º ‚Äî BRB time correction ‚Üì‚Üì‚Üì

// –í–æ-–ø–µ—Ä–≤—ã—Ö, –≤ HTML –∫ –º–æ–¥–∞–ª–∫–µ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É:
//   <button id="brb-correct-btn" class="btn btn-secondary">BRB time correction</button>

const brbBtn = document.getElementById("brb-correct-btn");
brbBtn.addEventListener("click", async () => {
  const employeeEmail = document.getElementById("modal-emp-email").textContent.trim();
  const adminEmail    = auth.currentUser.email;
  const minutesStr    = prompt("Enter BRB correction (minutes):", "0");
  const minutes       = Number(minutesStr);
  if (!minutesStr || isNaN(minutes) || minutes < 0) {
    return alert("Invalid number of minutes");
  }

  try {
    await fetch(
      "https://script.google.com/macros/s/AKfycbxVDXb7piIXJ8qhv8YPVLc0i08othqGVjcoIMsDxWveTBm95z1v6j4ZEQgEs-GN8EtC-w/exec",             // ‚Üê —Ç–æ—Ç –∂–µ URL Apps Script
      {
        method:  "POST",
        mode:    "no-cors",
        headers: { "Content-Type": "application/json" },
        body:    JSON.stringify({
          admin:    adminEmail,
          employee: employeeEmail,
          minutes:  minutes
        })
      }
    );
    alert("BRB time correction sent ‚úÖ");
    closeEmployeeModal();
  } catch (err) {
    console.error("BRB correction error:", err);
    alert("Failed to send BRB correction: " + err.message);
  }
});



  // 4) –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
  const countEl = document.getElementById("modal-platform-count");
  const listEl  = document.getElementById("modal-platform-list");
  countEl.textContent = "‚Ä¶";
  listEl.innerHTML    = "<li>Loading‚Ä¶</li>";

  // 5) –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª–∫–∏
  document.getElementById("modal-overlay").classList.add("show");
  document.getElementById("employee-modal").classList.add("show");

  // 6) –ö–Ω–æ–ø–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è e-mail + –∞–Ω–∏–º–∞—Ü–∏—è ¬´Copied!¬ª + —Ç—ë–º–Ω–∞—è/—Å–≤–µ—Ç–ª–∞—è –∏–∫–æ–Ω–∫–∞
  const emailEl = document.getElementById("modal-emp-email");
  let copyBtn   = document.getElementById("modal-copy-email-btn");

  // —Å–±—Ä–æ—Å —Å—Ç–∞—Ä—ã—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π
  copyBtn.replaceWith(copyBtn.cloneNode(true));
  copyBtn = document.getElementById("modal-copy-email-btn");

  // –ø–æ–¥—Å—Ç—Ä–æ–π–∫–∞ —Ü–≤–µ—Ç–∞ –∏–∫–æ–Ω–∫–∏ –ø–æ–¥ —Ç–µ–º—É
  function updateCopyIconColor() {
    if (document.body.classList.contains("dark-theme")) {
      copyBtn.style.filter = "invert(1)";
    } else {
      copyBtn.style.filter = "";
    }
  }
  updateCopyIconColor();
  // –µ—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã
  const themeToggle = document.getElementById("theme-checkbox");
  if (themeToggle) {
    themeToggle.addEventListener("change", updateCopyIconColor);
  }

  function copyEmailToClipboard() {
    const text = emailEl.textContent.trim();
    navigator.clipboard.writeText(text).then(() => {
      // —É–±—Ä–∞—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ñ–∏–¥–±—ç–∫
      const old = document.querySelector(".copy-feedback");
      if (old) old.remove();

      const wrapper = emailEl.parentElement;
      wrapper.style.position = wrapper.style.position || "relative";

      const fb = document.createElement("div");
      fb.className = "copy-feedback";
      fb.textContent = "Copied!";
      wrapper.appendChild(fb);

      // –∑–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é
      requestAnimationFrame(() => fb.classList.add("show"));

      // —É–±—Ä–∞—Ç—å —á–µ—Ä–µ–∑ 1.5 —Å–µ–∫—É–Ω–¥—ã
      setTimeout(() => {
        fb.classList.remove("show");
        setTimeout(() => fb.remove(), 200);
      }, 1500);
    })
    .catch(err => console.error("Copy failed:", err));
  }

  copyBtn.addEventListener("click", copyEmailToClipboard);
  emailEl.addEventListener("click", copyEmailToClipboard);

  // 7) –ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Ä–µ–Ω–¥–µ—Ä –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
  try {
    const url = `${TRANSITIONS_API}&name=${encodeURIComponent(empName)}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(res.statusText);
    const moves = await res.json();

    countEl.textContent = moves.length || "0";
    if (moves.length) {
      listEl.innerHTML = moves.map(r => {
        // [‚Ä¶, toPlatform, ‚Ä¶, from, to, duration]
        const [, toPlat, , fromStr, toStr, durStr] = r;
        return `
          <li>
            <strong>${fromStr}</strong> ‚Üí <strong>${toStr}</strong><br>
            To: <em>${toPlat}</em> (Duration ${durStr})
          </li>
        `;
      }).join("");
    } else {
      listEl.innerHTML = "<li>No platform changes today</li>";
    }
  } catch (err) {
    console.error("Error loading transitions:", err);
    countEl.textContent = "‚Äî";
    listEl.innerHTML    = `<li class="text-danger">Error loading data</li>`;
  }
}





        function closeEmployeeModal() {
          document.getElementById("employee-modal").classList.remove("show");
          document.getElementById("modal-overlay").classList.remove("show");
        }


        async function getAircallUserId(email) {
          try {
            const res = await fetch("https://aircall-proxy.mikhail-garayev.workers.dev", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                secret: "superWoltKey42",
                email: email
              })
            });
        
            if (!res.ok) {
              logDebug(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ Aircall: ${res.statusText}`);
              return null;
            }
        
            const data = await res.json();
        
            if (!data?.user?.id) {
              logDebug("Aircall API –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç");
              return null;
            }
        
            logDebug(`–ü–æ–ª—É—á–µ–Ω Aircall ID: ${data.user.id}`);
            return data.user.id;
        
          } catch (err) {
            logDebug("–û—à–∏–±–∫–∞ getAircallUserId —á–µ—Ä–µ–∑ Worker: " + err.message);
            return null;
          }
        }

        async function getAircallAvailability(userId) {
          if (!userId) {
            logDebug("getAircallAvailability: userId –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω");
            return "No ID";
          }
        
          try {
            const res = await fetch("https://aircall-proxy.mikhail-garayev.workers.dev", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                secret: "superWoltKey42",
                userId: userId,
                action: "availability"
              })
            });
        
            if (!res.ok) {
              logDebug("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ —á–µ—Ä–µ–∑ Worker: " + res.statusText);
              return "Error";
            }
        
            const data = await res.json();
        
            const status =
              data?.user_availability?.availability_status || data?.availability;
        
            logDebug(`–°—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ Worker: ${status}`);
            return status || "Unknown";
        
          } catch (err) {
            logDebug("–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –≤ getAircallAvailability —á–µ—Ä–µ–∑ Worker: " + err.message);
            return "Error";
          }
        }

        function passReallocAndLang(empName) {
          const info = employeeData[empName];
          if (!info) return false;
          if (currentReallocFilter !== "all") {
            if (info.canReallocate !== currentReallocFilter) return false;
          }
          if (currentLangFilter !== "all") {
            let lang = info.languages.replace(/\s+/g, "");
            if (currentLangFilter === "two") {
              if (!(lang.includes("üá¶üáø") && lang.includes("üá¨üáß")) || lang.includes("üá∑üá∫")) {
                return false;
              }
            } else if (currentLangFilter === "three") {
              if (!(lang.includes("üá¶üáø") && lang.includes("üá¨üáß") && lang.includes("üá∑üá∫"))) {
                return false;
              }
            }
          }
          return true;
        }

function applyFilters() {
  const container = document.getElementById("platforms-container");
  const settings = loadNotifSettings();
  container.innerHTML = "";

  const now = new Date();
  const SOON_MS = 10 * 60 * 1000;

  // 1) –ó–∞ 10 –º–∏–Ω—É—Ç –¥–æ –∫–æ–Ω—Ü–∞ —Å–º–µ–Ω—ã
  const endingSoon = new Set();
  if (Array.isArray(window.shiftsQuinyxData)) {
    window.shiftsQuinyxData.forEach(rec => {
      const name     = rec.name?.trim();
      const shiftStr = rec.shift;
      if (!name || typeof shiftStr !== "string" || !shiftStr.includes("-")) return;
      const endStr = shiftStr.split("-")[1];
      const [h, m] = endStr.split(":").map(Number);
      if (isNaN(h) || isNaN(m)) return;
      const endDt = new Date(now);
      endDt.setHours(h, m, 0, 0);
      if (endDt > now && (endDt - now) <= SOON_MS) {
        endingSoon.add(name);
      }
    });
  }

  // 2) –ó–∞ 10 –º–∏–Ω—É—Ç –¥–æ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–µ—Ä—ã–≤–∞ (BRB/Break)
  const breakSoon = new Set();
  if (Array.isArray(window.allBreaksData)) {
    window.allBreaksData.forEach(r => {
      const name    = r.Name?.trim();
      const timeStr = r.BreakTime;
      if (!name || !timeStr) return;
      const [h, m] = timeStr.split(":").map(Number);
      if (isNaN(h) || isNaN(m)) return;
      let dtBreak = new Date(now);
      dtBreak.setHours(h, m, 0, 0);
      if (dtBreak <= now) dtBreak.setDate(dtBreak.getDate() + 1);
      const delta = dtBreak - now;
      if (delta > 0 && delta <= SOON_MS) {
        breakSoon.add(name);
      }
    });
  }

  platforms.forEach(platform => {
    if (!currentPlatformFilter.includes("all") &&
        !currentPlatformFilter.includes(platform.name)) {
      return;
    }

    // –ù–ï Aircall
    if (platform.name !== "Aircall") {
      // –°–æ–±–∏—Ä–∞–µ–º activeNames –∏ awayData
      let activeNames = [];
      for (let r = platform.rowActiveNamesStart; r <= platform.rowActiveNamesEnd; r++) {
        const nm = fetchedData[r]?.[platform.colIndexNames]?.trim();
        if (nm) activeNames.push(nm);
      }
      let awayData = [];
      for (let r = platform.rowAwayNamesStart; r <= platform.rowAwayNamesEnd; r++) {
        const nm = fetchedData[r]?.[platform.colIndexNames]?.trim();
        if (!nm) continue;
        const rsn = fetchedData[r]?.[platform.colIndexData]?.trim() || "";
        awayData.push({ name: nm, reason: rsn });
      }


      // realloc/lang
      activeNames = activeNames.filter(n => passReallocAndLang(n));
      awayData    = awayData.filter(a => passReallocAndLang(a.name));

      // –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É
      let showActive = true, showAway = true;
      if (currentStatusFilter === "active") showAway = false;
      else if (currentStatusFilter === "away") showActive = false;

      // –ù–∞—á–∞–ª–æ HTML –∫–∞—Ä—Ç–æ—á–∫–∏
      let html = `
        <div class="platform-card">
          <h5>
            <a href="${platform.url}" target="_blank" rel="noopener">${platform.name}</a>
            <span class="info-icon" title="${platformInfo[platform.name]||""}">
              <img src="https://www.svgrepo.com/show/474873/info.svg" width="16" height="16"/>
            </span>
          </h5>
      `;

      // Active
      if (showActive) {
        if (activeNames.length === 0) {
          html += `<p class="text-center text-warning">‚ö†Ô∏è No active employees</p>`;
        } else {
          html += `<p><small>Active (${activeNames.length})</small></p><ul>`;
          activeNames.forEach(n => {
            const name       = n.trim();
            const rawShift   = getEmployeeShiftName(name);
            const shiftName  = shiftDisplayNames[rawShift] || rawShift;
            const badgeClass = shiftBadgeClasses[shiftName] || "badge-secondary";
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞
            const isSoonShift = endingSoon.has(name);
            const isSoonBrk   = breakSoon.has(name);
            const soonClass   = `${isSoonShift ? " shift-soon" : ""}${isSoonBrk ? " break-soon" : ""}`;
            // –ö–æ—Ä–æ–Ω–∞ –¥–ª—è –≤–∞—Å
            const crown = name.toLowerCase() === "mikhail garayev" ? " üëë" : "";

            html += `
              <li class="employee-item${soonClass}" data-employee="${name}">
                <span class="badge badge-pill ${badgeClass}">${shiftName}</span>
                <span class="employee-name">${name}${crown}</span>
              </li>`;
          });
          html += `</ul>`;
        }
      }

      // Away
      if (showAway) {
        let brbCount = 0;
        html += `<p><small>Away (${awayData.length})</small></p><ul>`;
        awayData.forEach(({name, reason}) => {
          const txt = reason || "";
          let reasonClass = "";
          if (/(Break|BRB)/.test(txt) && /-\d{1,2}:\d{2}/.test(txt)) {
            reasonClass = " break-overdue";
          }
          if (txt.includes("BRB")) brbCount++;
          const rawShift   = getEmployeeShiftName(name);
          const shiftName  = shiftDisplayNames[rawShift] || rawShift;
          const badgeClass = shiftBadgeClasses[shiftName] || "badge-secondary";
          // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ç–æ–∂–µ
          const isSoonShift = endingSoon.has(name);
          const isSoonBrk   = breakSoon.has(name);
          const soonClass   = `${isSoonShift ? " shift-soon" : ""}${isSoonBrk ? " break-soon" : ""}`;

          html += `
            <li class="employee-item${reasonClass}${soonClass}" data-employee="${name}">
              <span class="badge badge-pill ${badgeClass}">${shiftName}</span>
              <span class="employee-name">${name}</span>
              ${txt ? `<span class="text-muted">(${txt})</span>` : ""}
            </li>`;
        });
        html += `</ul>`;

        // BRB alert
        if (brbCount >= 2) {
          html += `
            <p style="text-align:center;color:red;font-size:0.95rem;">
              <span title="2 or more on BRB">&#9888;</span>
              <span style="margin-left:6px;">2 or more on BRB</span>
            </p>`;
          if (settings.brbTwoOrMore && !brbAlertSent[platform.name]) {
            const msg = `‚ö†Ô∏è ${brbCount} or more on BRB on ${platform.name}`;
            showDesktopNotification("BRB Alert", msg);
            addInPageNotification(msg);
            brbAlertSent[platform.name] = true;
          }
        } else {
          brbAlertSent[platform.name] = false;
        }
      }

      html += `</div>`;
      container.innerHTML += html;

    } else {
      // Aircall —Ä–µ–Ω–¥–µ—Ä –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
      let filteredActive = aircallActive.filter(n => n.toLowerCase() !== "away");
      let filteredAway   = aircallAway.filter(a => a.name.toLowerCase() !== "away");
      filteredActive = filteredActive.filter(n => passReallocAndLang(n));
      filteredAway   = filteredAway.filter(a => passReallocAndLang(a.name));

      const showActive = currentStatusFilter !== "away";
      const showAway   = currentStatusFilter !== "active";

      renderAircallCardWithStatuses(filteredActive, filteredAway, showActive, showAway);
    }
  });

  // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫–ª–∏–∫–∏, –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã Aircall –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Å—Ä–æ—á–∫–∏
  container.querySelectorAll(".employee-item").forEach(item => {
    item.addEventListener("click", () =>
      openEmployeeModal(item.getAttribute("data-employee"))
    );
  });
  setTimeout(() => fetchAircallStatuses().catch(console.error), 100);
  checkOverdueBRB();
}




function renderAircallCardWithStatuses(
  activeList,
  awayList,
  showActive = true,
  showAway = true
) {
  const aircallPlatform = platforms.find((p) => p.name === "Aircall");
  let html = `
    <div class="platform-card">
      <h5>
        <a href="${aircallPlatform.url}" target="_blank" rel="noopener">Aircall</a>
        <span class="info-icon" data-toggle="tooltip" title="${platformInfo["Aircall"]||""}">
          <img src="https://www.svgrepo.com/show/474873/info.svg" width="16" height="16"/>
        </span>
      </h5>`;

  // Active
  if (showActive) {
    if (!activeList.length) {
      html += `<p class="text-center text-warning">‚ö†Ô∏è No active employees</p>`;
    } else {
      html += `<p><small>Active (${activeList.length})</small></p><ul id="aircall-active-list">`;
      activeList.forEach((name, i) => {
        const rawShift   = getEmployeeShiftName(name);
        const shiftName  = shiftDisplayNames[rawShift] || rawShift;
        const badgeClass = shiftBadgeClasses[shiftName] || "badge-secondary";
        html += `
          <li class="employee-item d-flex align-items-center" data-employee="${name}">
            <span class="badge badge-pill ${badgeClass}" style="margin-right:6px;">
              ${shiftName}
            </span>
            <span class="employee-name">${name}</span>
            <span class="status-indicator status-unknown" title="Loading..." style="margin-left:6px;"></span>
          </li>
        `;
      });
      html += `</ul>`;
    }
  }

  // Away
if (showAway) {
  html += `<p><small>Away (${awayList.length})</small></p><ul>`;
  awayList.forEach(({ name, reason }) => {
    const rawShift   = getEmployeeShiftName(name);
    const shiftName  = shiftDisplayNames[rawShift] || rawShift;
    const badgeClass = shiftBadgeClasses[shiftName] || "badge-secondary";
    // –æ–ø—Ä–µ–¥–µ–ª—è–µ–º ¬´–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–æ—Å—Ç—å¬ª –ø–µ—Ä–µ—Ä—ã–≤–∞
    const isOverdue = /(?:Break|BRB)/i.test(reason) &&
                      /-\d{1,2}:\d{2}/.test(reason);
    const liClass   = isOverdue ? "break-overdue" : "";
    html += `
      <li class="employee-item d-flex align-items-center ${liClass}" data-employee="${name}">
        <span class="badge badge-pill ${badgeClass}" style="margin-right:6px;">
          ${shiftName}
        </span>
        <span class="employee-name">${name}</span>
        ${reason
          ? `<span class="text-muted" style="margin-left:6px;">(${reason})</span>`
          : ""}
        <span class="status-indicator status-unknown" title="Loading..." style="margin-left:6px;"></span>
      </li>
    `;
  });
  html += `</ul>`;
}

html += `</div>`;
document.getElementById("platforms-container").innerHTML += html;

// –ß–µ—Ä–µ–∑ 100ms –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã
setTimeout(() => fetchAircallStatuses().catch(console.error), 100);
}




const LAST_NOTHERE_KEY = 'lastNotHereCount';

function loadLastNotHereCount() {
  return localStorage.getItem(LAST_NOTHERE_KEY) || 0;
}

function saveLastNotHereCount(count) {
  localStorage.setItem(LAST_NOTHERE_KEY, count);
}

function renderShiftSummary(data) {
  const generalContainer  = document.getElementById("summary-general");
  const platformContainer = document.getElementById("summary-platforms");
  generalContainer.innerHTML  = "";
  platformContainer.innerHTML = "";

  // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–¥–ª—è Not here)
  let settings = { notHere: false };
  if (typeof loadNotifSettings === 'function') {
    try { settings = loadNotifSettings(); }
    catch (e) { console.warn('loadNotifSettings error', e); }
  }

  const summaryCards = [
    { title: "On shift now",  value: data[6][27] || "" },
    { title: "Should be",     value: data[6][29] || "" },
    { title: "CS",            value: data[6][31] || "", away: data[8][31] || "" },
    { title: "CS/Post Order", value: data[6][33] || "", away: data[8][33] || "" },
    { title: "PSR",           value: data[6][35] || "", away: data[8][35] || "" },
    { title: "SiMo",          value: data[6][41] || "", away: data[8][41] || "" },
    { title: "Aircall",       value: data[6][39] || "", away: data[8][39] || "" },
    { title: "Venue",         value: data[6][37] || "", away: data[8][37] || "" },
    { title: "Trainee",       value: data[11][41] || "", away: data[13][41] || "" },
    { title: "ST",            value: data[6][43] || "", away: data[8][43] || "" },
    {
      title: "Not here",
      value: (data[8][29] || "") + (data[10][29] ? "," + data[10][29] : "")
    },
    {
      title: "WNATS",
      value: (data[8][27] || "") + (data[10][27] ? "," + data[10][27] : "")
    }
  ];

  const platformTitles = [
    "CS","CS/Post Order","PSR",
    "SiMo","Aircall","Venue",
    "Trainee","ST"
  ];

  summaryCards.forEach(card => {
    if (!card.value) return;

    const div = document.createElement("div");
    div.className = "stats-card";

    // 1) PLATFORM CARD: progress-bar + —Ü–∏—Ñ—Ä—ã
    if (platformTitles.includes(card.title)) {
      const active = parseInt(card.value, 10) || 0;
      const away   = parseInt(card.away  || "0", 10);
      const total  = active + away || 1;
      const pctA   = Math.round(active/total * 100);
      const pctB   = 100 - pctA;

      div.innerHTML = `
  <div class="stats-title">${card.title}</div>
  <div class="stats-counts">
    <!-- –õ–µ–≤—ã–π —Å—á—ë—Ç—á–∏–∫: —á–∏—Å–ª–æ + –∏–∫–æ–Ω–∫–∞ -->
    <div class="stat stat-active">
      <span class="stat-value">${active}</span>
      <span class="stat-icon">
        <img src="https://www.svgrepo.com/show/436843/person-fill.svg" 
             alt="user" width="20" height="20"/>
      </span>
    </div>
    <!-- –ü—Ä–∞–≤—ã–π —Å—á—ë—Ç—á–∏–∫: —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ -->
    <div class="stat stat-away">
      <span class="stat-value">${away}</span>
    </div>
  </div>
  <div class="stats-progress">
    <div class="stats-progress-active" style="width:${pctA}%;"></div>
    <div class="stats-progress-away"  style="width:${pctB}%;"></div>
  </div>
`;


      platformContainer.appendChild(div);
      return;
    }

    // 2) SPECIAL CARDS: Not here / WNATS
    if (card.title === "Not here" || card.title === "WNATS") {
      const parts  = card.value.split(",").map(s => s.trim()).filter(Boolean);
      const count  = parts.shift();
      const detail = parts;

      if (card.title === "Not here") {
        if (count !== "0") {
          div.classList.add("red-card");
          const last = loadLastNotHereCount();
          if (settings.notHere && last === "0") {
            const msg = `${count} emps are Not Here`;
            showDesktopNotification('Not Here', msg);
            addInPageNotification(msg);
          }
          saveLastNotHereCount(count);
        } else {
          saveLastNotHereCount("0");
        }
      }

      div.innerHTML = `
        <div class="stats-title">${card.title}</div>
        <div class="stats-value d-inline-flex align-items-center gap-1">
          ${count}
          <img
            src="https://www.svgrepo.com/show/474873/info.svg"
            data-toggle="tooltip"
            data-html="true"
            title="${detail.join("\n")}"
            class="info-icon"
            style="width:16px; height:16px; cursor:pointer;"
          />
        </div>
      `;
      generalContainer.appendChild(div);
      return;
    }

    // 3) GENERAL STATS (On shift now / Should be)
    div.innerHTML = `
      <div class="stats-title">${card.title}</div>
      <div class="stats-value">${card.value}</div>
    `;
    generalContainer.appendChild(div);
  });

  // 4) WEATHER CARDS (–Ω–µ –º–µ–Ω—è–µ–º)
  const weatherCities = [
    { city: "Baku,AZ",        title: "Baku Weather",       tempId: "temp-baku",  windId: "wind-baku" },
    { city: "Ganja,AZ",       title: "Ganja Weather",      tempId: "temp-ganja", windId: "wind-ganja" },
    { city: "Lankaran,AZ",    title: "Lankaran Weather",   tempId: "temp-lank",  windId: "wind-lank" },
    { city: "Nakhchivan,AZ",  title: "Nakhchivan Weather", tempId: "temp-nakh",  windId: "wind-nakh" },
    { city: "Mingachevir,AZ", title: "Mingachevir Weather",tempId: "temp-ming",  windId: "wind-ming" }
  ];

  weatherCities.forEach(({ city, title, tempId, windId }) => {
    const card = document.createElement("div");
    card.className = "stats-card";
    card.innerHTML = `
      <div class="stats-title">${title}</div>
      <div class="stats-value" id="${tempId}">--</div>
      <div class="stats-title" style="margin-top:.5rem;">Wind Speed</div>
      <div class="stats-value small" id="${windId}">--</div>
    `;
    generalContainer.appendChild(card);
    fetchWeatherFor(city, tempId, windId);
  });
}



function renderResponsiblePeople(data) {
  if (!Array.isArray(data) || data.length === 0) return;

  // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∫–∞—Ä—Ç–æ—á–∫—É, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
  const existing = document.getElementById("responsible-card");
  if (existing) existing.remove();

  // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ä–æ–ª–∏ "Shift Lead‚Ä¶" –∏ "In charge‚Ä¶"
  const responsibleRows = data.filter(([name, role]) =>
  /shift\s+lead/i.test(role) || /in\s+charge/i.test(role)
);
  if (responsibleRows.length === 0) return;

  // –ù–∞—á–∞–ª–æ HTML
  let html = `
    <div class="shift-summary-card" id="responsible-card">
      <div class="shift-summary-title">üë• Responsible People</div>
      <table class="shift-summary-grid" style="max-width:500px; margin:0 auto;">
        <thead><tr><th>Name</th><th>Position</th></tr></thead>
        <tbody>`;

  // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å—Ç—Ä–æ–∫–∏
  responsibleRows.forEach(([rawName, rawRole]) => {
    const name = rawName.trim();
    const role = rawRole.trim();
    const lowerName = name.toLowerCase();

    // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —ç–º–æ–¥–∑–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    const isNaziya = lowerName === 'naziya orujova';
    const isRafig  = lowerName === 'rafig huseynov';
    let extraEmoji = '';
    if (isNaziya) extraEmoji = ' üéÄ';
    else if (isRafig)  extraEmoji = ' (Àµ Õ°¬∞ Õú ñ Õ°¬∞Àµ)';

    const nameClass = isNaziya ? 'pink-name' : '';

    html += `
      <tr>
        <td>
          <span class="${nameClass}" style="font-weight:bold;">
            ${name}${extraEmoji}
          </span>
        </td>
        <td>
          <span style="
            background: #e7f1ff;
            color: #0056b3;
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 0.85rem;
          ">
            ${role}
          </span>
        </td>
      </tr>`;
  });

  // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –∏ –≤—Å—Ç–∞–≤–ª—è–µ–º –≤ DOM
  html += `
        </tbody>
      </table>
    </div>`;

  document
    .getElementById('shift-overs-section')
    .insertAdjacentHTML('beforebegin', html);
}


function renderShiftOvers() {
  const container = document.getElementById("shift-overs-app");
  container.innerHTML = ""; 
  if (!window.shiftsQuinyxData) {
    container.textContent = "No data";
    return;
  }

  const now = new Date();
  const oneHourLater = new Date(now.getTime() + 60*60*1000);

  // —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
  const upcoming = window.shiftsQuinyxData.filter(({name, shift}) => {
    const parts = shift.split("-");
    if (parts.length < 2) return false;
    const [ hh, mm ] = parts[1].split(":").map(Number);
    const endDate = new Date(now);
    endDate.setHours(hh, mm, 0, 0);
    return endDate > now && endDate <= oneHourLater;
  });

  if (upcoming.length === 0) {
    container.innerHTML = "<p style='text-align:center;color:#666;'>No shift-overs in the next hour</p>";
    return;
  }

  // —Å–ø–∏—Å–æ–∫
  const ul = document.createElement("ul");
  upcoming.forEach(({name, shift}) => {
    const li = document.createElement("li");
    li.innerHTML = `<strong>${name}</strong> ‚Äî ${shift}`;
    ul.appendChild(li);
  });
  container.appendChild(ul);
}

                // 1) Shift-Overs –∏–∑ –ª–∏—Å—Ç–∞ shiftsquinyx!A:C
        async function fetchShiftOversData() {
  const raw = await fetchSheetData("shiftsquinyx!A:C"); // —Ç–µ–ø–µ—Ä—å A-C, –∞ –Ω–µ B-C
  if (!raw) {
    document.getElementById("shift-overs-app").textContent = "Error";
    return;
  }

  // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –º–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫ –≤ –æ–±—ä–µ–∫—Ç—ã —Å –ø–æ–ª—è–º–∏ Name, ShiftName –∏ Shift
  const arr = raw.slice(1).map(row => ({
    ShiftName: row[0]?.trim(),   // A = –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–º–µ–Ω—ã
    Name: row[1]?.trim(),        // B = –∏–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
    Shift: row[2]?.trim(),       // C = –≤—Ä–µ–º—è —Å–º–µ–Ω—ã
  }));

  const now = new Date();
  const next = new Date(now.getTime() + 60 * 60 * 1000);

  // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è: –æ—Ç–±–∏—Ä–∞–µ–º —Ç–µ—Ö, —É –∫–æ–≥–æ shift –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ —á–∞—Å–∞
  const upcoming = arr.filter(r => {
  const parts = r.Shift.split("-");
  if (parts.length !== 2) return false;
  const [h, m] = parts[1].split(":").map(Number);
  if (isNaN(h) || isNaN(m)) return false;
  const end = new Date(now);
  end.setHours(h, m, 0, 0);
  // —Å–º–µ—â–∞–µ–º –Ω–∞ –∑–∞–≤—Ç—Ä–∞, –µ—Å–ª–∏ –≤—Ä–µ–º—è ‚â§ now
  if (end <= now) end.setDate(end.getDate() + 1);
  return end > now && end <= next;
});


  const c = document.getElementById("shift-overs-app");

  if (!upcoming.length) {
    c.innerHTML = "<p>No shift-overs in the next hour</p>";
    return;
  }

  // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø—Ä–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏ shiftName + –≤—Ä–µ–º—è
  const counts = {};
  upcoming.forEach(r => {
    const key = `${r.ShiftName}‚Äì${r.Shift}`;
    counts[key] = (counts[key] || 0) + 1;
  });

  c.innerHTML = "<ul>" + upcoming.map(r => {
    const [start, end] = r.Shift.split("-").map(s => s.trim());
    const key = `${r.ShiftName}‚Äì${r.Shift}`;
    const conflictClass = counts[key] > 1 ? "break-conflict" : "";

    return `
      <li class="${conflictClass}">
        <strong>${r.Name}</strong><br/>
        Ends at ${end}<br/>
        Shift: ${start} | ${r.ShiftName}
      </li>`;
  }).join("") + "</ul>";
}



        
async function fetchBreaksData() {
  const raw = await fetchSheetData(BREAKS_RANGE);
  const container = document.getElementById("breaks-app");
  if (!Array.isArray(raw) || raw.length < 2) {
    container.textContent = "Error";
    return;
  }

  // 1) –†–∞–∑–±–∏—Ä–∞–µ–º —à–∞–ø–∫—É
  const header = raw[0].map(h => h.trim());
  const idxName  = header.indexOf("Name");
  const idxTime  = header.indexOf("Break Time");
  const idxShift = header.indexOf("Shift Start Time");
  const idxSpace = header.indexOf("Working Space");

  if ([idxName, idxTime, idxShift, idxSpace].some(i => i < 0)) {
    console.error("Bad header:", header);
    container.textContent = "Bad header";
    return;
  }

  // 2) –°–æ–±–∏—Ä–∞–µ–º –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤
  const now = new Date();
  const nextHour = new Date(now.getTime() + 60*60*1000);

  const list = raw
    .slice(1)
    .map(row => ({
      Name:         (row[idxName]  || "").trim(),
      BreakTime:    (row[idxTime]  || "").trim(),
      ShiftStart:   (row[idxShift] || "").trim(),
      WorkingSpace: (row[idxSpace] || "").trim()
    }))
    // —É–±–∏—Ä–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –±–µ–∑ BreakTime
    .filter(r => r.BreakTime)
    // —Ñ–∏–ª—å—Ç—Ä upcoming vs all
      .filter(r => {
    if (currentBreakFilter === "upcoming") {
      const [h, m] = r.BreakTime.split(":").map(Number);
      if (isNaN(h) || isNaN(m)) return false;
      const dt = new Date(now);
      dt.setHours(h, m, 0, 0);
      // –µ—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–æ—Å—å –≤—Ä–µ–º—è —Ä–∞–Ω—å—à–µ now, —ç—Ç–æ —É–∂–µ –∑–∞–≤—Ç—Ä–∞
      if (dt <= now) dt.setDate(dt.getDate() + 1);
      return dt > now && dt <= nextHour;
    }
    return true;
  })
    // —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ BreakTime
    .sort((a, b) => {
      const toMin = t => {
        const [h,m] = t.split(":").map(Number);
        return h*60 + m;
      };
      return toMin(a.BreakTime) - toMin(b.BreakTime);
    });

  window.allBreaksData = list;

  // 3) –†–µ–Ω–¥–µ—Ä
  if (list.length === 0) {
    container.innerHTML = "<p>No breaks</p>";
  } else {
    // –ø–æ–¥—Å—á—ë—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
    const counts = {};
    list.forEach(r => {
      const key = `${r.WorkingSpace}‚Äì${r.BreakTime}`;
      counts[key] = (counts[key]||0) + 1;
    });

    container.innerHTML = "<ul>" + list.map(r => {
      const key = `${r.WorkingSpace}‚Äì${r.BreakTime}`;
      const conflict = counts[key] > 1 ? "break-conflict" : "";
      return `
        <li class="${conflict}">
          <strong>${r.Name}</strong><br/>
          Break at
          <span class="break-time"
                data-name="${r.Name}"
                data-time="${r.BreakTime}">
            ${r.BreakTime}
          </span>
          <button class="edit-btn" title="Edit time" style="border:none;background:none;cursor:pointer;">
            <img src="https://www.svgrepo.com/show/502640/edit-1.svg" width="16" height="16"/>
          </button><br/>
          Shift: ${r.ShiftStart} | ${r.WorkingSpace}
        </li>`;
    }).join("") + "</ul>";

    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
    document.querySelectorAll(".edit-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const name = btn.previousElementSibling.dataset.name;
        const timeSpan = btn.previousElementSibling;
        const oldTime = timeSpan.dataset.time;
        const newTime = prompt(`Enter new break time for ${name}:`, oldTime);
        if (!newTime || newTime === oldTime) return;
        fetch("https://breaks-proxy.mikhail-garayev.workers.dev/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name,
            newBreakTime: newTime,
            secret: "superWoltKey42"
          })
        })
        .then(res => res.text())
        .then(response => {
          if (response === "Success") {
            timeSpan.textContent = newTime;
            timeSpan.dataset.time = newTime;
            alert("Break time updated successfully!");
          } else {
            alert("Server response:\n" + response);
          }
        })
        .catch(err => {
          alert("Request failed:\n" + err.message);
        });
      });
    });
  }

  // ===== –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ—Ä—ã–≤—ã –∏ —É–≤–µ–¥–æ–º–ª—è–µ–º =====
  (function checkOverdueBreaks() {
  const ALLOWED_BREAK_MINUTES = 60;
  const now = new Date();

  // 1) –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏, –ø–æ–º–µ—á–µ–Ω–Ω—ã–µ active –ø–æ –ª–∏—Å—Ç—É
  const activeSet = new Set();
  platforms.forEach(p => {
    for (let r = p.rowActiveNamesStart; r <= p.rowActiveNamesEnd; r++) {
      const nm = fetchedData[r]?.[p.colIndexNames]?.trim();
      if (nm) activeSet.add(nm.toLowerCase());
    }
  });

  // 2) –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –ø–µ—Ä–µ—Ä—ã–≤–∞–º
  (window.allBreaksData || []).forEach(r => {
    const name = r.Name?.trim();
    if (!name) return;
    const key = name.toLowerCase();

    // –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ —Å–Ω–æ–≤–∞ active ‚Äî –æ—á–∏—â–∞–µ–º —Ñ–ª–∞–≥ –∏ –Ω–µ —É–≤–µ–¥–æ–º–ª—è–µ–º
    if (activeSet.has(key)) {
      if (overdueBreakNotified[key]) {
        delete overdueBreakNotified[key];
        localStorage.setItem(BREAK_NOTIF_KEY, JSON.stringify(overdueBreakNotified));
      }
      return;
    }

    // **–ù–û–í–´–ô –ë–õ–û–ö**: –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å –ª–∏ —É –Ω–µ–≥–æ —Å–º–µ–Ω–∞
    // –∏—â–µ–º –≤ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Å–º–µ–Ω–∞–º
    const shiftRec = (window.shiftsQuinyxData || [])
      .find(x => x.name.trim().toLowerCase() === key);
    if (shiftRec) {
      const [, endStr] = shiftRec.shift.split('-');
      const [eh, em] = endStr.split(':').map(Number);
      const endDate = new Date(now);
      endDate.setHours(eh, em, 0, 0);
      // –µ—Å–ª–∏ —Å–µ–π—á–∞—Å —É–∂–µ –ø–æ—Å–ª–µ –∫–æ–Ω—Ü–∞ —Å–º–µ–Ω—ã ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
      if (now > endDate) {
        // –∏ –æ—á–∏—â–∞–µ–º —Ñ–ª–∞–≥ –≤ —Å–ª—É—á–∞–µ, –µ—Å–ª–∏ –∫–æ–≥–¥–∞-—Ç–æ –±—ã–ª–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        if (overdueBreakNotified[key]) {
          delete overdueBreakNotified[key];
          localStorage.setItem(BREAK_NOTIF_KEY, JSON.stringify(overdueBreakNotified));
        }
        return;
      }
    }

    // 3) –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å break-–∞
    const [h, m, s = 0] = (r.BreakTime || "").split(":").map(Number);
    const breakDate = new Date(now);
    breakDate.setHours(h, m, s, 0);
    const durationMins = (now - breakDate) / 60000;
    const settings = loadNotifSettings();
    if (durationMins > ALLOWED_BREAK_MINUTES && settings.breakOverdue) {
      if (!overdueBreakNotified[key]) {
        const lateMin = Math.floor(durationMins);
        const msg = `‚ùó ${name} is late from break for ${lateMin} min.`;
        showDesktopNotification("Break overdue", msg);
        addInPageNotification(msg);
        overdueBreakNotified[key] = true;
        localStorage.setItem(BREAK_NOTIF_KEY, JSON.stringify(overdueBreakNotified));
      }
    }
  });
})();
}

        function checkOverdueBRB() {
  // –Ω–∞–π–¥—ë–º –≤—Å–µ li, –ø–æ–º–µ—á–µ–Ω–Ω—ã–µ –∫–ª–∞—Å—Å–æ–º break-overdue –∏ —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ "BRB"
  const overdueBRB = Array.from(
    document.querySelectorAll('.employee-item.break-overdue')
  ).filter(li => /\bBRB\b/.test(li.textContent));

  // –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–æ–≤–æ–≥–æ ‚Äî —à–ª—ë–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
  overdueBRB.forEach(li => {
    const name = li.dataset.employee;
    const settings = loadNotifSettings();
    if (!brbOverdueNotified[name] && settings.brbOverdue) {
      const reason = li.querySelector('.text-muted')?.textContent || '';
      const msg = `‚è∞ ${name} is late from BRB ${reason}`;
      showDesktopNotification('BRB Overdue', msg);
      addInPageNotification(msg);
      brbOverdueNotified[name] = true;
    }
  });

  // —Å–±—Ä–æ—Å–∏–º —Ñ–ª–∞–≥, –µ—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ —É–∂–µ –Ω–µ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω
  Object.keys(brbOverdueNotified).forEach(name => {
    if (!overdueBRB.some(li => li.dataset.employee === name)) {
      delete brbOverdueNotified[name];
    }
  });
}
        
        // –∫–ª–∞–¥—ë–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é window.shiftsQuinyxData
        async function fetchShiftsQuinyxData() {
          const raw = await fetchSheetData("shiftsquinyx!A2:C");
          if (!raw || raw.length < 2) {
            window.shiftsQuinyxData = [];
            return;
          }
          // raw[0] ‚Äî –∑–∞–≥–æ–ª–æ–≤–∫–∏, raw[1..] ‚Äî —Å—Ç—Ä–æ–∫–∏ [name, "HH:mm-HH:mm"]
          window.shiftsQuinyxData = raw
          .filter(r => r[0] && r[1] && r[2])
          .map(r => ({
            platform: r[0].trim(), // A: SHIFT TYPE
            name: r[1].trim(),     // B: Name
            shift: r[2].trim()     // C: Shift time
          }));
        }


        function parseTimeToMinutes(timeStr) {
          timeStr = timeStr.trim();
          let parts = timeStr.split(":");
          if (parts.length < 2) return 0;
          let hours = parseInt(parts[0], 10);
          let minutes = parseInt(parts[1], 10);
          return hours * 60 + minutes;
        }

        function arrayToObjects(arr) {
          if (!arr.length) return [];
          const header = arr[0];
          return arr.slice(1).map((row) => {
            const obj = {};
            header.forEach((key, i) => {
              obj[key] = row[i] || "";
            });
            return obj;
          });
        }

        // ‚Äî‚Äî‚Äî –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ Aircall ‚Äî‚Äî‚Äî
        // ------------------
// –ü–æ–¥—Ç—è–≥–∏–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –≤–º–µ—Å—Ç–æ Checking...
// ------------------
async function fetchAircallStatuses() {
  // 1) –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å—Ç–∞—Ç—É—Å–∞
  const indicators = Array.from(document.querySelectorAll(".status-indicator"));
  if (!indicators.length) return;

  // –í—Å–ø–æ–º–æ–≥–∞–ª–∫–∞ –¥–ª—è ¬´–∫—Ä–∏–≤—ã—Ö¬ª –∏–º–µ–π–ª–æ–≤
  function normalizeEmail(email) {
    const aliases = {
      'ramil.guliyev@wolt.com':  'ramil.quliyev@wolt.com',
      'adil.ibrahimov@wolt.com': 'adil.ibragimov@wolt.com'
    };
    return aliases[email] || email;
  }

  // –ü–æ–º–µ—á–∞–µ–º –≤—Å–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –∫–∞–∫ ¬´Loading‚Ä¶¬ª (—Å–µ—Ä—ã–π)
  indicators.forEach(ind => {
    ind.className  = "status-indicator status-unknown";
    ind.title      = "Loading‚Ä¶";
  });

  // –°–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–º–µ–π–ª—ã
  const emails = [...new Set(indicators.map(ind => {
    const name = ind.closest("li[data-employee]")?.dataset.employee || "";
    const raw  = generateWoltEmail(name);
    return normalizeEmail(raw);
  }))];

  // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –±–∞—Ç—á–µ–º —É –ø—Ä–æ–∫—Å–∏
  let results = [];
  try {
    const res = await fetch("https://aircall-proxy.mikhail-garayev.workers.dev/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ secret: "superWoltKey42", emails })
    });
    const json = await res.json();
    results = Array.isArray(json.results) ? json.results : [];
  } catch (err) {
    console.error("Aircall batch error:", err);
  }

  // –°—Ç—Ä–æ–∏–º –º–∞–ø—É email ‚Üí —Å—Ç–∞—Ç—É—Å
  const statusMap = results.reduce((acc, { email, status, error }) => {
    acc[email] = status ?? error ?? "unknown";
    return acc;
  }, {});

  // 2) –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
  indicators.forEach(ind => {
    const li        = ind.closest("li[data-employee]");
    const raw       = generateWoltEmail(li.dataset.employee || "");
    const email     = normalizeEmail(raw);
    const statRaw   = (statusMap[email] || "offline").toString();
    const statKey   = statRaw.toLowerCase().replace(/[\s_]+/g, "-");
    const label     = statKey.charAt(0).toUpperCase() +
                      statKey.slice(1).replace(/-/g, " ");

    ind.className = `status-indicator status-${statKey}`;
    ind.title     = label;
  });
}




        let autoRefreshEnabled = true;
        let refreshInterval = 15;
        let refreshTimer = null;
        let countdownTimer = null;
        let countdownValue = refreshInterval;

        function resetAutoRefresh() {
  clearTimeout(refreshTimer);
  clearInterval(countdownTimer);
  countdownValue = refreshInterval;
  updateCountdownDisplay();

  // —á–µ—Ä–µ–∑ –ª—è–º–±–¥—É, —á—Ç–æ–±—ã —É—Å–ø–µ—Ç—å –¥–æ–±–∞–≤–∏—Ç—å –∫–ª–∞—Å—Å –ø–µ—Ä–µ–¥ fetchData()
  refreshTimer = setTimeout(() => {
    const ico = document.getElementById("refresh-icon");
    ico.classList.add("rotating");  // —Å—Ç–∞—Ä—Ç –∞–Ω–∏–º–∞—Ü–∏–∏
    fetchData();
  }, refreshInterval * 1000);

  countdownTimer = setInterval(() => {
    countdownValue--;
    updateCountdownDisplay();
    if (countdownValue <= 0) clearInterval(countdownTimer);
  }, 1000);
}

        function updateCountdownDisplay() {
          const countdownElem = document.getElementById("countdown");
          if (countdownElem) {
            countdownElem.textContent = countdownValue;
          }
        }
        function toggleAutoRefresh() {
          autoRefreshEnabled = !autoRefreshEnabled;
          const btn = document.getElementById("toggle-autorefresh");
          if (autoRefreshEnabled) {
            btn.textContent = "Disable Auto Refresh";
            resetAutoRefresh();
          } else {
            btn.textContent = "Enable Auto Refresh";
            clearTimeout(refreshTimer);
            clearInterval(countdownTimer);
          }
        }
        // –ö–Ω–æ–ø–∫–∞ Refresh Now –∏ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–∑—ã–≤–∞—é—Ç —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é
        function refreshNow() {
  const ico = document.getElementById('refresh-icon');
  // –≤–µ—à–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
  ico.classList.add('rotating');

  // –∑–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
  fetchData().finally(() => {
    // –∫–æ–≥–¥–∞ –≤—Å—ë –æ—Ç—Ä–∞–±–æ—Ç–∞–ª–æ ‚Äî –≤—ã–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
    ico.classList.remove('rotating');
  });
}

        function showDesktopNotification(title, body) {
  if (doNotDisturb) return;       // üõë –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
  if (Notification.permission === "granted") {
    new Notification(title, { body, icon: "favicon.png" });
  }
}

function addInPageNotification(message) {
  if (doNotDisturb) return;       // üõë –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
  notificationQueue.push(message);
  const $cnt = document.getElementById("notification-count");
  $cnt.textContent = notificationQueue.length;
  $cnt.style.display = notificationQueue.length > 0 ? "block" : "none";
}

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ü–∞–Ω–µ–ª—å in-page —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// –∑–∞–≥—Ä—É–∑–∫–∞/—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
function loadNotifications() {
  return JSON.parse(localStorage.getItem('notifications') || '[]');
}
function saveNotifications(arr) {
  localStorage.setItem('notifications', JSON.stringify(arr));
}

// –ø—É—à –≤ –æ—á–µ—Ä–µ–¥—å + –±–µ–π–¥–∂
function pushNotification(text) {
  const arr = loadNotifications();
  arr.unshift({ text, timestamp: Date.now(), read: false });
  saveNotifications(arr);
  renderBadge(arr);
}

// —Ä–µ–Ω–¥–µ—Ä –±–µ–π–¥–∂–∞ –Ω–∞ –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫–µ
function renderBadge(arr) {
  const unread = arr.filter(n => !n.read).length;
  const $cnt = document.getElementById('notification-count');
  if (unread > 0) {
    $cnt.textContent = unread;
    $cnt.style.display = 'block';
  } else {
    $cnt.style.display = 'none';
  }
}

// —Ä–µ–Ω–¥–µ—Ä –ø–∞–Ω–µ–ª–∏
function renderPanel() {
  const arr = loadNotifications();
  const panel = document.getElementById('notifications-panel');
  if (!arr.length) {
    panel.innerHTML = '<p class="p-3 text-center text-muted">–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</p>';
    return;
  }
  panel.innerHTML = '<ul class="list-group">' +
    arr.map((n, i) => {
      const cls = n.read ? 'read' : 'unread';
      const time = new Date(n.timestamp).toLocaleTimeString();
      return `<li class="list-group-item ${cls}">${n.text}
                <br><small class="text-muted">${time}</small>
              </li>`;
    }).join('') +
    '</ul>';
}

// –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø–∞–Ω–µ–ª–∏ ‚Äî –ø–æ–º–µ—á–∞–µ–º ¬´–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º–∏¬ª
function markAllRead() {
  const arr = loadNotifications().map(n => ({ ...n, read: true }));
  saveNotifications(arr);
  renderBadge(arr);
  renderPanel();
}

// –ø–µ—Ä–µ—Ö–≤–∞—Ç in-page —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function addInPageNotification(message) {
  if (doNotDisturb) return;
  pushNotification(message);
}

// –∫–ª–∏–∫ –ø–æ –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫—É
document.getElementById('notification-bell').addEventListener('click', () => {
  const panel = document.getElementById('notifications-panel');
  panel.classList.toggle('show');
  if (panel.classList.contains('show')) {
    renderPanel();
    markAllRead();
  }
});

// –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–µ–π–¥–∂–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
renderBadge(loadNotifications());
        

        async function fetchData() {
          const data = await fetchSheetData(RANGE);
          fetchedData = data;
          const shiftData = await fetchSheetData(SHIFT_RANGE);
          window.allShiftData = shiftData;

          await fetchEmployeeList();
          await fetchShiftsQuinyxData();     
          await fetchShiftOversData();
          initAutocomplete();

          // –ü–µ—Ä–µ–≤–æ–¥–∏–º –æ–±—ä–µ–∫—Ç employeeData ‚Üí –º–∞—Å—Å–∏–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
          window.empList = Object.entries(employeeData).map(([name, info]) => ({
            name,
            canReallocate: info.canReallocate,
            prime: info.prime,
            pref: info.pref,
            languages: info.languages,
            // capacity —É –≤–∞—Å —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ info.capacity
            maxChats: parseInt(info.capacity, 10) || 0,
            // –ò –µ—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –µ—ë –≤ fetchEmployeeList()
            // –∏ –∑–¥–µ—Å—å –≤–æ–∑—å–º–∏—Ç–µ –µ—ë –∫–∞–∫ info.startDate
            startDate: info.startDate 
          }));

          // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Aircall
          const aircallConfig = platforms.find((p) => p.name === "Aircall");
          aircallActive = [];
          aircallAway = [];
          for (
            let r = aircallConfig.rowActiveNamesStart;
            r <= aircallConfig.rowActiveNamesEnd;
            r++
          ) {
            const name = data[r]?.[aircallConfig.colIndexNames]?.trim();
            if (name) aircallActive.push(name);
          }
          for (
            let r = aircallConfig.rowAwayNamesStart;
            r <= aircallConfig.rowAwayNamesEnd;
            r++
          ) {
            const name = data[r]?.[aircallConfig.colIndexNames]?.trim();
            const reason = data[r]?.[aircallConfig.colIndexData]?.trim() || "";
            if (name) aircallAway.push({ name, reason });
          }

          renderShiftSummary(data);
          const responsiblesData = await fetchSheetData(RESPONSIBLES_RANGE);
          renderResponsiblePeople(responsiblesData);
          await fetchBreaksData();
          await fetchStatusChanges();
          fetchAircallStatuses();
          applyFilters();
          checkEmptyPlatforms(data);
          await getUpcomingShiftOvers();
          await fetchUpcomingShiftsData();
          
          // –ø–æ–¥–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É
          document.getElementById('find-candidate')
          .addEventListener('click', findCandidate);
          
          document.getElementById("refresh-icon").classList.remove('rotating');
          if (autoRefreshEnabled) resetAutoRefresh();
        }
        

        function getPrimaryPlatform(empName) {
          if (!window.shiftsQuinyxData) return null;
        
          const found = window.shiftsQuinyxData.find(row =>
            row.name.toLowerCase() === empName.toLowerCase()
          );
        
          return found?.platform || null;
        }

        function saveNotifiedEmpty() {
          localStorage.setItem(STORAGE_KEY, JSON.stringify([...notifiedEmpty]));
        }
        // –¥–ª—è –∫–∞–∂–¥–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã —Å–º–æ—Ç—Ä–∏–º, –Ω–µ —Å—Ç–∞–ª–æ –ª–∏ 0 –∞–∫—Ç–∏–≤–Ω—ã—Ö
function checkEmptyPlatforms(data) {
  // summaryCards –≤ renderShiftSummary ‚Äî –≤ data[6] —Å—Ç—Ä–æ—á–∫–∞ ¬´On shift now¬ª –≤ 6-–º —Ä—è–¥—É, –Ω–æ –Ω–∞–º –ø—Ä–æ—â–µ —Ä—É–∫–∞–º–∏ –ø–µ—Ä–µ–±—Ä–∞—Ç—å
  const platformCols = {
    "CS": 31,
    "CS/Post Order": 33,
    "PSR": 35,
    "SiMo": 41,
    "Aircall": 39,
    "Venue": 37,
    "Trainee": 41,   // —Ç—É—Ç –≤ –≤–∞—à–µ–º summaryCards –æ–Ω–∏ –±—Ä–∞–ª–∏ data[11][41]
    "ST": 43
  };
  Object.entries(platformCols).forEach(([name, colIdx]) => {
    const count = parseInt(data[6][colIdx] || "0", 10);

    // –µ—Å–ª–∏ 0 –∏ –µ—â—ë –Ω–µ —É–≤–µ–¥–æ–º–ª—è–ª–∏
    const settings = loadNotifSettings();
    if (count === 0 && !notifiedEmpty.has(name) && settings.emptyPlatforms) {
      notifiedEmpty.add(name);
      saveNotifiedEmpty();              // —Å–æ—Ö—Ä–∞–Ω–∏–º —Å—Ä–∞–∑—É
      const msg = `‚ö†Ô∏è No active employees on ${name}`;
      showDesktopNotification("Empty platform", msg);
      addInPageNotification(msg);
    }

    // –µ—Å–ª–∏ —Å–Ω–æ–≤–∞ –ø–æ—è–≤–∏–ª–æ—Å—å ‚Äî —Å–±—Ä–æ—Å–∏–º, —á—Ç–æ–±—ã –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º —É—Ö–æ–¥–µ –≤ 0 –º–æ–∂–Ω–æ –±—ã–ª–æ —É–≤–µ–¥–æ–º–∏—Ç—å —Å–Ω–æ–≤–∞
    if (count > 0 && notifiedEmpty.has(name)) {
      notifiedEmpty.delete(name);
      saveNotifiedEmpty();              // –∏ —ç—Ç–æ —Å–æ—Ö—Ä–∞–Ω–∏–º
    }
  });
}

// ‚Ä¶–≤–Ω—É—Ç—Ä–∏ fetchData(), —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ renderShiftSummary(data):

        
        function generateWoltEmail(name) {
          if (!name) return "";
          const parts = name.split(" ");
          return parts.length < 2
            ? parts[0].toLowerCase() + "@wolt.com"
            : parts[0].toLowerCase() +
                "." +
                parts[1].toLowerCase() +
                "@wolt.com";
        }

        function getUpcomingShiftOvers() {
        if (!window.shiftsQuinyxData) return [];
        const now = new Date();
        const oneHourLater = new Date(now.getTime() + 60*60*1000);

        return window.shiftsQuinyxData
          .filter(({name, shift}) => {
            // –∏–∑ "06:00-15:00" –±–µ—Ä—ë–º –≤—Ç–æ—Ä—É—é —á–∞—Å—Ç—å ‚Äì –≤—Ä–µ–º—è –∫–æ–Ω—Ü–∞
            const endStr = shift.split("-")[1];
            if (!endStr) return false;
            // —Å–æ—Å—Ç–∞–≤–ª—è–µ–º –¥–∞—Ç—É-–æ–±—ä–µ–∫—Ç: —Å–µ–≥–æ–¥–Ω—è + endStr
            const [hh, mm] = endStr.split(":").map(Number);
            const endDate = new Date(now);
            endDate.setHours(hh, mm, 0, 0);

            return endDate > now && endDate <= oneHourLater;
          })
          .map(o => o.name);
      }

      function setLogoutIcon(isDark) {
        const logoutBtn = document.getElementById("logout-btn");
        if (!logoutBtn) return;
        // –µ—Å–ª–∏ –≤ —Ç–æ–π –∂–µ –ø–∞–ø–∫–µ —á—Ç–æ –∏ HTML:
        logoutBtn.src = isDark
          ? "log-out-white.svg"   // –±–µ–ª–∞—è –∏–∫–æ–Ω–∫–∞
          : "log-out.svg";        // —Ü–≤–µ—Ç–Ω–∞—è, –∏—Å—Ö–æ–¥–Ω–∞—è
      }

      function loadThemePreference() {
  const isDark = localStorage.getItem("darkThemeEnabled") === "true";
  document.body.classList.toggle("dark-theme", isDark);

  const bellIcon = document.querySelector("#notification-bell img");
  bellIcon.src = isDark
    ? "https://www.svgrepo.com/show/526479/bell-off.svg"
    : "https://www.svgrepo.com/show/527618/bell-off.svg";

  const themeCheckbox = document.getElementById("theme-checkbox");
  if (themeCheckbox) themeCheckbox.checked = isDark;
  setLogoutIcon(isDark);
}



        
      function toggleTheme(e) {
  const isDark = e.target.checked;
  document.body.classList.toggle("dark-theme", isDark);

  // –ø–æ–¥–º–µ–Ω—è–µ–º –∏–∫–æ–Ω–∫—É:
  const bellIcon = document.querySelector("#notification-bell img");
  bellIcon.src = isDark
    ? "https://www.svgrepo.com/show/526479/bell-off.svg"
    : "https://www.svgrepo.com/show/527618/bell-off.svg";

  localStorage.setItem("darkThemeEnabled", isDark);
  setLogoutIcon(isDark);
}


function findCandidate() {
  const target = document.getElementById('target-platform').value;
  if (!target) {
    return alert('Select the platform first');
  }
  const now = new Date();

  // –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è ‚Äî –ø—Ä–∏–≤–æ–¥–∏–º —Å—Ç—Ä–æ–∫—É –∫ –µ–¥–∏–Ω–æ–º—É –∫–ª—é—á—É
  const canonical = str =>
    str.toLowerCase().replace(/[^a-z0-9]/g, '');

  const targetKey = canonical(target);

  // 1) —Ç–æ–ª—å–∫–æ —Ç–µ, –∫—Ç–æ –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∫–æ–º–ø–ª–µ–∫—Ç–æ–≤–∞—Ç—å—Å—è
  const pool = window.empList.filter(e => e.canReallocate === 'Yes');
  if (!pool.length) {
    $('#candidateModalBody').html(
      '<div class="alert alert-warning">No employees to reallocate</div>'
    );
    return $('#candidateModal').modal('show');
  }

  const badStatuses = ['will not attend the shift', 'not attended the shift'];

  const candidates = pool.map(e => {
    // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ ¬´–Ω–µ –±—É–¥–µ—Ç/–Ω–µ –ø—Ä–∏—à—ë–ª¬ª
    const rowIdx = fetchedData.findIndex(row =>
      row.some(cell =>
        typeof cell === 'string' &&
        cell.trim().toLowerCase() === e.name.toLowerCase()
      )
    );
    if (rowIdx < 0) return null;
    const shiftIdx = rowIdx - 4;
    const shifts   = window.allShiftData || [];
    if (shiftIdx >= 1 && shiftIdx < shifts.length) {
      if (shifts[shiftIdx].some(cell =>
        typeof cell === 'string' &&
        badStatuses.some(bs => cell.trim().toLowerCase().includes(bs))
      )) {
        return null;
      }
    }

    // 2. –ù–∞ —Å–º–µ–Ω–µ? –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Å–º–µ–Ω—É –∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É
    const rec = window.shiftsQuinyxData.find(r =>
      r.name.toLowerCase() === e.name.toLowerCase()
    ) || {};
    // **–ù–û–í–ê–Ø –ü–†–û–í–ï–†–ö–ê**: –µ—Å–ª–∏ —É–∂–µ –Ω–∞ —Ü–µ–ª–µ–≤–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
    if (rec.platform === target) return null;

    const parts = (rec.shift || '').split('-');
    if (parts.length < 2) return null;
    const [startStr, endStr] = parts;
    const [sh, sm] = startStr.split(':').map(Number);
    const [eh, em] = endStr.split(':').map(Number);
    const sd = new Date(now); sd.setHours(sh, sm, 0, 0);
    const ed = new Date(now); ed.setHours(eh, em, 0, 0);
    if (now < sd || now > ed) return null;

    // 3. –ù–µ –Ω–∞ –±—Ä–µ–π–∫–µ?
    const br = (window.allBreaksData || []).find(b =>
      b.Name.trim().toLowerCase() === e.name.trim().toLowerCase()
    );
    if (br) {
  const [bh, bm] = (br.BreakTime    || "").split(":").map(Number);
  const bd = new Date(now);
  bd.setHours(bh, bm, 0, 0);

  const msToBreak = bd - now;

  // 1) –£–∂–µ –≤ –±—Ä–µ–π–∫–µ ‚Äî –∏—Å–∫–ª—é—á–∞–µ–º
  if (msToBreak <= 0) {
    return null;
  }

  // 2) –ë—Ä–µ–π–∫ —Å–∫–æ—Ä–æ (<30 –º–∏–Ω) ‚Äî —Ç–æ–∂–µ –∏—Å–∫–ª—é—á–∞–µ–º
  const THRESHOLD_MS = 30 * 60 * 1000;
  if (msToBreak < THRESHOLD_MS) {
    return null;
  }
}

    // 4. –†–∞—Å—á—ë—Ç –æ–ø—ã—Ç–∞ –∏ —Å–∫–æ—Ä–∏–Ω–≥–∞
    let startDateObj = new Date(e.startDate);
    if (isNaN(startDateObj)) {
      const pd = e.startDate.split(/[./]/);
      if (pd.length === 3) {
        const [d, m, y] = pd;
        startDateObj = new Date(`${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`);
      }
    }
    const tenure = isNaN(startDateObj)
      ? 0
      : Math.floor((now - startDateObj) / (1000*60*60*24*30));

    const primeMatch = e.prime === target ? 1 : 0;
    const prefList = (e.pref || '').split(',').map(s => canonical(s));
    const prefMatch = prefList.some(pk =>
      pk === targetKey || targetKey.includes(pk) || pk.includes(targetKey)
    ) ? 1 : 0;

    // –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è ‚Äî –∏—â–µ–º –ø–∞—Ä—ã ¬´—Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤¬ª (—Ñ–ª–∞–≥–∏)
    const flagRegex = /[\uD83C][\uDDE6-\uDDFF][\uD83C][\uDDE6-\uDDFF]/g;
    const flags = e.languages.match(flagRegex) || [];
    const langCount = flags.length;
    const cap = e.maxChats || 0;

    const w = { t:0.2, pr:0.3, pf:0.2, lg:0.2, cp:0.1 };
    const maxCap = Math.max(...pool.map(x => x.maxChats), 1);
    const score =
      w.t  * Math.min(tenure/24, 1) +
      w.pr * primeMatch +
      w.pf * prefMatch +
      w.lg * (langCount/3) +
      w.cp * (cap/maxCap);

    return { ...e, tenure, primeMatch, prefMatch, langCount, cap, score };
  }).filter(x => x);

  if (!candidates.length) {
    $('#candidateModalBody').html(
      '<div class="alert alert-warning">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤</div>'
    );
    return $('#candidateModal').modal('show');
  }

  // —Ç–æ–ø-3 –ø–æ —Å–∫–æ—Ä—É
  const top3 = candidates
    .sort((a, b) => b.score - a.score)
    .slice(0, 3);

  // —Å—Ç—Ä–æ–∏–º HTML –≤ —Ä—è–¥
  let html = `<div class="d-flex justify-content-between">`;
  top3.forEach((best, idx) => {
    const rec = window.shiftsQuinyxData.find(r =>
      r.name.toLowerCase() === best.name.toLowerCase()
    ) || {};
    const shiftInfo = `${rec.platform || '‚Äì'} (${rec.shift || '‚Äì'})`;

    let breakTime = '‚Äì';
    if (Array.isArray(window.allBreaksData)) {
      const br = window.allBreaksData.find(b =>
        b.Name?.trim().toLowerCase() === best.name.trim().toLowerCase()
      );
      if (br) breakTime = br.BreakTime || '‚Äì';
    }

    html += `
      <div style="flex:1; max-width:30%; padding:0 10px; box-sizing:border-box;">
        <h5>‚Ññ${idx+1} ‚Äî ${best.name}</h5>
        <p>Score: <strong>${best.score.toFixed(2)}</strong></p>
        <ul class="list-unstyled mb-0">
          <li>Shift: <strong>${shiftInfo}</strong></li>
          <li>Break: <strong>${breakTime}</strong></li>
          <li>Tenure: <strong>${best.tenure}</strong> mo.</li>
          <li>Prime match: <strong>${best.primeMatch? 'Yes': 'No'}</strong></li>
          <li>Pref match: <strong>${best.prefMatch? 'Yes': 'No'}</strong></li>
          <li>Languages: <strong>${best.langCount}</strong></li>
          <li>Capacity: <strong>${best.cap}</strong></li>
        </ul>
      </div>
    `;
  });
  html += `</div>`;

  $('#candidateModalBody').html(html);
  $('#candidateModal').modal('show');
}


 // 1) –°–∞–º —Ä–µ–Ω–¥–µ—Ä –º–æ–¥–∞–ª–∫–∏ (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
 function showWhatsNewModal(onClose) {
    const modal = document.createElement('div');
    modal.id = 'whats-new-modal';
    modal.innerHTML = `
      <div style="
        position:fixed; top:0; left:0; width:100%; height:100%;
        background:rgba(0,0,0,0.5); display:flex;
        justify-content:center; align-items:center;
      ">
        <div style="
          background:white; padding:20px; border-radius:8px;
          max-width:400px; text-align:center;
        ">
          <h2>What‚Äôs new?</h2>
          <p>New release <strong>${window.CURRENT_UPDATE_ID}</strong></p>
          <p>Added global search. You can search for offline employees now.</p>
          <p>Small bug fixes</p>
          <button id="close-update-modal">OK</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
    document.getElementById('close-update-modal')
      .addEventListener('click', () => {
        onClose();
        document.body.removeChild(modal);
      });
  }

  document.addEventListener('DOMContentLoaded', () => {
    const icon   = document.getElementById('notebook-icon');
    const choice = document.getElementById('notebook-choice');
    const panel = document.getElementById('notebook-panel');
    const modeLabel = document.getElementById('notebook-mode');
    const closeBtn = panel.querySelector('.close-btn');
    const textarea = document.getElementById('notebook-content');
    let currentMode = null;
    let noteRef = null;

    // clamp helper
    const clamp = (v,m,M)=>Math.min(Math.max(v,m),M);
    function clampPosition(left, top) {
      return {
        left: clamp(left,0,window.innerWidth-panel.offsetWidth),
        top: clamp(top,0,window.innerHeight-panel.offsetHeight)
      };
    }

    // open choice menu
    icon.addEventListener('click', () => {
      // –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–ª–∞—Å—Å, CSS —Å–∞–º –ø–æ–∫–∞–∂–µ—Ç/—Å–ø—Ä—è—á–µ—Ç –∏ –∞–Ω–∏–º–∏—Ä—É–µ—Ç
      choice.classList.toggle('show');
    });

    // handle selection
    choice.querySelectorAll('button').forEach(btn=>{
      btn.addEventListener('click',async()=>{
        currentMode = btn.getAttribute('data-mode');
        modeLabel.textContent = currentMode==='personal'? 'Personal Notebook':'General Notebook';
        choice.classList.remove('show');
        choice.style.removeProperty('display');
        // show panel
        panel.style.display='flex';
        const rect = icon.getBoundingClientRect();
        let left = rect.left;
        let top = rect.top - panel.offsetHeight -8;
        const pos = clampPosition(left,top);
        panel.style.left=pos.left+'px';
        panel.style.top=pos.top+'px';
        // attach to firebase
        const user = firebase.auth().currentUser;
        if(!user) return;
        if(currentMode==='personal') {
          noteRef = firebase.database().ref('users/'+user.uid+'/note');
        } else {
          noteRef = firebase.database().ref('generalNote');
        }
        // load
        noteRef.once('value',snap=>{ textarea.value = snap.val()||''; });
      });
    });

    // close panel
    closeBtn.addEventListener('click',()=> panel.style.display='none');

    // dragging same as before...
    let isMouseDown=false,dragPanel=false,offsetX,offsetY;
    panel.querySelector('header').addEventListener('mousedown',e=>{
      isMouseDown=true;dragPanel=true;
      offsetX=e.clientX-panel.offsetLeft;
      offsetY=e.clientY-panel.offsetTop;
      e.stopPropagation();
    });
    document.addEventListener('mousemove',e=>{
      if(dragPanel){
        const pos=clampPosition(e.clientX-offsetX,e.clientY-offsetY);
        panel.style.left=pos.left+'px';panel.style.top=pos.top+'px';
      }
    });
    document.addEventListener('mouseup',()=>{isMouseDown=dragPanel=false;});

    // save on input
    let timeout;
    textarea.addEventListener('input',()=>{
      clearTimeout(timeout);
      if(!noteRef) return;
      timeout=setTimeout(()=>noteRef.set(textarea.value),500);
    });
  });
        
  /**
 * –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ —Å–º–µ–Ω—ã –∏ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Ç–µ, 
 * —É –∫–æ–≥–æ **–Ω–∞—á–∞–ª–æ** —Å–º–µ–Ω—ã –≤ —Ç–µ—á–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ —á–∞—Å–∞.
 */
 async function fetchShiftOversData() {
  const container = document.getElementById("shift-overs-app");
  const raw = await fetchSheetData("shiftsquinyx!A:C");
  if (!Array.isArray(raw) || raw.length < 2) {
    container.textContent = "No data";
    return;
  }

  // 1) –ú–∞–ø–∏–º + —Ñ–∏–ª—å—Ç—Ä—É–µ–º —Å—Ä–∞–∑—É ¬´–ø–ª–æ—Ö–∏–µ¬ª –∑–∞–ø–∏—Å–∏
  const arr = raw
    .slice(1)
    .map(row => ({
      ShiftName: row[0]?.trim() ?? "",
      Name:      row[1]?.trim() ?? "",
      Shift:     row[2]?.trim() ?? ""
    }))
    .filter(r =>
      // –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–µ–ø—É—Å—Ç—ã–µ –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¥–µ—Ñ–∏—Å
      r.Name      !== "" &&
      r.Shift     !== "" &&
      r.Shift.includes("-")
    );

  const now  = new Date();
  const next = new Date(now.getTime() + 60 * 60 * 1000);

  // 2) –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–º–µ–Ω—ã
  const upcoming = arr.filter(r => {
    // –±–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç—å –ø–æ—Å–ª–µ –¥–µ—Ñ–∏—Å–∞ –∏ –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º –µ—ë –≤ —á–∞—Å—ã/–º–∏–Ω—É—Ç—ã
    const [ , endStr = "" ] = r.Shift.split("-");
    const [h, m] = endStr.split(":").map(Number);
    if (isNaN(h) || isNaN(m)) return false;

    const end = new Date(now);
    end.setHours(h, m, 0, 0);
    if (end <= now) end.setDate(end.getDate() + 1);
    return end > now && end <= next;
  });

  // 3) –†–µ–Ω–¥–µ—Ä
  if (upcoming.length === 0) {
    container.innerHTML = "<p style='text-align:center;color:#666;'>No shift-overs in the next hour</p>";
  } else {
    const html = "<ul>" + upcoming.map(r => {
      const [start = "", end = ""] = r.Shift.split("-").map(s => s.trim());
      return `
        <li>
          <strong>${r.Name}</strong><br/>
          Ends at ${end}<br/>
          Shift: ${start} | ${r.ShiftName}
        </li>
      `;
    }).join("") + "</ul>";
    container.innerHTML = html;
  }
}

async function fetchUpcomingShiftsData() {
  // 1) –±–µ—Ä—ë–º –≤—Å–µ —Å–º–µ–Ω—ã A:C —á–µ—Ä–µ–∑ —Ç–≤–æ–π sheets-proxy
  const raw = await fetchSheetData("shiftsquinyx!A:C");
  const container = document.getElementById("upcoming-shifts-app");
  if (!Array.isArray(raw) || raw.length < 2) {
    container.innerHTML = "<p style='text-align:center;color:#666;'>No upcoming shifts</p>";
    return;
  }

  // 2) –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —Å—Ç–∞—Ä—Ç—É —Å–º–µ–Ω—ã –≤ —Ç–µ—á–µ–Ω–∏–µ —á–∞—Å–∞
  const now  = new Date();
  const next = new Date(now.getTime() + 60*60*1000);

  const upcoming = raw
    .slice(1)
    .map(r => ({
      name:      (r[1] || "").trim(),
      shiftName: (r[0] || "").trim(),
      times:     (r[2] || "").trim()
    }))
    .filter(({name, times}) => {
      if (!name || !times.includes("-")) return false;
      const [start] = times.split("-");
      const [h, m] = start.split(":").map(Number);
      if (isNaN(h) || isNaN(m)) return false;
      const dt = new Date(now);
      dt.setHours(h, m, 0, 0);
      // –µ—Å–ª–∏ —É–∂–µ –ø—Ä–æ—à–ª–æ ‚Äî —ç—Ç–æ –Ω–∞ –∑–∞–≤—Ç—Ä–∞
      if (dt <= now) dt.setDate(dt.getDate() + 1);
      return dt > now && dt <= next;
    });

  // 3) —Ä–µ–Ω–¥–µ—Ä–∏–º
  if (upcoming.length === 0) {
    container.innerHTML = "<p style='text-align:center;color:#666;'>No upcoming shifts</p>";
  } else {
    container.innerHTML = "<ul>" +
      upcoming.map(u =>
        `<li>
           <strong>${u.name}</strong><br>
           Starts at ${u.times.split("-")[0]} | ${u.shiftName}
         </li>`
      ).join("") +
      "</ul>";
  }
}


  // 2) –û—Ç–º–µ—Ç–∫–∞, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ¬´—É–≤–∏–¥–µ–ª¬ª –∞–ø–¥–µ–π—Ç
  async function markSeenInRTDB(uid) {
    // update() ‚Äî —á—Ç–æ–±—ã –Ω–µ –∑–∞—Ç–∏—Ä–∞—Ç—å –¥—Ä—É–≥–∏–µ –ø–æ–ª—è
    await database.ref(`users/${uid}`).update({
      lastSeenUpdateId: window.CURRENT_UPDATE_ID
    });
  }

  // 3) –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  firebase.auth().onAuthStateChanged(async user => {
    if (!user) return; // –≥–æ—Å—Ç—å ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º

    const ref = database.ref(`users/${user.uid}/lastSeenUpdateId`);
    const snapshot = await ref.get();
    const lastSeen = snapshot.exists() ? snapshot.val() : null;

    if (lastSeen !== window.CURRENT_UPDATE_ID) {
      showWhatsNewModal(() => markSeenInRTDB(user.uid));
    }
  });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Bootstrap-Select –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—ã–±–æ—Ä–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º
        $(document).ready(function () {
          $("#platform-dropdown").selectpicker();
          $("#platform-dropdown").on(
            "changed.bs.select",
            function (e, clickedIndex, isSelected, previousValue) {
              let selected = $(this).val();
              currentPlatformFilter = selected && selected.length ? selected : ["all"];
              applyFilters();
            }
          );
        });

        document.getElementById("theme-checkbox")
  .addEventListener("change", toggleTheme);
document.addEventListener("DOMContentLoaded", loadThemePreference);
document.addEventListener("DOMContentLoaded", () => {
  // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–º—ã
  loadThemePreference();

// –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∫–∏ ‚Äî –∑–∞–ø–æ–ª–Ω—è–µ–º —á–µ–∫–±–æ–∫—Å—ã
$('#notif-settings-btn').on('click', () => {
  const s = loadNotifSettings();
  $('#notif-break-overdue').prop('checked', s.breakOverdue);
  $('#notif-brb-overdue').prop('checked',   s.brbOverdue);
  $('#notif-empty-platforms').prop('checked', s.emptyPlatforms);
  $('#notif-not-here').prop('checked', s.notHere);
  $('#notif-brb-two-or-more').prop('checked', s.brbTwoOrMore);
  $('#notifSettingsModal').modal('show');
});

// –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ª—é–±–æ–≥–æ —á–µ–∫–±–æ–∫—Å–∞ ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º
$('#notif-settings-form input[type=checkbox]').on('change', () => {
  const newS = {
    breakOverdue:     $('#notif-break-overdue').prop('checked'),
    brbOverdue:       $('#notif-brb-overdue').prop('checked'),
    emptyPlatforms:   $('#notif-empty-platforms').prop('checked'),
    notHere:          $('#notif-not-here').prop('checked'),
    brbTwoOrMore:     $('#notif-brb-two-or-more').prop('checked')
  };
  saveNotifSettings(newS);
});


  const dndCheckbox = document.getElementById('dnd-toggle');
  dndCheckbox.checked = doNotDisturb;
  dndCheckbox.addEventListener('change', e => {
    setDoNotDisturb(e.target.checked);
  })
  // ‚Ä¶ –æ—Å—Ç–∞–ª—å–Ω–æ–π –≤–∞—à –∫–æ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏


  // –°–∞–π–¥–±–∞—Ä
  const layout    = document.querySelector(".dashboard-layout");
  const sidebar   = document.getElementById("sidebar");
  const hamburger = document.getElementById("hamburger-menu");
  const closeBtn  = document.getElementById("sidebar-close");

  // –û—Ç–∫—Ä—ã—Ç–∏–µ —Å–∞–π–¥–±–∞—Ä–∞ –ø–æ –±—É—Ä–≥–µ—Ä-–º–µ–Ω—é
  hamburger.addEventListener("click", (e) => {
    e.stopPropagation();
    sidebar.classList.add("active");
    layout.classList.add("sidebar-open");
  });

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–Ω–æ–ø–∫–µ ¬´√ó¬ª
  closeBtn.addEventListener("click", () => {
    sidebar.classList.remove("active");
    layout.classList.remove("sidebar-open");
  });


  // –ü–æ–∏—Å–∫ –∏ ¬´√ó¬ª-–∫–Ω–æ–ø–∫–∞
  const inpEl    = document.getElementById("employee-search");
  const clearBtn = document.getElementById("clear-search-button");
  // —É–±–∏—Ä–∞–µ–º, –ø–æ–∫–∞ –Ω–µ—Ç —Ç–µ–∫—Å—Ç–∞
  clearBtn.style.display = "none";

  inpEl.addEventListener("input", (e) => {
    const v = e.target.value.trim();
    // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–ª–∏ –ø—Ä—è—á–µ–º –∫—Ä–µ—Å—Ç–∏–∫
    clearBtn.style.display = v ? "block" : "none";
    // —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –Ω–æ–≤–æ–º—É –∑–Ω–∞—á–µ–Ω–∏—é
    currentSearchTerm = v;
    applyFilters();
  });

  clearBtn.addEventListener("click", () => {
    // –æ—á–∏—Å—Ç–∫–∞ –ø–æ–ª—è
    inpEl.value = "";
    clearBtn.style.display = "none";
    currentSearchTerm = "";
    applyFilters();
    // —Å–Ω–∏–º–µ–º –ø—É–ª—å—Å–∞—Ü–∏—é, –µ—Å–ª–∏ –∫—Ç–æ –ø–æ–¥—Å–≤–µ—á–µ–Ω
    document.querySelectorAll(".pulse-highlight")
            .forEach(el => el.classList.remove("pulse-highlight"));
    // –∑–∞–∫—Ä–æ–µ–º –º–æ–¥–∞–ª–∫—É (–µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ)
    closeEmployeeModal();
  });


  document
    .getElementById("status-filter")
    .addEventListener("change", (e) => {
      currentStatusFilter = e.target.value;
      applyFilters();
    });

  document
    .getElementById("realloc-filter")
    .addEventListener("change", (e) => {
      currentReallocFilter = e.target.value;
      applyFilters();
    });

  document
    .getElementById("lang-filter")
    .addEventListener("change", (e) => {
      currentLangFilter = e.target.value;
      applyFilters();
    });
  
  // –§–∏–ª—å—Ç—Ä –ø–µ—Ä–µ—Ä—ã–≤–æ–≤
  document
    .getElementById("break-filter")
    .addEventListener("change", (e) => {
      currentBreakFilter = e.target.value; // "upcoming" –∏–ª–∏ "all"
      fetchBreaksData();
    });
  // User dropdown toggle
// User dropdown toggle
document.getElementById('user-menu-toggle').addEventListener('click', function(e) {
  e.stopPropagation();
  const dropdown = document.getElementById('user-dropdown-menu');
  dropdown.classList.toggle('show');
  this.closest('.user-dropdown').classList.toggle('show');
});

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
  const dropdown = document.getElementById('user-dropdown-menu');
  const userDropdown = document.querySelector('.user-dropdown');
  if (dropdown.classList.contains('show') && 
      !e.target.closest('.user-dropdown')) {
    dropdown.classList.remove('show');
    userDropdown.classList.remove('show');
  }
});

// Existing functionality
document.getElementById('logout-btn').addEventListener('click', () => {
  auth.signOut();
});

document.getElementById('notif-settings-btn').addEventListener('click', () => {
  $('#notifSettingsModal').modal('show');
  document.getElementById('user-dropdown-menu').classList.remove('show');
  document.querySelector('.user-dropdown').classList.remove('show');
});
  // –°–µ–ª–µ–∫—Ç–æ—Ä –ø–ª–∞—Ç—Ñ–æ—Ä–º (bootstrap-select)
  $('#platform-dropdown').selectpicker();
  $('#platform-dropdown').on('changed.bs.select', function () {
    const selected = $(this).val();
    currentPlatformFilter = selected && selected.length ? selected : ['all'];
    applyFilters();
  });

  // –ú–æ–¥–∞–ª–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
  const overlay = document.getElementById("modal-overlay");
  const modalClose = document.getElementById("modal-close");
  overlay.addEventListener("click", closeEmployeeModal);
  modalClose.addEventListener("click", closeEmployeeModal);
  
    // 1) –û–¥–∏–Ω —Ä–∞–∑ –∑–∞–ø–æ–ª–Ω—è–µ–º dropdown –ø–ª–∞—Ç—Ñ–æ—Ä–º
  const sel = document.getElementById('target-platform');
  // –æ—á–∏—â–∞–µ–º (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∑–∞–≥–ª—É—à–∫—É)
  sel.innerHTML = '<option value="">Reallocate to..</option>';
  platforms.forEach(p => sel.add(new Option(p.name, p.name)));

  // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã
  document.getElementById("theme-checkbox").addEventListener("change", toggleTheme);

  document.getElementById('find-candidate')
  .addEventListener('click', findCandidate);

  // –ü–µ—Ä–≤–∏—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
  if ("Notification" in window) {
  Notification.requestPermission().then(p => {
    console.log("Push permission:", p);
  });
}
  
  // 1) –ü–æ–∏—Å–∫-Enter: –ø—É–ª—å—Å–∏—Ä—É–µ–º –∏–ª–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º Enter –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
    document
      .getElementById("employee-search")
      .addEventListener("keydown", (e) => {
        if (e.key !== "Enter") return;
        const name = e.target.value.trim();
        processEmployeeSelection(name);
      });
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –≤–∞—Ä–∏–∞–Ω—Ç–∞ –∏–∑ datalist
    document
      .getElementById("employee-search")
      .addEventListener("input", (e) => {
        const name = e.target.value.trim();
        // –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–∞–∫–æ–µ —Ç–æ—á–Ω–æ–µ –∏–º—è –≤ employeeData
        if (employeeData[name]) {
          processEmployeeSelection(name);
        }
      });

  
  fetchData();
  // 1) –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–æ–∞—Å—Ç–∞
function showToast(msg) {
  const container = document.getElementById('toast-container');
  const t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  container.appendChild(t);
  // –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è ‚Äì —É–¥–∞–ª—è–µ–º –∏–∑ DOM
  t.addEventListener('animationend', e => {
    if (e.animationName === 'toast-fade-out') t.remove();
  });
}

// 2) —Ä–∞–±–æ—Ç–∞–µ–º —Å –º–µ–Ω—é
const ctxMenu = document.getElementById('custom-context-menu');
let ctxData = { name:'', email:'' };

// –ü—Ä–∞–≤—ã–π –∫–ª–∏–∫ –ø–æ —ç–ª–µ–º–µ–Ω—Ç—É .employee-item
document.addEventListener('contextmenu', e => {
  const item = e.target.closest('.employee-item');
  if (!item) {
    ctxMenu.classList.remove('show');
    return;
  }
  e.preventDefault();
  // –¥–æ—Å—Ç–∞—ë–º –∏–º—è
  const name = item.querySelector('.employee-name').textContent.trim();
  // —Ñ–æ—Ä–º–∏—Ä—É–µ–º e-mail (–ø–æ –≤–∞—à–µ–π –ª–æ–≥–∏–∫–µ)
  const [first, last] = name.split(' ');
  const email = `${first.toLowerCase()}.${last.toLowerCase()}@wolt.com`;

  ctxData = { name, email };
  ctxMenu.style.top  = `${e.pageY}px`;
  ctxMenu.style.left = `${e.pageX}px`;
  ctxMenu.classList.add('show');
});

// –°–∫—Ä—ã—Ç—å –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤ –ª—é–±–æ–º –º–µ—Å—Ç–µ
document.addEventListener('click', () => {
  ctxMenu.classList.remove('show');
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –≤ –º–µ–Ω—é
ctxMenu.addEventListener('click', e => {
  const action = e.target.dataset.action;
  ctxMenu.classList.remove('show');

  if (action === 'copy-name') {
    navigator.clipboard.writeText(ctxData.name)
      .then(() => showToast('Name copied'));
  }
  else if (action === 'copy-email') {
    navigator.clipboard.writeText(ctxData.email)
      .then(() => showToast('Email copied'));
  }
  else if (action === 'send-email') {                    // ‚Üê –≤—Å—Ç–∞–≤—å—Ç–µ —ç—Ç–æ
    window.location.href = `mailto:${ctxData.email}`;
  }
});

});
     
      
      </script>
    </div>
    <!-- Notification Settings Modal -->
<div class="modal fade" id="notifSettingsModal" tabindex="-1" aria-labelledby="notifSettingsLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="notifSettingsLabel">Notifications settings</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="notif-settings-form">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="" id="notif-break-overdue">
            <label class="form-check-label" for="notif-break-overdue">
              Late from break notifications (disable for now)
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="" id="notif-brb-overdue">
            <label class="form-check-label" for="notif-brb-overdue">
              Late from BRB notifications
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="" id="notif-empty-platforms">
            <label class="form-check-label" for="notif-empty-platforms">
              Notifications for empty platforms
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="notif-not-here">
            <label class="form-check-label" for="notif-not-here">
              Not Here notifications
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="notif-brb-two-or-more">
            <label class="form-check-label" for="notif-brb-two-or-more">
              Notifications for 2 or more BRB
            </label>
          </div>
                
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Save</button>
      </div>
    </div>
  </div>
</div>
<!-- Add inside <body> -->
<div id="notebook-icon">
  <img id="notebook-icon-img" src="https://www.svgrepo.com/show/495547/note-favorite.svg" alt="Notebook">
</div>

<div id="notebook-choice">
  <button data-mode="personal">Personal Notepad</button>
  <button data-mode="general">General Notepad</button>
</div>

<div id="notebook-panel">
  <header>
    <span id="notebook-mode">Notebook</span>
    <span class="close-btn">&times;</span>
  </header>
  <textarea id="notebook-content" placeholder="Write your notes..."></textarea>
</div>
<!-- –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –æ–≤–µ—Ä–ª–µ–π —Ç–µ—Ö—Ä–∞–±–æ—Ç -->
<!-- –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –æ–≤–µ—Ä–ª–µ–π —Ç–µ—Ö—Ä–∞–±–æ—Ç -->
<div id="maintenance-overlay" class="maintenance-overlay">
  <div class="maintenance-content">
    <h1>Ooopss...Support Monitoring Dashboard is under maintenance</h1>
    <p>Sit back and listen to Ayg√ºn Kazƒ±mova.</p>
    <!-- –í–∞—à –ø—Ä–∏–∫–æ–ª—å–Ω—ã–π gif: -->
    <img
      src="https://i.giphy.com/vR1dPIYzQmkRzLZk2w.webp"
      alt="Under maintenance"
      class="maintenance-gif"
    />
  </div>
</div>
    <!-- custom context menu -->
<ul id="custom-context-menu" class="custom-menu">
  <li data-action="copy-name">Copy Name</li>
  <li data-action="copy-email">Copy Email</li>
  <li id="ctx-send-email" data-action="send-email">Send E-mail</li>
</ul>

<!-- toast container -->
<div id="toast-container"></div>
</body>
</html>
