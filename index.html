<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>SUMO Dashboard</title>
  <!-- Подключаем Bootstrap (опционально) -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    /* Общий сброс и фон */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      min-height: 100vh;
      background: linear-gradient(120deg, #fdfbfb 0%, #ebedee 100%);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow-x: hidden;
    }
    .dashboard-container {
      width: 100%;
      margin: 0;
      padding: 40px 20px;
      box-sizing: border-box;
    }
    h1 {
      text-align: center;
      color: #343a40;
      margin-bottom: 30px;
      font-weight: 500;
      font-size: 2rem;
    }
    .status-bar {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      flex-wrap: wrap;
      margin-bottom: 30px;
    }
    .status-bar button {
      border: none;
      border-radius: 50px;
      padding: 10px 20px;
      font-size: 0.9rem;
      margin: 6px;
      transition: background-color 0.3s, box-shadow 0.3s;
      cursor: pointer;
    }
    .status-bar button:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(52, 58, 64, 0.4);
    }
    .btn-outline-primary {
      background-color: #ffffff;
      color: #007bff;
      border: 2px solid #007bff;
    }
    .btn-outline-primary:hover {
      background-color: #007bff;
      color: #ffffff;
    }
    .btn-outline-secondary {
      background-color: #ffffff;
      color: #6c757d;
      border: 2px solid #6c757d;
    }
    .btn-outline-secondary:hover {
      background-color: #6c757d;
      color: #ffffff;
    }
    .status-badge {
      background-color: #28a745;
      border-radius: 50px;
      padding: 8px 16px;
      font-size: 0.9rem;
      margin: 6px;
      color: #ffffff;
    }
    .status-bar span {
      margin: 6px;
      font-size: 0.9rem;
      color: #343a40;
    }
    /* Горизонтальная лента карточек */
    .platforms-row {
      display: flex;
      flex-wrap: nowrap;
      align-items: flex-start;
      justify-content: space-between;
      overflow-x: auto;
      width: 100%;
      gap: 10px;
    }
    .platform-card {
      flex: 1 1 220px;
      min-width: 220px;
      box-sizing: border-box;
      background: #ffffff;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      transition: transform 0.2s, box-shadow 0.2s;
      white-space: normal;
      overflow-wrap: break-word;
      word-break: normal;
    }
    .platform-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    }
    .platform-card h5 {
      color: #343a40;
      margin-bottom: 12px;
      text-align: center;
      font-weight: 600;
      font-size: 1.1rem;
    }
    .platform-card p {
      text-align: center;
      color: #6c757d;
      margin: 10px 0;
      font-size: 0.85rem;
    }
    .platform-card ul {
      list-style: none;
      padding-left: 0;
      margin: 0;
      font-size: 0.85rem;
      color: #495057;
    }
    .platform-card ul li {
      border-bottom: 1px solid #e9ecef;
      padding: 4px 0;
      white-space: normal;
      overflow-wrap: break-word;
      word-break: normal;
    }
    .platform-card ul li:last-child {
      border-bottom: none;
    }
    /* Shift Summary Card */
    .shift-summary-card {
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      padding: 20px;
      margin: 0 auto 40px;
      width: auto;
      text-align: center;
      transition: transform 0.2s, box-shadow 0.2s;
      overflow-wrap: break-word;
      word-break: normal;
    }
    .shift-summary-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    }
    .shift-summary-title {
      margin-bottom: 16px;
      font-weight: 600;
      color: #343a40;
      font-size: 1.3rem;
    }
    .shift-summary-grid {
      width: 100%;
      border-collapse: collapse;
      table-layout: auto;
    }
    .shift-summary-grid th,
    .shift-summary-grid td {
      border: 1px solid #dee2e6;
      padding: 8px 12px;
      text-align: center;
      font-size: 0.85rem;
      color: #495057;
      white-space: normal;
    }
    .shift-summary-grid th {
      background-color: #f8f9fa;
      font-weight: 600;
    }
    /* Upcoming Breaks */
    #breaks-section {
      margin-top: 40px;
    }
    #breaks-section h2 {
      text-align: center;
      color: #343a40;
      margin-bottom: 20px;
      font-weight: 500;
      font-size: 1.5rem;
    }
    .break-card {
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      padding: 20px;
      margin: 0 auto 40px;
      max-width: 600px;
      text-align: center;
      transition: transform 0.2s, box-shadow 0.2s;
      overflow-wrap: break-word;
      word-break: normal;
    }
    .break-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    }
    .break-card h5 {
      margin-bottom: 12px;
      font-weight: 600;
      color: #343a40;
      font-size: 1.1rem;
    }
    .break-card ul {
      list-style: none;
      padding-left: 0;
      margin: 0;
      font-size: 0.85rem;
      color: #495057;
    }
    .break-card ul li {
      padding: 6px 0;
      border-bottom: 1px solid #e9ecef;
    }
    .break-card ul li:last-child {
      border-bottom: none;
    }
    /* Отладочный блок (вывод сообщений на сайте) */
    #debug {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ddd;
      background-color: #f9f9f9;
      max-height: 300px;
      overflow-y: auto;
      font-size: 0.85rem;
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <h1>SUMO Dashboard</h1>
    
    <div class="status-bar">
      <button id="toggle-autorefresh" class="btn btn-outline-primary">Disable Auto Refresh</button>
      <button id="refresh-now" class="btn btn-outline-secondary">Refresh now</button>
      <span id="update-status" class="status-badge">Updated</span>
      <span>Auto refresh in <span id="countdown">10</span> seconds...</span>
    </div>
    
    <!-- Shift Summary Card (данные из диапазона AB:AR, начиная с AB6) -->
    <div id="shift-summary" class="shift-summary-card">
      <div class="shift-summary-title">Shift Summary</div>
      <table class="shift-summary-grid" id="summary-table"></table>
    </div>
    
    <!-- Горизонтальная лента карточек платформ -->
    <div id="platforms-container" class="platforms-row"></div>
    
    <!-- Раздел Upcoming Breaks -->
    <div id="breaks-section">
      <h2>Upcoming Breaks</h2>
      <div id="breaks-app"></div>
    </div>

    <!-- Отладочный блок для вывода сообщений -->
    <div id="debug"><strong>Отладочные сообщения:</strong><br/></div>
  </div>
  
  <script>
    /********* Google Sheets API **********/
    const SPREADSHEET_ID = "1dICKOxxz9R3x8MY3FKQ9I-IwR9fBUDfMOT9PFDLloAE";  // Ваш ID таблицы
    const RANGE = "list1!A1:Z100";  // Основной диапазон
    const BREAKS_RANGE = "prebreaks!A1:D40";  // Диапазон для брейков
    const GOOGLE_API_KEY = "AIzaSyBVHrKvA61CAJBLxU-4AAiow6Y0TV4ChSY";

    async function fetchSheetData(range) {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(range)}?key=${GOOGLE_API_KEY}`;
      try {
        const res = await fetch(url);
        if (!res.ok) {
          logDebug("Ошибка получения данных: " + res.statusText);
          return null;
        }
        const data = await res.json();
        logDebug("Данные из Sheets API (" + range + "): " + JSON.stringify(data.values));
        return data.values;
      } catch (err) {
        logDebug("Ошибка запроса: " + err);
        return null;
      }
    }

    /********* Функция преобразования массива в объекты **********/
    function arrayToObjects(arr) {
      if (!arr.length) return [];
      const header = arr[0];
      // Преобразуем все строки после заголовка в объекты
      return arr.slice(1).map(row => {
        const obj = {};
        header.forEach((key, i) => {
          obj[key] = row[i] || "";
        });
        return obj;
      });
    }

    /********* Aircall API настройки **********/
    const AIRCALL_API_KEY = "43bce092d80a09050211a837c0bbd705";       // Ваш ключ Aircall API
    const AIRCALL_API_SECRET = "092d2eb157c47614788386920acd7413";       // Ваш секрет Aircall API

    // Конфигурация платформ
    const platforms = [
      { name: "CS",             colIndexNames: 3,  colIndexData: 4,  rowActiveCount: 3,  rowActiveNamesStart: 4,  rowActiveNamesEnd: 15, rowAwayCount: 27, rowAwayNamesStart: 28, rowAwayNamesEnd: 35 },
      { name: "CS/Post order",  colIndexNames: 5,  colIndexData: 6,  rowActiveCount: 3,  rowActiveNamesStart: 4,  rowActiveNamesEnd: 15, rowAwayCount: 27, rowAwayNamesStart: 28, rowAwayNamesEnd: 35 },
      { name: "PSR",            colIndexNames: 7,  colIndexData: 8,  rowActiveCount: 3,  rowActiveNamesStart: 4,  rowActiveNamesEnd: 15, rowAwayCount: 27, rowAwayNamesStart: 28, rowAwayNamesEnd: 35 },
      { name: "SiMo",           colIndexNames: 9,  colIndexData: 10, rowActiveCount: 3,  rowActiveNamesStart: 4,  rowActiveNamesEnd: 15, rowAwayCount: 27, rowAwayNamesStart: 28, rowAwayNamesEnd: 35 },
      { name: "Aircall",        colIndexNames: 11, colIndexData: 12, rowActiveCount: 3,  rowActiveNamesStart: 4,  rowActiveNamesEnd: 15, rowAwayCount: 27, rowAwayNamesStart: 28, rowAwayNamesEnd: 35 },
      { name: "Venue",          colIndexNames: 13, colIndexData: 14, rowActiveCount: 3,  rowActiveNamesStart: 4,  rowActiveNamesEnd: 15, rowAwayCount: 27, rowAwayNamesStart: 28, rowAwayNamesEnd: 35 },
      { name: "Trainee",        colIndexNames: 15, colIndexData: 16, rowActiveCount: 3,  rowActiveNamesStart: 4,  rowActiveNamesEnd: 15, rowAwayCount: 27, rowAwayNamesStart: 28, rowAwayNamesEnd: 35 },
      { name: "ST",             colIndexNames: 17, colIndexData: 18, rowActiveCount: 3,  rowActiveNamesStart: 4,  rowActiveNamesEnd: 15, rowAwayCount: 27, rowAwayNamesStart: 28, rowAwayNamesEnd: 35 }
    ];

    // Массивы для сотрудников Aircall
    let aircallActive = [];
    let aircallAway = [];

    // Функция для вывода сообщений для отладки на сайте
    function logDebug(message) {
      const debugDiv = document.getElementById("debug");
      debugDiv.innerHTML += message + "<br/>";
    }

    // Генерация email, например "lala.babayeva@wolt.com"
    function generateWoltEmail(fullName) {
      const parts = fullName.trim().split(/\s+/);
      if (parts.length < 2) return "";
      return parts[0].toLowerCase() + "." + parts[1].toLowerCase() + "@wolt.com";
    }

    // Получение userId через Aircall API
    async function getAircallUserId(email) {
      const authString = btoa(`${AIRCALL_API_KEY}:${AIRCALL_API_SECRET}`);
      const url = `https://api.aircall.io/v1/users/${encodeURIComponent(email)}`;
      try {
        const res = await fetch(url, { headers: { "Authorization": `Basic ${authString}` }});
        if (!res.ok) {
          logDebug("[Aircall] Ошибка getUserId для " + email + ": " + res.status + " " + res.statusText);
          return null;
        }
        const data = await res.json();
        logDebug("[Aircall] Получен userId для " + email + ": " + (data.user?.id || "null"));
        return data.user?.id || null;
      } catch (e) {
        logDebug("[Aircall] Исключение в getUserId: " + e);
        return null;
      }
    }

    // Получение availability через Aircall API
    async function getAircallAvailability(userId) {
      if (!userId) return "No ID";
      const authString = btoa(`${AIRCALL_API_KEY}:${AIRCALL_API_SECRET}`);
      const url = `https://api.aircall.io/v1/users/${userId}/availability`;
      try {
        const res = await fetch(url, { headers: { "Authorization": `Basic ${authString}` }});
        if (!res.ok) {
          logDebug("[Aircall] Ошибка getAvailability для userId " + userId + ": " + res.status + " " + res.statusText);
          return "Error";
        }
        const data = await res.json();
        logDebug("[Aircall] Данные availability для userId " + userId + ": " + JSON.stringify(data));
        let status = data?.user_availability?.availability_status || data?.availability;
        return status || "Unknown";
      } catch (e) {
        logDebug("[Aircall] Исключение в getAvailability: " + e);
        return "Error";
      }
    }

    /********* Рендеринг дашборда **********/
    function renderDashboard(data) {
      const container = document.getElementById("platforms-container");
      let html = "";
      platforms.forEach(platform => {
        // Собираем активные имена
        const activeNames = [];
        for (let r = platform.rowActiveNamesStart; r <= platform.rowActiveNamesEnd; r++) {
          const nm = data[r]?.[platform.colIndexNames]?.trim();
          if (nm) activeNames.push(nm);
        }
        // Собираем away данные
        const awayData = [];
        for (let r = platform.rowAwayNamesStart; r <= platform.rowAwayNamesEnd; r++) {
          const nm = data[r]?.[platform.colIndexNames]?.trim();
          if (!nm) continue;
          const rsn = data[r]?.[platform.colIndexData]?.trim() || "";
          awayData.push({ name: nm, reason: rsn });
        }
        if (platform.name === "Aircall") {
          // Для Aircall сохраняем массивы активных и away сотрудников
          aircallActive = activeNames;
          aircallAway = awayData;
          // Рендерим "скелет" карточки Aircall (будет обновлен позже)
          html += `
            <div class="platform-card" id="aircall-skeleton">
              <h5>${platform.name}</h5>
              <p><small>Активные (${activeNames.length})</small></p>
              <ul>${activeNames.map(n => `<li>${n}</li>`).join("")}</ul>
              <p><small>Away (${awayData.length})</small></p>
              <ul>${awayData.map(a => {
                const extra = a.reason ? " - " + a.reason : "";
                return `<li>${a.name}${extra}</li>`;
              }).join("")}</ul>
            </div>
          `;
        } else {
          html += `
            <div class="platform-card">
              <h5>${platform.name}</h5>
              <p><small>Активные (${activeNames.length})</small></p>
              <ul>${activeNames.map(n => `<li>${n}</li>`).join("")}</ul>
              <p><small>Away (${awayData.length})</small></p>
              <ul>${awayData.map(item => {
                const extra = item.reason ? " - " + item.reason : "";
                return `<li>${item.name}${extra}</li>`;
              }).join("")}</ul>
            </div>
          `;
        }
      });
      container.innerHTML = html;
    }

    /********* Рендер Shift Summary **********/
    function renderShiftSummary(data) {
      const tableEl = document.getElementById("summary-table");
      let html = "";
      for (let i = 5; i < data.length; i++) {
        const row = data[i];
        const subset = row.slice(27, 44);
        if (subset.every(cell => !cell.trim()) || subset.some(cell => cell.trim() === "Dashboard"))
          continue;
        html += "<tr>";
        subset.forEach(cell => {
          html += `<td>${cell.trim() || ""}</td>`;
        });
        html += "</tr>";
      }
      tableEl.innerHTML = html;
    }

    /********* Рендер Upcoming Breaks **********/
    async function fetchBreaksData() {
      const data = await fetchSheetData(BREAKS_RANGE);
      if (!data) return;
      // Преобразуем массив в объекты, используя первую строку в качестве заголовков
      const breaksObjects = arrayToObjects(data);
      logDebug("Преобразованные данные для брейков: " + JSON.stringify(breaksObjects));
      renderBreaks(breaksObjects);
    }
    function renderBreaks(breaksData) {
      const now = new Date();
      const currMinutes = now.getHours() * 60 + now.getMinutes();
      const horizon = currMinutes + 60;
      const upcoming = breaksData.filter(item => {
        if (!item["Break Time"]) return false;
        const timeStr = item["Break Time"].trim();
        const minutes = parseTimeToMinutes(timeStr);
        return (minutes > currMinutes && minutes <= horizon);
      });
      upcoming.sort((a, b) => parseTimeToMinutes(a["Break Time"]) - parseTimeToMinutes(b["Break Time"]));
      let html = `<div class="break-card">
                    <h5>Upcoming Breaks</h5>
                    <ul>`;
      upcoming.forEach(item => {
        html += `
          <li>
            <strong>${item["Name"]}</strong><br/>
            Break at: <strong>${item["Break Time"]}</strong><br/>
            Shift: ${item["Shift Start Time"]} | ${item["Working Space"]}
          </li>`;
      });
      html += `</ul></div>`;
      document.getElementById("breaks-app").innerHTML = html;
    }
    function parseTimeToMinutes(timeStr) {
      const [hh, mm] = timeStr.trim().split(":");
      return parseInt(hh, 10) * 60 + parseInt(mm, 10);
    }

    /********* Функция преобразования массива в объекты **********/
    function arrayToObjects(arr) {
      if (!arr.length) return [];
      const header = arr[0];
      return arr.slice(1).map(row => {
        const obj = {};
        header.forEach((key, i) => {
          obj[key] = row[i] || "";
        });
        return obj;
      });
    }

    /********* Aircall: Рендер карточки с обновленными статусами **********/
    function renderAircallCardWithStatuses(activeList, awayList) {
      let html = `
        <div class="platform-card">
          <h5>Aircall</h5>
          <p><small>Активные (${activeList.length})</small></p>
          <ul id="aircall-active-list">`;
      activeList.forEach(n => {
        const safeId = n.replace(/\s+/g, "_");
        html += `<li id="emp-${safeId}">${n} - <span style="color:blue;">Loading...</span></li>`;
      });
      html += `</ul>
          <p><small>Away (${awayList.length})</small></p>
          <ul>`;
      awayList.forEach(a => {
        const extra = a.reason ? " - " + a.reason : "";
        html += `<li>${a.name}${extra}</li>`;
      });
      html += `</ul></div>`;
      const skel = document.getElementById("aircall-skeleton");
      if (skel) {
        skel.outerHTML = html;
      } else {
        document.getElementById("platforms-container").innerHTML += html;
      }
    }

    async function fetchAircallStatuses() {
      renderAircallCardWithStatuses(aircallActive, aircallAway);
      for (let emp of aircallActive) {
        const safeId = emp.replace(/\s+/g, "_");
        const liEl = document.getElementById("emp-" + safeId);
        if (!liEl) continue;
        const email = generateWoltEmail(emp);
        liEl.querySelector("span").textContent = "Fetching ID...";
        const userId = await getAircallUserId(email);
        if (!userId) {
          liEl.querySelector("span").textContent = "No ID";
          continue;
        }
        liEl.querySelector("span").textContent = "Fetching status...";
        const status = await getAircallAvailability(userId);
        liEl.querySelector("span").textContent = status;
      }
    }

    /********* Автообновление **********/
    let autoRefreshEnabled = true;
    let refreshInterval = 10;
    let refreshTimer = null;
    let countdownTimer = null;
    let countdownValue = refreshInterval;
    function resetAutoRefresh() {
      clearTimeout(refreshTimer);
      clearInterval(countdownTimer);
      countdownValue = refreshInterval;
      updateCountdownDisplay();
      refreshTimer = setTimeout(fetchData, refreshInterval * 1000);
      countdownTimer = setInterval(() => {
        countdownValue--;
        if (countdownValue <= 0) clearInterval(countdownTimer);
        updateCountdownDisplay();
      }, 1000);
    }
    function updateCountdownDisplay() {
      document.getElementById("countdown").textContent = countdownValue;
    }
    function toggleAutoRefresh() {
      autoRefreshEnabled = !autoRefreshEnabled;
      const btn = document.getElementById("toggle-autorefresh");
      if (autoRefreshEnabled) {
        btn.textContent = "Disable Auto Refresh";
        resetAutoRefresh();
      } else {
        btn.textContent = "Enable Auto Refresh";
        clearTimeout(refreshTimer);
        clearInterval(countdownTimer);
        document.getElementById("countdown").textContent = "";
      }
    }
    function refreshNow() {
      fetchData();
    }

    /********* Основная функция загрузки данных и рендера дашборда **********/
    async function fetchData() {
      const data = await fetchSheetData(RANGE);
      if (!data) return;
      logDebug("Основные данные получены: " + JSON.stringify(data));
      renderDashboard(data);
      showUpdatedStatus();
      renderShiftSummary(data);
      fetchBreaksData();
      if (autoRefreshEnabled) resetAutoRefresh();
      // Извлекаем список сотрудников для платформы Aircall
      const aircallConfig = platforms.find(p => p.name === "Aircall");
      aircallActive = [];
      aircallAway = [];
      for (let r = aircallConfig.rowActiveNamesStart; r <= aircallConfig.rowActiveNamesEnd; r++) {
        const name = data[r]?.[aircallConfig.colIndexNames]?.trim();
        if (name) aircallActive.push(name);
      }
      // Если есть отдельный диапазон для away, можно его обработать (в этом примере away оставляем пустым)
      renderAircallCardWithStatuses(aircallActive, aircallAway);
      fetchAircallStatuses();
    }

    function showUpdatedStatus() {
      const el = document.getElementById("update-status");
      el.textContent = "Updated";
      el.style.backgroundColor = "#28a745";
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("toggle-autorefresh").addEventListener("click", toggleAutoRefresh);
      document.getElementById("refresh-now").addEventListener("click", refreshNow);
      fetchData();
    });
  </script>
</body>
</html>
