<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>SUMO Dashboard</title>
    <link rel="icon" type="image/png" href="favicon.png" />
    <!-- Подключаем Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <!-- Подключаем Bootstrap-Select CSS для современного dropdown -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.18/css/bootstrap-select.min.css"
    />
    <style>
      /* Скрываем страницу до проверки авторизации */
      body.hidden {
        display: none;
      }

      /* Grid layout: header + sidebar + main + right panel */
      html, body { height: 100%; margin: 0; padding: 0; }
      .dashboard-header { grid-area: header; }
      .dashboard-layout { display: grid; grid-template-rows: auto 1fr; grid-template-columns: 0 1fr 300px; grid-template-areas: "header header header" "sidebar main right"; transition: grid-template-columns .3s; padding-top: 60px;}
      aside.sidebar { overflow: hidden; }
      main.main-content { grid-area: main; padding:0.5rem 2rem; overflow-y:auto; }
      aside.right-panel { grid-area: right; background: rgba(255,255,255,0.15); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-left:1px solid rgba(255,255,255,0.3); box-shadow:-4px 0 24px rgba(0,0,0,0.08); border-radius:16px 0 0 16px; padding:1rem; overflow-y:auto; }
      .dashboard-layout.sidebar-open {
        grid-template-columns: 250px 1fr 300px;       /* при открытом меню */
      }

      /* Glass-card base */
      .glass-card, .stats-card, .platform-card, .alert-card, .filter-panel {
        background: rgba(255,255,255,0.12);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border:1px solid rgba(255,255,255,0.3);
        box-shadow:0 10px 40px rgba(0,0,0,0.06);
        border-radius:16px;
        padding:1rem;
        margin-bottom:1rem;
        transition:transform .3s, box-shadow .3s;
      }
      .stats-card:hover, .platform-card:hover, .alert-card:hover, .filter-panel:hover { transform:translateY(-4px); box-shadow:0 14px 48px rgba(0,0,0,0.1); }

      /* Header styling */
      .dashboard-header nav.navbar { position:sticky; top:0; z-index:100; }

      /* Sidebar menu inside aside.sidebar */
      aside.sidebar #sidebar { background:var(--menu-bg-color, #fff); border-radius:8px; overflow:hidden; }
      aside.sidebar #sidebar a { display:flex; align-items:center; gap:8px; padding:8px; color:var(--text-color,#343a40); text-decoration:none; border-bottom:1px solid rgba(0,0,0,0.05); }
      aside.sidebar #sidebar a:hover { background:rgba(0,0,0,0.05); }

      /* Filter panel */
      .filter-panel { display:flex; flex-wrap:wrap; gap:12px; max-width:1200px; margin:0 auto 24px; padding: 16px 24px !important; border-radius: 30px !important;}
      .filter-panel .filter-dropdown, .filter-panel .search-input { background:rgba(255,255,255,0.25); border:1px solid rgba(255,255,255,0.4); border-radius:20px !important; padding:10px 16px !important; min-width:120px; transition: background 0.2s, border-color 0.2s; box-shadow: 0.2s; }
      .filter-panel .filter-dropdown:hover, .filter-panel .filter-dropdown:focus, .filter-panel .search-input:hover, .filter-panel .search-input:focus { background:rgba(255,255,255,0.35); border-color:rgba(255,255,255,0.6); outline:none; }
      
      /* Stats cards grid */
      #summary-grid {
        display: grid !important;
        /* сколько угодно колонок, но минимум по 180px и максимум 1fr */
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)) !important;
        gap: 1rem !important;
        /* тянем на всю ширину родителя */
        width: 100% !important;
        max-width: none !important;
        margin: 0 !important;
        padding-bottom: 0;
        justify-items: stretch;
      }

      .stats-title { font-size:.75rem; color:#6c757d; text-transform:uppercase; letter-spacing:.05rem; }
      .stats-value { font-size:1.4rem; font-weight:700; margin:0.3rem 0; }
      .stats-card.small-font-card .stats-value { font-size:1rem; }

      #find-candidate { border-radius: 20px;}
      /* Platforms row */
      /* 1) Общие статы — пусть остаются flex’ом или как вам удобно */
      #summary-general {
  display: grid !important;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)) !important;
  gap: 1rem !important;
  width: 100% !important;
  margin-bottom: 1.5rem;
}


/* 2) Платформенные статы — grid с тем же шаблоном, что и platform-card */
#summary-platforms {
  display: grid !important;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)) !important;
  gap: 1rem !important;
  width: 100% !important;
  margin: 0 0 1.5rem 0;
}

/* 3) Платформенные карточки — тоже grid, точно по этим же колонкам */
.platforms-row {
  display: grid !important;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)) !important;
  gap: 1rem !important;
  width: 100% !important;
  margin: 0 !important;
  align-items: start !important;
}


      .platform-card { flex:1 1 220px; min-width:200px; overflow-wrap:break-word; }
      .platform-card h5 { margin-bottom:.5rem; font-weight:600; }
      .platform-card ul { list-style:none; padding:0; margin:0; }
      .platform-card li { padding:.25rem 0; }

      /* Alerts */
      #alerts-section { display:flex; flex-wrap:wrap; gap:1.5rem; justify-content:center; }
      .alert-card { flex:0 1 320px; max-width:400px; display:flex; flex-direction:column; text-align:center; justify-content:flex-start; }
      .alert-card h2 { margin-bottom:1rem; font-weight:500; }
      .alert-content { flex:1; overflow-y:auto; }

      /* Responsive */
      @media(max-width:768px) {
        .dashboard-layout { grid-template-columns:1fr; grid-template-areas:"header" "main" "right" "sidebar"; height:auto; }
        aside.sidebar, aside.right-panel { width:100%; border-radius:0; box-shadow:none; }
      }

      :root {
        /* Светлая тема по умолчанию */
        --bg-color: linear-gradient(120deg, #fdfbfb 0%, #ebedee 100%);
        --text-color: #343a40;
        --card-bg-color: #ffffff;
        --card-text-color: #495057;
        --card-border-color: #dee2e6;
        --card-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        --card-hover-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
        --menu-bg-color: #ffffff;
        --menu-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
        --menu-width: 250px;
        --transition-speed: 0.3s;
      }
      /* Тёмная тема */
      body.dark-theme {
        --bg-color: linear-gradient(120deg, #252525 0%, #313131 100%);
        --text-color: #f0f0f0;
        --card-bg-color: #3a3a3a;
        --card-text-color: #e5e5e5;
        --card-border-color: #555555;
        --card-shadow: 0 4px 16px rgba(255, 255, 255, 0.08);
        --card-hover-shadow: 0 6px 20px rgba(255, 255, 255, 0.12);
        --menu-bg-color: #3a3a3a;
      }

      body.dark-theme .stats-card.red-card {
        background-color: #4a1f1f !important;
        border: 1px solid #dc3545 !important;
      }

      /* Общий сброс и фон */
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        min-height: 100vh;
        background: var(--bg-color);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        overflow-x: hidden;
        color: var(--text-color);
        transition: background var(--transition-speed) ease,
          color var(--transition-speed) ease;
      }

      /* Стиль для блока с информацией о пользователе и кнопкой выхода */
      #user-info {
        text-align: right;
        padding: 10px;
        font-size: 1rem;
        color: var(--text-color);
      }
      .notifications-dropdown {
        position: absolute;
        top: calc(100% + 20px);    /* прямо под иконкой */
        right: -135px;     /* по правому краю контейнера */
        width: 300px; /* или ваша ширина */
        max-height: 400px;
        overflow-y: auto;
        background: var(--card-bg-color);
        border: 1px solid var(--card-border-color);
        box-shadow: var(--card-shadow);
        border-radius: 8px;
        z-index: 1000;
        display: none;
    }
    .notifications-dropdown.show {
      display: block;
    }
    .notifications-dropdown .unread {
      background-color: rgba(220,53,69,0.1);
      font-weight: bold;
    }
    .notifications-dropdown .read {
      background-color: transparent;
      color: var(--text-color);
    }

      /* Сайдбар (меню) */
      .hamburger-menu {
        margin-right: 12px;
        cursor: pointer;
      }
      .hamburger-menu span {
        font-size: 28px;
        color: var(--text-color);
      }
      #sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 250px;
        height: 100%;
        background: var(--menu-bg-color);
        box-shadow: 2px 0 12px rgba(0, 0, 0, 0.2);
        transition: transform .3s;
        z-index: 200 !important;
        padding: 30px 20px;
        transform: translate(-100%);
      }
      aside.sidebar #sidebar {
        position: fixed;             /* чтобы не зависело от потока */
        top: 60px !important;        /* под шапку */
        height: calc(100% - 60px);   /* занимать остальную высоту */
        z-index: 90;                 /* чуть ниже шапки */
      }

      #sidebar.active {
        transform: translateX(0);
      }
      #sidebar-close {
        position-absolute;
        top: 12px;
        right: 12px;
        z-index: 91;
      }

      #sidebar a {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 10px;
        font-size: 1rem;
        color: var(--text-color);
        border-bottom: 1px solid var(--card-border-color);
        transition: background 0.2s ease, transform 0.2s ease;
        text-decoration: none;
      }

      #sidebar a:hover {
        background: rgba(0, 123, 255, 0.05);
        transform: translateX(4px);
        border-radius: 6px;
      }

      #sidebar .close-btn {
        font-size: 24px;
        text-align: right;
        cursor: pointer;
        color: var(--text-color);
        margin-bottom: 20px;
      }

      body.dark-theme #sidebar {
        background: #2b2b2b;
      }

      body.dark-theme #sidebar a {
        color: #f0f0f0;
      }

      body.dark-theme #sidebar a:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .dashboard-container {
        width: 100%;
        margin: 0;
        padding: 20px;
        box-sizing: border-box;
      }
      h1 {
        text-align: center;
        margin-bottom: 20px;
        font-weight: 500;
        font-size: 2rem;
        color: var(--text-color);
      }

      /* Панель фильтров */
      .filter-panel {
        background: rgba(255,255,255,0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 12px 24px;
        margin: 0 auto 24px;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        border: 1px solid rgba(255,255,255,0.3);
        max-width: 1200px;
      }
      .filter-panel .filter-dropdown {
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.4);
        border-radius: 8px;
        padding: 8px 12px;
        min-width: 140px;
        transition: background 0.2s ease, border-color 0.2s ease;
      }
      .filter-panel .filter-dropdown:hover,
      .filter-panel .filter-dropdown:focus,
      .filter-panel .search-input:hover,
      .filter-panel .search-input:focus {
        background: rgba(255,255,255,0.3);      
        border-color: rgba(255,255,255,0.6); /* подчеркнём цветом при взаимодействии */
        outline: none;
      }
      .filter-panel .bootstrap-select .dropdown-toggle {
        height: 100% !important;
        padding: 0 16px !important; /* слева-справа как у остальных */
        display: flex;
        align-items: center;
        box-shadow: none !important;
        border-radius: 20px !important;
      }
      .filter-panel .bootstrap-select .dropdown-toggle .filter-option-inner-inner {
        display: flex;
        align-items: center;
        height: 100%;
      }
      /* выпадашка тоже закругляется */
      .filter-panel .bootstrap-select .dropdown-menu {
        border-radius: 20px;
      }
      #summary-grid {
      display: grid !important;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)) !important;
      gap: 1rem !important;
      width: 100% !important;      /* тянем на всю ширину родителя */
      margin: 0 !important;        /* без авто-отступов */
      padding: 0;
    }

      .stats-card {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        margin: 8px;
        padding: 0.8rem 0.6rem !important;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        background: rgba(255,255,255,0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 16px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        position: relative;
        overflow: hidden;
        border: 1px solid rgba(255,255,255,0.3);
        min-width: 180px;
      }
      .stats-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
      }
      .stats-card .stats-title {
        font-size: 0.75rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.05rem;
        margin-bottom: 0.3rem;
      }
      .stats-card .stats-value {
        font-size: 1.4rem;
        font-weight: 700;
        color: #343a40;
        margin-bottom: 0.2rem;
      }
      .stats-card .small {
        font-size: 0.75rem;
        color: #868e96;
        margin-top: 0.25rem;
      }
      .stats-card .info-icon {
        width: 1rem;
        height: 1rem;
        marging-left: 0.5rem !important;
        filter: grayscale(100%);
        transition: filter 0.2s ease;
        cursor: pointer;
      }
      .stats-card .info-icon:hover {
        filter: none;
      }
      .stats-value.d-inline-flex {
        gap: 0.25rem  !important;
        align-items: center !important;
      }
      .stats-card.red-card {
        background-color: #fff5ff;
        border: 1px solid #ff6b6b;     /* красная граница */
      }
      .stats-title {
        font-size: 0.9rem;
        opacity: 0.7;
      }
      .stats-value {
        font-weight: bold;
        font-size: 1.2rem;
        margin-top: 4px;
      }
      .red-card {
        background-color: #ffe5e5;
        border-color: #dc3545;     /* красная граница */
        border: 1px solid #ff6b6b;
      }
      .filter-section {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }
      .filter-dropdown {
        padding: 8px 12px;
        border: 1px solid var(--card-border-color);
        border-radius: 6px;
        background: var(--card-bg-color);
        min-width: 120px;
        color: var(--text-color);
      }
      .search-section {
        display: flex;
        margin-left: auto;
      }
      .search-input {
        padding: 8px 12px;
        border: 1px solid var(--card-border-color);
        border-radius: 6px 0 0 6px;
        background: var(--card-bg-color);
        width: 150px;
        color: var(--text-color);
      }

      /* Секция обновления страницы */
      .refresh-section {
        margin-left: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .refresh-btn {
        padding: 6px 10px;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .refresh-btn, .refresh-section img {
        transition: transform .2s ease;
      }
      .refresh-btn:hover, .refresh-section img:hover {
        transform: scale(1.1);
      }
      .theme-switch .slider:before {
        font-size: 14px;
        line-height: 18px;
      }
      .refresh-btn:hover {
        background-color: #218838;
      }
      .spinner-border {
        width: 1rem;
        height: 1rem;
        border-width: 0.1em;
      }
      @media (max-width: 768px) {
        .filter-panel {
          justify-content: center;
        }
        .filter-panel .filter-dropdown,
        .filter-panel .search-input {
          min-width: 45%;
        }
      }
      /* Сброс стилей для текста */
      .theme-text {
        margin: 0;
        padding: 0;
        line-height: 1;
        font-size: 1rem;
      }
      /* Переключатель темы */
      .theme-toggle-container {
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .theme-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
      }
      .theme-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 24px;
      }
      .slider:before {
        position: absolute;
        content: "☀️";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
        font-size: 12px;
        line-height: 18px;
        text-align: center;
        color: #f39c12;
      }
      input:checked + .slider {
        background-color: #007bff;
      }
      input:checked + .slider:before {
        transform: translateX(26px);
        content: "🌙";
        color: #f1c40f;
      }

      /* Карточки и таблицы */
      .platform-card {
        flex: 1 1 220px;
        min-width: 220px;
        background: rgba(255,255,255,0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.3);
        color: var(--card-text-color);
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
        overflow-wrap: break-word;
      }
      .platform-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--card-hover-shadow);
      }
      .platform-card h5 {
        text-align: center;
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 12px;
        color: var(--text-color);
      }
      .platform-card h5 .info-icon {
        display: inline-block;
        margin-left: 5px;
        cursor: pointer;
        font-size: 0.9rem;
        vertical-align: middle;
      }
      .platform-card p {
        text-align: center;
        margin: 10px 0;
        font-size: 0.85rem;
        color: #6c757d;
      }
      .platform-card ul {
        list-style: none;
        padding-left: 0;
        font-size: 0.85rem;
        color: var(--card-text-color);
      }
      .platform-card ul li {
        padding: 4px 0;
        cursor: pointer;
      }
      
      .platform-card ul li:not(:last-child) {
        border-bottom: 1px solid var(--card-border-color);
      }
      .platform-card ul li:last-child {
        border-bottom: none;
      }

      /* Стили для бейджей смены перед именем */
      .platform-card .badge {
        font-size: 0.75rem;
        vertical-align: middle;
      }
      .platform-card .badge-pill {
        padding: 0.25em 0.6em;
        margin-right: 0.4em;
      }

      .shift-summary-card {
        background: none !important;
        color: var(--card-text-color);
        border: none !important;
        box-shadow: none !important;
        padding: 20px;
        margin: 0 auto 40px;
        text-align: center;
        overflow-wrap: break-word;
        font-size: 1.2rem;
        font-weight: 700;
        border-radius:16px;
      }
      .shift-summary-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--card-hover-shadow);
      }
      .shift-summary-title {
        margin-bottom: 16px;
        font-weight: 600;
        font-size: 1.3rem;
        color: var(--text-color);
      }
      .shift-summary-grid {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        table-layout: auto;
        font-size: 2rem;
      }
      .shift-summary-grid th,
      .shift-summary-grid td {
        padding: 8px 12px;
        text-align: center;
        font-size: 0.85rem;
        color: var(--card-text-color);
      }
      .shift-summary-grid th {
        background: none !important;
        font-weight: 600;
      }
      .shift-summary-grid td {
        background: none !important;
        border: 1px solid var(--card-border-color);
        border-radius: 8px;
      }
      .small-font-card {
        font-size: 0.9rem;
      }
      .shift-card-title {
        font-size: 1.4rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
        text-align: center;
      }
      .shift-card-away {
        font-size: 1.1rem;
        color: #666;
        text-align: center;
      }
      #breaks-section {
        margin-top: 40px;
      }

      #alerts-section #breaks-section {
        margin-top: 0;
      }
      
      #breaks-section h2 {
        text-align: center;
        margin-bottom: 20px;
        font-weight: 500;
        font-size: 1.5rem;
        color: var(--text-color);
      }
      /* Контейнер двух карточек */
      #alerts-section {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
        justify-content: center;
        align-items: stretch;
        margin: 2rem 0;
      }
      
      /* Карточка внутри */
      .alert-card {
        flex: 0 1 320px;      /* не растягиваем карточку больше базисной ширины */
        max-width: 400px;      /* ограничиваем максимальную ширину */
        align-self: stretch;   /* заставляем все карточки быть одной высоты */
        background: rgba(255,255,255,0.1);
        border: 1px solid var(--card-border-color);
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: 16px;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        text-align: center;
        justify-content: center;
      }

      #breaks-app .break-card {
      margin-bottom: 0 !important;
      }

      .alert-content {
        flex: 1;             /* займёт всё оставшееся пространство */
        overflow-y: auto;    /* если много элементов — появится скролл */
      }
      
      /* Заголовок */
      .alert-card h2 {
        margin-bottom: 20px;
        font-weight: 500;
        font-size: 1.5rem;
        color: var(--text-color);
      }
      
      /* Контент-область */
      .alert-card > div {
        flex: 1;
        overflow-y: auto;
      }

      .alert-card ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .alert-card li {
        margin-bottom: 0.75rem;
        line-height: 1.3;
      }
      @media (max-width: 768px) {
        .alert-card { max-width: 100%; }
      }

      .break-conflict > strong {
        color: #dc3545;
      }

      /* контейнер списка внутри */
      #shift-overs-app ul,
      #breaks-app ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      #shift-overs-app li,
      #breaks-app li {
        margin-bottom: 0.75rem;
      }

      .break-card {
        background: var(--card-bg-color);
        color: var(--card-text-color);
        border-radius: 16px;
        box-shadow: var(--card-shadow);
        padding: 20px;
        margin: 0 auto 40px;
        max-width: 600px;
        text-align: center;
        overflow-wrap: break-word;
      }
      .break-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--card-hover-shadow);
      }
      .break-card h5 {
        margin-bottom: 12px;
        font-weight: 600;
        font-size: 1.1rem;
        color: var(--text-color);
      }
      .break-card ul {
        list-style: none;
        padding-left: 0;
        font-size: 0.85rem;
        color: var(--card-text-color);
      }
      .break-card ul li {
        padding: 6px 0;
        border-bottom: 1px solid var(--card-border-color);
      }
      .break-card ul li:last-child {
        border-bottom: none;
      }

      /* Модальное окно сотрудника */
      #modal-overlay {
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
        position:fixed;
        top : 0;
        left: 0;  
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }
      #employee-modal {
        opacity: 0;
        transform: translateX(-50%) scale(0.95);
        transition: opacity 0.3s ease, transform 0.3s ease;
        position: fixed;
        top: 20%;
        left: 50%;
        background: var(--card-bg-color);
        color: var(--card-text-color);
        border: 1px solid var(--card-border-color);
        box-shadow: var(--card-shadow);
        border-radius: 8px;
        padding: 20px;
        z-index: 1001;
        width: 330px;
        pointer-events: none;
        max-height: 80vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      #employee-modal.show {
        opacity: 1;
        transform: translateX(-50%) scale(1);
        pointer-events: auto;
      }

      #modal-overlay.show {
        opacity: 1;
        pointer-events: auto;
      }

      #employee-modal h3 {
        margin: 0 0 8px 0;
      }
      #employee-modal .close-btn {
        position: absolute;
        top: 8px;
        right: 12px;
        cursor: pointer;
        font-size: 20px;
      }
      #employee-modal a {
        color: #007bff;
        text-decoration: underline;
      }
      #employee-modal a:hover {
        color: #0056b3;
      }
      /* Контейнер с инфой и кнопками оставляем по контенту, а вот список делаем скроллимым */
      #employee-modal > div:nth-of-type(2) {
        /* это как раз <div> с padding вокруг всей таблички инфы и списка */
        flex: 1 1 auto;
        overflow-y: auto;
      }
      
      /* Если хотите более точечно только список платформенных переходов: */
      #modal-platform-list {
        max-height: 200px;    /* или сколько вам нужно */
        overflow-y: auto;
        margin-left: 20px;
        font-size: 0.9rem;
      }
      .dashboard-header {
        position: fixed;
        display: flex;
        padding: 1rem 2rem;
        min-height: 60px;
        justify-content: space-between;
        align-items: center;
        background: var(--card-bg-color);
        border-bottom: 1px solid var(--card-border-color);
        box-shadow: var(--card-shadow);
        border-radius: 0 0 12px 12px;
        position: sticky;
        top: 0;
        left: 0;
        right: 0;
        height: 60px;
        z-index: 100;
      }
      .filters-wrapper {
        displax: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        border-radius: 30px !important;
        padding: 16px 24px !important;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(0,0,0,0.1) !important;
        box-shadow: var(--card-shadow);
        background-filter: blur(10px);
        flex: 1 1 auto;
        min-width: 0;
        max-width: 100%;
        margin: 0.25rem auto 24px;
        margin-top: -0.5rem;
      }
      .filters-wrapper .filter-dropdown {
      box-sizing: border-box;
      height: 40px;
      padding: 8px 16px;
      min-width: 120px; /* или любую вашу ширину */
      background: var(--card-bg-color);
      border: 1px solid var(--card-border-color);
      border-radius: 20px;
    }

    .filters-wrapper .bootstrap-select {
  width: auto !important;
  flex-shrink: 0;            /* не даём ужиматься */
  margin-right: 0.5rem;      /* чуть отступа справа */
}

    /* Применяем тот же стиль к кнопке bootstrap-select */
    .filters-wrapper .bootstrap-select .dropdown-toggle.filter-dropdown {
      flex: 0 0 auto !important;
      box-sizing: border-box !important;
      height: 40px !important;
      padding: 8px 16px !important;
      min-width: 120px !important;
    }
      .filters-wrapper .filter-dropdown,
      .filters-wrapper .search-input {
        border-radius: 20px !important;
        padding: 10px 16px !important;
        transition: background 0.2s, border-color 0.2s, box-shadow 0.2s;
      }

      
      .filters-wrapper select,
      .filters-wrapper input {
        flex-shrink: 0;
      }
      @media (max-width: 768px) {
        .filters-wrapper {
          flex-direction: column;
          align-items: stretch;
        }
        .filters-wrapper > * {
          width: 100%;
        }
      }
      .header-gap > * {
        margin-right: 10px;
        margin-bottom: 6px;
      }
      .header-gap > *:last-child {
        margin-right: 0;
      }
      .info-cards {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        justify-content: center;
        margin-bottom: 20px;
      }

      .aircall-status {
      font-weight: bold;
    }
    
    .status-available {
      color: green;
    }
    
    .status-on-a-call {
      color: orange;
    }
    
    .status-offline {
      color: gray;
    }
    
    .status-busy, .status-away {
      color: red;
    }


/* 4) Скругляем само выпадающее меню */
.filters-wrapper .bootstrap-select .dropdown-menu {
  border-radius: 20px !important;
  background: var(--card-bg-color) !important;
  border: 1px solid var(--card-border-color) !important;
  box-shadow: none !important;
}
      /* Используем вашу переменную тёмного фона */
.shift-summary-card,
aside.right-panel .alert-card {
  background: var(--card-bg-color) !important;
  border: 1px solid var(--card-border-color) !important;
  box-shadow: var(--card-shadow) !important;
}

/* И чтобы текст внутри них тоже был читабельным */
.shift-summary-card,
aside.right-panel .alert-card {
  color: var(--card-text-color) !important;
}

      
      /* Переопределение ширины для поля Platform, используем bootstrap‑select */
      .btn-outline-primary:hover {
        color: white !important;
        background-color: #007bff !important;
        border-color: #007bff !important;
      }

      body.dark-theme #employee-modal {
        background-color: #2b2b2b;
        color: #f0f0f0;
        border: 1px solid #444;
      }

      body.dark-theme #employee-modal h5 {
        color: #fff;
      }

      body.dark-theme #employee-modal small {
        color: #aaa;
      }

      body.dark-theme #employee-modal strong {
        color: #ddd;
      }

      body.dark-theme #employee-modal a,
      body.dark-theme #employee-modal .btn-outline-primary {
        color: #66b0ff;
        border-color: #66b0ff;
      }

      body.dark-theme #employee-modal .btn-outline-primary:hover {
        background-color: #66b0ff;
        color: white;
      }

      /* Стили для карточек в dark-theme */
      body.dark-theme .stats-card {
        background: var(--card-bg-color) !important;    /* из ваших переменных тёмной темы */
        border-color: var(--card-border-color) !important;
        color: var(--card-text-color) !important;       /* общий цвет текста */
      }

      /* Заголовки внутри карточек (stats-title) */
      body.dark-theme .stats-card .stats-title {
        color: rgba(255,255,255,0.7) !important;
      }

      /* Основные большие цифры (stats-value) */
      body.dark-theme .stats-card .stats-value {
        color: #ffffff !important;
      }

      /* Мелкий дополнительный текст (класс .small или inline) */
      body.dark-theme .stats-card .small,
      body.dark-theme .stats-card .stats-value small {
        color: rgba(255,255,255,0.6) !important;
      }

      body.dark-theme .platform-card,
      body.dark-theme .stats-card,
      body.dark-theme .alert-card {
        box-shadow: none !important;
      }

      body.dark-theme .platform-card .text-muted {
      color: #f1f1f1 !important;
     }
     /* Увеличиваем размер шрифта и делаем чуть погуще */
    #user-display-name {
      font-size: 1.1rem;      /* вы можете подправить под свой вкус */
      font-weight: 500;
    }
    /* чтобы анимация была плавной */
#notification-bell img {
  transition: filter 0.3s ease;
  position: relative;
}

/* в тёмной теме просто инвертируем изображение */
body.dark-theme #notification-bell img {
  filter: invert(1) brightness(1.5);
}


    /* В светлой теме пусть остаётся ваш стандартный цвет */
    #user-display-name {
      color: var(--text-color);
    }

    /* В тёмной теме — строгий белый */
    body.dark-theme #user-display-name {
      color: #ffffff !important;
    }

     body.dark-theme #user-display-name.text-muted {
      color: #ffffff !important;
    }


     /* для контейнера фильтров без тени в темной теме */
      body.dark-theme .filter-panel,
      body.dark-theme .filters-wrapper {
        box-shadow: none !important;
      }

      /* Общие скругления для выпадашки */
      .bootstrap-select .dropdown-menu {
        border-radius: 16px !important;
      }

      /* Светлая тема: белый фон и тонкая серая рамка */
      body:not(.dark-theme) .bootstrap-select .dropdown-menu {
        background: #ffffff !important;
        border: 1px solid #dee2e6 !important;
        box-shadow: none !important;
      }

      /* Тёмная тема: тёмный фон и рамка из переменной */
      body.dark-theme .bootstrap-select .dropdown-menu {
        background: var(--card-bg-color) !important;
        border: 1px solid var(--card-border-color) !important;
        box-shadow: none !important;
      }

      /* — Скругляем и убираем белый фон у кнопки выпадашки — */
.bootstrap-select .dropdown-toggle {
  border-radius: 20px !important;
  box-shadow: none !important;
}

/* — светлая тема для кнопки — */
body:not(.dark-theme) .bootstrap-select .dropdown-toggle {
  background-color: #fff !important;
  border: 1px solid #dee2e6 !important;
  color: #343a40 !important;
}

/* — тёмная тема для кнопки — */
body.dark-theme .bootstrap-select .dropdown-toggle {
  background-color: var(--card-bg-color) !important;
  border: 1px solid var(--card-border-color) !important;
  color: var(--text-color) !important;
}

/* — чуть скругляем стрелочку — */
.bootstrap-select .dropdown-toggle .filter-option-inner-inner {
  border-radius: 20px !important;
}

      /* Текст пунктов */
      .bootstrap-select .dropdown-item {
        border-radius: 12px;             /* чуть скруглить сами пункты */
        transition: background .2s ease;
      }

      /* Цвета пунктов в светлой теме */
      body:not(.dark-theme) .bootstrap-select .dropdown-item {
        color: #343a40;
      }
      body:not(.dark-theme) .bootstrap-select .dropdown-item:hover,
      body:not(.dark-theme) .bootstrap-select .dropdown-item.active {
        background-color: #f1f1f1 !important;
      }

      /* Цвета пунктов в тёмной теме */
      body.dark-theme .bootstrap-select .dropdown-item {
        color: #e5e5e5;
      }
      body.dark-theme .bootstrap-select .dropdown-item:hover,
      body.dark-theme .bootstrap-select .dropdown-item.active {
        background-color: rgba(255,255,255,0.1) !important;
      }

      .break-overdue {
        color: #dc3545 !important; /* Bootstrap red */
        font-weight: bold;
        animation: pulse 1s infinite;
      }
      .break-overdue .employee-name,
      .break-overdue .text-muted {
        color: #dc3545 !important; /* Bootstrap red */
        font-weight: bold;
      }
      .body.dark-theme .break-overdue {
        color: #dc3545 !important; /* Bootstrap red */
        font-weight: bold;
        animation: pulse 1s infinite !important;
      }
      body.dark-theme .break-overdue .employee-name,
      body.dark-theme .break-overdue .text-muted {
        color: #dc3545 !important;
      }
      .employee-item.king .employee-name {
        color: gold !important;
        font-weight: bold;
      }

      .employee-item.pink-name .employee-name {
      color: hotpink !important;
      }

      .pink-name {
      color: hotpink !important;
      }

      .employee-name {
        transition: transform 0.3s ease, color 0.3 ease;
      }

      .employee-name:hover {
        transition: scale(1.1);
        color: #ff4500;
        cursor: pointer;
      }

      .aircall-status {
        color: green !important;
      }
      /* точно такой же размер и отступы, как у обычных .filter-dropdown */
    .filters-wrapper .bootstrap-select .dropdown-toggle {
      box-sizing: border-box !important;
      height: 40px !important;      /* совпадает с height .filter-dropdown */
      padding: 8px 16px !important; /* совпадает с padding .filter-dropdown */
      background: var(--card-bg-color) !important;
      border: 1px solid var(--card-border-color) !important;
      border-radius: 20px !important;
    }
    
    /* Сброс фонового цвета и установка белого текста для второго столбца таблицы в dark-theme */
body.dark-theme .shift-summary-grid td:nth-child(2),
body.dark-theme .shift-summary-grid th:nth-child(2) {
  background-color: transparent !important;
  color: #ffffff !important;
}

/* Если внутри ячеек ещё есть span-элементы с фоном, сбросим и у них */
body.dark-theme .shift-summary-grid td:nth-child(2) span {
  background-color: transparent !important;
  color: #ffffff !important;
}

/* родительский контейнер — общий флекс со всеми переключателями */
.toggle-container {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;      /* расстояние между текстом и слайдером */
  margin-right: 1rem;
}

/* при необходимости подкорректируйте размер шрифта/отступ у лейбла */
.toggle-container .toggle-label {
  font-size: 0.9rem;
  color: var(--text-color);
}

/* сам «слайдер» */
.dnd-switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 24px;
}
.dnd-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}
.dnd-switch .slider {
  position: absolute;
  cursor: pointer;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: #ccc;
  transition: background-color 0.3s;
  border-radius: 24px;
}
.dnd-switch .slider:before {
  content: "";
  position: absolute;
  height: 18px; width: 18px;
  left: 3px; bottom: 3px;
  background-color: white;
  transition: transform 0.3s;
  border-radius: 50%;
}

/* состояние «включено» */
.dnd-switch input:checked + .slider {
  background-color: #007bff;
}
.dnd-switch input:checked + .slider:before {
  transform: translateX(26px);
}
/* Делать контейнер блочным flex-элементом и выравнивать его содержимое по центру */
/* 1) Контейнер переключателя — flex-центр */
#dnd-toggle-container {
  display: inline-flex !important;
  align-items: center !important;
}

/* Override положения кружка при включённом чекбоксе */
#dnd-toggle-container .dnd-switch input:checked + .slider:before {
  bottom: 3px !important;            /* сохраняем смещение от низа */
  transform: translateX(26px) !important; /* сдвигаем вправо */
}

/* Не даём треку «подпрыгивать» */
#dnd-toggle-container .dnd-switch input:checked + .slider {
  top: 0 !important;
  bottom: 0 !important;
}

/* Вместо position:relative+top — просто поднимем/опустим весь лейбл чуть ниже */
#dnd-toggle-container .dnd-switch {
  /* экспериментируй с 1px–3px, пока не ляжет точно по центру */
  margin-top: 8px !important;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to   { transform: rotate(360deg); }
}
/* класс, который будем вешать на иконку */
.rotating {
  animation: spin 1s linear infinite;
}



      @keyframes pulse {
        0% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.6;
          transform: scale(1.05);
        }
        100% {
          opacity: 1;
          transform: scale(1);
        }
      }
    </style>
    <!-- Подключаем Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script>
      // Инициализация Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyAHyxC12UaO6QU_nCiWFnegul1Vix5skm8",
        authDomain: "shldashboard.firebaseapp.com",
        projectId: "shldashboard",
        storageBucket: "shldashboard.firebasestorage.app",
        messagingSenderId: "362566153595",
        appId: "1:362566153595:web:ee35c2588bd0f798e6f9de"
      };
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();

      const brbAlertSent = {};
      const BREAK_NOTIF_KEY = 'overdueBreakNotified';
      let overdueBreakNotified = JSON.parse(localStorage.getItem(BREAK_NOTIF_KEY) || '{}');
      const brbOverdueNotified = {};
      const TRANSITIONS_API = 'https://script.google.com/macros/s/AKfycbwlp0Gsq8sVkI28nFW1TZvW_immH6PLrXejAeexj-48MhFtV7_uQ8SVjNi13RUfv_uj/exec?json=1';



async function fetchStatusChanges() {
  try {
    const res = await fetch(TRANSFERS_API);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    // API возвращает массив объектов вида
    // { Timestamp: "...", Name: "...", FromPlatform: "...", ToPlatform: "...", Duration: "..." }
    const raw = await res.json();
    // приводим к единому формату
    window.transfersData = raw
      .map(item => ({
        name:         item.Name,
        fromPlatform: item.FromPlatform,
        toPlatform:   item.ToPlatform,
        duration:     item.Duration,
        timestamp:    item.Timestamp
      }))
      // отбрасываем неполные записи
      .filter(t => t.name && t.fromPlatform && t.toPlatform);
    console.log('transfersData', window.transfersData);
  } catch (err) {
    console.error('Ошибка fetchStatusChanges:', err);
    window.transfersData = [];
  }
}


      // Список разрешённых email
      const allowedEmails = [
        "mikhail.garayev@wolt.com",
        "elshan.tahmazov@wolt.com",
        "inara.mammadzada@wolt.com",
        "mayya.mirzayeva@wolt.com",
        "mikayil.alizada@wolt.com",
        "pasha.chiragov@wolt.com",
        "rahim.mammadov@wolt.com",
        "toghrul.mirzali@wolt.com",
        "amaliya.rizvanova@wolt.com",
        "anar.mikayilov@wolt.com",
        "arif.guliyev@wolt.com",
        "farid.hajiyev@wolt.com",
        "naziya.orujova@wolt.com",
        "rafig.huseynov@wolt.com",
        "sama.akbarzadegan@wolt.com",
        "mursal.askarov@wolt.com"
      ];

      // Проверка авторизации – если пользователь не авторизован или его email не разрешён, перенаправляем на login.html
      auth.onAuthStateChanged((user) => {
        if (!user || !allowedEmails.includes(user.email)) {
          window.location.replace("login.html");
        } else {
          // Если все ок, выводим имя пользователя и убираем класс hidden
          document.getElementById("user-display-name").textContent =
            user.displayName || user.email;
          document.body.classList.remove("hidden");
        }
      });

      // Обработчик для кнопки Log Out
      document.addEventListener("DOMContentLoaded", () => {
        const logoutBtn = document.getElementById("logout-btn");
        logoutBtn.addEventListener("click", () => {
          auth.signOut();
        });
      });
    </script>
  </head>
  <body class="hidden">
      <!-- Header -->
      <header class="dashboard-header">
  <!-- 1) Левая часть: бургер + заголовок -->
  <div class="d-flex align-items-center gap-3">
    <div class="hamburger-menu" id="hamburger-menu">
      <span style="font-size: 24px; cursor: pointer;">☰</span>
    </div>
    <h1 class="mb-0" style="font-size: 1.3rem;">
      Support Monitoring Dashboard
    </h1>
  </div>

  <!-- 2) Центральная часть: переключатели + таймер -->
  <div class="d-flex align-items-center flex-wrap header-gap flex-grow-1 justify-content-end">
    <!-- Do Not Disturb -->
    <div class="toggle-container" id="dnd-toggle-container">
      <span class="toggle-label">Do not Disturb</span>
      <label class="dnd-switch">
        <input type="checkbox" id="dnd-toggle" />
        <span class="slider"></span>
      </label>
    </div>

    <!-- Bell -->
    <div id="notification-bell" style="position:relative; cursor:pointer; margin-right:1rem;">
      <img
        src="https://www.svgrepo.com/show/525245/bell-off.svg"
        alt="Notifications"
        title="Notifications"
        style="width:24px; height:24px;"
      />
      <span
        id="notification-count"
        style="position:absolute; top:-4px; right:-4px; background:#dc3545;
               color:#fff; border-radius:50%; padding:2px 6px; font-size:0.7rem;
               display:none;"
      >0</span>
      <div id="notifications-panel" class="notifications-dropdown"></div>
    </div>
    <!-- Notifications dropdown panel -->

    <!-- Theme toggle -->
    <div class="d-flex align-items-center gap-2">
      <span>Theme:</span>
      <label class="theme-switch mb-0" style="margin-left: 8px;">
        <input type="checkbox" id="theme-checkbox" />
        <span class="slider"></span>
      </label>
    </div>

    <!-- Refresh -->
    <div class="refresh-section d-flex align-items-center gap-2 mr-3">
      <span id="timer-label">
        Refresh in: <span id="countdown">15</span>s
      </span>
      <img
        id="refresh-icon"
        src="https://www.svgrepo.com/show/168563/refresh.svg"
        alt="Refresh"
        title="Refresh now"
        style="width:24px; height:24px; cursor:pointer;"
        onclick="refreshNow()"
      />
    </div>
  </div>

  <!-- 3) Правая часть: имя + logout -->
  <div class="d-flex align-items-center gap-2">
    <span id="user-display-name" class="small text-muted"></span>
    <img
      id="logout-btn"
      src="./log-out.svg"
      alt="Log Out"
      title="Log Out"
      style="width:22px; height:22px; cursor:pointer; margin-left:8px;"
    />
  </div>
</header>

    <!-- Grid container -->
    <div class="dashboard-layout">

      <!-- Sidebar -->
      <aside class="sidebar">
        <div id="sidebar">
          <!-- новый close-btn с SVG-стрелкой -->
          <div class="close-btn" id="sidebar-close" title="Close sidebar">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24" height="24"
              viewBox="0 0 16 16"
              fill="currentColor"
              aria-hidden="true"
            >
              <path
                fill-rule="evenodd"
                d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 
                  5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 
                  1 0-.708l6-6a.5.5 0 0 1 .708 0z"
              />
            </svg>
          </div>
          <a href="https://mikhailgarayev.github.io/shldashboard/shifts.html">🗓️ Today`s Shifts by Platform</a>
          <a href="https://script.google.com/macros/s/AKfycbyMdv_AP0p3tTMUZoeKEQhw8YFI9upxx6P0oAAI5pO1s-PbcCyBkKIcbGasvi-dpVAb/exec">📈 Allocation stats</a>
          <a href="https://my.yigim.az/login" target="_blank">📊 YIGIM Dashboard</a>
          <a href="https://wolt-prod.datadoghq.eu/dashboard/zpt-745-5da/city-health-dashboard-template-24h-aze?fromUser=false&refresh_mode=sliding&tpl_var_area_name%5B0%5D=baku&view=spans&from_ts=1745505436253&to_ts=1745507236253&live=true" target="_blank">📈 Datadog Dashboard</a>
          <a href="https://wolt-prod.datadoghq.eu/dashboard/y66-xdi-4xy/payments---authorizations?fromUser=false&fullscreen_end_ts=1745567771563&fullscreen_paused=false&fullscreen_refresh_mode=sliding&fullscreen_section=overview&fullscreen_start_ts=1745566871563&fullscreen_widget=2003408243236226&refresh_mode=sliding&view=spans&from_ts=1745556684337&to_ts=1745560284337&live=true" target="_blank">📈 Datadog Payment Dashboard</a>
          <a href="https://ops.wolt.com/city-states?country=AZE" target="_blank">🏙️ City States</a>
          <a href="https://ops.wolt.com/city-tools" target="_blank">🛠️ City Tools</a>
          <a href="https://ops.wolt.com/support/converse/admin/users" target="_blank">🧭 Converse Admin Panel</a>
          <a href="https://wo.lt/tracker" target="_blank">⚙️ Away employees tracker</a>
          <a href="https://dashboard.aircall.io" target="_blank">📞 Aircall Dashboard</a>
          <a href="https://app.getguru.com/dashboard" target="_blank">📚 Guru</a>
          <a href="https://wo.lt/dashboard" target="_blank">📩 Video dashboard</a>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Filters -->
     <!-- Центр: фильтры -->
     <div class="filters-wrapper d-flex flex-wrap align-items-center flex-grow-1 justify-content-center header-gap">
      <!-- Статус -->
      <select id="status-filter" class="filter-dropdown">
        <option value="both">Status</option>
        <option value="active">Active</option>
        <option value="away">Away</option>
      </select>
    
      <!-- Платформы (bootstrap-select) -->
      <select
        id="platform-dropdown"
        class="selectpicker"
        multiple
        data-live-search="true"
        title="Platform"
        data-width="auto"
        data-style="filter-dropdown"
      >
        <option value="all" selected>All platforms</option>
        <option value="CS">CS</option>
        <option value="CS/Post order">CS/Post order</option>
        <option value="PSR">PSR</option>
        <option value="SiMo">SiMo</option>
        <option value="Aircall">Aircall</option>
        <option value="Venue">Venue</option>
        <option value="Trainee">Trainee</option>
        <option value="ST">ST</option>
      </select>
    
      <!-- Reallocate фильтр -->
      <select id="realloc-filter" class="filter-dropdown">
        <option value="all">Reallocate: All</option>
        <option value="Yes">Yes</option>
        <option value="No">No</option>
      </select>
    
      <!-- Language фильтр -->
      <select id="lang-filter" class="filter-dropdown">
        <option value="all">Language: All</option>
        <option value="two">Bilingual</option>
        <option value="three">Trilingual</option>
      </select>
    
      <!-- Breaks фильтр -->
      <select id="break-filter" class="filter-dropdown">
        <option value="upcoming">Breaks: Upcoming</option>
        <option value="all">Breaks: All</option>
      </select>
    
      <!-- Поиск по имени -->
      <input
        type="text"
        id="employee-search"
        placeholder="Search..."
        class="search-input"
      />
    
      <!-- Новый селект для Find Candidate -->
      <select id="target-platform" class="filter-dropdown">
        <option value="">→ Reallocate to..</option>
      </select>
      <button id="find-candidate" class="btn btn-outline-primary">Find candidate</button>
      <div id="candidate-result" style="margin:1rem 0;"></div>
    </div>

        <!-- Stats Cards -->
        <!-- 1) Общие карточки (On shift now, Should be, Not here, WNATS, Weather) -->
        <div id="summary-general"></div>

        <!-- 2) Только платформенные статы (CS, CS/Post Order, PSR, SiMo, Aircall, Venue, ST) -->
        <div id="summary-platforms"></div>

        <!-- 3) Платформенные platform-card -->
        <div id="platforms-container" class="platforms-row"></div>

      </main>

      <!-- Right Panel: Breaks & Shift-Overs -->
      <aside class="right-panel">
        <div id="shift-overs-section" class="alert-card"><h2>⏳ Upcoming Shift-Overs</h2><div id="shift-overs-app" class="alert-content">Loading...</div></div>
        <div id="breaks-section" class="alert-card"><h2>⏰ Breaks</h2><div id="breaks-app" class="alert-content">Loading...</div></div>
      </aside>

    </div> <!-- /.dashboard-layout -->

    <!-- Modals -->
  </div>
  <!-- Модальное окно сотрудника -->
  <div id="modal-overlay"></div>
  <div
    id="employee-modal">
    <div style="display: flex; align-items: center; justify-content: space-between; padding: 20px 20px 0 20px;">
      <div style="display: flex; align-items: center;">
        <img 
        id="modal-emp-avatar" 
        src="https://i.ibb.co/YrbxqCn/favicon.jpg" 
        alt="Avatar" 
        style="width: 60px; height: 60px; border-radius: 50%; margin-right: 15px;"
      />
        <div>
          <h5 id="modal-emp-name" style="margin: 0; font-weight: 600;">Employee Name</h5>
          <small id="modal-emp-email" style="color: #888;">employee.email@wolt.com</small>
        </div>
      </div>
      <span class="close-btn" id="modal-close" style="cursor: pointer; font-size: 24px; color: #999;">&times;</span>
    </div>
    <!-- Информация -->
    <div style="padding: 15px 20px 0 20px; text-align: left;">
      <div style="margin-bottom: 10px;">
        <strong>Role:</strong>
        <span id="modal-emp-role">Support Associate</span>
      </div>
      <div style="margin-bottom: 10px;">
        <strong>Prime platform:</strong>
        <span id="modal-emp-prime">CS</span>
      </div>
      <div style="margin-bottom: 10px;">
        <strong>Preferred platform:</strong>
        <span id="modal-emp-pref">PSR</span>
      </div>
      <div style="margin-bottom: 10px;">
        <strong>Can reallocate?:</strong>
        <span id="modal-emp-realloc">Yes</span>
      </div>
      <div style="margin-bottom: 10px;">
        <strong>Language:</strong>
        <span id="modal-emp-languages">AZ RUGB</span>
      </div>
      <div style="margin-bottom: 10px;">
        <strong>Capacity:</strong>
        <span id="modal-emp-capacity">—</span>
      </div>
      <div style="margin-bottom: 10px;">
        <strong>Shift:</strong>
        <span id="modal-emp-shift">—</span>
      </div>
      <div style="margin-bottom: 10px;">
        <strong>Break:</strong>
        <span id="modal-emp-break">—</span>
      </div>
      <div style="margin-bottom: 10px;">
        <strong>Platform changes today:</strong>
        <span id="modal-platform-count">–</span>
      </div>
      <ul id="modal-platform-list" style="margin-left: 20px; font-size:0.9rem;"></ul>

    </div>
    <!-- Кнопки -->
    <div style="padding: 20px; text-align: right;">
      <button id="modal-inbox-link" class="btn btn-primary" style="margin-right: 10px;">Open Inbox</button>
      <button id="modal-admin-link" class="btn btn-outline-primary">Admin Panel</button>
    </div>
  </div>


    <!-- Секция с двумя карточками: Shift-Overs и Breaks -->
    <div
  id="alerts-section"
  class="d-flex flex-wrap gap-4 justify-content-center my-4 px-3"
  style="align-items: stretch;"
>

    <div
      class="modal fade"
      id="candidateModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="candidateModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="candidateModalLabel">Recommended candidate</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" id="candidateModalBody">
            <!-- сюда JS вставляет результат -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <!-- ================================================== -->
      
      
      <!-- Подключаем jQuery, Bootstrap JS и Bootstrap-Select JS -->
      <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.18/js/bootstrap-select.min.js"></script>
      <script>
        // ========== Do Not Disturb ==========
        let doNotDisturb = localStorage.getItem('doNotDisturb') === 'true';

        function setDoNotDisturb(value) {
          doNotDisturb = value;
          localStorage.setItem('doNotDisturb', value);
        }

        // чтобы не спамить повторно
        // очередь для панели в интерфейсе
        const notificationQueue = [];


        // -------------- begin shift‐badge config --------------

        // map платформ → bootstrap‐класс бейджа

        // вместо platformBadgeClasses
        const shiftBadgeClasses = {
        "CS":      "badge-primary",
        "CS PO":   "badge-danger",
        "PSR":     "badge-success",
        "Simo":    "badge-info",
        "Aircall": "badge-warning",
        "Venue":   "badge-warning",
        "Trainee": "badge-light text-dark",
        "ST":      "badge-dark",
        "SUMO":    "badge-secondary",
      };

      const shiftDisplayNames = {
      "CS/Post order": "CS PO",
      "CS/Post Order": "CS PO",
      "CS / Post order": "CS PO",
      "CS / Post Order": "CS PO",
      "Special task": "ST",
      "SiMo/Aircall": "SUMO",
    };
        // возвращает строку вида "06:00-15:00" для имени
        // вместо "getEmployeeShift" — возвращаем название смены, а не время
        function getEmployeeShiftName(empName) {
          const rec = window.shiftsQuinyxData.find(r =>
            r.name.toLowerCase() === empName.toLowerCase()
          );
          return rec?.platform || "";
        }


        // -------------- end shift‐badge config --------------

        // ===============================
        // WEATHER SECTION WITH CACHING & EMOJI
        const OPENWEATHER_API_KEY = "f97220cfb6bcefa391405990e7b9825d";
        const STORAGE_KEY = "notifiedEmptyPlatforms";

        let notifiedEmpty = new Set(
  JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]")
);

/**
 * Универсальная функция: запрашивает погоду для произвольного города и кладёт
 * результат в указанные элементы.
 *
 * @param {string} city       — строка вида "Ganja,AZ"
 * @param {string} tempElemId — id блока для температуры (например "temp-ganja")
 * @param {string} windElemId — id блока для ветра       (например "wind-ganja")
 */
async function fetchWeatherFor(city, tempElemId, windElemId) {
  const cacheKey     = city + "_weatherData";
  const cacheTimeKey = city + "_weatherTimestamp";
  const now          = Date.now();
  const cacheTTL     = 15 * 60 * 1000; // 15 минут

  let data;
  const rawData      = localStorage.getItem(cacheKey);
  const rawTs        = localStorage.getItem(cacheTimeKey);

  if (rawData && rawTs && now - rawTs < cacheTTL) {
    data = JSON.parse(rawData);
  } else {
    const url = `https://api.openweathermap.org/data/2.5/weather` +
                `?q=${encodeURIComponent(city)}` +
                `&units=metric&appid=${OPENWEATHER_API_KEY}`;
    const res = await fetch(url);
    if (!res.ok) {
      console.error("Weather API error for", city, res.statusText);
      return;
    }
    data = await res.json();
    localStorage.setItem(cacheKey, JSON.stringify(data));
    localStorage.setItem(cacheTimeKey, now);
  }

  // Build display strings
  const tempRaw   = data.main?.temp;
  const windRaw   = data.wind?.speed;
  const emoji     = (() => {
    const cond = data.weather?.[0]?.main;
    switch(cond){
      case "Clear":       return "☀️";
      case "Clouds":      return "☁️";
      case "Rain": 
      case "Drizzle":     return "🌧️";
      case "Thunderstorm":return "⛈️";
      case "Snow":        return "❄️";
      default:            return "";
    }
  })();

  const tempText = (tempRaw != null)
    ? `${Math.round(tempRaw)} °C ${emoji}`
    : "-- °C";
  const windText = (typeof windRaw === "number")
    ? `${Math.round(windRaw*10)/10} m/s`
    : "-- m/s";

  // Вставляем в DOM
  document.getElementById(tempElemId).textContent = tempText;
  document.getElementById(windElemId).textContent = windText;
}

        
        // ===============================

        // Информация по платформам
        const platformInfo = {
          "CS":
            "Click on the link to open the CS platform.\nClick on employee name to open their profile.",
          "CS/Post order":
            "Click on the link to open the CS PO AZE platform.\nClick on employee name to open their profile.",
          PSR: "Click on the link to open the PSR platform.\nClick on employee name to open their profile.",
          SiMo: "Click on the link to open the Support Inbox.\nClick on employee name to open their profile.",
          Aircall:
            "Click on the link to open the CS platform.\nClick on employee name to open their profile.\n You can see employee's status in the Aircall.",
          Venue:
            "Click on the link to open the Venue platform.\nClick on employee name to open their profile.",
          Trainee: "Click on employee name to open their profile.",
          ST: "Click on employee name to open their profile."
        };

        let fetchedData = null;
        let currentSearchTerm = "";
        let currentStatusFilter = "both";
        let currentPlatformFilter = ["all"];
        let currentReallocFilter = "all";
        let currentLangFilter = "all";
        let currentBreakFilter = "upcoming";

        const SPREADSHEET_ID = "1dICKOxxz9R3x8MY3FKQ9I-IwR9fBUDfMOT9PFDLloAE";
        const SHIFT_RANGE = "list1!AT5:BH47";
        const RANGE = "list1!A1:BJ100";
        const RESPONSIBLES_RANGE = "responsiblepeople!A:B";
        const BREAKS_RANGE = "prebreaks!A1:D80";
        const SHIFT_QUINYX_RANGE = "shiftsquinyx!B3:C"; 

        let employeeData = {};

        const platforms = [
          {
            name: "CS",
            url: "https://ops.wolt.com/support/converse/conversations?conversationListId=6643245bfadf62c6edc28feb",
            colIndexNames: 3,
            colIndexData: 4,
            rowActiveNamesStart: 4,
            rowActiveNamesEnd: 27,
            rowAwayNamesStart: 28,
            rowAwayNamesEnd: 47
          },
          {
            name: "CS/Post order",
            url: "https://ops.wolt.com/support/converse/conversations?conversationListId=664324a0510ac011feaa798c",
            colIndexNames: 5,
            colIndexData: 6,
            rowActiveNamesStart: 4,
            rowActiveNamesEnd: 27,
            rowAwayNamesStart: 28,
            rowAwayNamesEnd: 47
          },
          {
            name: "PSR",
            url: "https://ops.wolt.com/support/converse/conversations?conversationListId=6567a44af7d470550b11dc68",
            colIndexNames: 7,
            colIndexData: 8,
            rowActiveNamesStart: 4,
            rowActiveNamesEnd: 27,
            rowAwayNamesStart: 28,
            rowAwayNamesEnd: 47
          },
          {
            name: "SiMo",
            url: "https://ops.wolt.com/support/converse/conversations?conversationListId=6668088fc6d870f3cfd61653",
            colIndexNames: 9,
            colIndexData: 10,
            rowActiveNamesStart: 4,
            rowActiveNamesEnd: 27,
            rowAwayNamesStart: 28,
            rowAwayNamesEnd: 47
          },
          {
            name: "Aircall",
            url: "https://ops.wolt.com/support/converse/conversations?conversationListId=671a26a2a5b9ae4a2ca603fb",
            colIndexNames: 11,
            colIndexData: 12,
            rowActiveNamesStart: 4,
            rowActiveNamesEnd: 27,
            rowAwayNamesStart: 28,
            rowAwayNamesEnd: 47
          },
          {
            name: "Venue",
            url: "https://ops.wolt.com/support/converse/conversations?conversationListId=666807fc28b3f1231948f407",
            colIndexNames: 13,
            colIndexData: 14,
            rowActiveNamesStart: 4,
            rowActiveNamesEnd: 27,
            rowAwayNamesStart: 28,
            rowAwayNamesEnd: 47
          },
          {
            name: "Trainee",
            url: "https://wolt.com/",
            colIndexNames: 15,
            colIndexData: 16,
            rowActiveNamesStart: 4,
            rowActiveNamesEnd: 27,
            rowAwayNamesStart: 28,
            rowAwayNamesEnd: 47
          },
          {
            name: "ST",
            url: "https://wolt.com/",
            colIndexNames: 17,
            colIndexData: 18,
            rowActiveNamesStart: 4,
            rowActiveNamesEnd: 27,
            rowAwayNamesStart: 28,
            rowAwayNamesEnd: 47
          }
        ];

        let aircallActive = [];
        let aircallAway = [];

        function logDebug(message) {
          console.log(message);
        }

        async function fetchSheetData(range) {
          try {
            const res = await fetch("https://sheets-proxy.mikhail-garayev.workers.dev", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                secret: "superWoltKey42",
                range: range
              })
            });
            const data = await res.json();
            return data.values;
          } catch (e) {
            console.error("Sheets proxy error:", e);
            return null;
          }
        }

        async function fetchEmployeeList() {
  // теперь A–H: A: Name, B: ID, C: CanReallocate, D: Prime, E: Pref, F: Languages, G: Capacity, H: StartDate
  const data = await fetchSheetData("emplist!A1:H");
  if (!data || data.length < 2) return;

  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    const empName           = row[0]?.trim();
    if (!empName) continue;

    const empId             = row[1]?.trim() || "";
    const canRealloc        = row[2]?.trim() || "No";
    const primePlatform     = row[3]?.trim() || "N/A";
    const preferredPlatform = row[4]?.trim() || "N/A";
    const languages         = row[5]?.trim() || "";
    const capacity          = row[6]?.trim() || "";
    const startDateRaw      = row[7]?.trim() || "";

    employeeData[empName] = {
      id:            empId,
      canReallocate: canRealloc,
      prime:         primePlatform,
      pref:          preferredPlatform,
      languages:     languages,
      capacity:      capacity,
      startDate:     startDateRaw
    };
  }
}


        function generateInboxLink(empId) {
          return (
            "https://ops.wolt.com/support/converse/users/conversations?assigneeIds=" +
            encodeURIComponent(empId)
          );
        }

        function generateAdminLink(empId) {
          return (
            "https://ops.wolt.com/support/converse/admin/users?userId=" +
            encodeURIComponent(empId)
          );
        }

        // Вставьте где-нибудь рядом с другими утилитами
function normalize(str) {
  return String(str || "")
    .toLowerCase()
    .replace(/[\s\/-]+/g, ""); // убираем пробелы, косую черту, дефис
}
// парсит строки вида "DD.MM.YYYY HH:mm:ss" → JS Date
// парсит строки вида "DD.MM.YYYY HH:mm:ss" → JS Date,
// обрабатывает некорректные или неполные строки без падения
function parseDDMMYYYY(str) {
  if (typeof str !== 'string') {
    console.warn('parseDDMMYYYY got non-string:', str);
    return new Date(str);           // попробуем native-парсер
  }

  // разделяем по любому числу пробелов
  const parts = str.trim().split(/\s+/);
  if (parts.length < 2) {
    // нет времени — попытка native-парсера
    return new Date(str);
  }
  const [datePart, timePart] = parts;

  const dp = datePart.split('.');
  if (dp.length !== 3) {
    console.warn('parseDDMMYYYY got bad datePart:', datePart);
    return new Date(str);
  }
  let [day, month, year] = dp;

  // гарантируем по две цифры
  day   = String(day).padStart(2,'0');
  month = String(month).padStart(2,'0');

  // формируем ISO-строку
  const iso = `${year}-${month}-${day}T${timePart}`;
  const d = new Date(iso);
  if (isNaN(d.getTime())) {
    console.warn('parseDDMMYYYY failed to parse:', iso);
    return new Date(str);
  }
  return d;
}



async function openEmployeeModal(empName) {
  const info = employeeData[empName];
  if (!info) {
    console.warn("Данные о сотруднике не найдены: " + empName);
    return;
  }

  // 1) Смена
  const rec = window.shiftsQuinyxData.find(
    r => r.name.toLowerCase() === empName.toLowerCase()
  ) || {};
  const shiftName = rec.platform || "—";
  const shiftTime = rec.shift    || "—";
  document.getElementById("modal-emp-shift").textContent =
    `${shiftName} (${shiftTime})`;

  // 2) Перерыв
  let breakTime = "—";
  if (Array.isArray(window.allBreaksData)) {
    const br = window.allBreaksData.find(b =>
      b.Name?.trim().toLowerCase() === empName.trim().toLowerCase()
    );
    if (br) breakTime = br["Break Time"] || "—";
  }
  document.getElementById("modal-emp-break").textContent = breakTime;

  // 3) Общая инфа
  const parts = empName.trim().split(" ");
  const email = parts.length >= 2
    ? `${parts[0].toLowerCase()}.${parts[1].toLowerCase()}@wolt.com`
    : `${parts[0].toLowerCase()}@wolt.com`;

  document.getElementById("modal-emp-name").textContent      = empName;
  document.getElementById("modal-emp-email").textContent     = email;
  document.getElementById("modal-emp-realloc").textContent   = info.canReallocate || "N/A";
  document.getElementById("modal-emp-prime").textContent     = info.prime         || "N/A";
  document.getElementById("modal-emp-pref").textContent      = info.pref          || "N/A";
  document.getElementById("modal-emp-languages").textContent = info.languages     || "N/A";
  document.getElementById("modal-emp-capacity").textContent  = info.capacity      || "N/A";

  document.getElementById("modal-inbox-link").onclick = () => {
    window.open(generateInboxLink(info.id), "_blank");
  };
  document.getElementById("modal-admin-link").onclick = () => {
    window.open(generateAdminLink(info.id), "_blank");
  };

  // 4) Подготовка списка переходов
  const countEl = document.getElementById("modal-platform-count");
  const listEl  = document.getElementById("modal-platform-list");
  countEl.textContent = "…";
  listEl.innerHTML    = "<li>Loading…</li>";

  // Показываем модалку сразу
  document.getElementById("modal-overlay").classList.add("show");
  document.getElementById("employee-modal").classList.add("show");

  try {
    // **Важно**: передаём empName в запрос
    const url = `${TRANSITIONS_API}&name=${encodeURIComponent(empName)}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(res.statusText);
    const moves = await res.json(); // теперь только переходы данного сотрудника

    countEl.textContent = moves.length;
    if (moves.length > 0) {
      listEl.innerHTML = moves.map(r => {
        const [, toPlat, , fromStr, toStr, durStr] = r;
        return `
          <li>
            <strong>${fromStr}</strong> → <strong>${toStr}</strong><br>
            To: <em>${toPlat}</em> (Duration ${durStr})
          </li>
        `;
      }).join("");
    } else {
      listEl.innerHTML = "<li>No platform changes today</li>";
    }
  } catch (err) {
    console.error("Error loading transitions:", err);
    countEl.textContent = "—";
    listEl.innerHTML    = `<li class="text-danger">Error loading data</li>`;
  }
}



        function closeEmployeeModal() {
          document.getElementById("employee-modal").classList.remove("show");
          document.getElementById("modal-overlay").classList.remove("show");
        }


        async function getAircallUserId(email) {
          try {
            const res = await fetch("https://aircall-proxy.mikhail-garayev.workers.dev", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                secret: "superWoltKey42",
                email: email
              })
            });
        
            if (!res.ok) {
              logDebug(`Ошибка при проксированном запросе Aircall: ${res.statusText}`);
              return null;
            }
        
            const data = await res.json();
        
            if (!data?.user?.id) {
              logDebug("Aircall API вернул пустой результат");
              return null;
            }
        
            logDebug(`Получен Aircall ID: ${data.user.id}`);
            return data.user.id;
        
          } catch (err) {
            logDebug("Ошибка getAircallUserId через Worker: " + err.message);
            return null;
          }
        }


        async function getAircallAvailability(userId) {
          if (!userId) {
            logDebug("getAircallAvailability: userId не передан");
            return "No ID";
          }
        
          try {
            const res = await fetch("https://aircall-proxy.mikhail-garayev.workers.dev", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                secret: "superWoltKey42",
                userId: userId,
                action: "availability"
              })
            });
        
            if (!res.ok) {
              logDebug("Ошибка при получении статуса через Worker: " + res.statusText);
              return "Error";
            }
        
            const data = await res.json();
        
            const status =
              data?.user_availability?.availability_status || data?.availability;
        
            logDebug(`Статус через Worker: ${status}`);
            return status || "Unknown";
        
          } catch (err) {
            logDebug("Исключение в getAircallAvailability через Worker: " + err.message);
            return "Error";
          }
        }

        function passReallocAndLang(empName) {
          const info = employeeData[empName];
          if (!info) return false;
          if (currentReallocFilter !== "all") {
            if (info.canReallocate !== currentReallocFilter) return false;
          }
          if (currentLangFilter !== "all") {
            let lang = info.languages.replace(/\s+/g, "");
            if (currentLangFilter === "two") {
              if (!(lang.includes("🇦🇿") && lang.includes("🇬🇧")) || lang.includes("🇷🇺")) {
                return false;
              }
            } else if (currentLangFilter === "three") {
              if (!(lang.includes("🇦🇿") && lang.includes("🇬🇧") && lang.includes("🇷🇺"))) {
                return false;
              }
            }
          }
          return true;
        }

function applyFilters() {
  const container = document.getElementById("platforms-container");
  container.innerHTML = "";

  platforms.forEach((platform) => {
    if (
      !currentPlatformFilter.includes("all") &&
      !currentPlatformFilter.includes(platform.name)
    ) {
      return;
    }

    if (platform.name !== "Aircall") {
      // Собираем active и away
      let activeNames = [];
      for (
        let r = platform.rowActiveNamesStart;
        r <= platform.rowActiveNamesEnd;
        r++
      ) {
        const nm = fetchedData[r]?.[platform.colIndexNames]?.trim();
        if (nm) activeNames.push(nm);
      }
      let awayData = [];
      for (
        let r = platform.rowAwayNamesStart;
        r <= platform.rowAwayNamesEnd;
        r++
      ) {
        const nm = fetchedData[r]?.[platform.colIndexNames]?.trim();
        if (!nm) continue;
        const rsn = fetchedData[r]?.[platform.colIndexData]?.trim() || "";
        awayData.push({ name: nm, reason: rsn });
      }

      // Поиск
      if (currentSearchTerm) {
        const term = currentSearchTerm.toLowerCase();
        activeNames = activeNames.filter((n) =>
          n.toLowerCase().includes(term)
        );
        awayData = awayData.filter((a) =>
          a.name.toLowerCase().includes(term)
        );
      }

      // realloc/lang
      activeNames = activeNames.filter((n) => passReallocAndLang(n));
      awayData = awayData.filter((a) => passReallocAndLang(a.name));

      // Фильтр по статусу
      let showActive = true,
        showAway = true;
      if (currentStatusFilter === "active") showAway = false;
      else if (currentStatusFilter === "away") showActive = false;

      // Начало HTML карточки
      let html = `
        <div class="platform-card">
          <h5>
            <a href="${platform.url}" target="_blank" rel="noopener">${platform.name}</a>
            <span class="info-icon" data-toggle="tooltip" title="${
              platformInfo[platform.name] || ""
            }">
              <img src="https://www.svgrepo.com/show/474873/info.svg" width="16" height="16"/>
            </span>
          </h5>
      `;

      // — Active
      if (showActive) {
        if (activeNames.length === 0) {
          html += `<p class="text-center text-warning">⚠️ No active employees</p>`;
        } else {
          html += `<p><small>Active (${activeNames.length})</small></p><ul>`;
          activeNames.forEach((n) => {
            const name = n.trim();
            const isYou = name.toLowerCase() === "mikhail garayev";
            const isNaziya = name.toLowerCase() === "naziya orujova";
            const extraEmoji = isNaziya ? " 🎀" : "";
            const crown = isYou ? "👑" : "";

            const rawShift = getEmployeeShiftName(name);
            const shiftName = shiftDisplayNames[rawShift] || rawShift;
            const badgeClass =
              shiftBadgeClasses[shiftName] || "badge-secondary";

            html += `
              <li class="employee-item" data-employee="${name}">
                <span class="badge badge-pill ${badgeClass}">${shiftName}</span>
                <span class="employee-name">${name}${extraEmoji}</span>
                ${crown}
              </li>
            `;
          });
          html += `</ul>`;
        }
      }

// — Always render Away section, even if awayData.length === 0
if (showAway) {
  let brbCount = 0;
  html += `<p><small>Away (${awayData.length})</small></p><ul>`;
  awayData.forEach(({ name, reason }) => {
    const txt = reason || "";
    let reasonClass = "";
    // mark overdue breaks
    if (/(Break|BRB)/.test(txt) && /-\d{1,2}:\d{2}(?::\d{2})?/.test(txt)) {
      reasonClass = "break-overdue";
    }
    if (txt.includes("BRB")) brbCount++;

    const rawShift   = getEmployeeShiftName(name);
    const shiftName  = shiftDisplayNames[rawShift] || rawShift;
    const badgeClass = shiftBadgeClasses[shiftName] || "badge-secondary";

    html += `
      <li class="employee-item ${reasonClass}" data-employee="${name}">
        <span class="badge badge-pill ${badgeClass}">${shiftName}</span>
        <span class="employee-name">${name}</span>
        ${txt ? `<span class="text-muted">(${txt})</span>` : ""}
      </li>
    `;
  });
  html += `</ul>`;
  if (brbCount >= 2) {
    html += `
      <p style="text-align:center;color:red;font-size:0.95rem;">
        <span title="2 or more on BRB">&#9888;</span>
        <span style="margin-left:6px;">2 or more on BRB</span>
      </p>
    `;
      const msg = `⚠️ ${brbCount} or more on BRB on ${platform.name}`;
      if (!brbAlertSent[platform.name]) {
      showDesktopNotification('BRB Alert', msg);
      addInPageNotification(msg);
      brbAlertSent[platform.name] = true;
    }
  } else {
    // сбрасываем флаг, чтобы при следующем повторном выходе за порог оповещение снова ушло
    brbAlertSent[platform.name] = false;
  }
}

      html += `</div>`;
      container.innerHTML += html;
    } else {
      // Aircall остаётся как было
      let filteredActive = aircallActive.filter(
        (n) => n.toLowerCase() !== "away"
      );
      let filteredAway = aircallAway.filter(
        ({ name }) => name.toLowerCase() !== "away"
      );

      if (currentSearchTerm) {
        const term = currentSearchTerm.toLowerCase();
        filteredActive = filteredActive.filter((n) =>
          n.toLowerCase().includes(term)
        );
        filteredAway = filteredAway.filter(({ name }) =>
          name.toLowerCase().includes(term)
        );
      }
      filteredActive = filteredActive.filter((n) => passReallocAndLang(n));
      filteredAway = filteredAway.filter((a) => passReallocAndLang(a.name));

      const showActive = currentStatusFilter !== "away";
      const showAway = currentStatusFilter !== "active";

      renderAircallCardWithStatuses(
        filteredActive,
        filteredAway,
        showActive,
        showAway
      );
    }
  });

  // Навешиваем клик для модалки
  container.querySelectorAll(".employee-item").forEach((item) => {
    item.addEventListener("click", () =>
      openEmployeeModal(item.getAttribute("data-employee"))
    );
  });

  // Обновляем статусы Aircall
  setTimeout(() => fetchAircallStatuses().catch(console.error), 100);

  checkOverdueBRB();
}


function renderAircallCardWithStatuses(
  activeList,
  awayList,
  showActive = true,
  showAway = true
) {
  const aircallPlatform = platforms.find((p) => p.name === "Aircall");
  let html = `
    <div class="platform-card">
      <h5>
        <a href="${aircallPlatform.url}" target="_blank" rel="noopener">Aircall</a>
        <span class="info-icon" data-toggle="tooltip" title="${platformInfo["Aircall"]||""}">
          <img src="https://www.svgrepo.com/show/474873/info.svg" width="16" height="16"/>
        </span>
      </h5>`;

  // Active
    if (showActive) {
    if (activeList.length === 0) {
      html += `<p class="text-center text-warning">⚠️ No active employees</p>`;
    } else {
      html += `<p><small>Active (${activeList.length})</small></p><ul id="aircall-active-list">`;
      activeList.forEach((name, i) => {
        const rawShift   = getEmployeeShiftName(name);
        const shiftName  = shiftDisplayNames[rawShift] || rawShift;
        const badgeClass = shiftBadgeClasses[shiftName] || "badge-secondary";
        const safeId     = `aircall-active-${i}`;
        html += `
          <li id="${safeId}" class="employee-item d-flex align-items-center" data-employee="${name}">
            <span class="badge badge-pill ${badgeClass}" style="margin-right:6px;">
              ${shiftName}
            </span>
            <span class="employee-name" style="margin-right:6px;">${name}</span>
            &nbsp;–&nbsp;<span class="aircall-status">Checking...</span>
          </li>
        `;
      });
      html += `</ul>`;
    }
  }

  // Away
  if (showAway) {
    html += `<p><small>Away (${awayList.length})</small></p><ul>`;
    awayList.forEach(({ name, reason }) => {
      // Берём смену и бейдж
      const rawShift   = getEmployeeShiftName(name);
      const shiftName  = shiftDisplayNames[rawShift] || rawShift;
      const badgeClass = shiftBadgeClasses[shiftName] || "badge-secondary";

      // Логика покраски в красный, если есть BRB или Break
      const isOverdue =
      /(?:Break|BRB)/i.test(reason || "") &&
      /-([0-9]{2}:[0-9]{2})/.test(reason || "");
      const liClass   = isOverdue ? "break-overdue" : "";

      const extra = reason ? ` (${reason})` : "";

      html += `
      <li class="employee-item d-flex align-items-center ${liClass}" data-employee="${name}">
        <span class="badge badge-pill ${badgeClass}" style="margin-right:6px;">
          ${shiftName}
        </span>
        <span class="employee-name" style="margin-right:6px;">
          ${name}
        </span>
        <span class="text-muted">${extra}</span>
      </li>`;
  });
  html += `</ul>`;
}

  html += `</div>`;

  // Вставляем в DOM и пересобираем статусы
  document.getElementById("platforms-container").innerHTML += html;
    setTimeout(() => {
    fetchAircallStatuses().catch(console.error);
  }, 100);
}


  function renderShiftSummary(data) {
  // контейнер, где рендерятся все stats-card
  const generalContainer  = document.getElementById("summary-general");
const platformContainer = document.getElementById("summary-platforms");
generalContainer.innerHTML  = "";
platformContainer.innerHTML = "";

  // ваши карточки: title — заголовок, value — строка из ячейки (например "2, Alice, Bob"), away — опционально
  const summaryCards = [
    { title: "On shift now",  value: data[6][27] || "" },
    { title: "Should be",     value: data[6][29] || "" },
    { title: "CS",            value: data[6][31] || "", away: data[8][31] || "" },
    { title: "CS/Post Order", value: data[6][33] || "", away: data[8][33] || "" },
    { title: "PSR",           value: data[6][35] || "", away: data[8][35] || "" },
    { title: "SiMo",          value: data[6][41] || "", away: data[8][41] || "" },
    { title: "Aircall",       value: data[6][39] || "", away: data[8][39] || "" },
    { title: "Venue",         value: data[6][37] || "", away: data[8][37] || "" },
    { title: "Trainee",       value: data[11][41] || "", away: data[13][41] || "" },
    { title: "ST",            value: data[6][43] || "", away: data[8][43] || "" },
    // Special: Not here и WNATS тоже делают из столбца 29 и 27, плюс детали из колонки 10
    { 
      title: "Not here", 
      value: (data[8][29] || "") + (data[10][29] ? "," + data[10][29] : ""), 
      customClass: "small-font-card" 
    },
    { 
      title: "WNATS", 
      value: (data[8][27] || "") + (data[10][27] ? "," + data[10][27] : ""), 
      customClass: "small-font-card" 
    }
  ];

  summaryCards.forEach(card => {
    // если нет даже count — пропускаем
    if (!card.value) return;

    // создаём div.stats-card
    const div = document.createElement("div");
    div.className = `stats-card ${card.customClass || ""}`;

    // разбираем для специальных тултипов
    if (card.title === "Not here" || card.title === "WNATS") {
      // value = "count, detail1, detail2, …"
      const parts = card.value.split(",").map(s => s.trim()).filter(s => s !== "");
      const count = parts.shift();        // первое — число
      const details = parts;              // остаток — массив тултипов
      // если Not here и count ≠ 0, добавляем красный фон
      if (card.title === "Not here" && count !== "0") {
        div.classList.add("red-card");
      }
      // формируем HTML
      div.innerHTML = `
        <div class="stats-title">${card.title}</div>
        <div class="stats-value d-inline-flex align-items-center gap-1">
          ${count}
          <img
            src="https://www.svgrepo.com/show/474873/info.svg"
            data-toggle="tooltip"
            data-html="true"
            title="${details.join("<br/>")}"
            class="info-icon"
            style="width:16px; height:16px; cursor:pointer;"
          />
        </div>
      `;
    } else {
      // обычная карточка: title, value, away
      let html = `
        <div class="stats-title">${card.title}</div>
        <div class="stats-value">${card.value}</div>
      `;
      html += `
      <div class="stats-value" style="font-size:0.9rem; color:#666;">
      Away: ${card.away || 0}
      </div>`;

      div.innerHTML = html;
    }

    // список названий «платформенных» карточек
const platformTitles = [
  "CS",
  "CS/Post Order",
  "PSR",
  "SiMo",
  "Aircall",
  "Venue",
  "Trainee",
  "ST"
];

// если это карточка платформы — в платформенный грид,
// иначе — в общий контейнер
if (platformTitles.includes(card.title)) {
  platformContainer.appendChild(div);
} else {
  generalContainer.appendChild(div);
}
  });

  // вставляем погоду как последнюю карточку
  // новый код — в конце renderShiftSummary
    // вставляем карточки погоды для всех городов
    const weatherCities = [
    { city: "Baku,AZ",        title: "Baku Weather",       tempId: "temp-baku",  windId: "wind-baku" },
    { city: "Ganja,AZ",       title: "Ganja Weather",      tempId: "temp-ganja", windId: "wind-ganja" },
    { city: "Lankaran,AZ",    title: "Lankaran Weather",   tempId: "temp-lank",  windId: "wind-lank" },
    { city: "Nakhchivan,AZ",  title: "Nakhchivan Weather", tempId: "temp-nakh",  windId: "wind-nakh" },
    { city: "Mingachevir,AZ", title: "Mingachevir Weather",tempId: "temp-ming",  windId: "wind-ming" }
  ];

  weatherCities.forEach(({ city, title, tempId, windId }) => {
    const card = document.createElement("div");
    card.className = "stats-card";
    card.innerHTML = `
      <div class="stats-title">${title}</div>
      <div class="stats-value" id="${tempId}">--</div>
      <div class="stats-title" style="margin-top:.5rem;">Wind Speed</div>
      <div class="stats-value small" id="${windId}">--</div>
    `;
    generalContainer.appendChild(card);
    // запускаем запрос именно для этого города и этих id
    fetchWeatherFor(city, tempId, windId);
  });

}

function renderResponsiblePeople(data) {
  if (!Array.isArray(data) || data.length === 0) return;

  // Удаляем старую карточку, если она есть
  const existing = document.getElementById("responsible-card");
  if (existing) existing.remove();

  // Оставляем только роли "Shift Lead…" и "In charge…"
  const responsibleRows = data.filter(([name, role]) =>
  /shift\s+lead/i.test(role) || /in\s+charge/i.test(role)
);
  if (responsibleRows.length === 0) return;

  // Начало HTML
  let html = `
    <div class="shift-summary-card" id="responsible-card">
      <div class="shift-summary-title">👥 Responsible People</div>
      <table class="shift-summary-grid" style="max-width:500px; margin:0 auto;">
        <thead><tr><th>Name</th><th>Position</th></tr></thead>
        <tbody>`;

  // Заполняем строки
  responsibleRows.forEach(([rawName, rawRole]) => {
    const name = rawName.trim();
    const role = rawRole.trim();
    const lowerName = name.toLowerCase();

    // Специальные эмодзи для пользователей
    const isNaziya = lowerName === 'naziya orujova';
    const isRafig  = lowerName === 'rafig huseynov';
    let extraEmoji = '';
    if (isNaziya) extraEmoji = ' 🎀';
    else if (isRafig)  extraEmoji = ' (˵ ͡° ͜ʖ ͡°˵)';

    const nameClass = isNaziya ? 'pink-name' : '';

    html += `
      <tr>
        <td>
          <span class="${nameClass}" style="font-weight:bold;">
            ${name}${extraEmoji}
          </span>
        </td>
        <td>
          <span style="
            background: #e7f1ff;
            color: #0056b3;
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 0.85rem;
          ">
            ${role}
          </span>
        </td>
      </tr>`;
  });

  // Закрываем таблицу и вставляем в DOM
  html += `
        </tbody>
      </table>
    </div>`;

  document
    .getElementById('shift-overs-section')
    .insertAdjacentHTML('beforebegin', html);
}


function renderShiftOvers() {
  const container = document.getElementById("shift-overs-app");
  container.innerHTML = ""; 
  if (!window.shiftsQuinyxData) {
    container.textContent = "No data";
    return;
  }

  const now = new Date();
  const oneHourLater = new Date(now.getTime() + 60*60*1000);

  // фильтрация сотрудников
  const upcoming = window.shiftsQuinyxData.filter(({name, shift}) => {
    const parts = shift.split("-");
    if (parts.length < 2) return false;
    const [ hh, mm ] = parts[1].split(":").map(Number);
    const endDate = new Date(now);
    endDate.setHours(hh, mm, 0, 0);
    return endDate > now && endDate <= oneHourLater;
  });

  if (upcoming.length === 0) {
    container.innerHTML = "<p style='text-align:center;color:#666;'>No shift-overs in the next hour</p>";
    return;
  }

  // список
  const ul = document.createElement("ul");
  upcoming.forEach(({name, shift}) => {
    const li = document.createElement("li");
    li.innerHTML = `<strong>${name}</strong> — ${shift}`;
    ul.appendChild(li);
  });
  container.appendChild(ul);
}

                // 1) Shift-Overs из листа shiftsquinyx!A:C
        async function fetchShiftOversData() {
  const raw = await fetchSheetData("shiftsquinyx!A:C"); // теперь A-C, а не B-C
  if (!raw) {
    document.getElementById("shift-overs-app").textContent = "Error";
    return;
  }

  // Преобразуем массив строк в объекты с полями Name, ShiftName и Shift
  const arr = raw.slice(1).map(row => ({
    ShiftName: row[0]?.trim(),   // A = название смены
    Name: row[1]?.trim(),        // B = имя сотрудника
    Shift: row[2]?.trim(),       // C = время смены
  }));

  const now = new Date();
  const next = new Date(now.getTime() + 60 * 60 * 1000);

  // Фильтрация: отбираем тех, у кого shift заканчивается в течение часа
  const upcoming = arr.filter(r => {
    if (!r.Shift) return false;
    const parts = r.Shift.split("-");
    if (parts.length !== 2) return false;

    const [h, m] = parts[1].split(":").map(Number);
    if (isNaN(h)) return false;

    const end = new Date(now);
    end.setHours(h, m, 0, 0);
    return end > now && end <= next;
  });

  const c = document.getElementById("shift-overs-app");

  if (!upcoming.length) {
    c.innerHTML = "<p>No shift-overs in the next hour</p>";
    return;
  }

  // Подсветка при совпадении shiftName + время
  const counts = {};
  upcoming.forEach(r => {
    const key = `${r.ShiftName}–${r.Shift}`;
    counts[key] = (counts[key] || 0) + 1;
  });

  c.innerHTML = "<ul>" + upcoming.map(r => {
    const [start, end] = r.Shift.split("-").map(s => s.trim());
    const key = `${r.ShiftName}–${r.Shift}`;
    const conflictClass = counts[key] > 1 ? "break-conflict" : "";

    return `
      <li class="${conflictClass}">
        <strong>${r.Name}</strong><br/>
        Ends at ${end}<br/>
        Shift: ${start} | ${r.ShiftName}
      </li>`;
  }).join("") + "</ul>";
}



        
async function fetchBreaksData() {
  const raw = await fetchSheetData(BREAKS_RANGE);
  if (!raw) {
    document.getElementById("breaks-app").textContent = "Error";
    return;
  }

  const arr = arrayToObjects(raw);
  const now = new Date();
  const nextHour = new Date(now.getTime() + 3600 * 1000);
  window.allBreaksData = arr;

  // Фильтрация по режиму
  let list;
  if (currentBreakFilter === "upcoming") {
    list = arr.filter(r => {
      const [h, m] = (r["Break Time"] || "").split(":").map(Number);
      if (isNaN(h)) return false;
      const dt = new Date(now);
      dt.setHours(h, m, 0, 0);
      return dt > now && dt <= nextHour;
    });
  } else {
    list = arr.slice().sort((a, b) => {
      const pa = parseTimeToMinutes(a["Break Time"]),
            pb = parseTimeToMinutes(b["Break Time"]);
      return pa - pb;
    });
  }

  const c = document.getElementById("breaks-app");

  // Подсчёт совпадений
  const counts = {};
  list.forEach(r => {
    const key = `${r["Working Space"]}–${r["Break Time"]}`;
    counts[key] = (counts[key] || 0) + 1;
  });

  if (!list.length) {
    c.innerHTML = "<p>No breaks</p>";
  } else {
    // Генерация HTML списка
    c.innerHTML = "<ul>" + list.map(r => {
      const key = `${r["Working Space"]}–${r["Break Time"]}`;
      const conflictClass = counts[key] > 1 ? "break-conflict" : "";
      return `
        <li class="${conflictClass}">
          <strong>${r.Name}</strong><br/>
          Break at
            <span class="break-time"
                  data-name="${r.Name}"
                  data-time="${r["Break Time"]}"
            >${r["Break Time"]}</span>
          <button class="edit-btn"
                  title="Edit time"
                  style="border:none;background:none;cursor:pointer;">
            <img src="https://www.svgrepo.com/show/502640/edit-1.svg"
                 alt="edit" width="16" height="16">
          </button><br/>
          Shift: ${r["Shift Start Time"]} | ${r["Working Space"]}
        </li>
      `;
    }).join("") + "</ul>";

    // Редактирование времени
    document.querySelectorAll(".edit-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const name = btn.previousElementSibling.dataset.name;
        const timeSpan = btn.previousElementSibling;
        const oldTime = timeSpan.dataset.time;
        const newTime = prompt(`Enter new break time for ${name}:`, oldTime);
        if (!newTime || newTime === oldTime) return;
        fetch("https://breaks-proxy.mikhail-garayev.workers.dev/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name,
            newBreakTime: newTime,
            secret: "superWoltKey42"
          })
        })
        .then(res => res.text())
        .then(response => {
          if (response === "Success") {
            timeSpan.textContent = newTime;
            timeSpan.dataset.time = newTime;
            alert("Break time updated successfully!");
          } else {
            alert("Server response:\n" + response);
          }
        })
        .catch(err => {
          alert("Request failed:\n" + err.message);
        });
      });
    });
  }

  // ===== Проверяем просроченные перерывы и уведомляем =====
  (function checkOverdueBreaks() {
  const ALLOWED_BREAK_MINUTES = 60;
  const now = new Date();

  // 1) Сотрудники, помеченные active по листу
  const activeSet = new Set();
  platforms.forEach(p => {
    for (let r = p.rowActiveNamesStart; r <= p.rowActiveNamesEnd; r++) {
      const nm = fetchedData[r]?.[p.colIndexNames]?.trim();
      if (nm) activeSet.add(nm.toLowerCase());
    }
  });

  // 2) Проходим по всем перерывам
  (window.allBreaksData || []).forEach(r => {
    const name = r.Name?.trim();
    if (!name) return;
    const key = name.toLowerCase();

    // Если человек снова active — очищаем флаг и не уведомляем
    if (activeSet.has(key)) {
      if (overdueBreakNotified[key]) {
        delete overdueBreakNotified[key];
        localStorage.setItem(BREAK_NOTIF_KEY, JSON.stringify(overdueBreakNotified));
      }
      return;
    }

    // **НОВЫЙ БЛОК**: проверяем, не закончилась ли у него смена
    // ищем в данных по сменам
    const shiftRec = (window.shiftsQuinyxData || [])
      .find(x => x.name.trim().toLowerCase() === key);
    if (shiftRec) {
      const [, endStr] = shiftRec.shift.split('-');
      const [eh, em] = endStr.split(':').map(Number);
      const endDate = new Date(now);
      endDate.setHours(eh, em, 0, 0);
      // если сейчас уже после конца смены — пропускаем
      if (now > endDate) {
        // и очищаем флаг в случае, если когда-то было уведомление
        if (overdueBreakNotified[key]) {
          delete overdueBreakNotified[key];
          localStorage.setItem(BREAK_NOTIF_KEY, JSON.stringify(overdueBreakNotified));
        }
        return;
      }
    }

    // 3) Проверяем длительность break-а
    const [h, m, s = 0] = (r["Break Time"] || "").split(":").map(Number);
    const breakDate = new Date(now);
    breakDate.setHours(h, m, s, 0);
    const durationMins = (now - breakDate) / 60000;

    if (durationMins > ALLOWED_BREAK_MINUTES) {
      if (!overdueBreakNotified[key]) {
        const lateMin = Math.floor(durationMins);
        const msg = `❗ ${name} is late from break for ${lateMin} min.`;
        showDesktopNotification("Break overdue", msg);
        addInPageNotification(msg);
        overdueBreakNotified[key] = true;
        localStorage.setItem(BREAK_NOTIF_KEY, JSON.stringify(overdueBreakNotified));
      }
    }
  });
})();
}

        function checkOverdueBRB() {
  // найдём все li, помеченные классом break-overdue и содержащие "BRB"
  const overdueBRB = Array.from(
    document.querySelectorAll('.employee-item.break-overdue')
  ).filter(li => /\bBRB\b/.test(li.textContent));

  // для каждого нового — шлём уведомление
  overdueBRB.forEach(li => {
    const name = li.dataset.employee;
    if (!brbOverdueNotified[name]) {
      const reason = li.querySelector('.text-muted')?.textContent || '';
      const msg = `⏰ ${name} is late from BRB ${reason}`;
      showDesktopNotification('BRB Overdue', msg);
      addInPageNotification(msg);
      brbOverdueNotified[name] = true;
    }
  });

  // сбросим флаг, если человек уже не просрочен
  Object.keys(brbOverdueNotified).forEach(name => {
    if (!overdueBRB.some(li => li.dataset.employee === name)) {
      delete brbOverdueNotified[name];
    }
  });
}
        
        // кладём в глобальную window.shiftsQuinyxData
        async function fetchShiftsQuinyxData() {
          const raw = await fetchSheetData("shiftsquinyx!A2:C");
          if (!raw || raw.length < 2) {
            window.shiftsQuinyxData = [];
            return;
          }
          // raw[0] — заголовки, raw[1..] — строки [name, "HH:mm-HH:mm"]
          window.shiftsQuinyxData = raw
          .filter(r => r[0] && r[1] && r[2])
          .map(r => ({
            platform: r[0].trim(), // A: SHIFT TYPE
            name: r[1].trim(),     // B: Name
            shift: r[2].trim()     // C: Shift time
          }));
        }


        function parseTimeToMinutes(timeStr) {
          timeStr = timeStr.trim();
          let parts = timeStr.split(":");
          if (parts.length < 2) return 0;
          let hours = parseInt(parts[0], 10);
          let minutes = parseInt(parts[1], 10);
          return hours * 60 + minutes;
        }

        function arrayToObjects(arr) {
          if (!arr.length) return [];
          const header = arr[0];
          return arr.slice(1).map((row) => {
            const obj = {};
            header.forEach((key, i) => {
              obj[key] = row[i] || "";
            });
            return obj;
          });
        }

        // ——— Функция для запроса и отрисовки статусов Aircall ———
        // ------------------
// Подтягиваем реальные статусы вместо Checking...
// ------------------
async function fetchAircallStatuses() {
  const spans = Array.from(document.querySelectorAll(".aircall-status"));
  if (!spans.length) return;

  // Помечаем все спаны как «Loading…»
  spans.forEach(span => {
    span.textContent = "Loading…";
  });

  // Собираем уникальные email
  const emails = [...new Set(spans.map(span => {
    const name = span.closest("li[data-employee]")?.dataset.employee || "";
    return generateWoltEmail(name);
  }))];

  let results = [];
  try {
    const res = await fetch("https://aircall-proxy.mikhail-garayev.workers.dev/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        secret: "superWoltKey42",
        emails: emails
      })
    });
    const json = await res.json();
    results = Array.isArray(json.results) ? json.results : [];
  } catch (e) {
    console.error("Aircall batch error:", e);
  }

  // Составляем мапу email → статус
  const statusMap = results.reduce((acc, { email, status, error }) => {
    acc[email] = status ?? error ?? "Unknown";
    return acc;
  }, {});

  // Обновляем каждый span
  spans.forEach(span => {
    const li    = span.closest("li[data-employee]");
    const email = generateWoltEmail(li?.dataset.employee || "");
    const status = statusMap[email] || "Error";

    span.textContent = status;
    const safeClass = "status-" + status.toLowerCase().replace(/\s+/g, "-");
    span.className = `aircall-status ${safeClass}`;
  });
}


        let autoRefreshEnabled = true;
        let refreshInterval = 15;
        let refreshTimer = null;
        let countdownTimer = null;
        let countdownValue = refreshInterval;

        function resetAutoRefresh() {
  clearTimeout(refreshTimer);
  clearInterval(countdownTimer);
  countdownValue = refreshInterval;
  updateCountdownDisplay();

  // через лямбду, чтобы успеть добавить класс перед fetchData()
  refreshTimer = setTimeout(() => {
    const ico = document.getElementById("refresh-icon");
    ico.classList.add("rotating");  // старт анимации
    fetchData();
  }, refreshInterval * 1000);

  countdownTimer = setInterval(() => {
    countdownValue--;
    updateCountdownDisplay();
    if (countdownValue <= 0) clearInterval(countdownTimer);
  }, 1000);
}

        function updateCountdownDisplay() {
          const countdownElem = document.getElementById("countdown");
          if (countdownElem) {
            countdownElem.textContent = countdownValue;
          }
        }
        function toggleAutoRefresh() {
          autoRefreshEnabled = !autoRefreshEnabled;
          const btn = document.getElementById("toggle-autorefresh");
          if (autoRefreshEnabled) {
            btn.textContent = "Disable Auto Refresh";
            resetAutoRefresh();
          } else {
            btn.textContent = "Enable Auto Refresh";
            clearTimeout(refreshTimer);
            clearInterval(countdownTimer);
          }
        }
        // Кнопка Refresh Now и автообновление вызывают эту функцию
        function refreshNow() {
  const ico = document.getElementById('refresh-icon');
  // вешаем анимацию
  ico.classList.add('rotating');

  // запускаем обновление
  fetchData().finally(() => {
    // когда всё отработало — выключаем анимацию
    ico.classList.remove('rotating');
  });
}

        function showDesktopNotification(title, body) {
  if (doNotDisturb) return;       // 🛑 ничего не делаем
  if (Notification.permission === "granted") {
    new Notification(title, { body, icon: "favicon.png" });
  }
}

function addInPageNotification(message) {
  if (doNotDisturb) return;       // 🛑 ничего не делаем
  notificationQueue.push(message);
  const $cnt = document.getElementById("notification-count");
  $cnt.textContent = notificationQueue.length;
  $cnt.style.display = notificationQueue.length > 0 ? "block" : "none";
}

      // ───── Панель in-page уведомлений ─────

// загрузка/сохранение
function loadNotifications() {
  return JSON.parse(localStorage.getItem('notifications') || '[]');
}
function saveNotifications(arr) {
  localStorage.setItem('notifications', JSON.stringify(arr));
}

// пуш в очередь + бейдж
function pushNotification(text) {
  const arr = loadNotifications();
  arr.unshift({ text, timestamp: Date.now(), read: false });
  saveNotifications(arr);
  renderBadge(arr);
}

// рендер бейджа на колокольчике
function renderBadge(arr) {
  const unread = arr.filter(n => !n.read).length;
  const $cnt = document.getElementById('notification-count');
  if (unread > 0) {
    $cnt.textContent = unread;
    $cnt.style.display = 'block';
  } else {
    $cnt.style.display = 'none';
  }
}

// рендер панели
function renderPanel() {
  const arr = loadNotifications();
  const panel = document.getElementById('notifications-panel');
  if (!arr.length) {
    panel.innerHTML = '<p class="p-3 text-center text-muted">Нет уведомлений</p>';
    return;
  }
  panel.innerHTML = '<ul class="list-group">' +
    arr.map((n, i) => {
      const cls = n.read ? 'read' : 'unread';
      const time = new Date(n.timestamp).toLocaleTimeString();
      return `<li class="list-group-item ${cls}">${n.text}
                <br><small class="text-muted">${time}</small>
              </li>`;
    }).join('') +
    '</ul>';
}

// при открытии панели — помечаем «прочитанными»
function markAllRead() {
  const arr = loadNotifications().map(n => ({ ...n, read: true }));
  saveNotifications(arr);
  renderBadge(arr);
  renderPanel();
}

// перехват in-page уведомлений
function addInPageNotification(message) {
  if (doNotDisturb) return;
  pushNotification(message);
}

// клик по колокольчику
document.getElementById('notification-bell').addEventListener('click', () => {
  const panel = document.getElementById('notifications-panel');
  panel.classList.toggle('show');
  if (panel.classList.contains('show')) {
    renderPanel();
    markAllRead();
  }
});

// инициализация бейджа при загрузке
renderBadge(loadNotifications());



        async function fetchData() {
          const data = await fetchSheetData(RANGE);
          fetchedData = data;
          const shiftData = await fetchSheetData(SHIFT_RANGE);
          window.allShiftData = shiftData;

          await fetchEmployeeList();
          await fetchShiftsQuinyxData();     
          await fetchShiftOversData();

          // Переводим объект employeeData → массив для поиска кандидата
          window.empList = Object.entries(employeeData).map(([name, info]) => ({
            name,
            canReallocate: info.canReallocate,
            prime: info.prime,
            pref: info.pref,
            languages: info.languages,
            // capacity у вас хранится в info.capacity
            maxChats: parseInt(info.capacity, 10) || 0,
            // И если у вас есть дата начала работы — добавьте её в fetchEmployeeList()
            // и здесь возьмите её как info.startDate
            startDate: info.startDate 
          }));

          // Заполнение данных для Aircall
          const aircallConfig = platforms.find((p) => p.name === "Aircall");
          aircallActive = [];
          aircallAway = [];
          for (
            let r = aircallConfig.rowActiveNamesStart;
            r <= aircallConfig.rowActiveNamesEnd;
            r++
          ) {
            const name = data[r]?.[aircallConfig.colIndexNames]?.trim();
            if (name) aircallActive.push(name);
          }
          for (
            let r = aircallConfig.rowAwayNamesStart;
            r <= aircallConfig.rowAwayNamesEnd;
            r++
          ) {
            const name = data[r]?.[aircallConfig.colIndexNames]?.trim();
            const reason = data[r]?.[aircallConfig.colIndexData]?.trim() || "";
            if (name) aircallAway.push({ name, reason });
          }

          renderShiftSummary(data);
          const responsiblesData = await fetchSheetData(RESPONSIBLES_RANGE);
          renderResponsiblePeople(responsiblesData);
          await fetchBreaksData();
          await fetchShiftsQuinyxData();
          await fetchStatusChanges();
          fetchAircallStatuses();
          applyFilters();
          checkEmptyPlatforms(data);
          
          // подключаем кнопку
          document.getElementById('find-candidate')
          .addEventListener('click', findCandidate);
          
          document.getElementById("refresh-icon").classList.remove('rotating');
          if (autoRefreshEnabled) resetAutoRefresh();
        }

        function getPrimaryPlatform(empName) {
          if (!window.shiftsQuinyxData) return null;
        
          const found = window.shiftsQuinyxData.find(row =>
            row.name.toLowerCase() === empName.toLowerCase()
          );
        
          return found?.platform || null;
        }

        function saveNotifiedEmpty() {
          localStorage.setItem(STORAGE_KEY, JSON.stringify([...notifiedEmpty]));
        }
        // для каждой платформы смотрим, не стало ли 0 активных
function checkEmptyPlatforms(data) {
  // summaryCards в renderShiftSummary — в data[6] строчка «On shift now» в 6-м ряду, но нам проще руками перебрать
  const platformCols = {
    "CS": 31,
    "CS/Post Order": 33,
    "PSR": 35,
    "SiMo": 41,
    "Aircall": 39,
    "Venue": 37,
    "Trainee": 41,   // тут в вашем summaryCards они брали data[11][41]
    "ST": 43
  };
  Object.entries(platformCols).forEach(([name, colIdx]) => {
    const count = parseInt(data[6][colIdx] || "0", 10);

    // если 0 и ещё не уведомляли
    if (count === 0 && !notifiedEmpty.has(name)) {
      notifiedEmpty.add(name);
      saveNotifiedEmpty();              // сохраним сразу
      const msg = `⚠️ No active employees on ${name}`;
      showDesktopNotification("Empty platform", msg);
      addInPageNotification(msg);
    }

    // если снова появилось — сбросим, чтобы при повторном уходе в 0 можно было уведомить снова
    if (count > 0 && notifiedEmpty.has(name)) {
      notifiedEmpty.delete(name);
      saveNotifiedEmpty();              // и это сохраним
    }
  });
}

// …внутри fetchData(), сразу после renderShiftSummary(data):

        
        function generateWoltEmail(name) {
          if (!name) return "";
          const parts = name.split(" ");
          return parts.length < 2
            ? parts[0].toLowerCase() + "@wolt.com"
            : parts[0].toLowerCase() +
                "." +
                parts[1].toLowerCase() +
                "@wolt.com";
        }

        function getUpcomingShiftOvers() {
        if (!window.shiftsQuinyxData) return [];
        const now = new Date();
        const oneHourLater = new Date(now.getTime() + 60*60*1000);

        return window.shiftsQuinyxData
          .filter(({name, shift}) => {
            // из "06:00-15:00" берём вторую часть – время конца
            const endStr = shift.split("-")[1];
            if (!endStr) return false;
            // составляем дату-объект: сегодня + endStr
            const [hh, mm] = endStr.split(":").map(Number);
            const endDate = new Date(now);
            endDate.setHours(hh, mm, 0, 0);

            return endDate > now && endDate <= oneHourLater;
          })
          .map(o => o.name);
      }

      function setLogoutIcon(isDark) {
        const logoutBtn = document.getElementById("logout-btn");
        if (!logoutBtn) return;
        // если в той же папке что и HTML:
        logoutBtn.src = isDark
          ? "log-out-white.svg"   // белая иконка
          : "log-out.svg";        // цветная, исходная
      }

      function loadThemePreference() {
  const isDark = localStorage.getItem("darkThemeEnabled") === "true";
  document.body.classList.toggle("dark-theme", isDark);

  const bellIcon = document.querySelector("#notification-bell img");
  bellIcon.src = isDark
    ? "https://www.svgrepo.com/show/526479/bell-off.svg"
    : "https://www.svgrepo.com/show/527618/bell-off.svg";

  const themeCheckbox = document.getElementById("theme-checkbox");
  if (themeCheckbox) themeCheckbox.checked = isDark;
  setLogoutIcon(isDark);
}



        
      function toggleTheme(e) {
  const isDark = e.target.checked;
  document.body.classList.toggle("dark-theme", isDark);

  // подменяем иконку:
  const bellIcon = document.querySelector("#notification-bell img");
  bellIcon.src = isDark
    ? "https://www.svgrepo.com/show/526479/bell-off.svg"
    : "https://www.svgrepo.com/show/527618/bell-off.svg";

  localStorage.setItem("darkThemeEnabled", isDark);
  setLogoutIcon(isDark);
}


function findCandidate() {
  const target = document.getElementById('target-platform').value;
  if (!target) {
    return alert('Select the platform first');
  }
  const now = new Date();

  // вспомогательная функция — приводим строку к единому ключу
  const canonical = str =>
    str.toLowerCase().replace(/[^a-z0-9]/g, '');

  const targetKey = canonical(target);

  // 1) только те, кто может перекомплектоваться
  const pool = window.empList.filter(e => e.canReallocate === 'Yes');
  if (!pool.length) {
    $('#candidateModalBody').html(
      '<div class="alert alert-warning">No employees to reallocate</div>'
    );
    return $('#candidateModal').modal('show');
  }

  const badStatuses = ['will not attend the shift', 'not attended the shift'];

  const candidates = pool.map(e => {
    // 1. Проверка «не будет/не пришёл»
    const rowIdx = fetchedData.findIndex(row =>
      row.some(cell =>
        typeof cell === 'string' &&
        cell.trim().toLowerCase() === e.name.toLowerCase()
      )
    );
    if (rowIdx < 0) return null;
    const shiftIdx = rowIdx - 4;
    const shifts   = window.allShiftData || [];
    if (shiftIdx >= 1 && shiftIdx < shifts.length) {
      if (shifts[shiftIdx].some(cell =>
        typeof cell === 'string' &&
        badStatuses.some(bs => cell.trim().toLowerCase().includes(bs))
      )) {
        return null;
      }
    }

    // 2. На смене?
    const rec = window.shiftsQuinyxData.find(r =>
      r.name.toLowerCase() === e.name.toLowerCase()
    ) || {};
    const parts = (rec.shift || '').split('-');
    if (parts.length < 2) return null;
    const [startStr, endStr] = parts;
    const [sh, sm] = startStr.split(':').map(Number);
    const [eh, em] = endStr.split(':').map(Number);
    const sd = new Date(now); sd.setHours(sh, sm, 0, 0);
    const ed = new Date(now); ed.setHours(eh, em, 0, 0);
    if (now < sd || now > ed) return null;

    // 3. Не на брейке?
    const br = (window.allBreaksData || []).find(b =>
      b.Name.trim().toLowerCase() === e.name.trim().toLowerCase()
    );
    if (br) {
      const [bh, bm] = (br['Break Time'] || '').split(':').map(Number);
      const bd = new Date(now); bd.setHours(bh, bm, 0, 0);
      if (now >= bd && now < new Date(bd.getTime() + 15*60*1000)) {
        return null;
      }
    }

    // 4. Расчёт опыта и скоринга
    // — опыт
    let startDateObj = new Date(e.startDate);
    if (isNaN(startDateObj)) {
      const pd = e.startDate.split(/[./]/);
      if (pd.length === 3) {
        const [d, m, y] = pd;
        startDateObj = new Date(`${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`);
      }
    }
    const tenure = isNaN(startDateObj)
      ? 0
      : Math.floor((now - startDateObj) / (1000*60*60*24*30));

    // — prime
    const primeMatch = e.prime === target ? 1 : 0;

    // — pref
    const prefList = (e.pref || '').split(',').map(s => canonical(s));
    const prefMatch = prefList.some(pk =>
      pk === targetKey || targetKey.includes(pk) || pk.includes(targetKey)
    ) ? 1 : 0;

    // — языки и capacity
    const langCount = e.languages.trim()
      ? e.languages.trim().split(/\s+/).length
      : 0;
    const cap = e.maxChats || 0;

    // — финальный score
    const w = { t:0.2, pr:0.3, pf:0.2, lg:0.2, cp:0.1 };
    const maxCap = Math.max(...pool.map(x => x.maxChats), 1);
    const score =
      w.t  * Math.min(tenure/24, 1) +
      w.pr * primeMatch +
      w.pf * prefMatch +
      w.lg * (langCount/3) +
      w.cp * (cap/maxCap);

    return { ...e, tenure, primeMatch, prefMatch, langCount, cap, score };
  }).filter(x => x);

  if (!candidates.length) {
    $('#candidateModalBody').html(
      '<div class="alert alert-warning">Нет доступных кандидатов</div>'
    );
    return $('#candidateModal').modal('show');
  }

  // выбираем лучшего
  const best = candidates.sort((a,b) => b.score - a.score)[0];

  // внутри findCandidate(), после const best = …
const rec = window.shiftsQuinyxData
  .find(r => r.name.toLowerCase() === best.name.toLowerCase()) || {};

const shiftInfo = `${rec.platform || '–'} (${rec.shift || '–'})`;

let breakTime = '–';
if (Array.isArray(window.allBreaksData)) {
  const br = window.allBreaksData.find(b =>
    b.Name?.trim().toLowerCase() === best.name.trim().toLowerCase()
  );
  if (br) breakTime = br['Break Time'] || '–';
}


  // собираем HTML для модалки
  const html = `
  <div class="text-center">
    <h4>${best.name}</h4>
    <p>Score <strong>${best.score.toFixed(2)}</strong></p>
    <ul class="list-unstyled text-left mx-auto" style="max-width:200px;">
      <li>Current Shift: <strong>${shiftInfo}</strong></li>
      <li>Break: <strong>${breakTime}</strong></li>
      <li>Total working time: <strong>${best.tenure}</strong> months</li>
      <li>Is this his prime platform: <strong>${best.primeMatch ? 'Yes' : 'No'}</strong></li>
      <li>Is this his preferrable platform: <strong>${best.prefMatch ? 'Yes' : 'No'}</strong></li>
      <li>Languages: <strong>${best.langCount}</strong></li>
      <li>Chat capacity: <strong>${best.cap}</strong></li>
    </ul>
  </div>
`;

  $('#candidateModalBody').html(html);
  $('#candidateModal').modal('show');
}


        // Инициализация Bootstrap-Select и обработка изменения выбора платформ
        $(document).ready(function () {
          $("#platform-dropdown").selectpicker();
          $("#platform-dropdown").on(
            "changed.bs.select",
            function (e, clickedIndex, isSelected, previousValue) {
              let selected = $(this).val();
              currentPlatformFilter = selected && selected.length ? selected : ["all"];
              applyFilters();
            }
          );
        });

        document.getElementById("theme-checkbox")
  .addEventListener("change", toggleTheme);
document.addEventListener("DOMContentLoaded", loadThemePreference);
document.addEventListener("DOMContentLoaded", () => {
  // Загрузка темы
  loadThemePreference();

  const dndCheckbox = document.getElementById('dnd-toggle');
  dndCheckbox.checked = doNotDisturb;
  dndCheckbox.addEventListener('change', e => {
    setDoNotDisturb(e.target.checked);
  })
  // … остальной ваш код инициализации


  // Сайдбар
  const layout    = document.querySelector(".dashboard-layout");
  const sidebar   = document.getElementById("sidebar");
  const hamburger = document.getElementById("hamburger-menu");
  const closeBtn  = document.getElementById("sidebar-close");

  // Открытие сайдбара по бургер-меню
  hamburger.addEventListener("click", (e) => {
    e.stopPropagation();
    sidebar.classList.add("active");
    layout.classList.add("sidebar-open");
  });

  // Закрытие по кнопке «×»
  closeBtn.addEventListener("click", () => {
    sidebar.classList.remove("active");
    layout.classList.remove("sidebar-open");
  });


  // Фильтры таблицы платформ
  document
    .getElementById("employee-search")
    .addEventListener("input", (e) => {
      currentSearchTerm = e.target.value;
      applyFilters();
    });

  document
    .getElementById("status-filter")
    .addEventListener("change", (e) => {
      currentStatusFilter = e.target.value;
      applyFilters();
    });

  document
    .getElementById("realloc-filter")
    .addEventListener("change", (e) => {
      currentReallocFilter = e.target.value;
      applyFilters();
    });

  document
    .getElementById("lang-filter")
    .addEventListener("change", (e) => {
      currentLangFilter = e.target.value;
      applyFilters();
    });

  // Фильтр перерывов
  document
    .getElementById("break-filter")
    .addEventListener("change", (e) => {
      currentBreakFilter = e.target.value; // "upcoming" или "all"
      fetchBreaksData();
    });

  // Селектор платформ (bootstrap-select)
  $('#platform-dropdown').selectpicker();
  $('#platform-dropdown').on('changed.bs.select', function () {
    const selected = $(this).val();
    currentPlatformFilter = selected && selected.length ? selected : ['all'];
    applyFilters();
  });

  // Модалка сотрудника
  const overlay = document.getElementById("modal-overlay");
  const modalClose = document.getElementById("modal-close");
  overlay.addEventListener("click", closeEmployeeModal);
  modalClose.addEventListener("click", closeEmployeeModal);

    // 1) Один раз заполняем dropdown платформ
  const sel = document.getElementById('target-platform');
  // очищаем (оставляем только заглушку)
  sel.innerHTML = '<option value="">→ Reallocate to..</option>';
  platforms.forEach(p => sel.add(new Option(p.name, p.name)));

  // Переключатель темы
  document.getElementById("theme-checkbox").addEventListener("change", toggleTheme);

  document.getElementById('find-candidate')
  .addEventListener('click', findCandidate);

  // Первичная загрузка данных
  if ("Notification" in window) {
  Notification.requestPermission().then(p => {
    console.log("Push permission:", p);
  });
}

  fetchData();
});
     
      
      </script>
    </div>
  </body>
</html>
