<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Support Monitoring Dashboard</title>
  <!-- Bootstrap для удобного оформления -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    body {
      background-color: #f8f9fa;
      padding: 20px;
      font-family: Arial, sans-serif;
    }
    .dashboard-container {
      max-width: 1200px;
      margin: auto;
    }
    .platform-card {
      margin: 10px;
      padding: 10px;
      border-radius: 8px;
      background-color: #ffffff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      font-size: 0.9rem;
    }
    h1, h5 {
      color: #343a40;
    }
    h5 {
      margin-bottom: 5px;
      font-weight: bold;
    }
    p {
      margin: 5px 0;
    }
    ul {
      list-style: none;
      padding-left: 0;
      margin: 0 0 5px 0;
    }
    ul li {
      padding: 2px 0;
      border-bottom: 1px solid #dee2e6;
    }
    ul li:last-child {
      border-bottom: none;
    }
    /* Статусная панель */
    .status-bar {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .status-badge {
      background-color: #28a745;
      border-radius: 4px;
      color: #fff;
      padding: 3px 8px;
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <h1 class="text-center mb-4">Dashboard</h1>
    <!-- Панель с кнопками и статусом -->
    <div class="status-bar">
      <button id="toggle-autorefresh" class="btn btn-outline-primary btn-sm">Disable Auto Refresh</button>
      <button id="refresh-now" class="btn btn-outline-secondary btn-sm ml-2">Refresh now</button>
      <span id="update-status" class="status-badge ml-2">Updated</span>
      <span class="ml-3">Auto refresh in <span id="countdown">60</span> seconds...</span>
    </div>
    <div id="app">Загрузка...</div>
  </div>

  <!-- PapaParse для парсинга CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script>
    // Ссылка на CSV из Google Sheets (замените при необходимости)
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSmaCLCDgsSsk-HY4qtkZteI60f1NxMCO4IYrFjeXoCbQRjAh0IeK0tJ4fMSScZqbS1troISgXNvssJ/pub?output=csv";

    // Конфигурация платформ: имена/статусы в одной паре столбцов
    // CS: D (3), E (4)
    // CS/Post: F (5), G (6)
    // PSR: H (7), I (8)
    // SiMo: J (9), K (10)
    // Aircall: L (11), M (12)
    // Venue: N (13), O (14)
    // Trainee: P (15), Q (16)
    // ST: R (17), S (18)

    // colIndexNames -> столбец с именами
    // colIndexData  -> тот же столбец, где хранятся числа и статусы
    const platforms = [
      {
        name: "CS",
        colIndexNames: 3,   // D
        colIndexData: 4,    // E (и число Active/Away, и статусы)
        // строки, где брать число активных, имена, etc.
        rowActiveCount: 3,         // E4
        rowActiveNamesStart: 4,    // E5
        rowActiveNamesEnd: 15,     // E16
        rowAwayCount: 27,          // E28
        rowAwayNamesStart: 28,     // E29
        rowAwayNamesEnd: 35        // E36
      },
      {
        name: "CS/Post order",
        colIndexNames: 5,  // F
        colIndexData: 6,   // G
        rowActiveCount: 3,
        rowActiveNamesStart: 4,
        rowActiveNamesEnd: 15,
        rowAwayCount: 27,
        rowAwayNamesStart: 28,
        rowAwayNamesEnd: 35
      },
      {
        name: "PSR",
        colIndexNames: 7,  // H
        colIndexData: 8,   // I
        rowActiveCount: 3,
        rowActiveNamesStart: 4,
        rowActiveNamesEnd: 15,
        rowAwayCount: 27,
        rowAwayNamesStart: 28,
        rowAwayNamesEnd: 35
      },
      {
        name: "SiMo",
        colIndexNames: 9,   // J
        colIndexData: 10,   // K
        rowActiveCount: 3,
        rowActiveNamesStart: 4,
        rowActiveNamesEnd: 15,
        rowAwayCount: 27,
        rowAwayNamesStart: 28,
        rowAwayNamesEnd: 35
      },
      {
        name: "Aircall",
        colIndexNames: 11,  // L
        colIndexData: 12,   // M
        rowActiveCount: 3,
        rowActiveNamesStart: 4,
        rowActiveNamesEnd: 15,
        rowAwayCount: 27,
        rowAwayNamesStart: 28,
        rowAwayNamesEnd: 35
      },
      {
        name: "Venue",
        colIndexNames: 13,  // N
        colIndexData: 14,   // O
        rowActiveCount: 3,
        rowActiveNamesStart: 4,
        rowActiveNamesEnd: 15,
        rowAwayCount: 27,
        rowAwayNamesStart: 28,
        rowAwayNamesEnd: 35
      },
      {
        name: "Trainee",
        colIndexNames: 15,  // P
        colIndexData: 16,   // Q
        rowActiveCount: 3,
        rowActiveNamesStart: 4,
        rowActiveNamesEnd: 15,
        rowAwayCount: 27,
        rowAwayNamesStart: 28,
        rowAwayNamesEnd: 35
      },
      {
        name: "ST",
        colIndexNames: 17,  // R
        colIndexData: 18,   // S
        rowActiveCount: 3,
        rowActiveNamesStart: 4,
        rowActiveNamesEnd: 15,
        rowAwayCount: 27,
        rowAwayNamesStart: 28,
        rowAwayNamesEnd: 35
      }
    ];

    // Параметры автообновления
    let autoRefreshEnabled = true;
    let refreshInterval = 60; // секунд
    let refreshTimer = null;
    let countdownTimer = null;
    let countdownValue = refreshInterval;

    // Загрузка данных
    function fetchData() {
      Papa.parse(CSV_URL, {
        download: true,
        header: false,
        complete: function(results) {
          const data = results.data;
          renderDashboard(data);
          showUpdatedStatus();

          if (autoRefreshEnabled) {
            resetAutoRefresh();
          }
        },
        error: function(err) {
          console.error("CSV parse error:", err);
        }
      });
    }

    // Рендерим дэшборд
    function renderDashboard(data) {
      const app = document.getElementById("app");
      let html = '<div class="row">';

      platforms.forEach(platform => {
        // Число активных из одной ячейки
        const activeCount = data[platform.rowActiveCount]?.[platform.colIndexData] || 0;
        // Имена активных (просто берём строки rowActiveNamesStart..rowActiveNamesEnd)
        const activeNames = [];
        for (let r = platform.rowActiveNamesStart; r <= platform.rowActiveNamesEnd; r++) {
          const name = data[r]?.[platform.colIndexNames]?.trim();
          if (name) activeNames.push(name);
        }

        // Количество away из одной ячейки
        const awayCount = data[platform.rowAwayCount]?.[platform.colIndexData] || 0;
        // Список away: берём имена и "статус"
        // Но статус/причина хранится там же (colIndexData) в соответствующей строке
        const awayData = [];
        for (let r = platform.rowAwayNamesStart; r <= platform.rowAwayNamesEnd; r++) {
          const name = data[r]?.[platform.colIndexNames]?.trim();
          if (!name) continue;
          // Статус / причина
          const reason = data[r]?.[platform.colIndexData]?.trim() || "";
          awayData.push({ name, reason });
        }

        html += `
          <div class="col-md-3 col-sm-6">
            <div class="platform-card">
              <h5>${platform.name}</h5>
              <p><small>Активные (${activeCount})</small></p>
              <ul>
                ${activeNames.map(n => `<li>${n}</li>`).join("")}
              </ul>
              <p><small>Away (${awayCount})</small></p>
              <ul>
                ${awayData.map(item => {
                  // Если reason непуст, ставим тире
                  const extra = item.reason ? ` - ${item.reason}` : "";
                  return `<li>${item.name}${extra}</li>`;
                }).join("")}
              </ul>
            </div>
          </div>
        `;
      });

      html += '</div>';
      app.innerHTML = html;
    }

    // Отметка "Updated"
    function showUpdatedStatus() {
      const updateStatusEl = document.getElementById("update-status");
      updateStatusEl.textContent = "Updated";
      updateStatusEl.style.backgroundColor = "#28a745"; // зелёный
    }

    // Сброс автообновления и запуск таймеров
    function resetAutoRefresh() {
      clearTimeout(refreshTimer);
      clearInterval(countdownTimer);

      countdownValue = refreshInterval;
      updateCountdownDisplay();

      refreshTimer = setTimeout(fetchData, refreshInterval * 1000);
      countdownTimer = setInterval(() => {
        countdownValue--;
        if (countdownValue <= 0) {
          clearInterval(countdownTimer);
        }
        updateCountdownDisplay();
      }, 1000);
    }

    // Отображение обратного отсчёта
    function updateCountdownDisplay() {
      document.getElementById("countdown").textContent = countdownValue;
    }

    // Вкл/выкл автообновления
    function toggleAutoRefresh() {
      autoRefreshEnabled = !autoRefreshEnabled;
      const btn = document.getElementById("toggle-autorefresh");
      if (autoRefreshEnabled) {
        btn.textContent = "Disable Auto Refresh";
        resetAutoRefresh();
      } else {
        btn.textContent = "Enable Auto Refresh";
        clearTimeout(refreshTimer);
        clearInterval(countdownTimer);
        document.getElementById("countdown").textContent = "";
      }
    }

    // Ручное обновление
    function refreshNow() {
      fetchData();
    }

    // Инициализация
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("toggle-autorefresh").addEventListener("click", toggleAutoRefresh);
      document.getElementById("refresh-now").addEventListener("click", refreshNow);
      fetchData();
    });
  </script>
</body>
</html>
