<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>SUMO Dashboard</title>
  <link rel="icon" type="image/png" href="favicon.png" />
  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    /* –í–∞—à–∏ CSS-—Å—Ç–∏–ª–∏, –∫–∞–∫ –∏ —Ä–∞–Ω–µ–µ */
    :root {
      --bg-color: linear-gradient(120deg, #fdfbfb 0%, #ebedee 100%);
      --text-color: #343a40;
      --card-bg-color: #ffffff;
      --card-text-color: #495057;
      --card-border-color: #dee2e6;
      --card-shadow: 0 4px 16px rgba(0,0,0,0.08);
      --card-hover-shadow: 0 6px 20px rgba(0,0,0,0.12);
      --menu-bg-color: #ffffff;
      --menu-shadow: 2px 0 5px rgba(0,0,0,0.2);
      --menu-width: 250px;
      --transition-speed: 0.3s;
    }
    body.dark-theme {
      --bg-color: linear-gradient(120deg, #2a2a2a 0%, #3c3c3c 100%);
      --text-color: #f0f0f0;
      --card-bg-color: #3a3a3a;
      --card-text-color: #e5e5e5;
      --card-border-color: #555555;
      --card-shadow: 0 4px 16px rgba(255,255,255,0.08);
      --card-hover-shadow: 0 6px 20px rgba(255,255,255,0.12);
      --menu-bg-color: #3a3a3a;
    }
    
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      min-height: 100vh;
      background: var(--bg-color);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow-x: hidden;
      color: var(--text-color);
      transition: background var(--transition-speed) ease, color var(--transition-speed) ease;
    }
    /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
    /* ... */
  </style>
  
  <!-- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Firebase –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –∫–∞–∫ –º–æ–∂–Ω–æ —Ä–∞–Ω—å—à–µ -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAHyxC12UaO6QU_nCiWFnegul1Vix5skm8",
      authDomain: "shldashboard.firebaseapp.com",
      projectId: "shldashboard",
      storageBucket: "shldashboard.firebasestorage.app",
      messagingSenderId: "362566153595",
      appId: "1:362566153595:web:ee35c2588bd0f798e6f9de"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // –°–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    const allowedEmails = [
      "mikhail.garayev@wolt.com",
      "user2@example.com"
    ];

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
    auth.onAuthStateChanged((user) => {
      if (!user) {
        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚Äì –ø–µ—Ä–µ–∞–¥—Ä–µ—Å—É–µ–º –Ω–∞ login.html
        window.location.replace("login.html");
      } else if (!allowedEmails.includes(user.email)) {
        // –ï—Å–ª–∏ email –Ω–µ –≤—Ö–æ–¥–∏—Ç –≤ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫, –≤—ã—Ö–æ–¥–∏–º –∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏–º
        auth.signOut().then(() => {
          window.location.replace("login.html");
        });
      }
      // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∏ email —Ä–∞–∑—Ä–µ—à—ë–Ω, –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –¥–∞–ª—å—à–µ.
    });
  </script>
  
</head>
<body>
  <!-- –ì–∞–º–±—É—Ä–≥–µ—Ä-–º–µ–Ω—é -->
  <div class="hamburger-menu" id="hamburger-menu">
    <span>&#9776;</span>
  </div>
  <!-- –°–∞–π–¥–±–∞—Ä —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π -->
  <div id="sidebar">
    <div class="close-btn" id="sidebar-close">&times;</div>
    <a href="https://example.com" target="_blank">YIGIM Dashboard</a>
    <a href="https://anotherexample.com" target="_blank">Datadog Dashboard</a>
    <a href="https://yetanother.com" target="_blank">City States</a>
    <a href="https://yetanother.com" target="_blank">City Tools</a>
    <a href="https://yetanother.com" target="_blank">Converse Admin Panel</a>
  </div>

  <div class="dashboard-container">
    <h1>Support Monitoring Dashboard</h1>
    
    <!-- –ü–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –æ–ø—Ü–∏—è–º–∏ -->
    <div class="filter-panel">
      <!-- –ü—Ä–∏–º–µ—Ä –º–µ—Ç—Ä–∏–∫–∏ "Baku Central 1.1" -->
      <div class="stats-card">
        <span class="stats-title">Baku Central</span>
        <span class="stats-value">1.1</span>
      </div>
      
      <!-- WEATHER CARD -->
      <div class="stats-card" id="weather-card">
        <span class="stats-title">Baku Weather</span>
        <span class="stats-value" id="baku-temp">-- ¬∞C</span>
        <br/>
        <span class="stats-title">Wind Speed</span>
        <span class="stats-value" id="baku-wind">-- m/s</span>
      </div>
      
      <div class="filter-section">
        <!-- Status Filter -->
        <select id="status-filter" class="filter-dropdown">
          <option value="both">Status</option>
          <option value="active">Active</option>
          <option value="away">Away</option>
        </select>
        <!-- Dropdown –¥–ª—è –ø–ª–∞—Ç—Ñ–æ—Ä–º -->
        <div class="dropdown">
          <button class="btn btn-secondary dropdown-toggle" type="button" id="platformDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Platform
          </button>
          <div class="dropdown-menu" aria-labelledby="platformDropdown" id="platform-dropdown-menu">
            <div class="dropdown-item platform-checkbox">
              <div class="form-check">
                <input class="form-check-input platform-option" type="checkbox" value="all" id="platform-all" checked>
                <label class="form-check-label" for="platform-all">–í—Å–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã</label>
              </div>
            </div>
            <!-- –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
          </div>
        </div>
        <!-- Reallocate Filter -->
        <select id="realloc-filter" class="filter-dropdown">
          <option value="all">Reallocate: All</option>
          <option value="Yes">Yes</option>
          <option value="No">No</option>
        </select>
        <!-- Language Filter -->
        <select id="lang-filter" class="filter-dropdown">
          <option value="all">Language: All</option>
          <option value="two">Bilingual</option>
          <option value="three">Trilingual</option>
        </select>
        <!-- Break Filter -->
        <select id="break-filter" class="filter-dropdown">
          <option value="upcoming">Breaks: Upcoming</option>
          <option value="all">Breaks: All</option>
        </select>
      </div>
      
      <div class="search-section">
        <input type="text" id="employee-search" placeholder="Search..." class="search-input">
        <button class="search-btn">Search</button>
      </div>
      
      <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã -->
      <div class="theme-toggle-container">
        <span>–¢–µ–º–∞:</span>
        <label class="theme-switch">
          <input type="checkbox" id="theme-checkbox">
          <span class="slider"></span>
        </label>
      </div>
      
      <!-- –°–µ–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å —Ç–∞–π–º–µ—Ä–æ–º –∏ –∫–Ω–æ–ø–∫–æ–π refresh now -->
      <div class="refresh-section">
        <span id="timer-label">Refresh in: <span id="countdown">15</span> s</span>
        <div id="refresh-spinner" class="spinner-border text-primary" role="status" style="display:none;">
          <span class="sr-only">Loading...</span>
        </div>
        <button class="refresh-btn" onclick="refreshNow()">Refresh now</button>
      </div>
      
    </div>
    
    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
    <div id="shift-summary" class="shift-summary-card">
      <div class="shift-summary-title">Statistics per platform</div>
      <table class="shift-summary-grid" id="summary-table"></table>
    </div>
    
    <div id="platforms-container" class="platforms-row"></div>
    
    <div id="breaks-section">
      <h2>Upcoming Breaks</h2>
      <div id="breaks-app"></div>
    </div>
  </div>
  
  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ -->
  <div id="modal-overlay"></div>
  <div id="employee-modal">
    <span class="close-btn" id="modal-close">&times;</span>
    <h3 id="modal-emp-name"></h3>
    <p><strong>Can Reallocate?</strong>: <span id="modal-emp-realloc"></span></p>
    <p><strong>Prime Platform:</strong> <span id="modal-emp-prime"></span></p>
    <p><strong>Preferred Platform:</strong> <span id="modal-emp-pref"></span></p>
    <p><strong>Languages:</strong> <span id="modal-emp-languages"></span></p>
    <p>
      <a id="modal-inbox-link" href="#" target="_blank">Inbox</a> |
      <a id="modal-admin-link" href="#" target="_blank">Admin Dashboard</a>
    </p>
  </div>
  
  <script>
    // ===============================
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    const firebaseConfig = {
      apiKey: "AIzaSyAHyxC12UaO6QU_nCiWFnegul1Vix5skm8",
      authDomain: "shldashboard.firebaseapp.com",
      projectId: "shldashboard",
      storageBucket: "shldashboard.firebasestorage.app",
      messagingSenderId: "362566153595",
      appId: "1:362566153595:web:ee35c2588bd0f798e6f9de"
    };
    
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    
    // –°–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö email
    const allowedEmails = [
      "mikhail.garayev@wolt.com",
      "user2@example.com"
    ];
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∫–∞–∫ –º–æ–∂–Ω–æ —Ä–∞–Ω—å—à–µ
    auth.onAuthStateChanged((user) => {
      if (!user || !allowedEmails.includes(user.email)) {
        window.location.replace("login.html");
      }
    });
    
    // ===============================
    // WEATHER SECTION WITH CACHING
    const OPENWEATHER_API_KEY = "f97220cfb6bcefa391405990e7b9825d";
    const CITY_NAME = "Baku,AZ";
    async function fetchWeather() {
      const cacheKey = "bakuWeatherData";
      const cacheTimeKey = "bakuWeatherTimestamp";
      const now = Date.now();
      const cacheTTL = 15 * 60 * 1000; // 15 –º–∏–Ω—É—Ç
      
      const cachedData = localStorage.getItem(cacheKey);
      const cachedTimestamp = localStorage.getItem(cacheTimeKey);
      
      if (cachedData && cachedTimestamp && (now - cachedTimestamp) < cacheTTL) {
        const data = JSON.parse(cachedData);
        updateWeatherUI(data);
        return;
      }
      
      const url = `https://api.openweathermap.org/data/2.5/weather?q=${CITY_NAME}&units=metric&appid=${OPENWEATHER_API_KEY}`;
      try {
        const res = await fetch(url);
        if (!res.ok) {
          console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–≥–æ–¥—ã: " + res.statusText);
          return;
        }
        const data = await res.json();
        localStorage.setItem(cacheKey, JSON.stringify(data));
        localStorage.setItem(cacheTimeKey, now);
        updateWeatherUI(data);
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –ø–æ–≥–æ–¥—ã: " + err);
      }
    }
    function updateWeatherUI(data) {
      const temperature = data.main?.temp ?? null;
      const windSpeed = data.wind?.speed ?? null;
      document.getElementById("baku-temp").textContent =
        temperature ? `${Math.round(temperature)} ¬∞C` : "-- ¬∞C";
      document.getElementById("baku-wind").textContent =
        windSpeed ? `${windSpeed} m/s` : "-- m/s";
    }
    // ===============================
    
    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º
    const platformInfo = {
      "CS": "–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ —á–∞—Ç –∏ –∑–≤–æ–Ω–∫–∏.",
      "CS/Post order": "–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ –∑–∞–∫–∞–∑–∞–º –ø–æ—Å–ª–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è.",
      "PSR": "–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º –≤–æ–ø—Ä–æ—Å–∞–º.",
      "SiMo": "–°–∏–º—É–ª—è—Ü–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –≤–Ω—É—Ç—Ä–∏ —Å–∏—Å—Ç–µ–º—ã.",
      "Aircall": "–¢–µ–ª–µ—Ñ–æ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Aircall.",
      "Venue": "–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Ä–µ–≥–∏–æ–Ω–∞—Ö.",
      "Trainee": "–°—Ç–∞–∂–µ—Ä—ã, –Ω–∞—Ö–æ–¥—è—â–∏–µ—Å—è –Ω–∞ –æ–±—É—á–µ–Ω–∏–∏.",
      "ST": "–ú–µ—Å—Ç–Ω–∞—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞."
    };
    
    let fetchedData = null;
    let currentSearchTerm = "";
    let currentStatusFilter = "both";
    let currentPlatformFilter = ["all"];
    let currentReallocFilter = "all";
    let currentLangFilter = "all";
    let currentBreakFilter = "upcoming";
    
    const SPREADSHEET_ID = "1dICKOxxz9R3x8MY3FKQ9I-IwR9fBUDfMOT9PFDLloAE";
    const RANGE = "list1!A1:BJ100";
    const BREAKS_RANGE = "prebreaks!A1:D40";
    const GOOGLE_API_KEY = "AIzaSyBVHrKvA61CAJBLxU-4AAiow6Y0TV4ChSY";
    
    let employeeData = {};
    
    const platforms = [
      { name: "CS",             url: "https://ops.wolt.com/support/converse/conversations?conversationListId=6643245bfadf62c6edc28feb", colIndexNames: 3, colIndexData: 4,  rowActiveNamesStart: 4, rowActiveNamesEnd: 27, rowAwayNamesStart: 28, rowAwayNamesEnd: 47 },
      { name: "CS/Post order",  url: "https://ops.wolt.com/support/converse/conversations?conversationListId=664324a0510ac011feaa798c", colIndexNames: 5, colIndexData: 6,  rowActiveNamesStart: 4, rowActiveNamesEnd: 27, rowAwayNamesStart: 28, rowAwayNamesEnd: 47 },
      { name: "PSR",            url: "https://ops.wolt.com/support/converse/conversations?conversationListId=6567a44af7d470550b11dc68", colIndexNames: 7, colIndexData: 8,  rowActiveNamesStart: 4, rowActiveNamesEnd: 27, rowAwayNamesStart: 28, rowAwayNamesEnd: 47 },
      { name: "SiMo",           url: "https://ops.wolt.com/support/converse/conversations?conversationListId=6668088fc6d870f3cfd61653", colIndexNames: 9, colIndexData: 10, rowActiveNamesStart: 4, rowActiveNamesEnd: 27, rowAwayNamesStart: 28, rowAwayNamesEnd: 47 },
      { name: "Aircall",        url: "https://ops.wolt.com/support/converse/conversations?conversationListId=671a26a2a5b9ae4a2ca603fb", colIndexNames: 11, colIndexData: 12, rowActiveNamesStart: 4, rowActiveNamesEnd: 27, rowAwayNamesStart: 28, rowAwayNamesEnd: 47 },
      { name: "Venue",          url: "https://ops.wolt.com/support/converse/conversations?conversationListId=666807fc28b3f1231948f407", colIndexNames: 13, colIndexData: 14, rowActiveNamesStart: 4, rowActiveNamesEnd: 27, rowAwayNamesStart: 28, rowAwayNamesEnd: 47 },
      { name: "Trainee",        url: "https://wolt.com/", colIndexNames: 15, colIndexData: 16, rowActiveNamesStart: 4, rowActiveNamesEnd: 27, rowAwayNamesStart: 28, rowAwayNamesEnd: 47 },
      { name: "ST",             url: "https://wolt.com/", colIndexNames: 17, colIndexData: 18, rowActiveNamesStart: 4, rowActiveNamesEnd: 27, rowAwayNamesStart: 28, rowAwayNamesEnd: 47 }
    ];
    
    let aircallActive = [];
    let aircallAway = [];
    
    function logDebug(message) {
      console.log(message);
    }
    
    async function fetchSheetData(range) {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(range)}?key=${GOOGLE_API_KEY}`;
      try {
        const res = await fetch(url);
        if (!res.ok) {
          logDebug("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: " + res.statusText);
          return null;
        }
        const data = await res.json();
        return data.values;
      } catch (err) {
        logDebug("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: " + err);
        return null;
      }
    }
    
    async function fetchEmployeeList() {
      const data = await fetchSheetData("emplist!A1:F");
      if (!data || data.length < 2) return;
      for (let i = 1; i < data.length; i++) {
        const row = data[i];
        if (!row[0]) continue;
        const empName = row[0].trim();
        const empId = row[1]?.trim() || "";
        const canRealloc = row[2]?.trim() || "";
        const primePlatform = row[3]?.trim() || "";
        const preferredPlatform = row[4]?.trim() || "";
        const languages = row[5]?.trim() || "";
        employeeData[empName] = {
          id: empId,
          canReallocate: canRealloc,
          prime: primePlatform,
          pref: preferredPlatform,
          languages: languages
        };
      }
    }
    
    function generateInboxLink(empId) {
      return "https://ops.wolt.com/support/converse/users/conversations?assigneeIds=" + encodeURIComponent(empId);
    }
    
    function generateAdminLink(empId) {
      return "https://ops.wolt.com/support/converse/admin/users?userId=" + encodeURIComponent(empId);
    }
    
    function openEmployeeModal(empName) {
      const info = employeeData[empName];
      if (!info) {
        logDebug("–î–∞–Ω–Ω—ã–µ –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã: " + empName);
        return;
      }
      document.getElementById("modal-emp-name").textContent = empName;
      document.getElementById("modal-emp-realloc").textContent = info.canReallocate || "N/A";
      document.getElementById("modal-emp-prime").textContent = info.prime || "N/A";
      document.getElementById("modal-emp-pref").textContent = info.pref || "N/A";
      document.getElementById("modal-emp-languages").textContent = info.languages || "N/A";
      document.getElementById("modal-inbox-link").href = generateInboxLink(info.id);
      document.getElementById("modal-admin-link").href = generateAdminLink(info.id);
      document.getElementById("employee-modal").style.display = "block";
      document.getElementById("modal-overlay").style.display = "block";
    }
    
    function closeEmployeeModal() {
      document.getElementById("employee-modal").style.display = "none";
      document.getElementById("modal-overlay").style.display = "none";
    }
    
    const AIRCALL_API_KEY = "43bce092d80a09050211a837c0bbd705";
    const AIRCALL_API_SECRET = "092d2eb157c47614788386920acd7413";
    
    async function getAircallUserId(email) {
      const authString = btoa(`${AIRCALL_API_KEY}:${AIRCALL_API_SECRET}`);
      const url = `https://api.aircall.io/v1/users/${encodeURIComponent(email)}`;
      try {
        logDebug(`–ó–∞–ø—Ä–æ—Å Aircall ID –¥–ª—è email: ${email}`);
        const res = await fetch(url, { headers: { "Authorization": `Basic ${authString}` }});
        if (!res.ok) {
          logDebug(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è ID Aircall: ${res.statusText} (–°—Ç–∞—Ç—É—Å: ${res.status})`);
          return null;
        }
        const data = await res.json();
        logDebug(`–ü–æ–ª—É—á–µ–Ω ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${data.user?.id}`);
        return data.user?.id || null;
      } catch (err) {
        logDebug("–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ Aircall ID: " + err);
        return null;
      }
    }
    
    async function getAircallAvailability(userId) {
      if (!userId) {
         logDebug("getAircallAvailability: userId –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω");
         return "No ID";
      }
      const authString = btoa(`${AIRCALL_API_KEY}:${AIRCALL_API_SECRET}`);
      const url = `https://api.aircall.io/v1/users/${userId}/availability`;
      try {
         logDebug(`–ó–∞–ø—Ä–æ—Å —Å—Ç–∞—Ç—É—Å–∞ Aircall –¥–ª—è userId: ${userId}`);
         const res = await fetch(url, { headers: { "Authorization": `Basic ${authString}` }});
         if (!res.ok) {
             logDebug(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ Aircall: ${res.statusText} (–°—Ç–∞—Ç—É—Å: ${res.status})`);
             return "Error";
         }
         const data = await res.json();
         let status = data?.user_availability?.availability_status || data?.availability;
         logDebug(`–ü–æ–ª—É—á–µ–Ω —Å—Ç–∞—Ç—É—Å –¥–ª—è userId ${userId}: ${status}`);
         return status || "Unknown";
      } catch (err) {
         logDebug("–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –≤ getAircallAvailability: " + err);
         return "Error";
      }
    }
    
    function passReallocAndLang(empName) {
      const info = employeeData[empName];
      if (!info) return false;
      if (currentReallocFilter !== "all") {
        if (info.canReallocate !== currentReallocFilter) return false;
      }
      if (currentLangFilter !== "all") {
        let lang = info.languages.replace(/\s+/g, "");
        if (currentLangFilter === "two") {
          if (!(lang.includes("üá¶üáø") && lang.includes("üá¨üáß")) || lang.includes("üá∑üá∫")) {
            return false;
          }
        } else if (currentLangFilter === "three") {
          if (!(lang.includes("üá¶üáø") && lang.includes("üá¨üáß") && lang.includes("üá∑üá∫"))) {
            return false;
          }
        }
      }
      return true;
    }
    
    function applyFilters() {
      const container = document.getElementById("platforms-container");
      container.innerHTML = "";
      
      platforms.forEach(platform => {
        if (!currentPlatformFilter.includes("all") && !currentPlatformFilter.includes(platform.name)) {
          return;
        }
        
        if (platform.name !== "Aircall") {
          let activeNames = [];
          for (let r = platform.rowActiveNamesStart; r <= platform.rowActiveNamesEnd; r++) {
            const nm = fetchedData[r]?.[platform.colIndexNames]?.trim();
            if (nm) activeNames.push(nm);
          }
          let awayData = [];
          for (let r = platform.rowAwayNamesStart; r <= platform.rowAwayNamesEnd; r++) {
            const nm = fetchedData[r]?.[platform.colIndexNames]?.trim();
            if (!nm) continue;
            const rsn = fetchedData[r]?.[platform.colIndexData]?.trim() || "";
            awayData.push({ name: nm, reason: rsn });
          }
          if (currentSearchTerm) {
            activeNames = activeNames.filter(n => n.toLowerCase().includes(currentSearchTerm.toLowerCase()));
            awayData = awayData.filter(item => item.name.toLowerCase().includes(currentSearchTerm.toLowerCase()));
          }
          activeNames = activeNames.filter(n => passReallocAndLang(n));
          awayData = awayData.filter(item => passReallocAndLang(item.name));
          
          let showActive = true, showAway = true;
          if (currentStatusFilter === "active") showAway = false;
          else if (currentStatusFilter === "away") showActive = false;
          
          let html = `<div class="platform-card">
              <h5>
                <a href="${platform.url}" target="_blank" rel="noopener" title="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å ${platform.name}">
                  ${platform.name}
                </a>
                <span class="info-icon" data-toggle="tooltip" title="${platformInfo[platform.name] || ''}">‚ÑπÔ∏è</span>
              </h5>`;
          if (showActive) {
            html += `<p><small>–ê–∫—Ç–∏–≤–Ω—ã–µ (${activeNames.length})</small></p><ul>`;
            activeNames.forEach(n => {
              html += `<li class="employee-item" data-employee="${n}">${n}</li>`;
            });
            html += `</ul>`;
          }
          if (showAway) {
            html += `<p><small>Away (${awayData.length})</small></p><ul>`;
            awayData.forEach(item => {
              html += `<li class="employee-item" data-employee="${item.name}">${item.name}`;
              if (item.reason) html += ` (${item.reason})`;
              html += `</li>`;
            });
            html += `</ul>`;
          }
          html += `</div>`;
          container.innerHTML += html;
        } else {
          let filteredActive = aircallActive.slice().filter(n => n.toLowerCase() !== "away");
          let filteredAway = aircallAway.slice().filter(item => item.name.toLowerCase() !== "away");
          if (currentSearchTerm) {
            filteredActive = filteredActive.filter(n => n.toLowerCase().includes(currentSearchTerm.toLowerCase()));
            filteredAway = filteredAway.filter(item => item.name.toLowerCase().includes(currentSearchTerm.toLowerCase()));
          }
          filteredActive = filteredActive.filter(n => passReallocAndLang(n));
          filteredAway = filteredAway.filter(item => passReallocAndLang(item.name));
          
          let showActive = true, showAway = true;
          if (currentStatusFilter === "active") showAway = false;
          else if (currentStatusFilter === "away") showActive = false;
          renderAircallCardWithStatuses(filteredActive, filteredAway, showActive, showAway);
        }
      });
      
      const employeeItems = document.querySelectorAll(".employee-item");
      employeeItems.forEach(item => {
        item.addEventListener("click", function() {
          const empName = this.getAttribute("data-employee");
          openEmployeeModal(empName);
        });
      });
      
      $('[data-toggle="tooltip"]').tooltip();
    }
    
    function renderAircallCardWithStatuses(activeList, awayList, showActive = true, showAway = true) {
      const aircallPlatform = platforms.find(p => p.name === "Aircall");
      let html = `<div class="platform-card">
            <h5>
              <a href="${aircallPlatform.url}" target="_blank" rel="noopener" title="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å Aircall">
                Aircall
              </a>
              <span class="info-icon" data-toggle="tooltip" title="${platformInfo["Aircall"] || ''}">‚ÑπÔ∏è</span>
            </h5>`;
      if (showActive) {
        html += `<p><small>–ê–∫—Ç–∏–≤–Ω—ã–µ (${activeList.length})</small></p>
                 <ul id="aircall-active-list">` +
                 activeList.map((n, index) => {
                   const safeId = `aircall-active-${index}`;
                   return `<li id="${safeId}" class="employee-item" data-employee="${n}">${n} - <span style="color:blue;">Loading...</span></li>`;
                 }).join("") +
                 `</ul>`;
      }
      if (showAway) {
        html += `<p><small>Away (${awayList.length})</small></p>
                 <ul>` +
                 awayList.map(a => {
                   const extra = a.reason ? " - " + a.reason : "";
                   return `<li class="employee-item" data-employee="${a.name}">${a.name}${extra}</li>`;
                 }).join("") +
                 `</ul>`;
      }
      html += `</div>`;
      document.getElementById("platforms-container").innerHTML += html;
    }
    
    function renderShiftSummary(data) {
      const tableEl = document.getElementById("summary-table"); 
      tableEl.innerHTML = "";
    
      const summaryCards = [
        {
          title: "On shift now",
          value: data[6][27] || "",
        },
        {
          title: "Should be on shift",
          value: data[6][29] || "",
        },
        {
          title: "CS",
          value: data[6][31] || "",
          away: data[8][31] || "",
        },
        {
          title: "CS/Post Order",
          value: data[6][33] || "",
          away: data[8][33] || "",
        },
        {
          title: "PSR",
          value: data[6][35] || "",
          away: data[8][35] || "",
        },
        {
          title: "Venue",
          value: data[6][37] || "",
          away: data[8][37] || "",
        },
        {
          title: "Aircall",
          value: data[6][39] || "",
          away: data[8][39] || "",
        },
        {
          title: "Simo",
          value: data[6][41] || "",
          away: data[8][41] || "",
        },
        {
          title: "ST",
          value: data[6][43] || "",
          away: data[8][43] || "",
        },
        {
          title: "Not here",
          value: (data[8][29] || "") + (data[10][29] ? ", " + data[10][29] : ""),
          customClass: "small-font-card"
        },
        {
          title: "Will not attend the shift",
          value: (data[8][27] || "") + (data[10][27] ? ", " + data[10][27] : ""),
          customClass: "small-font-card"
        }
      ];
    
      let html = `<div class="shift-summary-cards-container" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">`;
    
      summaryCards.forEach(card => {
        html += `
          <div class="shift-card ${card.customClass ? card.customClass : ""}" style="
            background: var(--card-bg-color);
            color: var(--card-text-color);
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            padding: 16px;
            min-width: 150px;
          ">
            <h6 class="shift-card-title">
              ${card.title}
            </h6>
            <div style="margin-bottom: 0.5rem;">${card.value || ""}</div>
        `;
        if (card.away) {
          html += `
            <div class="shift-card-away">
              <strong>Away:</strong> ${card.away}
            </div>
          `;
        }
        html += `</div>`;
      });
    
      html += `</div>`;
      tableEl.innerHTML = html;
    }
    
    async function fetchBreaksData() {
      const data = await fetchSheetData(BREAKS_RANGE);
      if (!data) return;
      const breaksObjects = arrayToObjects(data);
      const now = new Date();
      const currMinutes = now.getHours() * 60 + now.getMinutes();
      let filteredBreaks = breaksObjects;
      if (currentBreakFilter === "upcoming") {
        const horizon = currMinutes + 60;
        filteredBreaks = breaksObjects.filter(item => {
          if (!item["Break Time"]) return false;
          const timeStr = item["Break Time"].trim();
          const minutes = parseTimeToMinutes(timeStr);
          return (minutes >= currMinutes && minutes <= horizon);
        });
        filteredBreaks.sort((a, b) => parseTimeToMinutes(a["Break Time"]) - parseTimeToMinutes(b["Break Time"]));
      } else if (currentBreakFilter === "all") {
        filteredBreaks.sort((a, b) => parseTimeToMinutes(a["Break Time"]) - parseTimeToMinutes(b["Break Time"]));
      }
      let html = `<div class="break-card">
                    <h5>${currentBreakFilter === "upcoming" ? "Upcoming breaks in the next hour" : "All Breaks"}</h5>
                    <ul>`;
      filteredBreaks.forEach(item => {
        html += `
          <li>
            <strong>${item["Name"]}</strong><br/>
            Break at: <strong>${item["Break Time"]}</strong><br/>
            Shift: ${item["Shift Start Time"]} | ${item["Working Space"]}
          </li>`;
      });
      html += `</ul></div>`;
      document.getElementById("breaks-app").innerHTML = html;
    }
    
    function parseTimeToMinutes(timeStr) {
      timeStr = timeStr.trim();
      let parts = timeStr.split(":");
      if (parts.length < 2) return 0;
      let hours = parseInt(parts[0], 10);
      let minutes = parseInt(parts[1], 10);
      return hours * 60 + minutes;
    }
    
    function arrayToObjects(arr) {
      if (!arr.length) return [];
      const header = arr[0];
      return arr.slice(1).map(row => {
        const obj = {};
        header.forEach((key, i) => {
          obj[key] = row[i] || "";
        });
        return obj;
      });
    }
    
    async function fetchAircallStatuses() {
      const activeElements = document.querySelectorAll("[id^='aircall-active-']");
      for (let elem of activeElements) {
        const name = elem.textContent.split(" - ")[0].trim();
        elem.querySelector("span").textContent = "Fetching ID...";
        const email = generateWoltEmail(name);
        const userId = await getAircallUserId(email);
        if (!userId) {
          elem.querySelector("span").textContent = "No ID";
          continue;
        }
        elem.querySelector("span").textContent = "Fetching status...";
        const status = await getAircallAvailability(userId);
        elem.querySelector("span").textContent = status;
      }
    }
    
    let autoRefreshEnabled = true;
    let refreshInterval = 15;
    let refreshTimer = null;
    let countdownTimer = null;
    let countdownValue = refreshInterval;
    
    function resetAutoRefresh() {
      clearTimeout(refreshTimer);
      clearInterval(countdownTimer);
      countdownValue = refreshInterval;
      updateCountdownDisplay();
      refreshTimer = setTimeout(fetchData, refreshInterval * 1000);
      countdownTimer = setInterval(() => {
        countdownValue--;
        updateCountdownDisplay();
        if (countdownValue <= 0) clearInterval(countdownTimer);
      }, 1000);
    }
    function updateCountdownDisplay() {
      const countdownElem = document.getElementById("countdown");
      if (countdownElem) {
        countdownElem.textContent = countdownValue;
      }
    }
    function toggleAutoRefresh() {
      autoRefreshEnabled = !autoRefreshEnabled;
      const btn = document.getElementById("toggle-autorefresh");
      if (autoRefreshEnabled) {
        btn.textContent = "Disable Auto Refresh";
        resetAutoRefresh();
      } else {
        btn.textContent = "Enable Auto Refresh";
        clearTimeout(refreshTimer);
        clearInterval(countdownTimer);
      }
    }
    function refreshNow() {
      document.getElementById("refresh-spinner").style.display = "inline-block";
      fetchData();
    }
    
    async function fetchData() {
      document.getElementById("refresh-spinner").style.display = "inline-block";
      const data = await fetchSheetData(RANGE);
      if (!data) {
        document.getElementById("refresh-spinner").style.display = "none";
        return;
      }
      fetchedData = data;
      
      await fetchEmployeeList();
      
      // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Aircall
      const aircallConfig = platforms.find(p => p.name === "Aircall");
      aircallActive = [];
      aircallAway = [];
      for (let r = aircallConfig.rowActiveNamesStart; r <= aircallConfig.rowActiveNamesEnd; r++) {
        const name = data[r]?.[aircallConfig.colIndexNames]?.trim();
        if (name) aircallActive.push(name);
      }
      for (let r = aircallConfig.rowAwayNamesStart; r <= aircallConfig.rowAwayNamesEnd; r++) {
        const name = data[r]?.[aircallConfig.colIndexNames]?.trim();
        const reason = data[r]?.[aircallConfig.colIndexData]?.trim() || "";
        if (name) aircallAway.push({ name, reason });
      }
      
      renderShiftSummary(data);
      fetchBreaksData();
      applyFilters();
      fetchAircallStatuses();
      
      document.getElementById("refresh-spinner").style.display = "none";
      if (autoRefreshEnabled) resetAutoRefresh();
    }
    
    function generateWoltEmail(name) {
      if (!name) return "";
      const parts = name.split(" ");
      return parts.length < 2
        ? parts[0].toLowerCase() + "@wolt.com"
        : parts[0].toLowerCase() + "." + parts[1].toLowerCase() + "@wolt.com";
    }
    
    function loadThemePreference() {
      const saved = localStorage.getItem("darkThemeEnabled");
      if (saved === "true") {
        document.body.classList.add("dark-theme");
        const themeCheckbox = document.getElementById("theme-checkbox");
        if (themeCheckbox) themeCheckbox.checked = true;
      }
    }
    function toggleTheme(e) {
      const isDark = e.target.checked;
      document.body.classList.toggle("dark-theme", isDark);
      localStorage.setItem("darkThemeEnabled", isDark.toString());
    }
    
    function initPlatformCheckboxes() {
      const dropdownMenu = document.getElementById("platform-dropdown-menu");
      while (dropdownMenu.children.length > 1) {
        dropdownMenu.removeChild(dropdownMenu.lastChild);
      }
      platforms.forEach(platform => {
        const div = document.createElement("div");
        div.className = "dropdown-item platform-checkbox";
        div.innerHTML = `
          <div class="form-check">
            <input class="form-check-input platform-option" type="checkbox" value="${platform.name}" id="platform-${platform.name}">
            <label class="form-check-label" for="platform-${platform.name}">${platform.name}</label>
          </div>
        `;
        dropdownMenu.appendChild(div);
      });
    }
    
    function updatePlatformFilter() {
      const checkboxes = document.querySelectorAll(".platform-option");
      const selected = [];
      checkboxes.forEach(chk => {
        if (chk.checked) {
          selected.push(chk.value);
        }
      });
      currentPlatformFilter = selected.length ? selected : ["all"];
      applyFilters();
    }
    
    document.addEventListener("DOMContentLoaded", () => {
      loadThemePreference();
      initPlatformCheckboxes();
      
      // –ü–†–û–í–ï–†–ö–ê –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –≤—ã—à–µ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase
      
      const platformCheckboxes = document.querySelectorAll(".platform-option");
      platformCheckboxes.forEach(chk => {
        chk.addEventListener("change", function() {
          if (this.value === "all") {
            if (this.checked) {
              platformCheckboxes.forEach(cb => {
                if (cb.value !== "all") {
                  cb.checked = false;
                }
              });
            }
          } else {
            document.getElementById("platform-all").checked = false;
          }
          updatePlatformFilter();
        });
      });
      
      document.getElementById("employee-search").addEventListener("input", function(e) {
        currentSearchTerm = e.target.value;
        applyFilters();
      });
      document.getElementById("status-filter").addEventListener("change", function(e) {
        currentStatusFilter = e.target.value;
        applyFilters();
      });
      document.getElementById("realloc-filter").addEventListener("change", function(e) {
        currentReallocFilter = e.target.value;
        applyFilters();
      });
      document.getElementById("lang-filter").addEventListener("change", function(e) {
        currentLangFilter = e.target.value;
        applyFilters();
      });
      document.getElementById("break-filter").addEventListener("change", function(e) {
        currentBreakFilter = e.target.value;
        fetchBreaksData();
      });
      
      const overlay = document.getElementById("modal-overlay");
      const modalClose = document.getElementById("modal-close");
      overlay.addEventListener("click", closeEmployeeModal);
      modalClose.addEventListener("click", closeEmployeeModal);
      
      document.getElementById("theme-checkbox").addEventListener("change", toggleTheme);
      
      document.getElementById("hamburger-menu").addEventListener("click", function() {
        document.getElementById("sidebar").classList.toggle("active");
      });
      document.getElementById("sidebar-close").addEventListener("click", function() {
        document.getElementById("sidebar").classList.remove("active");
      });
      
      fetchData();
      fetchWeather();
    });
  </script>
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
