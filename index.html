<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>SUMO Dashboard</title>
  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Bootstrap (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    :root {
      /* –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
      --bg-color: linear-gradient(120deg, #fdfbfb 0%, #ebedee 100%);
      --text-color: #343a40;
      --card-bg-color: #ffffff;
      --card-text-color: #495057;
      --card-border-color: #dee2e6;
      --card-shadow: 0 4px 16px rgba(0,0,0,0.08);
      --card-hover-shadow: 0 6px 20px rgba(0,0,0,0.12);
    }
    /* –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ */
    body.dark-theme {
      --bg-color: linear-gradient(120deg, #2a2a2a 0%, #3c3c3c 100%);
      --text-color: #f0f0f0;
      --card-bg-color: #3a3a3a;
      --card-text-color: #e5e5e5;
      --card-border-color: #555555;
      --card-shadow: 0 4px 16px rgba(255,255,255,0.08);
      --card-hover-shadow: 0 6px 20px rgba(255,255,255,0.12);
    }

    /* –û–±—â–∏–π —Å–±—Ä–æ—Å –∏ —Ñ–æ–Ω */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      min-height: 100vh;
      background: var(--bg-color);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow-x: hidden;
      color: var(--text-color);
      transition: background 0.3s ease, color 0.3s ease;
    }

    .dashboard-container {
      width: 100%;
      margin: 0;
      padding: 40px 20px;
      box-sizing: border-box;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      font-weight: 500;
      font-size: 2rem;
      color: var(--text-color);
    }

    /* –ù–æ–≤—ã–π –±–ª–æ–∫-–±–∞—Ä –¥–ª—è –≤—Å–µ—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ */
    .tools-bar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .tools-bar > * {
      margin: 5px;
    }
    /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã */
    .theme-toggle-container {
      display: flex;
      align-items: center;
    }
    .theme-toggle-label {
      margin-right: 8px;
      font-size: 0.9rem;
    }
    .theme-switch {
      position: relative;
      display: inline-block;
      width: 52px;
      height: 28px;
    }
    .theme-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      border-radius: 34px;
      transition: .4s;
    }
    .slider:before {
      position: absolute;
      content: "‚òÄ";
      color: #f39c12;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      width: 22px;
      height: 22px;
      left: 3px;
      bottom: 3px;
      border-radius: 50%;
      background-color: #fff;
      transition: .4s;
    }
    input:checked + .slider {
      background-color: #007bff;
    }
    input:checked + .slider:before {
      transform: translateX(24px);
      content: "üåô";
      color: #f1c40f;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
    .btn {
      transition: background-color 0.3s, box-shadow 0.3s;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ */
    .tools-bar input[type="text"],
    .tools-bar select {
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.9rem;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    .tools-bar input[type="text"]:focus,
    .tools-bar select:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 5px rgba(0,123,255,0.5);
    }

    /* –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ª–µ–Ω—Ç–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ */
    .platforms-row {
      display: flex;
      flex-wrap: nowrap;
      align-items: flex-start;
      justify-content: space-between;
      overflow-x: auto;
      width: 100%;
      gap: 10px;
    }
    .platform-card {
      flex: 1 1 220px;
      min-width: 220px;
      box-sizing: border-box;
      background: var(--card-bg-color);
      color: var(--card-text-color);
      border-radius: 16px;
      padding: 20px;
      box-shadow: var(--card-shadow);
      transition: transform 0.2s, box-shadow 0.2s, background 0.3s;
      white-space: normal;
      overflow-wrap: break-word;
      word-break: normal;
    }
    .platform-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--card-hover-shadow);
    }
    .platform-card h5 {
      color: var(--text-color);
      margin-bottom: 12px;
      text-align: center;
      font-weight: 600;
      font-size: 1.1rem;
    }
    /* –°–¥–µ–ª–∞–µ–º –≥–∏–ø–µ—Ä—Å—Å—ã–ª–∫—É –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞: —É–±–∏—Ä–∞–µ–º –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ –∏ –ø–æ–¥—Å–∫–∞–∂–µ–º, —á—Ç–æ —ç—Ç–æ —Å—Å—ã–ª–∫–∞ */
    .platform-card h5 a {
      text-decoration: underline;      /* –ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç–æ */
      color: #007bff;                 /* —Å–¥–µ–ª–∞–µ–º —Ü–≤–µ—Ç –ø–æ—Å–∏–Ω–µ–µ –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏ */
      cursor: pointer;
    }
    .platform-card h5 a:hover {
      color: #0056b3;                 /* —á—É—Ç—å —Ç–µ–º–Ω–µ–µ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
    }
    .platform-card p {
      text-align: center;
      color: #6c757d;
      margin: 10px 0;
      font-size: 0.85rem;
    }
    .platform-card ul {
      list-style: none;
      padding-left: 0;
      margin: 0;
      font-size: 0.85rem;
      color: var(--card-text-color);
    }
    .platform-card ul li {
      border-bottom: 1px solid var(--card-border-color);
      padding: 4px 0;
      white-space: normal;
      overflow-wrap: break-word;
      word-break: normal;
    }
    .platform-card ul li:last-child {
      border-bottom: none;
    }
    /* Shift Summary Card */
    .shift-summary-card {
      background: var(--card-bg-color);
      color: var(--card-text-color);
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      padding: 20px;
      margin: 0 auto 40px;
      width: auto;
      text-align: center;
      transition: transform 0.2s, box-shadow 0.2s, background 0.3s;
      overflow-wrap: break-word;
      word-break: normal;
    }
    .shift-summary-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--card-hover-shadow);
    }
    .shift-summary-title {
      margin-bottom: 16px;
      font-weight: 600;
      font-size: 1.3rem;
      color: var(--text-color);
    }
    .shift-summary-grid {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      table-layout: auto;
    }
    .shift-summary-grid th,
    .shift-summary-grid td {
      padding: 8px 12px;
      text-align: center;
      font-size: 0.85rem;
      white-space: normal;
      color: var(--card-text-color);
    }
    .shift-summary-grid th {
      background-color: #f8f9fa;
      font-weight: 600;
    }
    .shift-summary-grid td {
      background: var(--card-bg-color);
      border: 1px solid var(--card-border-color);
      border-radius: 8px;
    }
    /* Upcoming Breaks */
    #breaks-section {
      margin-top: 40px;
    }
    #breaks-section h2 {
      text-align: center;
      margin-bottom: 20px;
      font-weight: 500;
      font-size: 1.5rem;
      color: var(--text-color);
    }
    .break-card {
      background: var(--card-bg-color);
      color: var(--card-text-color);
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      padding: 20px;
      margin: 0 auto 40px;
      max-width: 600px;
      text-align: center;
      transition: transform 0.2s, box-shadow 0.2s, background 0.3s;
      overflow-wrap: break-word;
      word-break: normal;
    }
    .break-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--card-hover-shadow);
    }
    .break-card h5 {
      margin-bottom: 12px;
      font-weight: 600;
      color: var(--text-color);
      font-size: 1.1rem;
    }
    .break-card ul {
      list-style: none;
      padding-left: 0;
      margin: 0;
      font-size: 0.85rem;
      color: var(--card-text-color);
    }
    .break-card ul li {
      padding: 6px 0;
      border-bottom: 1px solid var(--card-border-color);
    }
    .break-card ul li:last-child {
      border-bottom: none;
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <h1>Support Monitoring Dashboard</h1>
    
    <!-- –ï–¥–∏–Ω—ã–π –±–∞—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ -->
    <div class="tools-bar">
      <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã -->
      <div class="theme-toggle-container">
        <span class="theme-toggle-label">–¢–µ–º–∞:</span>
        <label class="theme-switch">
          <input type="checkbox" id="theme-checkbox"/>
          <span class="slider"></span>
        </label>
      </div>
      <button id="toggle-autorefresh" class="btn btn-outline-primary">Disable Auto Refresh</button>
      <button id="refresh-now" class="btn btn-outline-secondary">Refresh now</button>
      <span>Auto refresh in <span id="countdown">15</span> sec</span>
      <!-- –ü–æ–ª–µ –ø–æ–∏—Å–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä—ã -->
      <input type="text" id="employee-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º" />
      <select id="platform-filter">
        <option value="all">–í—Å–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã</option>
        <option value="CS">CS</option>
        <option value="CS/Post order">CS/Post order</option>
        <option value="PSR">PSR</option>
        <option value="SiMo">SiMo</option>
        <option value="Aircall">Aircall</option>
        <option value="Venue">Venue</option>
        <option value="Trainee">Trainee</option>
        <option value="ST">ST</option>
      </select>
      <select id="status-filter">
        <option value="both">–ê–∫—Ç–∏–≤–Ω—ã–µ –∏ Away</option>
        <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
        <option value="away">Away</option>
      </select>
    </div>
    
    <!-- Shift Summary Card -->
    <div id="shift-summary" class="shift-summary-card">
      <div class="shift-summary-title">Statistics per platform</div>
      <table class="shift-summary-grid" id="summary-table"></table>
    </div>
    
    <!-- –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ª–µ–Ω—Ç–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è –ø–ª–∞—Ç—Ñ–æ—Ä–º -->
    <div id="platforms-container" class="platforms-row"></div>
    
    <!-- –†–∞–∑–¥–µ–ª Upcoming Breaks -->
    <div id="breaks-section">
      <h2>Upcoming Breaks</h2>
      <div id="breaks-app"></div>
    </div>
  </div>
  
  <script>
    /********* –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ **********/
    let fetchedData = null;
    let currentSearchTerm = "";
    let currentPlatformFilter = "all";
    let currentStatusFilter = "both";
    
    /********* Google Sheets API **********/
    const SPREADSHEET_ID = "1dICKOxxz9R3x8MY3FKQ9I-IwR9fBUDfMOT9PFDLloAE";
    const RANGE = "list1!A1:BJ100";
    const BREAKS_RANGE = "prebreaks!A1:D40";
    const GOOGLE_API_KEY = "AIzaSyBVHrKvA61CAJBLxU-4AAiow6Y0TV4ChSY";
    
    async function fetchSheetData(range) {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(range)}?key=${GOOGLE_API_KEY}`;
      try {
        const res = await fetch(url);
        if (!res.ok) {
          console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: " + res.statusText);
          return null;
        }
        const data = await res.json();
        return data.values;
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", err);
        return null;
      }
    }
    
    /********* Aircall API –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ **********/
    const AIRCALL_API_KEY = "43bce092d80a09050211a837c0bbd705";
    const AIRCALL_API_SECRET = "092d2eb157c47614788386920acd7413";
    
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º (–¥–æ–±–∞–≤–∏–ª–∏ url –¥–ª—è –≥–∏–ø–µ—Ä—Å—Å—ã–ª–∫–∏)
    const platforms = [
      { name: "CS",             url: "https://ops.wolt.com/support/converse/conversations?conversationListId=6643245bfadf62c6edc28feb", colIndexNames: 3,  colIndexData: 4,  rowActiveNamesStart: 4,  rowActiveNamesEnd: 15, rowAwayNamesStart: 28, rowAwayNamesEnd: 35 },
      { name: "CS/Post order",  url: "https://ops.wolt.com/support/converse/conversations?conversationListId=664324a0510ac011feaa798c", colIndexNames: 5,  colIndexData: 6,  rowActiveNamesStart: 4,  rowActiveNamesEnd: 15, rowAwayNamesStart: 28, rowAwayNamesEnd: 35 },
      { name: "PSR",            url: "https://ops.wolt.com/support/converse/conversations?conversationListId=6567a44af7d470550b11dc68", colIndexNames: 7,  colIndexData: 8,  rowActiveNamesStart: 4,  rowActiveNamesEnd: 15, rowAwayNamesStart: 28, rowAwayNamesEnd: 35 },
      { name: "SiMo",           url: "https://ops.wolt.com/support/converse/conversations?conversationListId=6668088fc6d870f3cfd61653", colIndexNames: 9,  colIndexData: 10, rowActiveNamesStart: 4,  rowActiveNamesEnd: 15, rowAwayNamesStart: 28, rowAwayNamesEnd: 35 },
      { name: "Aircall",        url: "https://ops.wolt.com/support/converse/conversations?conversationListId=671a26a2a5b9ae4a2ca603fb", colIndexNames: 11, colIndexData: 12, rowActiveNamesStart: 4,  rowActiveNamesEnd: 15, rowAwayNamesStart: 28, rowAwayNamesEnd: 46 },
      { name: "Venue",          url: "https://ops.wolt.com/support/converse/conversations?conversationListId=666807fc28b3f1231948f407", colIndexNames: 13, colIndexData: 14, rowActiveNamesStart: 4,  rowActiveNamesEnd: 15, rowAwayNamesStart: 28, rowAwayNamesEnd: 35 },
      { name: "Trainee",        url: "https://wolt.com/", colIndexNames: 15, colIndexData: 16, rowActiveNamesStart: 4,  rowActiveNamesEnd: 15, rowAwayNamesStart: 28, rowAwayNamesEnd: 35 },
      { name: "ST",             url: "https://wolt.com/", colIndexNames: 17, colIndexData: 18, rowActiveNamesStart: 4,  rowActiveNamesEnd: 15, rowAwayNamesStart: 28, rowAwayNamesEnd: 35 }
    ];
    
    let aircallActive = [];
    let aircallAway = [];
    
    function generateWoltEmail(fullName) {
      const parts = fullName.trim().split(/\s+/);
      if (parts.length < 2) return "";
      return parts[0].toLowerCase() + "." + parts[1].toLowerCase() + "@wolt.com";
    }
    
    async function getAircallUserId(email) {
      const authString = btoa(`${AIRCALL_API_KEY}:${AIRCALL_API_SECRET}`);
      const url = `https://api.aircall.io/v1/users/${encodeURIComponent(email)}`;
      try {
        const res = await fetch(url, { headers: { "Authorization": `Basic ${authString}` }});
        if (!res.ok) return null;
        const data = await res.json();
        return data.user?.id || null;
      } catch {
        return null;
      }
    }
    
    async function getAircallAvailability(userId) {
      if (!userId) return "No ID";
      const authString = btoa(`${AIRCALL_API_KEY}:${AIRCALL_API_SECRET}`);
      const url = `https://api.aircall.io/v1/users/${userId}/availability`;
      try {
        const res = await fetch(url, { headers: { "Authorization": `Basic ${authString}` }});
        if (!res.ok) return "Error";
        const data = await res.json();
        let status = data?.user_availability?.availability_status || data?.availability;
        return status || "Unknown";
      } catch {
        return "Error";
      }
    }
    
    function applyFilters() {
      const container = document.getElementById("platforms-container");
      container.innerHTML = "";
      
      platforms.forEach(platform => {
        if (currentPlatformFilter !== "all" && platform.name.toLowerCase() !== currentPlatformFilter.toLowerCase())
          return;
    
        if (platform.name !== "Aircall") {
          let activeNames = [];
          for (let r = platform.rowActiveNamesStart; r <= platform.rowActiveNamesEnd; r++) {
            const nm = fetchedData[r]?.[platform.colIndexNames]?.trim();
            if (nm) activeNames.push(nm);
          }
          let awayData = [];
          for (let r = platform.rowAwayNamesStart; r <= platform.rowAwayNamesEnd; r++) {
            const nm = fetchedData[r]?.[platform.colIndexNames]?.trim();
            if (!nm) continue;
            const rsn = fetchedData[r]?.[platform.colIndexData]?.trim() || "";
            awayData.push({ name: nm, reason: rsn });
          }
    
          if (currentSearchTerm) {
            activeNames = activeNames.filter(n => n.toLowerCase().includes(currentSearchTerm.toLowerCase()));
            awayData = awayData.filter(item => item.name.toLowerCase().includes(currentSearchTerm.toLowerCase()));
          }
    
          let showActive = true, showAway = true;
          if (currentStatusFilter === "active") showAway = false;
          else if (currentStatusFilter === "away") showActive = false;
    
          let html = `<div class="platform-card">
              <h5>
                <a href="${platform.url}" target="_blank" rel="noopener">
                  ${platform.name}
                </a>
              </h5>`;
          if (showActive) {
            html += `<p><small>–ê–∫—Ç–∏–≤–Ω—ã–µ (${activeNames.length})</small></p>
                     <ul>${activeNames.map(n => `<li>${n}</li>`).join("")}</ul>`;
          }
          if (showAway) {
            html += `<p><small>Away (${awayData.length})</small></p>
                     <ul>${awayData.map(item => {
                       const extra = item.reason ? " - " + item.reason : "";
                       return `<li>${item.name}${extra}</li>`;
                     }).join("")}</ul>`;
          }
          html += `</div>`;
          container.innerHTML += html;
        } else {
          // Aircall
          let filteredActive = aircallActive.slice();
          let filteredAway = aircallAway.slice();
          if (currentSearchTerm) {
            filteredActive = filteredActive.filter(n => n.toLowerCase().includes(currentSearchTerm.toLowerCase()));
            filteredAway = filteredAway.filter(item => item.name.toLowerCase().includes(currentSearchTerm.toLowerCase()));
          }
          let showActive = true, showAway = true;
          if (currentStatusFilter === "active") showAway = false;
          else if (currentStatusFilter === "away") showActive = false;
          renderAircallCardWithStatuses(filteredActive, filteredAway, showActive, showAway);
        }
      });
    }
    
    function renderAircallCardWithStatuses(activeList, awayList, showActive = true, showAway = true) {
      const aircallPlatform = platforms.find(p => p.name === "Aircall");
      let html = `<div class="platform-card">
            <h5>
              <a href="${aircallPlatform.url}" target="_blank" rel="noopener">
                Aircall
              </a>
            </h5>`;
      if (showActive) {
        html += `<p><small>–ê–∫—Ç–∏–≤–Ω—ã–µ (${activeList.length})</small></p>
                 <ul id="aircall-active-list">` +
                 activeList.map((n, index) => {
                   const safeId = `aircall-active-${index}`;
                   return `<li id="${safeId}">${n} - <span style="color:blue;">Loading...</span></li>`;
                 }).join("") +
                 `</ul>`;
      }
      if (showAway) {
        html += `<p><small>Away (${awayList.length})</small></p>
                 <ul>` +
                 awayList.map(a => {
                   const extra = a.reason ? " - " + a.reason : "";
                   return `<li>${a.name}${extra}</li>`;
                 }).join("") +
                 `</ul>`;
      }
      html += `</div>`;
      document.getElementById("platforms-container").innerHTML += html;
    }
    
    function renderShiftSummary(data) {
      const tableEl = document.getElementById("summary-table");
      let html = "";
      for (let i = 5; i < data.length; i++) {
        const row = data[i];
        const subset = row.slice(27, 44)
                         .map(cell => cell.trim())
                         .filter(cell => cell !== "");
        if (subset.length === 0 || subset.includes("Dashboard"))
          continue;
        html += "<tr>";
        subset.forEach(cell => {
          html += `<td>${cell}</td>`;
        });
        html += "</tr>";
      }
      tableEl.innerHTML = html;
    }
    
    async function fetchBreaksData() {
      const data = await fetchSheetData(BREAKS_RANGE);
      if (!data) return;
      const breaksObjects = arrayToObjects(data);
      const now = new Date();
      const currMinutes = now.getHours() * 60 + now.getMinutes();
      const horizon = currMinutes + 60;
      const upcoming = breaksObjects.filter(item => {
        if (!item["Break Time"]) return false;
        const timeStr = item["Break Time"].trim();
        const minutes = parseTimeToMinutes(timeStr);
        return (minutes > currMinutes && minutes <= horizon);
      });
      upcoming.sort((a, b) => parseTimeToMinutes(a["Break Time"]) - parseTimeToMinutes(b["Break Time"]));
      let html = `<div class="break-card">
                    <h5>Upcoming breaks in the next hour</h5>
                    <ul>`;
      upcoming.forEach(item => {
        html += `
          <li>
            <strong>${item["Name"]}</strong><br/>
            Break at: <strong>${item["Break Time"]}</strong><br/>
            Shift: ${item["Shift Start Time"]} | ${item["Working Space"]}
          </li>`;
      });
      html += `</ul></div>`;
      document.getElementById("breaks-app").innerHTML = html;
    }
    
    function parseTimeToMinutes(timeStr) {
      const [hh, mm] = timeStr.trim().split(":");
      return parseInt(hh, 10) * 60 + parseInt(mm, 10);
    }
    
    function arrayToObjects(arr) {
      if (!arr.length) return [];
      const header = arr[0];
      return arr.slice(1).map(row => {
        const obj = {};
        header.forEach((key, i) => {
          obj[key] = row[i] || "";
        });
        return obj;
      });
    }
    
    async function fetchAircallStatuses() {
      const activeElements = document.querySelectorAll("[id^='aircall-active-']");
      for (let elem of activeElements) {
        const name = elem.textContent.split(" - ")[0].trim();
        elem.querySelector("span").textContent = "Fetching ID...";
        const email = generateWoltEmail(name);
        const userId = await getAircallUserId(email);
        if (!userId) {
          elem.querySelector("span").textContent = "No ID";
          continue;
        }
        elem.querySelector("span").textContent = "Fetching status...";
        const status = await getAircallAvailability(userId);
        elem.querySelector("span").textContent = status;
      }
    }
    
    let autoRefreshEnabled = true;
    let refreshInterval = 15;
    let refreshTimer = null;
    let countdownTimer = null;
    let countdownValue = refreshInterval;
    
    function resetAutoRefresh() {
      clearTimeout(refreshTimer);
      clearInterval(countdownTimer);
      countdownValue = refreshInterval;
      updateCountdownDisplay();
      refreshTimer = setTimeout(fetchData, refreshInterval * 1000);
      countdownTimer = setInterval(() => {
        countdownValue--;
        if (countdownValue <= 0) clearInterval(countdownTimer);
        updateCountdownDisplay();
      }, 1000);
    }
    
    function updateCountdownDisplay() {
      document.getElementById("countdown").textContent = countdownValue;
    }
    
    function toggleAutoRefresh() {
      autoRefreshEnabled = !autoRefreshEnabled;
      const btn = document.getElementById("toggle-autorefresh");
      if (autoRefreshEnabled) {
        btn.textContent = "Disable Auto Refresh";
        resetAutoRefresh();
      } else {
        btn.textContent = "Enable Auto Refresh";
        clearTimeout(refreshTimer);
        clearInterval(countdownTimer);
        document.getElementById("countdown").textContent = "";
      }
    }
    
    function refreshNow() {
      fetchData();
    }
    
    async function fetchData() {
      const data = await fetchSheetData(RANGE);
      if (!data) return;
      fetchedData = data;
      
      // –ó–∞–ø–æ–ª–Ω—è–µ–º Aircall
      const aircallConfig = platforms.find(p => p.name === "Aircall");
      aircallActive = [];
      aircallAway = [];
      for (let r = aircallConfig.rowActiveNamesStart; r <= aircallConfig.rowActiveNamesEnd; r++) {
        const name = data[r]?.[aircallConfig.colIndexNames]?.trim();
        if (name) aircallActive.push(name);
      }
      for (let r = aircallConfig.rowAwayNamesStart; r <= aircallConfig.rowAwayNamesEnd; r++) {
        const name = data[r]?.[aircallConfig.colIndexNames]?.trim();
        const reason = data[r]?.[aircallConfig.colIndexData]?.trim() || "";
        if (name) aircallAway.push({ name, reason });
      }
      
      renderShiftSummary(data);
      fetchBreaksData();
      applyFilters();
      fetchAircallStatuses();
      
      if (autoRefreshEnabled) resetAutoRefresh();
    }
    
    function loadThemePreference() {
      const saved = localStorage.getItem("darkThemeEnabled");
      if (saved === "true") {
        document.body.classList.add("dark-theme");
        document.getElementById("theme-checkbox").checked = true;
      }
    }
    function toggleTheme(e) {
      const isDark = e.target.checked;
      document.body.classList.toggle("dark-theme", isDark);
      localStorage.setItem("darkThemeEnabled", isDark.toString());
    }
    
    document.addEventListener("DOMContentLoaded", () => {
      loadThemePreference();
      
      document.getElementById("theme-checkbox").addEventListener("change", toggleTheme);
      document.getElementById("toggle-autorefresh").addEventListener("click", toggleAutoRefresh);
      document.getElementById("refresh-now").addEventListener("click", refreshNow);
    
      document.getElementById("employee-search").addEventListener("input", function(e){
        currentSearchTerm = e.target.value;
        applyFilters();
      });
      document.getElementById("platform-filter").addEventListener("change", function(e){
        currentPlatformFilter = e.target.value;
        applyFilters();
      });
      document.getElementById("status-filter").addEventListener("change", function(e){
        currentStatusFilter = e.target.value;
        applyFilters();
      });
    
      fetchData();
    });
  </script>
  <div id="loading-overlay">
    <div class="spinner"></div>
  </div>
</body>
</html>
